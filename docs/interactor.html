<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.3"/>
    <title>interactor API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Interactor">Interactor</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Interactor.__init__">Interactor</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.system">system</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.logger">logger</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.providers">providers</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.token_estimate">token_estimate</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.last_token_estimate">last_token_estimate</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.stream">stream</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.tools">tools</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.session_history">session_history</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.history">history</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.context_length">context_length</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.encoding">encoding</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.max_retries">max_retries</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.retry_delay">retry_delay</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.reveal_tool">reveal_tool</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.fallback_model">fallback_model</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.sdk">sdk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.session_enabled">session_enabled</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.session_id">session_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.session">session</a>
                        </li>
                        <li>
                                <a class="variable" href="#Interactor.tools_enabled">tools_enabled</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.add_function">add_function</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.disable_function">disable_function</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.enable_function">enable_function</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.delete_function">delete_function</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.list_functions">list_functions</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.list_models">list_models</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.interact">interact</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.messages_add">messages_add</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.messages_system">messages_system</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.messages">messages</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.messages_length">messages_length</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.session_load">session_load</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.session_reset">session_reset</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.track_token_usage">track_token_usage</a>
                        </li>
                        <li>
                                <a class="function" href="#Interactor.get_message_token_breakdown">get_message_token_breakdown</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Session">Session</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Session.__init__">Session</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.list">list</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.create">create</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.load">load</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.load_full">load_full</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.delete">delete</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.update">update</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.msg_insert">msg_insert</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.msg_get">msg_get</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.msg_index">msg_index</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.msg_update">msg_update</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.msg_delete">msg_delete</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.branch">branch</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.summarize">summarize</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.search">search</a>
                        </li>
                        <li>
                                <a class="function" href="#Session.search_meta">search_meta</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
interactor    </h1>

                
                        <input id="mod-interactor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-interactor-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos"> 1</span></a><span class="ch">#!/usr/bin/env python3</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos"> 2</span></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos"> 3</span></a><span class="c1">#</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos"> 4</span></a><span class="c1"># File: __init__.py</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos"> 5</span></a><span class="c1"># Author: Wadih Khairallah</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos"> 6</span></a><span class="c1"># Description: </span>
</span><span id="L-7"><a href="#L-7"><span class="linenos"> 7</span></a><span class="c1"># Created: 2025-05-05 16:35:44</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos"> 8</span></a><span class="c1"># Modified: 2025-05-05 17:56:50</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos"> 9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos">10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.interactor</span><span class="w"> </span><span class="kn">import</span> <span class="n">Interactor</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos">13</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Interactor&quot;</span><span class="p">,</span> <span class="s2">&quot;Session&quot;</span><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="Interactor">
                            <input id="Interactor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Interactor</span>:

                <label class="view-source-button" for="Interactor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor-61"><a href="#Interactor-61"><span class="linenos">  61</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Interactor</span><span class="p">:</span>
</span><span id="Interactor-62"><a href="#Interactor-62"><span class="linenos">  62</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Interactor-63"><a href="#Interactor-63"><span class="linenos">  63</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor-64"><a href="#Interactor-64"><span class="linenos">  64</span></a>        <span class="n">base_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-65"><a href="#Interactor-65"><span class="linenos">  65</span></a>        <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-66"><a href="#Interactor-66"><span class="linenos">  66</span></a>        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;openai:gpt-4o-mini&quot;</span><span class="p">,</span>
</span><span id="Interactor-67"><a href="#Interactor-67"><span class="linenos">  67</span></a>        <span class="n">fallback_model</span> <span class="o">=</span> <span class="s2">&quot;ollama:mistral-nemo:latest&quot;</span><span class="p">,</span>
</span><span id="Interactor-68"><a href="#Interactor-68"><span class="linenos">  68</span></a>        <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Interactor-69"><a href="#Interactor-69"><span class="linenos">  69</span></a>        <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Interactor-70"><a href="#Interactor-70"><span class="linenos">  70</span></a>        <span class="n">context_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">,</span>
</span><span id="Interactor-71"><a href="#Interactor-71"><span class="linenos">  71</span></a>        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="Interactor-72"><a href="#Interactor-72"><span class="linenos">  72</span></a>        <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="Interactor-73"><a href="#Interactor-73"><span class="linenos">  73</span></a>        <span class="n">log_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-74"><a href="#Interactor-74"><span class="linenos">  74</span></a>        <span class="n">session_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-75"><a href="#Interactor-75"><span class="linenos">  75</span></a>        <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-76"><a href="#Interactor-76"><span class="linenos">  76</span></a>        <span class="n">session_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-77"><a href="#Interactor-77"><span class="linenos">  77</span></a>    <span class="p">):</span>
</span><span id="Interactor-78"><a href="#Interactor-78"><span class="linenos">  78</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the universal AI interaction client.</span>
</span><span id="Interactor-79"><a href="#Interactor-79"><span class="linenos">  79</span></a>
</span><span id="Interactor-80"><a href="#Interactor-80"><span class="linenos">  80</span></a><span class="sd">        Args:</span>
</span><span id="Interactor-81"><a href="#Interactor-81"><span class="linenos">  81</span></a><span class="sd">            base_url: Optional base URL for the API. If None, uses the provider&#39;s default URL.</span>
</span><span id="Interactor-82"><a href="#Interactor-82"><span class="linenos">  82</span></a><span class="sd">            api_key: Optional API key. If None, attempts to use environment variables based on provider.</span>
</span><span id="Interactor-83"><a href="#Interactor-83"><span class="linenos">  83</span></a><span class="sd">            model: Model identifier in format &quot;provider:model_name&quot; (e.g., &quot;openai:gpt-4o-mini&quot;).</span>
</span><span id="Interactor-84"><a href="#Interactor-84"><span class="linenos">  84</span></a><span class="sd">            tools: Enable (True) or disable (False) tool calling; None for auto-detection based on model support.</span>
</span><span id="Interactor-85"><a href="#Interactor-85"><span class="linenos">  85</span></a><span class="sd">            stream: Enable (True) or disable (False) streaming responses.</span>
</span><span id="Interactor-86"><a href="#Interactor-86"><span class="linenos">  86</span></a><span class="sd">            context_length: Maximum number of tokens to maintain in conversation history.</span>
</span><span id="Interactor-87"><a href="#Interactor-87"><span class="linenos">  87</span></a><span class="sd">            max_retries: Maximum number of retries for failed API calls.</span>
</span><span id="Interactor-88"><a href="#Interactor-88"><span class="linenos">  88</span></a><span class="sd">            retry_delay: Initial delay (in seconds) for exponential backoff retries.</span>
</span><span id="Interactor-89"><a href="#Interactor-89"><span class="linenos">  89</span></a><span class="sd">            session_enabled: Enable persistent session support.</span>
</span><span id="Interactor-90"><a href="#Interactor-90"><span class="linenos">  90</span></a><span class="sd">            session_id: Optional session ID to load messages from.</span>
</span><span id="Interactor-91"><a href="#Interactor-91"><span class="linenos">  91</span></a>
</span><span id="Interactor-92"><a href="#Interactor-92"><span class="linenos">  92</span></a><span class="sd">        Raises:</span>
</span><span id="Interactor-93"><a href="#Interactor-93"><span class="linenos">  93</span></a><span class="sd">            ValueError: If provider is not supported or API key is missing for non-Ollama providers.</span>
</span><span id="Interactor-94"><a href="#Interactor-94"><span class="linenos">  94</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-95"><a href="#Interactor-95"><span class="linenos">  95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;You are a helpful Assistant.&quot;</span>
</span><span id="Interactor-96"><a href="#Interactor-96"><span class="linenos">  96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;InteractorLogger_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-97"><a href="#Interactor-97"><span class="linenos">  97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span id="Interactor-98"><a href="#Interactor-98"><span class="linenos">  98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">providers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-99"><a href="#Interactor-99"><span class="linenos">  99</span></a>            <span class="s2">&quot;openai&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-100"><a href="#Interactor-100"><span class="linenos"> 100</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor-101"><a href="#Interactor-101"><span class="linenos"> 101</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.openai.com/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor-102"><a href="#Interactor-102"><span class="linenos"> 102</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor-103"><a href="#Interactor-103"><span class="linenos"> 103</span></a>            <span class="p">},</span>
</span><span id="Interactor-104"><a href="#Interactor-104"><span class="linenos"> 104</span></a>           <span class="s2">&quot;ollama&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-105"><a href="#Interactor-105"><span class="linenos"> 105</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor-106"><a href="#Interactor-106"><span class="linenos"> 106</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://localhost:11434/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor-107"><a href="#Interactor-107"><span class="linenos"> 107</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="s2">&quot;ollama&quot;</span>
</span><span id="Interactor-108"><a href="#Interactor-108"><span class="linenos"> 108</span></a>            <span class="p">},</span>
</span><span id="Interactor-109"><a href="#Interactor-109"><span class="linenos"> 109</span></a>            <span class="s2">&quot;nvidia&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-110"><a href="#Interactor-110"><span class="linenos"> 110</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor-111"><a href="#Interactor-111"><span class="linenos"> 111</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://integrate.api.nvidia.com/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor-112"><a href="#Interactor-112"><span class="linenos"> 112</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NVIDIA_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor-113"><a href="#Interactor-113"><span class="linenos"> 113</span></a>            <span class="p">},</span>
</span><span id="Interactor-114"><a href="#Interactor-114"><span class="linenos"> 114</span></a>            <span class="s2">&quot;google&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-115"><a href="#Interactor-115"><span class="linenos"> 115</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor-116"><a href="#Interactor-116"><span class="linenos"> 116</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://generativelanguage.googleapis.com/v1beta/openai&quot;</span><span class="p">,</span>
</span><span id="Interactor-117"><a href="#Interactor-117"><span class="linenos"> 117</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GEMINI_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor-118"><a href="#Interactor-118"><span class="linenos"> 118</span></a>            <span class="p">},</span>
</span><span id="Interactor-119"><a href="#Interactor-119"><span class="linenos"> 119</span></a>            <span class="s2">&quot;anthropic&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-120"><a href="#Interactor-120"><span class="linenos"> 120</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;anthropic&quot;</span><span class="p">,</span>
</span><span id="Interactor-121"><a href="#Interactor-121"><span class="linenos"> 121</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.anthropic.com/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor-122"><a href="#Interactor-122"><span class="linenos"> 122</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor-123"><a href="#Interactor-123"><span class="linenos"> 123</span></a>            <span class="p">},</span>
</span><span id="Interactor-124"><a href="#Interactor-124"><span class="linenos"> 124</span></a>            <span class="s2">&quot;mistral&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-125"><a href="#Interactor-125"><span class="linenos"> 125</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor-126"><a href="#Interactor-126"><span class="linenos"> 126</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.mistral.ai/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor-127"><a href="#Interactor-127"><span class="linenos"> 127</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MISTRAL_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor-128"><a href="#Interactor-128"><span class="linenos"> 128</span></a>            <span class="p">},</span>
</span><span id="Interactor-129"><a href="#Interactor-129"><span class="linenos"> 129</span></a>            <span class="s2">&quot;deepseek&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-130"><a href="#Interactor-130"><span class="linenos"> 130</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor-131"><a href="#Interactor-131"><span class="linenos"> 131</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com&quot;</span><span class="p">,</span>
</span><span id="Interactor-132"><a href="#Interactor-132"><span class="linenos"> 132</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor-133"><a href="#Interactor-133"><span class="linenos"> 133</span></a>            <span class="p">},</span>
</span><span id="Interactor-134"><a href="#Interactor-134"><span class="linenos"> 134</span></a>            <span class="s2">&quot;grok&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-135"><a href="#Interactor-135"><span class="linenos"> 135</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;grok&quot;</span><span class="p">,</span>
</span><span id="Interactor-136"><a href="#Interactor-136"><span class="linenos"> 136</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.x.ai/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor-137"><a href="#Interactor-137"><span class="linenos"> 137</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GROK_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor-138"><a href="#Interactor-138"><span class="linenos"> 138</span></a>            <span class="p">}</span>
</span><span id="Interactor-139"><a href="#Interactor-139"><span class="linenos"> 139</span></a>        <span class="p">}</span>
</span><span id="Interactor-140"><a href="#Interactor-140"><span class="linenos"> 140</span></a>
</span><span id="Interactor-141"><a href="#Interactor-141"><span class="linenos"> 141</span></a>
</span><span id="Interactor-142"><a href="#Interactor-142"><span class="linenos"> 142</span></a>        <span class="c1"># Console log handler (always enabled at WARNING+)</span>
</span><span id="Interactor-143"><a href="#Interactor-143"><span class="linenos"> 143</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
</span><span id="Interactor-144"><a href="#Interactor-144"><span class="linenos"> 144</span></a>            <span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</span><span id="Interactor-145"><a href="#Interactor-145"><span class="linenos"> 145</span></a>            <span class="n">console_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
</span><span id="Interactor-146"><a href="#Interactor-146"><span class="linenos"> 146</span></a>            <span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">))</span>
</span><span id="Interactor-147"><a href="#Interactor-147"><span class="linenos"> 147</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>
</span><span id="Interactor-148"><a href="#Interactor-148"><span class="linenos"> 148</span></a>
</span><span id="Interactor-149"><a href="#Interactor-149"><span class="linenos"> 149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_enabled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Interactor-150"><a href="#Interactor-150"><span class="linenos"> 150</span></a>        <span class="k">if</span> <span class="n">log_path</span><span class="p">:</span>
</span><span id="Interactor-151"><a href="#Interactor-151"><span class="linenos"> 151</span></a>            <span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
</span><span id="Interactor-152"><a href="#Interactor-152"><span class="linenos"> 152</span></a>            <span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span id="Interactor-153"><a href="#Interactor-153"><span class="linenos"> 153</span></a>            <span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
</span><span id="Interactor-154"><a href="#Interactor-154"><span class="linenos"> 154</span></a>                <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Interactor-155"><a href="#Interactor-155"><span class="linenos"> 155</span></a>                <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span>
</span><span id="Interactor-156"><a href="#Interactor-156"><span class="linenos"> 156</span></a>            <span class="p">))</span>
</span><span id="Interactor-157"><a href="#Interactor-157"><span class="linenos"> 157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
</span><span id="Interactor-158"><a href="#Interactor-158"><span class="linenos"> 158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_enabled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor-159"><a href="#Interactor-159"><span class="linenos"> 159</span></a>
</span><span id="Interactor-160"><a href="#Interactor-160"><span class="linenos"> 160</span></a>
</span><span id="Interactor-161"><a href="#Interactor-161"><span class="linenos"> 161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_estimate</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Interactor-162"><a href="#Interactor-162"><span class="linenos"> 162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_token_estimate</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Interactor-163"><a href="#Interactor-163"><span class="linenos"> 163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span>
</span><span id="Interactor-164"><a href="#Interactor-164"><span class="linenos"> 164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-165"><a href="#Interactor-165"><span class="linenos"> 165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-166"><a href="#Interactor-166"><span class="linenos"> 166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-167"><a href="#Interactor-167"><span class="linenos"> 167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span> <span class="o">=</span> <span class="n">context_length</span>
</span><span id="Interactor-168"><a href="#Interactor-168"><span class="linenos"> 168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-169"><a href="#Interactor-169"><span class="linenos"> 169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
</span><span id="Interactor-170"><a href="#Interactor-170"><span class="linenos"> 170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="n">retry_delay</span>
</span><span id="Interactor-171"><a href="#Interactor-171"><span class="linenos"> 171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reveal_tool</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-172"><a href="#Interactor-172"><span class="linenos"> 172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fallback_model</span> <span class="o">=</span> <span class="n">fallback_model</span>
</span><span id="Interactor-173"><a href="#Interactor-173"><span class="linenos"> 173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-174"><a href="#Interactor-174"><span class="linenos"> 174</span></a>
</span><span id="Interactor-175"><a href="#Interactor-175"><span class="linenos"> 175</span></a>        <span class="c1"># Session support</span>
</span><span id="Interactor-176"><a href="#Interactor-176"><span class="linenos"> 176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="o">=</span> <span class="n">session_enabled</span>
</span><span id="Interactor-177"><a href="#Interactor-177"><span class="linenos"> 177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span>
</span><span id="Interactor-178"><a href="#Interactor-178"><span class="linenos"> 178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_session_id</span> <span class="o">=</span> <span class="n">session_id</span>
</span><span id="Interactor-179"><a href="#Interactor-179"><span class="linenos"> 179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">session_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">session_enabled</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Interactor-180"><a href="#Interactor-180"><span class="linenos"> 180</span></a>
</span><span id="Interactor-181"><a href="#Interactor-181"><span class="linenos"> 181</span></a>
</span><span id="Interactor-182"><a href="#Interactor-182"><span class="linenos"> 182</span></a>        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Interactor-183"><a href="#Interactor-183"><span class="linenos"> 183</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;openai:gpt-4o-mini&quot;</span>
</span><span id="Interactor-184"><a href="#Interactor-184"><span class="linenos"> 184</span></a>
</span><span id="Interactor-185"><a href="#Interactor-185"><span class="linenos"> 185</span></a>        <span class="c1"># Initialize model + encoding</span>
</span><span id="Interactor-186"><a href="#Interactor-186"><span class="linenos"> 186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_client</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
</span><span id="Interactor-187"><a href="#Interactor-187"><span class="linenos"> 187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tools_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_supported</span> <span class="k">if</span> <span class="n">tools</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tools</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_supported</span>
</span><span id="Interactor-188"><a href="#Interactor-188"><span class="linenos"> 188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_encoding</span><span class="p">()</span>
</span><span id="Interactor-189"><a href="#Interactor-189"><span class="linenos"> 189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
</span><span id="Interactor-190"><a href="#Interactor-190"><span class="linenos"> 190</span></a>
</span><span id="Interactor-191"><a href="#Interactor-191"><span class="linenos"> 191</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;info&quot;</span><span class="p">):</span>
</span><span id="Interactor-192"><a href="#Interactor-192"><span class="linenos"> 192</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_enabled</span><span class="p">:</span>
</span><span id="Interactor-193"><a href="#Interactor-193"><span class="linenos"> 193</span></a>            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">level</span><span class="p">)(</span><span class="n">message</span><span class="p">)</span>
</span><span id="Interactor-194"><a href="#Interactor-194"><span class="linenos"> 194</span></a>
</span><span id="Interactor-195"><a href="#Interactor-195"><span class="linenos"> 195</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_client</span><span class="p">(</span>
</span><span id="Interactor-196"><a href="#Interactor-196"><span class="linenos"> 196</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor-197"><a href="#Interactor-197"><span class="linenos"> 197</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-198"><a href="#Interactor-198"><span class="linenos"> 198</span></a>        <span class="n">base_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-199"><a href="#Interactor-199"><span class="linenos"> 199</span></a>        <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-200"><a href="#Interactor-200"><span class="linenos"> 200</span></a>    <span class="p">):</span>
</span><span id="Interactor-201"><a href="#Interactor-201"><span class="linenos"> 201</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize or reconfigure the Interactor for the given model and SDK.</span>
</span><span id="Interactor-202"><a href="#Interactor-202"><span class="linenos"> 202</span></a>
</span><span id="Interactor-203"><a href="#Interactor-203"><span class="linenos"> 203</span></a><span class="sd">        Ensures idempotent setup, assigns SDK-specific clients and tool handling logic,</span>
</span><span id="Interactor-204"><a href="#Interactor-204"><span class="linenos"> 204</span></a><span class="sd">        and normalizes history to match the provider-specific message schema.</span>
</span><span id="Interactor-205"><a href="#Interactor-205"><span class="linenos"> 205</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-206"><a href="#Interactor-206"><span class="linenos"> 206</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span>
</span><span id="Interactor-207"><a href="#Interactor-207"><span class="linenos"> 207</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be specified as &#39;provider:model_name&#39;&quot;</span><span class="p">)</span>
</span><span id="Interactor-208"><a href="#Interactor-208"><span class="linenos"> 208</span></a>
</span><span id="Interactor-209"><a href="#Interactor-209"><span class="linenos"> 209</span></a>        <span class="n">provider</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Interactor-210"><a href="#Interactor-210"><span class="linenos"> 210</span></a>
</span><span id="Interactor-211"><a href="#Interactor-211"><span class="linenos"> 211</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;session_history&quot;</span><span class="p">):</span>
</span><span id="Interactor-212"><a href="#Interactor-212"><span class="linenos"> 212</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-213"><a href="#Interactor-213"><span class="linenos"> 213</span></a>
</span><span id="Interactor-214"><a href="#Interactor-214"><span class="linenos"> 214</span></a>        <span class="c1"># Skip setup if nothing has changed (client may not yet exist on first call)</span>
</span><span id="Interactor-215"><a href="#Interactor-215"><span class="linenos"> 215</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="Interactor-216"><a href="#Interactor-216"><span class="linenos"> 216</span></a>            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;client&quot;</span><span class="p">)</span>
</span><span id="Interactor-217"><a href="#Interactor-217"><span class="linenos"> 217</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span>
</span><span id="Interactor-218"><a href="#Interactor-218"><span class="linenos"> 218</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="n">provider</span>
</span><span id="Interactor-219"><a href="#Interactor-219"><span class="linenos"> 219</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">model_name</span>
</span><span id="Interactor-220"><a href="#Interactor-220"><span class="linenos"> 220</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">==</span> <span class="p">(</span><span class="n">base_url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
</span><span id="Interactor-221"><a href="#Interactor-221"><span class="linenos"> 221</span></a>        <span class="p">):</span>
</span><span id="Interactor-222"><a href="#Interactor-222"><span class="linenos"> 222</span></a>            <span class="k">return</span>
</span><span id="Interactor-223"><a href="#Interactor-223"><span class="linenos"> 223</span></a>
</span><span id="Interactor-224"><a href="#Interactor-224"><span class="linenos"> 224</span></a>        <span class="k">if</span> <span class="n">provider</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="p">:</span>
</span><span id="Interactor-225"><a href="#Interactor-225"><span class="linenos"> 225</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported provider: </span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s2">. Supported: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-226"><a href="#Interactor-226"><span class="linenos"> 226</span></a>
</span><span id="Interactor-227"><a href="#Interactor-227"><span class="linenos"> 227</span></a>        <span class="c1"># Load provider configuration</span>
</span><span id="Interactor-228"><a href="#Interactor-228"><span class="linenos"> 228</span></a>        <span class="n">provider_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="p">[</span><span class="n">provider</span><span class="p">]</span>
</span><span id="Interactor-229"><a href="#Interactor-229"><span class="linenos"> 229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">=</span> <span class="n">provider_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sdk&quot;</span><span class="p">,</span> <span class="s2">&quot;openai&quot;</span><span class="p">)</span>
</span><span id="Interactor-230"><a href="#Interactor-230"><span class="linenos"> 230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>
</span><span id="Interactor-231"><a href="#Interactor-231"><span class="linenos"> 231</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_name</span>
</span><span id="Interactor-232"><a href="#Interactor-232"><span class="linenos"> 232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="ow">or</span> <span class="n">provider_config</span><span class="p">[</span><span class="s2">&quot;base_url&quot;</span><span class="p">]</span>
</span><span id="Interactor-233"><a href="#Interactor-233"><span class="linenos"> 233</span></a>        <span class="n">effective_api_key</span> <span class="o">=</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">provider_config</span><span class="p">[</span><span class="s2">&quot;api_key&quot;</span><span class="p">]</span>
</span><span id="Interactor-234"><a href="#Interactor-234"><span class="linenos"> 234</span></a>
</span><span id="Interactor-235"><a href="#Interactor-235"><span class="linenos"> 235</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">effective_api_key</span> <span class="ow">and</span> <span class="n">provider</span> <span class="o">!=</span> <span class="s2">&quot;ollama&quot;</span><span class="p">:</span>
</span><span id="Interactor-236"><a href="#Interactor-236"><span class="linenos"> 236</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API key not provided and not found in environment for </span><span class="si">{</span><span class="n">provider</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">_API_KEY&quot;</span><span class="p">)</span>
</span><span id="Interactor-237"><a href="#Interactor-237"><span class="linenos"> 237</span></a>
</span><span id="Interactor-238"><a href="#Interactor-238"><span class="linenos"> 238</span></a>        <span class="c1"># SDK-specific configuration</span>
</span><span id="Interactor-239"><a href="#Interactor-239"><span class="linenos"> 239</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
</span><span id="Interactor-240"><a href="#Interactor-240"><span class="linenos"> 240</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">effective_api_key</span><span class="p">)</span>
</span><span id="Interactor-241"><a href="#Interactor-241"><span class="linenos"> 241</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">async_client</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">AsyncOpenAI</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">effective_api_key</span><span class="p">)</span>
</span><span id="Interactor-242"><a href="#Interactor-242"><span class="linenos"> 242</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sdk_runner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openai_runner</span>
</span><span id="Interactor-243"><a href="#Interactor-243"><span class="linenos"> 243</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tool_key</span> <span class="o">=</span> <span class="s2">&quot;tool_call_id&quot;</span>
</span><span id="Interactor-244"><a href="#Interactor-244"><span class="linenos"> 244</span></a>
</span><span id="Interactor-245"><a href="#Interactor-245"><span class="linenos"> 245</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;anthropic&quot;</span><span class="p">:</span>
</span><span id="Interactor-246"><a href="#Interactor-246"><span class="linenos"> 246</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">anthropic</span><span class="o">.</span><span class="n">Anthropic</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">effective_api_key</span><span class="p">)</span>
</span><span id="Interactor-247"><a href="#Interactor-247"><span class="linenos"> 247</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">async_client</span> <span class="o">=</span> <span class="n">anthropic</span><span class="o">.</span><span class="n">AsyncAnthropic</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">effective_api_key</span><span class="p">)</span>
</span><span id="Interactor-248"><a href="#Interactor-248"><span class="linenos"> 248</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sdk_runner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anthropic_runner</span>
</span><span id="Interactor-249"><a href="#Interactor-249"><span class="linenos"> 249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tool_key</span> <span class="o">=</span> <span class="s2">&quot;tool_use_id&quot;</span>
</span><span id="Interactor-250"><a href="#Interactor-250"><span class="linenos"> 250</span></a>
</span><span id="Interactor-251"><a href="#Interactor-251"><span class="linenos"> 251</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-252"><a href="#Interactor-252"><span class="linenos"> 252</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported SDK type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sdk</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-253"><a href="#Interactor-253"><span class="linenos"> 253</span></a>
</span><span id="Interactor-254"><a href="#Interactor-254"><span class="linenos"> 254</span></a>        <span class="c1"># Determine tool support</span>
</span><span id="Interactor-255"><a href="#Interactor-255"><span class="linenos"> 255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tools_supported</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_tool_support</span><span class="p">()</span>
</span><span id="Interactor-256"><a href="#Interactor-256"><span class="linenos"> 256</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_supported</span><span class="p">:</span>
</span><span id="Interactor-257"><a href="#Interactor-257"><span class="linenos"> 257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool calling not supported for </span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-258"><a href="#Interactor-258"><span class="linenos"> 258</span></a>
</span><span id="Interactor-259"><a href="#Interactor-259"><span class="linenos"> 259</span></a>        <span class="c1"># Normalize session history to match SDK after any provider/model change</span>
</span><span id="Interactor-260"><a href="#Interactor-260"><span class="linenos"> 260</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Interactor-261"><a href="#Interactor-261"><span class="linenos"> 261</span></a>
</span><span id="Interactor-262"><a href="#Interactor-262"><span class="linenos"> 262</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MODEL] Switched to </span><span class="si">{</span><span class="n">provider</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-263"><a href="#Interactor-263"><span class="linenos"> 263</span></a>
</span><span id="Interactor-264"><a href="#Interactor-264"><span class="linenos"> 264</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_tool_support</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Interactor-265"><a href="#Interactor-265"><span class="linenos"> 265</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if the current model supports tool calling.</span>
</span><span id="Interactor-266"><a href="#Interactor-266"><span class="linenos"> 266</span></a>
</span><span id="Interactor-267"><a href="#Interactor-267"><span class="linenos"> 267</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-268"><a href="#Interactor-268"><span class="linenos"> 268</span></a><span class="sd">            bool: True if tools are supported for the active provider/model, False otherwise.</span>
</span><span id="Interactor-269"><a href="#Interactor-269"><span class="linenos"> 269</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-270"><a href="#Interactor-270"><span class="linenos"> 270</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-271"><a href="#Interactor-271"><span class="linenos"> 271</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
</span><span id="Interactor-272"><a href="#Interactor-272"><span class="linenos"> 272</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="Interactor-273"><a href="#Interactor-273"><span class="linenos"> 273</span></a>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="Interactor-274"><a href="#Interactor-274"><span class="linenos"> 274</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Test tool support.&quot;</span><span class="p">}],</span>
</span><span id="Interactor-275"><a href="#Interactor-275"><span class="linenos"> 275</span></a>                    <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-276"><a href="#Interactor-276"><span class="linenos"> 276</span></a>                    <span class="n">tools</span><span class="o">=</span><span class="p">[{</span>
</span><span id="Interactor-277"><a href="#Interactor-277"><span class="linenos"> 277</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="Interactor-278"><a href="#Interactor-278"><span class="linenos"> 278</span></a>                        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-279"><a href="#Interactor-279"><span class="linenos"> 279</span></a>                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test_tool&quot;</span><span class="p">,</span>
</span><span id="Interactor-280"><a href="#Interactor-280"><span class="linenos"> 280</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Check tool support&quot;</span><span class="p">,</span>
</span><span id="Interactor-281"><a href="#Interactor-281"><span class="linenos"> 281</span></a>                            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-282"><a href="#Interactor-282"><span class="linenos"> 282</span></a>                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="Interactor-283"><a href="#Interactor-283"><span class="linenos"> 283</span></a>                                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-284"><a href="#Interactor-284"><span class="linenos"> 284</span></a>                                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
</span><span id="Interactor-285"><a href="#Interactor-285"><span class="linenos"> 285</span></a>                                <span class="p">},</span>
</span><span id="Interactor-286"><a href="#Interactor-286"><span class="linenos"> 286</span></a>                                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span>
</span><span id="Interactor-287"><a href="#Interactor-287"><span class="linenos"> 287</span></a>                            <span class="p">}</span>
</span><span id="Interactor-288"><a href="#Interactor-288"><span class="linenos"> 288</span></a>                        <span class="p">}</span>
</span><span id="Interactor-289"><a href="#Interactor-289"><span class="linenos"> 289</span></a>                    <span class="p">}],</span>
</span><span id="Interactor-290"><a href="#Interactor-290"><span class="linenos"> 290</span></a>                    <span class="n">tool_choice</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span>
</span><span id="Interactor-291"><a href="#Interactor-291"><span class="linenos"> 291</span></a>                <span class="p">)</span>
</span><span id="Interactor-292"><a href="#Interactor-292"><span class="linenos"> 292</span></a>                <span class="n">message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
</span><span id="Interactor-293"><a href="#Interactor-293"><span class="linenos"> 293</span></a>                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="Interactor-294"><a href="#Interactor-294"><span class="linenos"> 294</span></a>
</span><span id="Interactor-295"><a href="#Interactor-295"><span class="linenos"> 295</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;anthropic&quot;</span><span class="p">:</span>
</span><span id="Interactor-296"><a href="#Interactor-296"><span class="linenos"> 296</span></a>                <span class="c1"># For Claude models, we pre-define support based on model ID</span>
</span><span id="Interactor-297"><a href="#Interactor-297"><span class="linenos"> 297</span></a>                <span class="c1"># Known tool-supporting Claude models</span>
</span><span id="Interactor-298"><a href="#Interactor-298"><span class="linenos"> 298</span></a>                <span class="n">claude_tool_models</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;claude-3-opus&quot;</span><span class="p">,</span> <span class="s2">&quot;claude-3-sonnet&quot;</span><span class="p">,</span> <span class="s2">&quot;claude-3-haiku&quot;</span><span class="p">,</span>
</span><span id="Interactor-299"><a href="#Interactor-299"><span class="linenos"> 299</span></a>                                      <span class="s2">&quot;claude-3.5-sonnet&quot;</span><span class="p">,</span> <span class="s2">&quot;claude-3.7-sonnet&quot;</span><span class="p">]</span>
</span><span id="Interactor-300"><a href="#Interactor-300"><span class="linenos"> 300</span></a>
</span><span id="Interactor-301"><a href="#Interactor-301"><span class="linenos"> 301</span></a>                <span class="c1"># Check if the current model supports tools</span>
</span><span id="Interactor-302"><a href="#Interactor-302"><span class="linenos"> 302</span></a>                <span class="k">for</span> <span class="n">supported_model</span> <span class="ow">in</span> <span class="n">claude_tool_models</span><span class="p">:</span>
</span><span id="Interactor-303"><a href="#Interactor-303"><span class="linenos"> 303</span></a>                    <span class="k">if</span> <span class="n">supported_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="Interactor-304"><a href="#Interactor-304"><span class="linenos"> 304</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOOLS] Anthropic model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2"> is known to support tools&quot;</span><span class="p">)</span>
</span><span id="Interactor-305"><a href="#Interactor-305"><span class="linenos"> 305</span></a>                        <span class="k">return</span> <span class="kc">True</span>
</span><span id="Interactor-306"><a href="#Interactor-306"><span class="linenos"> 306</span></a>
</span><span id="Interactor-307"><a href="#Interactor-307"><span class="linenos"> 307</span></a>                <span class="c1"># If not explicitly supported, try to test</span>
</span><span id="Interactor-308"><a href="#Interactor-308"><span class="linenos"> 308</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-309"><a href="#Interactor-309"><span class="linenos"> 309</span></a>                    <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="Interactor-310"><a href="#Interactor-310"><span class="linenos"> 310</span></a>                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="Interactor-311"><a href="#Interactor-311"><span class="linenos"> 311</span></a>                        <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;What&#39;s the weather?&quot;</span><span class="p">}],</span>
</span><span id="Interactor-312"><a href="#Interactor-312"><span class="linenos"> 312</span></a>                        <span class="n">tools</span><span class="o">=</span><span class="p">[{</span>
</span><span id="Interactor-313"><a href="#Interactor-313"><span class="linenos"> 313</span></a>                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test_tool&quot;</span><span class="p">,</span>
</span><span id="Interactor-314"><a href="#Interactor-314"><span class="linenos"> 314</span></a>                            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Check tool support&quot;</span><span class="p">,</span>
</span><span id="Interactor-315"><a href="#Interactor-315"><span class="linenos"> 315</span></a>                            <span class="s2">&quot;input_schema&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-316"><a href="#Interactor-316"><span class="linenos"> 316</span></a>                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="Interactor-317"><a href="#Interactor-317"><span class="linenos"> 317</span></a>                                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-318"><a href="#Interactor-318"><span class="linenos"> 318</span></a>                                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
</span><span id="Interactor-319"><a href="#Interactor-319"><span class="linenos"> 319</span></a>                                <span class="p">},</span>
</span><span id="Interactor-320"><a href="#Interactor-320"><span class="linenos"> 320</span></a>                                <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span>
</span><span id="Interactor-321"><a href="#Interactor-321"><span class="linenos"> 321</span></a>                            <span class="p">}</span>
</span><span id="Interactor-322"><a href="#Interactor-322"><span class="linenos"> 322</span></a>                        <span class="p">}],</span>
</span><span id="Interactor-323"><a href="#Interactor-323"><span class="linenos"> 323</span></a>                        <span class="n">max_tokens</span><span class="o">=</span><span class="mi">10</span>
</span><span id="Interactor-324"><a href="#Interactor-324"><span class="linenos"> 324</span></a>                    <span class="p">)</span>
</span><span id="Interactor-325"><a href="#Interactor-325"><span class="linenos"> 325</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="Interactor-326"><a href="#Interactor-326"><span class="linenos"> 326</span></a>                <span class="k">except</span> <span class="n">anthropic</span><span class="o">.</span><span class="n">BadRequestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-327"><a href="#Interactor-327"><span class="linenos"> 327</span></a>                    <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Interactor-328"><a href="#Interactor-328"><span class="linenos"> 328</span></a>                    <span class="k">if</span> <span class="s2">&quot;tool&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span> <span class="ow">and</span> <span class="s2">&quot;not supported&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
</span><span id="Interactor-329"><a href="#Interactor-329"><span class="linenos"> 329</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOOLS] Anthropic model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2"> does not support tools: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-330"><a href="#Interactor-330"><span class="linenos"> 330</span></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Interactor-331"><a href="#Interactor-331"><span class="linenos"> 331</span></a>                    <span class="k">if</span> <span class="s2">&quot;not a supported tool field&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
</span><span id="Interactor-332"><a href="#Interactor-332"><span class="linenos"> 332</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOOLS] Anthropic API rejected tool format: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-333"><a href="#Interactor-333"><span class="linenos"> 333</span></a>                        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Interactor-334"><a href="#Interactor-334"><span class="linenos"> 334</span></a>                    <span class="k">raise</span>
</span><span id="Interactor-335"><a href="#Interactor-335"><span class="linenos"> 335</span></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-336"><a href="#Interactor-336"><span class="linenos"> 336</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOOLS] Unexpected error testing tool support: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="Interactor-337"><a href="#Interactor-337"><span class="linenos"> 337</span></a>                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="Interactor-338"><a href="#Interactor-338"><span class="linenos"> 338</span></a>
</span><span id="Interactor-339"><a href="#Interactor-339"><span class="linenos"> 339</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-340"><a href="#Interactor-340"><span class="linenos"> 340</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool support check not implemented for SDK &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sdk</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="Interactor-341"><a href="#Interactor-341"><span class="linenos"> 341</span></a>                <span class="k">return</span> <span class="kc">False</span>
</span><span id="Interactor-342"><a href="#Interactor-342"><span class="linenos"> 342</span></a>
</span><span id="Interactor-343"><a href="#Interactor-343"><span class="linenos"> 343</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-344"><a href="#Interactor-344"><span class="linenos"> 344</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool support check failed for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2"> — </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-345"><a href="#Interactor-345"><span class="linenos"> 345</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="Interactor-346"><a href="#Interactor-346"><span class="linenos"> 346</span></a>
</span><span id="Interactor-347"><a href="#Interactor-347"><span class="linenos"> 347</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_function</span><span class="p">(</span>
</span><span id="Interactor-348"><a href="#Interactor-348"><span class="linenos"> 348</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor-349"><a href="#Interactor-349"><span class="linenos"> 349</span></a>        <span class="n">external_callable</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
</span><span id="Interactor-350"><a href="#Interactor-350"><span class="linenos"> 350</span></a>        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-351"><a href="#Interactor-351"><span class="linenos"> 351</span></a>        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-352"><a href="#Interactor-352"><span class="linenos"> 352</span></a>        <span class="n">override</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-353"><a href="#Interactor-353"><span class="linenos"> 353</span></a>        <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-354"><a href="#Interactor-354"><span class="linenos"> 354</span></a>        <span class="n">schema_extensions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-355"><a href="#Interactor-355"><span class="linenos"> 355</span></a>    <span class="p">):</span>
</span><span id="Interactor-356"><a href="#Interactor-356"><span class="linenos"> 356</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor-357"><a href="#Interactor-357"><span class="linenos"> 357</span></a><span class="sd">        Register a function for LLM tool calling with full type hints and metadata.</span>
</span><span id="Interactor-358"><a href="#Interactor-358"><span class="linenos"> 358</span></a>
</span><span id="Interactor-359"><a href="#Interactor-359"><span class="linenos"> 359</span></a><span class="sd">        Args:</span>
</span><span id="Interactor-360"><a href="#Interactor-360"><span class="linenos"> 360</span></a><span class="sd">            external_callable (Callable): The function to register.</span>
</span><span id="Interactor-361"><a href="#Interactor-361"><span class="linenos"> 361</span></a><span class="sd">            name (Optional[str]): Optional custom name. Defaults to function&#39;s __name__.</span>
</span><span id="Interactor-362"><a href="#Interactor-362"><span class="linenos"> 362</span></a><span class="sd">            description (Optional[str]): Optional custom description. Defaults to first line of docstring.</span>
</span><span id="Interactor-363"><a href="#Interactor-363"><span class="linenos"> 363</span></a><span class="sd">            override (bool): If True, replaces an existing tool with the same name.</span>
</span><span id="Interactor-364"><a href="#Interactor-364"><span class="linenos"> 364</span></a><span class="sd">            disabled (bool): If True, registers the function in a disabled state.</span>
</span><span id="Interactor-365"><a href="#Interactor-365"><span class="linenos"> 365</span></a><span class="sd">            schema_extensions (Optional[Dict[str, Any]]): Optional dictionary mapping parameter names to </span>
</span><span id="Interactor-366"><a href="#Interactor-366"><span class="linenos"> 366</span></a><span class="sd">                schema extensions that override or add to the auto-generated schema.</span>
</span><span id="Interactor-367"><a href="#Interactor-367"><span class="linenos"> 367</span></a>
</span><span id="Interactor-368"><a href="#Interactor-368"><span class="linenos"> 368</span></a><span class="sd">        Raises:</span>
</span><span id="Interactor-369"><a href="#Interactor-369"><span class="linenos"> 369</span></a><span class="sd">            ValueError: If the callable is invalid or duplicate name found without override.</span>
</span><span id="Interactor-370"><a href="#Interactor-370"><span class="linenos"> 370</span></a>
</span><span id="Interactor-371"><a href="#Interactor-371"><span class="linenos"> 371</span></a><span class="sd">        Example:</span>
</span><span id="Interactor-372"><a href="#Interactor-372"><span class="linenos"> 372</span></a><span class="sd">            interactor.add_function(</span>
</span><span id="Interactor-373"><a href="#Interactor-373"><span class="linenos"> 373</span></a><span class="sd">                my_tool, </span>
</span><span id="Interactor-374"><a href="#Interactor-374"><span class="linenos"> 374</span></a><span class="sd">                override=True, </span>
</span><span id="Interactor-375"><a href="#Interactor-375"><span class="linenos"> 375</span></a><span class="sd">                disabled=False,</span>
</span><span id="Interactor-376"><a href="#Interactor-376"><span class="linenos"> 376</span></a><span class="sd">                schema_extensions={</span>
</span><span id="Interactor-377"><a href="#Interactor-377"><span class="linenos"> 377</span></a><span class="sd">                    &quot;param1&quot;: {&quot;minimum&quot;: 0, &quot;maximum&quot;: 100},</span>
</span><span id="Interactor-378"><a href="#Interactor-378"><span class="linenos"> 378</span></a><span class="sd">                    &quot;param2&quot;: {&quot;format&quot;: &quot;email&quot;}</span>
</span><span id="Interactor-379"><a href="#Interactor-379"><span class="linenos"> 379</span></a><span class="sd">                }</span>
</span><span id="Interactor-380"><a href="#Interactor-380"><span class="linenos"> 380</span></a><span class="sd">            )</span>
</span><span id="Interactor-381"><a href="#Interactor-381"><span class="linenos"> 381</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-382"><a href="#Interactor-382"><span class="linenos"> 382</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_python_type_to_schema</span><span class="p">(</span><span class="n">ptype</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="Interactor-383"><a href="#Interactor-383"><span class="linenos"> 383</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Convert a Python type annotation to OpenAI-compatible JSON Schema.&quot;&quot;&quot;</span>
</span><span id="Interactor-384"><a href="#Interactor-384"><span class="linenos"> 384</span></a>            <span class="c1"># Handle None case</span>
</span><span id="Interactor-385"><a href="#Interactor-385"><span class="linenos"> 385</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Interactor-386"><a href="#Interactor-386"><span class="linenos"> 386</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;null&quot;</span><span class="p">}</span>
</span><span id="Interactor-387"><a href="#Interactor-387"><span class="linenos"> 387</span></a>            
</span><span id="Interactor-388"><a href="#Interactor-388"><span class="linenos"> 388</span></a>            <span class="c1"># Get the origin and arguments of the type</span>
</span><span id="Interactor-389"><a href="#Interactor-389"><span class="linenos"> 389</span></a>            <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
</span><span id="Interactor-390"><a href="#Interactor-390"><span class="linenos"> 390</span></a>            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
</span><span id="Interactor-391"><a href="#Interactor-391"><span class="linenos"> 391</span></a>            
</span><span id="Interactor-392"><a href="#Interactor-392"><span class="linenos"> 392</span></a>            <span class="c1"># Handle Union types (including Optional)</span>
</span><span id="Interactor-393"><a href="#Interactor-393"><span class="linenos"> 393</span></a>            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Union</span><span class="p">:</span>
</span><span id="Interactor-394"><a href="#Interactor-394"><span class="linenos"> 394</span></a>                <span class="c1"># Check for Optional (Union with None)</span>
</span><span id="Interactor-395"><a href="#Interactor-395"><span class="linenos"> 395</span></a>                <span class="n">none_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-396"><a href="#Interactor-396"><span class="linenos"> 396</span></a>                <span class="k">if</span> <span class="n">none_type</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
</span><span id="Interactor-397"><a href="#Interactor-397"><span class="linenos"> 397</span></a>                    <span class="n">non_none</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">none_type</span><span class="p">]</span>
</span><span id="Interactor-398"><a href="#Interactor-398"><span class="linenos"> 398</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_none</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Interactor-399"><a href="#Interactor-399"><span class="linenos"> 399</span></a>                        <span class="n">inner</span> <span class="o">=</span> <span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">non_none</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Interactor-400"><a href="#Interactor-400"><span class="linenos"> 400</span></a>                        <span class="n">inner_copy</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Interactor-401"><a href="#Interactor-401"><span class="linenos"> 401</span></a>                        <span class="n">inner_copy</span><span class="p">[</span><span class="s2">&quot;nullable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor-402"><a href="#Interactor-402"><span class="linenos"> 402</span></a>                        <span class="k">return</span> <span class="n">inner_copy</span>
</span><span id="Interactor-403"><a href="#Interactor-403"><span class="linenos"> 403</span></a>                    <span class="c1"># Multiple types excluding None</span>
</span><span id="Interactor-404"><a href="#Interactor-404"><span class="linenos"> 404</span></a>                    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">non_none</span><span class="p">]</span>
</span><span id="Interactor-405"><a href="#Interactor-405"><span class="linenos"> 405</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;anyOf&quot;</span><span class="p">:</span> <span class="n">types</span><span class="p">,</span> <span class="s2">&quot;nullable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span><span id="Interactor-406"><a href="#Interactor-406"><span class="linenos"> 406</span></a>                <span class="c1"># Regular Union without None</span>
</span><span id="Interactor-407"><a href="#Interactor-407"><span class="linenos"> 407</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;anyOf&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]}</span>
</span><span id="Interactor-408"><a href="#Interactor-408"><span class="linenos"> 408</span></a>            
</span><span id="Interactor-409"><a href="#Interactor-409"><span class="linenos"> 409</span></a>            <span class="c1"># Handle List and similar container types</span>
</span><span id="Interactor-410"><a href="#Interactor-410"><span class="linenos"> 410</span></a>            <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
</span><span id="Interactor-411"><a href="#Interactor-411"><span class="linenos"> 411</span></a>                <span class="n">item_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="n">Any</span>
</span><span id="Interactor-412"><a href="#Interactor-412"><span class="linenos"> 412</span></a>                <span class="k">if</span> <span class="n">item_type</span> <span class="ow">is</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="Interactor-413"><a href="#Interactor-413"><span class="linenos"> 413</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">}</span>
</span><span id="Interactor-414"><a href="#Interactor-414"><span class="linenos"> 414</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">item_type</span><span class="p">)}</span>
</span><span id="Interactor-415"><a href="#Interactor-415"><span class="linenos"> 415</span></a>            
</span><span id="Interactor-416"><a href="#Interactor-416"><span class="linenos"> 416</span></a>            <span class="c1"># Handle Dict types with typing info</span>
</span><span id="Interactor-417"><a href="#Interactor-417"><span class="linenos"> 417</span></a>            <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
</span><span id="Interactor-418"><a href="#Interactor-418"><span class="linenos"> 418</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Interactor-419"><a href="#Interactor-419"><span class="linenos"> 419</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>
</span><span id="Interactor-420"><a href="#Interactor-420"><span class="linenos"> 420</span></a>                
</span><span id="Interactor-421"><a href="#Interactor-421"><span class="linenos"> 421</span></a>                <span class="n">key_type</span><span class="p">,</span> <span class="n">val_type</span> <span class="o">=</span> <span class="n">args</span>
</span><span id="Interactor-422"><a href="#Interactor-422"><span class="linenos"> 422</span></a>                <span class="c1"># We can only really use val_type in JSON Schema</span>
</span><span id="Interactor-423"><a href="#Interactor-423"><span class="linenos"> 423</span></a>                <span class="k">if</span> <span class="n">val_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Any</span> <span class="ow">and</span> <span class="n">val_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">object</span><span class="p">:</span>
</span><span id="Interactor-424"><a href="#Interactor-424"><span class="linenos"> 424</span></a>                    <span class="k">return</span> <span class="p">{</span>
</span><span id="Interactor-425"><a href="#Interactor-425"><span class="linenos"> 425</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="Interactor-426"><a href="#Interactor-426"><span class="linenos"> 426</span></a>                        <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">val_type</span><span class="p">)</span>
</span><span id="Interactor-427"><a href="#Interactor-427"><span class="linenos"> 427</span></a>                    <span class="p">}</span>
</span><span id="Interactor-428"><a href="#Interactor-428"><span class="linenos"> 428</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>
</span><span id="Interactor-429"><a href="#Interactor-429"><span class="linenos"> 429</span></a>            
</span><span id="Interactor-430"><a href="#Interactor-430"><span class="linenos"> 430</span></a>            <span class="c1"># Handle Literal types for enums</span>
</span><span id="Interactor-431"><a href="#Interactor-431"><span class="linenos"> 431</span></a>            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Literal</span><span class="p">:</span>
</span><span id="Interactor-432"><a href="#Interactor-432"><span class="linenos"> 432</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="n">args</span>
</span><span id="Interactor-433"><a href="#Interactor-433"><span class="linenos"> 433</span></a>                <span class="c1"># Try to determine type from values</span>
</span><span id="Interactor-434"><a href="#Interactor-434"><span class="linenos"> 434</span></a>                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">):</span>
</span><span id="Interactor-435"><a href="#Interactor-435"><span class="linenos"> 435</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)}</span>
</span><span id="Interactor-436"><a href="#Interactor-436"><span class="linenos"> 436</span></a>                <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">):</span>
</span><span id="Interactor-437"><a href="#Interactor-437"><span class="linenos"> 437</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)}</span>
</span><span id="Interactor-438"><a href="#Interactor-438"><span class="linenos"> 438</span></a>                <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">):</span>
</span><span id="Interactor-439"><a href="#Interactor-439"><span class="linenos"> 439</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)}</span>
</span><span id="Interactor-440"><a href="#Interactor-440"><span class="linenos"> 440</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-441"><a href="#Interactor-441"><span class="linenos"> 441</span></a>                    <span class="c1"># Mixed types, use anyOf</span>
</span><span id="Interactor-442"><a href="#Interactor-442"><span class="linenos"> 442</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;anyOf&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">_get_json_type</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span><span class="p">]}</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]}</span>
</span><span id="Interactor-443"><a href="#Interactor-443"><span class="linenos"> 443</span></a>            
</span><span id="Interactor-444"><a href="#Interactor-444"><span class="linenos"> 444</span></a>            <span class="c1"># Handle basic types</span>
</span><span id="Interactor-445"><a href="#Interactor-445"><span class="linenos"> 445</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Interactor-446"><a href="#Interactor-446"><span class="linenos"> 446</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
</span><span id="Interactor-447"><a href="#Interactor-447"><span class="linenos"> 447</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Interactor-448"><a href="#Interactor-448"><span class="linenos"> 448</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">}</span>
</span><span id="Interactor-449"><a href="#Interactor-449"><span class="linenos"> 449</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Interactor-450"><a href="#Interactor-450"><span class="linenos"> 450</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">}</span>
</span><span id="Interactor-451"><a href="#Interactor-451"><span class="linenos"> 451</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Interactor-452"><a href="#Interactor-452"><span class="linenos"> 452</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">}</span>
</span><span id="Interactor-453"><a href="#Interactor-453"><span class="linenos"> 453</span></a>            
</span><span id="Interactor-454"><a href="#Interactor-454"><span class="linenos"> 454</span></a>            <span class="c1"># Handle common datetime types</span>
</span><span id="Interactor-455"><a href="#Interactor-455"><span class="linenos"> 455</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="n">datetime</span><span class="p">:</span>
</span><span id="Interactor-456"><a href="#Interactor-456"><span class="linenos"> 456</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;date-time&quot;</span><span class="p">}</span>
</span><span id="Interactor-457"><a href="#Interactor-457"><span class="linenos"> 457</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="n">date</span><span class="p">:</span>
</span><span id="Interactor-458"><a href="#Interactor-458"><span class="linenos"> 458</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">}</span>
</span><span id="Interactor-459"><a href="#Interactor-459"><span class="linenos"> 459</span></a>            
</span><span id="Interactor-460"><a href="#Interactor-460"><span class="linenos"> 460</span></a>            <span class="c1"># Handle UUID</span>
</span><span id="Interactor-461"><a href="#Interactor-461"><span class="linenos"> 461</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">:</span>
</span><span id="Interactor-462"><a href="#Interactor-462"><span class="linenos"> 462</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;uuid&quot;</span><span class="p">}</span>
</span><span id="Interactor-463"><a href="#Interactor-463"><span class="linenos"> 463</span></a>            
</span><span id="Interactor-464"><a href="#Interactor-464"><span class="linenos"> 464</span></a>            <span class="c1"># Default to object for any other types</span>
</span><span id="Interactor-465"><a href="#Interactor-465"><span class="linenos"> 465</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>
</span><span id="Interactor-466"><a href="#Interactor-466"><span class="linenos"> 466</span></a>        
</span><span id="Interactor-467"><a href="#Interactor-467"><span class="linenos"> 467</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_get_json_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span><span id="Interactor-468"><a href="#Interactor-468"><span class="linenos"> 468</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Get the JSON Schema type name for a Python value.&quot;&quot;&quot;</span>
</span><span id="Interactor-469"><a href="#Interactor-469"><span class="linenos"> 469</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor-470"><a href="#Interactor-470"><span class="linenos"> 470</span></a>                <span class="k">return</span> <span class="s2">&quot;string&quot;</span>
</span><span id="Interactor-471"><a href="#Interactor-471"><span class="linenos"> 471</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="Interactor-472"><a href="#Interactor-472"><span class="linenos"> 472</span></a>                <span class="k">return</span> <span class="s2">&quot;boolean&quot;</span>
</span><span id="Interactor-473"><a href="#Interactor-473"><span class="linenos"> 473</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="Interactor-474"><a href="#Interactor-474"><span class="linenos"> 474</span></a>                <span class="k">return</span> <span class="s2">&quot;number&quot;</span>
</span><span id="Interactor-475"><a href="#Interactor-475"><span class="linenos"> 475</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Interactor-476"><a href="#Interactor-476"><span class="linenos"> 476</span></a>                <span class="k">return</span> <span class="s2">&quot;array&quot;</span>
</span><span id="Interactor-477"><a href="#Interactor-477"><span class="linenos"> 477</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="Interactor-478"><a href="#Interactor-478"><span class="linenos"> 478</span></a>                <span class="k">return</span> <span class="s2">&quot;object&quot;</span>
</span><span id="Interactor-479"><a href="#Interactor-479"><span class="linenos"> 479</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-480"><a href="#Interactor-480"><span class="linenos"> 480</span></a>                <span class="k">return</span> <span class="s2">&quot;object&quot;</span>  <span class="c1"># Default</span>
</span><span id="Interactor-481"><a href="#Interactor-481"><span class="linenos"> 481</span></a>        
</span><span id="Interactor-482"><a href="#Interactor-482"><span class="linenos"> 482</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_parse_param_docs</span><span class="p">(</span><span class="n">docstring</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="Interactor-483"><a href="#Interactor-483"><span class="linenos"> 483</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Extract parameter descriptions from a docstring.&quot;&quot;&quot;</span>
</span><span id="Interactor-484"><a href="#Interactor-484"><span class="linenos"> 484</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">docstring</span><span class="p">:</span>
</span><span id="Interactor-485"><a href="#Interactor-485"><span class="linenos"> 485</span></a>                <span class="k">return</span> <span class="p">{}</span>
</span><span id="Interactor-486"><a href="#Interactor-486"><span class="linenos"> 486</span></a>            
</span><span id="Interactor-487"><a href="#Interactor-487"><span class="linenos"> 487</span></a>            <span class="n">lines</span> <span class="o">=</span> <span class="n">docstring</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="Interactor-488"><a href="#Interactor-488"><span class="linenos"> 488</span></a>            <span class="n">param_docs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Interactor-489"><a href="#Interactor-489"><span class="linenos"> 489</span></a>            <span class="n">current_param</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-490"><a href="#Interactor-490"><span class="linenos"> 490</span></a>            <span class="n">in_params</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Interactor-491"><a href="#Interactor-491"><span class="linenos"> 491</span></a>            
</span><span id="Interactor-492"><a href="#Interactor-492"><span class="linenos"> 492</span></a>            <span class="c1"># Regular expressions for finding parameter sections and param lines</span>
</span><span id="Interactor-493"><a href="#Interactor-493"><span class="linenos"> 493</span></a>            <span class="n">param_section_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(Args|Parameters):\s*$&quot;</span><span class="p">)</span>
</span><span id="Interactor-494"><a href="#Interactor-494"><span class="linenos"> 494</span></a>            <span class="n">param_line_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s</span><span class="si">{4}</span><span class="s2">(\w+)\s*(?:\([^\)]*\))?:\s*(.*)&quot;</span><span class="p">)</span>
</span><span id="Interactor-495"><a href="#Interactor-495"><span class="linenos"> 495</span></a>            
</span><span id="Interactor-496"><a href="#Interactor-496"><span class="linenos"> 496</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="Interactor-497"><a href="#Interactor-497"><span class="linenos"> 497</span></a>                <span class="c1"># Check if we&#39;re entering the parameters section</span>
</span><span id="Interactor-498"><a href="#Interactor-498"><span class="linenos"> 498</span></a>                <span class="k">if</span> <span class="n">param_section_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
</span><span id="Interactor-499"><a href="#Interactor-499"><span class="linenos"> 499</span></a>                    <span class="n">in_params</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor-500"><a href="#Interactor-500"><span class="linenos"> 500</span></a>                    <span class="k">continue</span>
</span><span id="Interactor-501"><a href="#Interactor-501"><span class="linenos"> 501</span></a>                    
</span><span id="Interactor-502"><a href="#Interactor-502"><span class="linenos"> 502</span></a>                <span class="k">if</span> <span class="n">in_params</span><span class="p">:</span>
</span><span id="Interactor-503"><a href="#Interactor-503"><span class="linenos"> 503</span></a>                    <span class="c1"># Skip empty lines</span>
</span><span id="Interactor-504"><a href="#Interactor-504"><span class="linenos"> 504</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="Interactor-505"><a href="#Interactor-505"><span class="linenos"> 505</span></a>                        <span class="k">continue</span>
</span><span id="Interactor-506"><a href="#Interactor-506"><span class="linenos"> 506</span></a>                        
</span><span id="Interactor-507"><a href="#Interactor-507"><span class="linenos"> 507</span></a>                    <span class="c1"># Check for a parameter definition line</span>
</span><span id="Interactor-508"><a href="#Interactor-508"><span class="linenos"> 508</span></a>                    <span class="n">match</span> <span class="o">=</span> <span class="n">param_line_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="Interactor-509"><a href="#Interactor-509"><span class="linenos"> 509</span></a>                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
</span><span id="Interactor-510"><a href="#Interactor-510"><span class="linenos"> 510</span></a>                        <span class="n">current_param</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Interactor-511"><a href="#Interactor-511"><span class="linenos"> 511</span></a>                        <span class="n">param_docs</span><span class="p">[</span><span class="n">current_param</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="Interactor-512"><a href="#Interactor-512"><span class="linenos"> 512</span></a>                    <span class="c1"># Check for continuation of a parameter description</span>
</span><span id="Interactor-513"><a href="#Interactor-513"><span class="linenos"> 513</span></a>                    <span class="k">elif</span> <span class="n">current_param</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">):</span>
</span><span id="Interactor-514"><a href="#Interactor-514"><span class="linenos"> 514</span></a>                        <span class="n">param_docs</span><span class="p">[</span><span class="n">current_param</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="Interactor-515"><a href="#Interactor-515"><span class="linenos"> 515</span></a>                    <span class="c1"># If we see a line that doesn&#39;t match our patterns, we&#39;re out of the params section</span>
</span><span id="Interactor-516"><a href="#Interactor-516"><span class="linenos"> 516</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-517"><a href="#Interactor-517"><span class="linenos"> 517</span></a>                        <span class="n">current_param</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-518"><a href="#Interactor-518"><span class="linenos"> 518</span></a>            
</span><span id="Interactor-519"><a href="#Interactor-519"><span class="linenos"> 519</span></a>            <span class="k">return</span> <span class="n">param_docs</span>
</span><span id="Interactor-520"><a href="#Interactor-520"><span class="linenos"> 520</span></a>        
</span><span id="Interactor-521"><a href="#Interactor-521"><span class="linenos"> 521</span></a>        <span class="c1"># Start of main function logic</span>
</span><span id="Interactor-522"><a href="#Interactor-522"><span class="linenos"> 522</span></a>        
</span><span id="Interactor-523"><a href="#Interactor-523"><span class="linenos"> 523</span></a>        <span class="c1"># Skip if tools are disabled</span>
</span><span id="Interactor-524"><a href="#Interactor-524"><span class="linenos"> 524</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_enabled</span><span class="p">:</span>
</span><span id="Interactor-525"><a href="#Interactor-525"><span class="linenos"> 525</span></a>            <span class="k">return</span>
</span><span id="Interactor-526"><a href="#Interactor-526"><span class="linenos"> 526</span></a>            
</span><span id="Interactor-527"><a href="#Interactor-527"><span class="linenos"> 527</span></a>        <span class="c1"># Validate input callable</span>
</span><span id="Interactor-528"><a href="#Interactor-528"><span class="linenos"> 528</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">external_callable</span><span class="p">:</span>
</span><span id="Interactor-529"><a href="#Interactor-529"><span class="linenos"> 529</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A valid external callable must be provided.&quot;</span><span class="p">)</span>
</span><span id="Interactor-530"><a href="#Interactor-530"><span class="linenos"> 530</span></a>        
</span><span id="Interactor-531"><a href="#Interactor-531"><span class="linenos"> 531</span></a>        <span class="c1"># Set function name, either from parameter or from callable&#39;s __name__</span>
</span><span id="Interactor-532"><a href="#Interactor-532"><span class="linenos"> 532</span></a>        <span class="n">function_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">external_callable</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="Interactor-533"><a href="#Interactor-533"><span class="linenos"> 533</span></a>        
</span><span id="Interactor-534"><a href="#Interactor-534"><span class="linenos"> 534</span></a>        <span class="c1"># Try to get docstring and extract description</span>
</span><span id="Interactor-535"><a href="#Interactor-535"><span class="linenos"> 535</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-536"><a href="#Interactor-536"><span class="linenos"> 536</span></a>            <span class="n">docstring</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">external_callable</span><span class="p">)</span>
</span><span id="Interactor-537"><a href="#Interactor-537"><span class="linenos"> 537</span></a>            <span class="n">description</span> <span class="o">=</span> <span class="n">description</span> <span class="ow">or</span> <span class="p">(</span><span class="n">docstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">docstring</span> <span class="k">else</span> <span class="s2">&quot;No description provided.&quot;</span><span class="p">)</span>
</span><span id="Interactor-538"><a href="#Interactor-538"><span class="linenos"> 538</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-539"><a href="#Interactor-539"><span class="linenos"> 539</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOOL] Warning: Could not extract docstring from </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
</span><span id="Interactor-540"><a href="#Interactor-540"><span class="linenos"> 540</span></a>            <span class="n">docstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Interactor-541"><a href="#Interactor-541"><span class="linenos"> 541</span></a>            <span class="n">description</span> <span class="o">=</span> <span class="n">description</span> <span class="ow">or</span> <span class="s2">&quot;No description provided.&quot;</span>
</span><span id="Interactor-542"><a href="#Interactor-542"><span class="linenos"> 542</span></a>        
</span><span id="Interactor-543"><a href="#Interactor-543"><span class="linenos"> 543</span></a>        <span class="c1"># Extract parameter documentation from docstring</span>
</span><span id="Interactor-544"><a href="#Interactor-544"><span class="linenos"> 544</span></a>        <span class="n">param_docs</span> <span class="o">=</span> <span class="n">_parse_param_docs</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span>
</span><span id="Interactor-545"><a href="#Interactor-545"><span class="linenos"> 545</span></a>        
</span><span id="Interactor-546"><a href="#Interactor-546"><span class="linenos"> 546</span></a>        <span class="c1"># Handle conflicts with existing functions</span>
</span><span id="Interactor-547"><a href="#Interactor-547"><span class="linenos"> 547</span></a>        <span class="k">if</span> <span class="n">override</span><span class="p">:</span>
</span><span id="Interactor-548"><a href="#Interactor-548"><span class="linenos"> 548</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delete_function</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
</span><span id="Interactor-549"><a href="#Interactor-549"><span class="linenos"> 549</span></a>        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">function_name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">):</span>
</span><span id="Interactor-550"><a href="#Interactor-550"><span class="linenos"> 550</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39; is already registered. Use override=True to replace.&quot;</span><span class="p">)</span>
</span><span id="Interactor-551"><a href="#Interactor-551"><span class="linenos"> 551</span></a>        
</span><span id="Interactor-552"><a href="#Interactor-552"><span class="linenos"> 552</span></a>        <span class="c1"># Try to get function signature for parameter info</span>
</span><span id="Interactor-553"><a href="#Interactor-553"><span class="linenos"> 553</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-554"><a href="#Interactor-554"><span class="linenos"> 554</span></a>            <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">external_callable</span><span class="p">)</span>
</span><span id="Interactor-555"><a href="#Interactor-555"><span class="linenos"> 555</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-556"><a href="#Interactor-556"><span class="linenos"> 556</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot inspect callable &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-557"><a href="#Interactor-557"><span class="linenos"> 557</span></a>        
</span><span id="Interactor-558"><a href="#Interactor-558"><span class="linenos"> 558</span></a>        <span class="c1"># Process parameters to build schema</span>
</span><span id="Interactor-559"><a href="#Interactor-559"><span class="linenos"> 559</span></a>        <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Interactor-560"><a href="#Interactor-560"><span class="linenos"> 560</span></a>        <span class="n">required</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-561"><a href="#Interactor-561"><span class="linenos"> 561</span></a>        
</span><span id="Interactor-562"><a href="#Interactor-562"><span class="linenos"> 562</span></a>        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Interactor-563"><a href="#Interactor-563"><span class="linenos"> 563</span></a>            <span class="c1"># Skip self, cls parameters for instance/class methods</span>
</span><span id="Interactor-564"><a href="#Interactor-564"><span class="linenos"> 564</span></a>            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">:</span>
</span><span id="Interactor-565"><a href="#Interactor-565"><span class="linenos"> 565</span></a>                <span class="k">continue</span>
</span><span id="Interactor-566"><a href="#Interactor-566"><span class="linenos"> 566</span></a>                
</span><span id="Interactor-567"><a href="#Interactor-567"><span class="linenos"> 567</span></a>            <span class="c1"># Get parameter annotation, defaulting to Any</span>
</span><span id="Interactor-568"><a href="#Interactor-568"><span class="linenos"> 568</span></a>            <span class="n">annotation</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">Any</span>
</span><span id="Interactor-569"><a href="#Interactor-569"><span class="linenos"> 569</span></a>            
</span><span id="Interactor-570"><a href="#Interactor-570"><span class="linenos"> 570</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-571"><a href="#Interactor-571"><span class="linenos"> 571</span></a>                <span class="c1"># Convert Python type to JSON Schema</span>
</span><span id="Interactor-572"><a href="#Interactor-572"><span class="linenos"> 572</span></a>                <span class="n">schema</span> <span class="o">=</span> <span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
</span><span id="Interactor-573"><a href="#Interactor-573"><span class="linenos"> 573</span></a>                
</span><span id="Interactor-574"><a href="#Interactor-574"><span class="linenos"> 574</span></a>                <span class="c1"># Add description from docstring or create a default one</span>
</span><span id="Interactor-575"><a href="#Interactor-575"><span class="linenos"> 575</span></a>                <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_docs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> parameter&quot;</span><span class="p">)</span>
</span><span id="Interactor-576"><a href="#Interactor-576"><span class="linenos"> 576</span></a>                
</span><span id="Interactor-577"><a href="#Interactor-577"><span class="linenos"> 577</span></a>                <span class="c1"># Add to properties</span>
</span><span id="Interactor-578"><a href="#Interactor-578"><span class="linenos"> 578</span></a>                <span class="n">properties</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema</span>
</span><span id="Interactor-579"><a href="#Interactor-579"><span class="linenos"> 579</span></a>                
</span><span id="Interactor-580"><a href="#Interactor-580"><span class="linenos"> 580</span></a>                <span class="c1"># If no default, add to required list</span>
</span><span id="Interactor-581"><a href="#Interactor-581"><span class="linenos"> 581</span></a>                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="Interactor-582"><a href="#Interactor-582"><span class="linenos"> 582</span></a>                    <span class="n">required</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
</span><span id="Interactor-583"><a href="#Interactor-583"><span class="linenos"> 583</span></a>                    
</span><span id="Interactor-584"><a href="#Interactor-584"><span class="linenos"> 584</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-585"><a href="#Interactor-585"><span class="linenos"> 585</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOOL] Error processing parameter </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="Interactor-586"><a href="#Interactor-586"><span class="linenos"> 586</span></a>                <span class="c1"># Add a basic object schema as fallback</span>
</span><span id="Interactor-587"><a href="#Interactor-587"><span class="linenos"> 587</span></a>                <span class="n">properties</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-588"><a href="#Interactor-588"><span class="linenos"> 588</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="Interactor-589"><a href="#Interactor-589"><span class="linenos"> 589</span></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> parameter (type conversion failed)&quot;</span>
</span><span id="Interactor-590"><a href="#Interactor-590"><span class="linenos"> 590</span></a>                <span class="p">}</span>
</span><span id="Interactor-591"><a href="#Interactor-591"><span class="linenos"> 591</span></a>        
</span><span id="Interactor-592"><a href="#Interactor-592"><span class="linenos"> 592</span></a>        <span class="c1"># Apply schema extensions if provided</span>
</span><span id="Interactor-593"><a href="#Interactor-593"><span class="linenos"> 593</span></a>        <span class="k">if</span> <span class="n">schema_extensions</span><span class="p">:</span>
</span><span id="Interactor-594"><a href="#Interactor-594"><span class="linenos"> 594</span></a>            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">extensions</span> <span class="ow">in</span> <span class="n">schema_extensions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Interactor-595"><a href="#Interactor-595"><span class="linenos"> 595</span></a>                <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
</span><span id="Interactor-596"><a href="#Interactor-596"><span class="linenos"> 596</span></a>                    <span class="n">properties</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
</span><span id="Interactor-597"><a href="#Interactor-597"><span class="linenos"> 597</span></a>        
</span><span id="Interactor-598"><a href="#Interactor-598"><span class="linenos"> 598</span></a>        <span class="c1"># Build the final tool specification</span>
</span><span id="Interactor-599"><a href="#Interactor-599"><span class="linenos"> 599</span></a>        <span class="n">tool_spec</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-600"><a href="#Interactor-600"><span class="linenos"> 600</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="Interactor-601"><a href="#Interactor-601"><span class="linenos"> 601</span></a>            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-602"><a href="#Interactor-602"><span class="linenos"> 602</span></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">function_name</span><span class="p">,</span>
</span><span id="Interactor-603"><a href="#Interactor-603"><span class="linenos"> 603</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
</span><span id="Interactor-604"><a href="#Interactor-604"><span class="linenos"> 604</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-605"><a href="#Interactor-605"><span class="linenos"> 605</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="Interactor-606"><a href="#Interactor-606"><span class="linenos"> 606</span></a>                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span><span class="p">,</span>
</span><span id="Interactor-607"><a href="#Interactor-607"><span class="linenos"> 607</span></a>                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="n">required</span>
</span><span id="Interactor-608"><a href="#Interactor-608"><span class="linenos"> 608</span></a>                <span class="p">}</span>
</span><span id="Interactor-609"><a href="#Interactor-609"><span class="linenos"> 609</span></a>            <span class="p">}</span>
</span><span id="Interactor-610"><a href="#Interactor-610"><span class="linenos"> 610</span></a>        <span class="p">}</span>
</span><span id="Interactor-611"><a href="#Interactor-611"><span class="linenos"> 611</span></a>        
</span><span id="Interactor-612"><a href="#Interactor-612"><span class="linenos"> 612</span></a>        <span class="c1"># Set disabled flag if requested</span>
</span><span id="Interactor-613"><a href="#Interactor-613"><span class="linenos"> 613</span></a>        <span class="k">if</span> <span class="n">disabled</span><span class="p">:</span>
</span><span id="Interactor-614"><a href="#Interactor-614"><span class="linenos"> 614</span></a>            <span class="n">tool_spec</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;disabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor-615"><a href="#Interactor-615"><span class="linenos"> 615</span></a>        
</span><span id="Interactor-616"><a href="#Interactor-616"><span class="linenos"> 616</span></a>        <span class="c1"># Add to tools list</span>
</span><span id="Interactor-617"><a href="#Interactor-617"><span class="linenos"> 617</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_spec</span><span class="p">)</span>
</span><span id="Interactor-618"><a href="#Interactor-618"><span class="linenos"> 618</span></a>        
</span><span id="Interactor-619"><a href="#Interactor-619"><span class="linenos"> 619</span></a>        <span class="c1"># Make the function available as an attribute on the instance</span>
</span><span id="Interactor-620"><a href="#Interactor-620"><span class="linenos"> 620</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">external_callable</span><span class="p">)</span>
</span><span id="Interactor-621"><a href="#Interactor-621"><span class="linenos"> 621</span></a>        
</span><span id="Interactor-622"><a href="#Interactor-622"><span class="linenos"> 622</span></a>        <span class="c1"># Log the registration</span>
</span><span id="Interactor-623"><a href="#Interactor-623"><span class="linenos"> 623</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOOL] Registered function &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39; with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span><span class="si">}</span><span class="s2"> parameters&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
</span><span id="Interactor-624"><a href="#Interactor-624"><span class="linenos"> 624</span></a>        
</span><span id="Interactor-625"><a href="#Interactor-625"><span class="linenos"> 625</span></a>        <span class="k">return</span> <span class="n">function_name</span>  <span class="c1"># Return the name for reference</span>
</span><span id="Interactor-626"><a href="#Interactor-626"><span class="linenos"> 626</span></a>
</span><span id="Interactor-627"><a href="#Interactor-627"><span class="linenos"> 627</span></a>        
</span><span id="Interactor-628"><a href="#Interactor-628"><span class="linenos"> 628</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">disable_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Interactor-629"><a href="#Interactor-629"><span class="linenos"> 629</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor-630"><a href="#Interactor-630"><span class="linenos"> 630</span></a><span class="sd">        Disable a registered tool function by name.</span>
</span><span id="Interactor-631"><a href="#Interactor-631"><span class="linenos"> 631</span></a>
</span><span id="Interactor-632"><a href="#Interactor-632"><span class="linenos"> 632</span></a><span class="sd">        This marks the function as inactive for tool calling without removing it from the internal registry.</span>
</span><span id="Interactor-633"><a href="#Interactor-633"><span class="linenos"> 633</span></a><span class="sd">        The function remains visible in the tool listing but is skipped during tool selection by the LLM.</span>
</span><span id="Interactor-634"><a href="#Interactor-634"><span class="linenos"> 634</span></a>
</span><span id="Interactor-635"><a href="#Interactor-635"><span class="linenos"> 635</span></a><span class="sd">        Args:</span>
</span><span id="Interactor-636"><a href="#Interactor-636"><span class="linenos"> 636</span></a><span class="sd">            name (str): The name of the function to disable.</span>
</span><span id="Interactor-637"><a href="#Interactor-637"><span class="linenos"> 637</span></a>
</span><span id="Interactor-638"><a href="#Interactor-638"><span class="linenos"> 638</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-639"><a href="#Interactor-639"><span class="linenos"> 639</span></a><span class="sd">            bool: True if the function was found and disabled, False otherwise.</span>
</span><span id="Interactor-640"><a href="#Interactor-640"><span class="linenos"> 640</span></a>
</span><span id="Interactor-641"><a href="#Interactor-641"><span class="linenos"> 641</span></a><span class="sd">        Example:</span>
</span><span id="Interactor-642"><a href="#Interactor-642"><span class="linenos"> 642</span></a><span class="sd">            interactor.disable_function(&quot;extract_text&quot;)</span>
</span><span id="Interactor-643"><a href="#Interactor-643"><span class="linenos"> 643</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-644"><a href="#Interactor-644"><span class="linenos"> 644</span></a>        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
</span><span id="Interactor-645"><a href="#Interactor-645"><span class="linenos"> 645</span></a>            <span class="k">if</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span><span id="Interactor-646"><a href="#Interactor-646"><span class="linenos"> 646</span></a>                <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;disabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor-647"><a href="#Interactor-647"><span class="linenos"> 647</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="Interactor-648"><a href="#Interactor-648"><span class="linenos"> 648</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Interactor-649"><a href="#Interactor-649"><span class="linenos"> 649</span></a>
</span><span id="Interactor-650"><a href="#Interactor-650"><span class="linenos"> 650</span></a>
</span><span id="Interactor-651"><a href="#Interactor-651"><span class="linenos"> 651</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">enable_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Interactor-652"><a href="#Interactor-652"><span class="linenos"> 652</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor-653"><a href="#Interactor-653"><span class="linenos"> 653</span></a><span class="sd">        Re-enable a previously disabled tool function by name.</span>
</span><span id="Interactor-654"><a href="#Interactor-654"><span class="linenos"> 654</span></a>
</span><span id="Interactor-655"><a href="#Interactor-655"><span class="linenos"> 655</span></a><span class="sd">        This removes the &#39;disabled&#39; flag from a tool function, making it available again for LLM use.</span>
</span><span id="Interactor-656"><a href="#Interactor-656"><span class="linenos"> 656</span></a>
</span><span id="Interactor-657"><a href="#Interactor-657"><span class="linenos"> 657</span></a><span class="sd">        Args:</span>
</span><span id="Interactor-658"><a href="#Interactor-658"><span class="linenos"> 658</span></a><span class="sd">            name (str): The name of the function to enable.</span>
</span><span id="Interactor-659"><a href="#Interactor-659"><span class="linenos"> 659</span></a>
</span><span id="Interactor-660"><a href="#Interactor-660"><span class="linenos"> 660</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-661"><a href="#Interactor-661"><span class="linenos"> 661</span></a><span class="sd">            bool: True if the function was found and enabled, False otherwise.</span>
</span><span id="Interactor-662"><a href="#Interactor-662"><span class="linenos"> 662</span></a>
</span><span id="Interactor-663"><a href="#Interactor-663"><span class="linenos"> 663</span></a><span class="sd">        Example:</span>
</span><span id="Interactor-664"><a href="#Interactor-664"><span class="linenos"> 664</span></a><span class="sd">            interactor.enable_function(&quot;extract_text&quot;)</span>
</span><span id="Interactor-665"><a href="#Interactor-665"><span class="linenos"> 665</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-666"><a href="#Interactor-666"><span class="linenos"> 666</span></a>        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
</span><span id="Interactor-667"><a href="#Interactor-667"><span class="linenos"> 667</span></a>            <span class="k">if</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span><span id="Interactor-668"><a href="#Interactor-668"><span class="linenos"> 668</span></a>                <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-669"><a href="#Interactor-669"><span class="linenos"> 669</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="Interactor-670"><a href="#Interactor-670"><span class="linenos"> 670</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Interactor-671"><a href="#Interactor-671"><span class="linenos"> 671</span></a>
</span><span id="Interactor-672"><a href="#Interactor-672"><span class="linenos"> 672</span></a>
</span><span id="Interactor-673"><a href="#Interactor-673"><span class="linenos"> 673</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Interactor-674"><a href="#Interactor-674"><span class="linenos"> 674</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor-675"><a href="#Interactor-675"><span class="linenos"> 675</span></a><span class="sd">        Permanently remove a registered tool function from the Interactor.</span>
</span><span id="Interactor-676"><a href="#Interactor-676"><span class="linenos"> 676</span></a>
</span><span id="Interactor-677"><a href="#Interactor-677"><span class="linenos"> 677</span></a><span class="sd">        This deletes both the tool metadata and the callable attribute, making it fully inaccessible</span>
</span><span id="Interactor-678"><a href="#Interactor-678"><span class="linenos"> 678</span></a><span class="sd">        from the active session. Useful for dynamically trimming the toolset.</span>
</span><span id="Interactor-679"><a href="#Interactor-679"><span class="linenos"> 679</span></a>
</span><span id="Interactor-680"><a href="#Interactor-680"><span class="linenos"> 680</span></a><span class="sd">        Args:</span>
</span><span id="Interactor-681"><a href="#Interactor-681"><span class="linenos"> 681</span></a><span class="sd">            name (str): The name of the function to delete.</span>
</span><span id="Interactor-682"><a href="#Interactor-682"><span class="linenos"> 682</span></a>
</span><span id="Interactor-683"><a href="#Interactor-683"><span class="linenos"> 683</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-684"><a href="#Interactor-684"><span class="linenos"> 684</span></a><span class="sd">            bool: True if the function was found and removed, False otherwise.</span>
</span><span id="Interactor-685"><a href="#Interactor-685"><span class="linenos"> 685</span></a>
</span><span id="Interactor-686"><a href="#Interactor-686"><span class="linenos"> 686</span></a><span class="sd">        Example:</span>
</span><span id="Interactor-687"><a href="#Interactor-687"><span class="linenos"> 687</span></a><span class="sd">            interactor.delete_function(&quot;extract_text&quot;)</span>
</span><span id="Interactor-688"><a href="#Interactor-688"><span class="linenos"> 688</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-689"><a href="#Interactor-689"><span class="linenos"> 689</span></a>        <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>
</span><span id="Interactor-690"><a href="#Interactor-690"><span class="linenos"> 690</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="k">if</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">name</span><span class="p">]</span>
</span><span id="Interactor-691"><a href="#Interactor-691"><span class="linenos"> 691</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="Interactor-692"><a href="#Interactor-692"><span class="linenos"> 692</span></a>            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="Interactor-693"><a href="#Interactor-693"><span class="linenos"> 693</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">before</span>
</span><span id="Interactor-694"><a href="#Interactor-694"><span class="linenos"> 694</span></a>
</span><span id="Interactor-695"><a href="#Interactor-695"><span class="linenos"> 695</span></a>
</span><span id="Interactor-696"><a href="#Interactor-696"><span class="linenos"> 696</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">list_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="Interactor-697"><a href="#Interactor-697"><span class="linenos"> 697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of registered functions for tool calling.</span>
</span><span id="Interactor-698"><a href="#Interactor-698"><span class="linenos"> 698</span></a>
</span><span id="Interactor-699"><a href="#Interactor-699"><span class="linenos"> 699</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-700"><a href="#Interactor-700"><span class="linenos"> 700</span></a><span class="sd">            List[Dict[str, Any]]: List of registered functions.</span>
</span><span id="Interactor-701"><a href="#Interactor-701"><span class="linenos"> 701</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-702"><a href="#Interactor-702"><span class="linenos"> 702</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span>
</span><span id="Interactor-703"><a href="#Interactor-703"><span class="linenos"> 703</span></a>
</span><span id="Interactor-704"><a href="#Interactor-704"><span class="linenos"> 704</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">list_models</span><span class="p">(</span>
</span><span id="Interactor-705"><a href="#Interactor-705"><span class="linenos"> 705</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor-706"><a href="#Interactor-706"><span class="linenos"> 706</span></a>        <span class="n">providers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-707"><a href="#Interactor-707"><span class="linenos"> 707</span></a>        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-708"><a href="#Interactor-708"><span class="linenos"> 708</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Interactor-709"><a href="#Interactor-709"><span class="linenos"> 709</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve available models from configured providers.</span>
</span><span id="Interactor-710"><a href="#Interactor-710"><span class="linenos"> 710</span></a>
</span><span id="Interactor-711"><a href="#Interactor-711"><span class="linenos"> 711</span></a><span class="sd">        Args:</span>
</span><span id="Interactor-712"><a href="#Interactor-712"><span class="linenos"> 712</span></a><span class="sd">            providers: Provider name or list of provider names. If None, all are queried.</span>
</span><span id="Interactor-713"><a href="#Interactor-713"><span class="linenos"> 713</span></a><span class="sd">            filter: Optional regex to filter model names.</span>
</span><span id="Interactor-714"><a href="#Interactor-714"><span class="linenos"> 714</span></a>
</span><span id="Interactor-715"><a href="#Interactor-715"><span class="linenos"> 715</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-716"><a href="#Interactor-716"><span class="linenos"> 716</span></a><span class="sd">            List[str]: Sorted list of &quot;provider:model_id&quot; strings.</span>
</span><span id="Interactor-717"><a href="#Interactor-717"><span class="linenos"> 717</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-718"><a href="#Interactor-718"><span class="linenos"> 718</span></a>        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-719"><a href="#Interactor-719"><span class="linenos"> 719</span></a>
</span><span id="Interactor-720"><a href="#Interactor-720"><span class="linenos"> 720</span></a>        <span class="k">if</span> <span class="n">providers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Interactor-721"><a href="#Interactor-721"><span class="linenos"> 721</span></a>            <span class="n">providers_to_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span>
</span><span id="Interactor-722"><a href="#Interactor-722"><span class="linenos"> 722</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">providers</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor-723"><a href="#Interactor-723"><span class="linenos"> 723</span></a>            <span class="n">providers_to_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">providers</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">providers</span><span class="p">)}</span>
</span><span id="Interactor-724"><a href="#Interactor-724"><span class="linenos"> 724</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">providers</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Interactor-725"><a href="#Interactor-725"><span class="linenos"> 725</span></a>            <span class="n">providers_to_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">}</span>
</span><span id="Interactor-726"><a href="#Interactor-726"><span class="linenos"> 726</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-727"><a href="#Interactor-727"><span class="linenos"> 727</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="Interactor-728"><a href="#Interactor-728"><span class="linenos"> 728</span></a>
</span><span id="Interactor-729"><a href="#Interactor-729"><span class="linenos"> 729</span></a>        <span class="n">invalid_providers</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers_to_list</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Interactor-730"><a href="#Interactor-730"><span class="linenos"> 730</span></a>        <span class="k">if</span> <span class="n">invalid_providers</span><span class="p">:</span>
</span><span id="Interactor-731"><a href="#Interactor-731"><span class="linenos"> 731</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid providers: </span><span class="si">{</span><span class="n">invalid_providers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-732"><a href="#Interactor-732"><span class="linenos"> 732</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="Interactor-733"><a href="#Interactor-733"><span class="linenos"> 733</span></a>
</span><span id="Interactor-734"><a href="#Interactor-734"><span class="linenos"> 734</span></a>        <span class="n">regex_pattern</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-735"><a href="#Interactor-735"><span class="linenos"> 735</span></a>        <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
</span><span id="Interactor-736"><a href="#Interactor-736"><span class="linenos"> 736</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-737"><a href="#Interactor-737"><span class="linenos"> 737</span></a>                <span class="n">regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span><span id="Interactor-738"><a href="#Interactor-738"><span class="linenos"> 738</span></a>            <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-739"><a href="#Interactor-739"><span class="linenos"> 739</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-740"><a href="#Interactor-740"><span class="linenos"> 740</span></a>                <span class="k">return</span> <span class="p">[]</span>
</span><span id="Interactor-741"><a href="#Interactor-741"><span class="linenos"> 741</span></a>
</span><span id="Interactor-742"><a href="#Interactor-742"><span class="linenos"> 742</span></a>        <span class="k">for</span> <span class="n">provider_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">providers_to_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Interactor-743"><a href="#Interactor-743"><span class="linenos"> 743</span></a>            <span class="n">sdk</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sdk&quot;</span><span class="p">,</span> <span class="s2">&quot;openai&quot;</span><span class="p">)</span>
</span><span id="Interactor-744"><a href="#Interactor-744"><span class="linenos"> 744</span></a>            <span class="n">base_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_url&quot;</span><span class="p">)</span>
</span><span id="Interactor-745"><a href="#Interactor-745"><span class="linenos"> 745</span></a>            <span class="n">api_key</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">)</span>
</span><span id="Interactor-746"><a href="#Interactor-746"><span class="linenos"> 746</span></a>
</span><span id="Interactor-747"><a href="#Interactor-747"><span class="linenos"> 747</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-748"><a href="#Interactor-748"><span class="linenos"> 748</span></a>                <span class="k">if</span> <span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
</span><span id="Interactor-749"><a href="#Interactor-749"><span class="linenos"> 749</span></a>                    <span class="n">client</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">)</span>
</span><span id="Interactor-750"><a href="#Interactor-750"><span class="linenos"> 750</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</span><span id="Interactor-751"><a href="#Interactor-751"><span class="linenos"> 751</span></a>                    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
</span><span id="Interactor-752"><a href="#Interactor-752"><span class="linenos"> 752</span></a>                        <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Interactor-753"><a href="#Interactor-753"><span class="linenos"> 753</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_pattern</span> <span class="ow">or</span> <span class="n">regex_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">model_id</span><span class="p">):</span>
</span><span id="Interactor-754"><a href="#Interactor-754"><span class="linenos"> 754</span></a>                            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
</span><span id="Interactor-755"><a href="#Interactor-755"><span class="linenos"> 755</span></a>
</span><span id="Interactor-756"><a href="#Interactor-756"><span class="linenos"> 756</span></a>                <span class="k">elif</span> <span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;anthropic&quot;</span><span class="p">:</span>
</span><span id="Interactor-757"><a href="#Interactor-757"><span class="linenos"> 757</span></a>                    <span class="n">client</span> <span class="o">=</span> <span class="n">Anthropic</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
</span><span id="Interactor-758"><a href="#Interactor-758"><span class="linenos"> 758</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</span><span id="Interactor-759"><a href="#Interactor-759"><span class="linenos"> 759</span></a>                    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
</span><span id="Interactor-760"><a href="#Interactor-760"><span class="linenos"> 760</span></a>                        <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Interactor-761"><a href="#Interactor-761"><span class="linenos"> 761</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_pattern</span> <span class="ow">or</span> <span class="n">regex_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">model_id</span><span class="p">):</span>
</span><span id="Interactor-762"><a href="#Interactor-762"><span class="linenos"> 762</span></a>                            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
</span><span id="Interactor-763"><a href="#Interactor-763"><span class="linenos"> 763</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-764"><a href="#Interactor-764"><span class="linenos"> 764</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SDK &#39;</span><span class="si">{</span><span class="n">sdk</span><span class="si">}</span><span class="s2">&#39; for provider &#39;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2">&#39; is not supported by list_models()&quot;</span><span class="p">)</span>
</span><span id="Interactor-765"><a href="#Interactor-765"><span class="linenos"> 765</span></a>
</span><span id="Interactor-766"><a href="#Interactor-766"><span class="linenos"> 766</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-767"><a href="#Interactor-767"><span class="linenos"> 767</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to list models for </span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-768"><a href="#Interactor-768"><span class="linenos"> 768</span></a>
</span><span id="Interactor-769"><a href="#Interactor-769"><span class="linenos"> 769</span></a>        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
</span><span id="Interactor-770"><a href="#Interactor-770"><span class="linenos"> 770</span></a>
</span><span id="Interactor-771"><a href="#Interactor-771"><span class="linenos"> 771</span></a>
</span><span id="Interactor-772"><a href="#Interactor-772"><span class="linenos"> 772</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_retry_with_backoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Interactor-773"><a href="#Interactor-773"><span class="linenos"> 773</span></a>        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Interactor-774"><a href="#Interactor-774"><span class="linenos"> 774</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-775"><a href="#Interactor-775"><span class="linenos"> 775</span></a>                <span class="k">return</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Interactor-776"><a href="#Interactor-776"><span class="linenos"> 776</span></a>
</span><span id="Interactor-777"><a href="#Interactor-777"><span class="linenos"> 777</span></a>            <span class="k">except</span> <span class="p">(</span><span class="n">RateLimitError</span><span class="p">,</span> <span class="n">APIConnectionError</span><span class="p">,</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-778"><a href="#Interactor-778"><span class="linenos"> 778</span></a>                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
</span><span id="Interactor-779"><a href="#Interactor-779"><span class="linenos"> 779</span></a>                    <span class="n">model_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Interactor-780"><a href="#Interactor-780"><span class="linenos"> 780</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_model</span> <span class="ow">and</span> <span class="n">model_key</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fallback_model</span><span class="p">:</span>
</span><span id="Interactor-781"><a href="#Interactor-781"><span class="linenos"> 781</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Model &#39;</span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">&#39; failed. Switching to fallback: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fallback_model</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span><span class="p">)</span>
</span><span id="Interactor-782"><a href="#Interactor-782"><span class="linenos"> 782</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fallback_model</span><span class="p">)</span>
</span><span id="Interactor-783"><a href="#Interactor-783"><span class="linenos"> 783</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_encoding</span><span class="p">()</span>
</span><span id="Interactor-784"><a href="#Interactor-784"><span class="linenos"> 784</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">()</span>
</span><span id="Interactor-785"><a href="#Interactor-785"><span class="linenos"> 785</span></a>                        <span class="k">return</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># retry once with fallback model</span>
</span><span id="Interactor-786"><a href="#Interactor-786"><span class="linenos"> 786</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-787"><a href="#Interactor-787"><span class="linenos"> 787</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> retries failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-788"><a href="#Interactor-788"><span class="linenos"> 788</span></a>                        <span class="k">raise</span>
</span><span id="Interactor-789"><a href="#Interactor-789"><span class="linenos"> 789</span></a>
</span><span id="Interactor-790"><a href="#Interactor-790"><span class="linenos"> 790</span></a>                <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">attempt</span><span class="p">)</span>
</span><span id="Interactor-791"><a href="#Interactor-791"><span class="linenos"> 791</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retry </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> after </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2">s due to </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-792"><a href="#Interactor-792"><span class="linenos"> 792</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[RETRY] Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
</span><span id="Interactor-793"><a href="#Interactor-793"><span class="linenos"> 793</span></a>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</span><span id="Interactor-794"><a href="#Interactor-794"><span class="linenos"> 794</span></a>
</span><span id="Interactor-795"><a href="#Interactor-795"><span class="linenos"> 795</span></a>            <span class="k">except</span> <span class="n">OpenAIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-796"><a href="#Interactor-796"><span class="linenos"> 796</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenAI error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-797"><a href="#Interactor-797"><span class="linenos"> 797</span></a>                <span class="k">raise</span>
</span><span id="Interactor-798"><a href="#Interactor-798"><span class="linenos"> 798</span></a>
</span><span id="Interactor-799"><a href="#Interactor-799"><span class="linenos"> 799</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-800"><a href="#Interactor-800"><span class="linenos"> 800</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-801"><a href="#Interactor-801"><span class="linenos"> 801</span></a>                <span class="k">raise</span>
</span><span id="Interactor-802"><a href="#Interactor-802"><span class="linenos"> 802</span></a>
</span><span id="Interactor-803"><a href="#Interactor-803"><span class="linenos"> 803</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">interact</span><span class="p">(</span>
</span><span id="Interactor-804"><a href="#Interactor-804"><span class="linenos"> 804</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor-805"><a href="#Interactor-805"><span class="linenos"> 805</span></a>        <span class="n">user_input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="Interactor-806"><a href="#Interactor-806"><span class="linenos"> 806</span></a>        <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-807"><a href="#Interactor-807"><span class="linenos"> 807</span></a>        <span class="n">tools</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Interactor-808"><a href="#Interactor-808"><span class="linenos"> 808</span></a>        <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Interactor-809"><a href="#Interactor-809"><span class="linenos"> 809</span></a>        <span class="n">markdown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-810"><a href="#Interactor-810"><span class="linenos"> 810</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-811"><a href="#Interactor-811"><span class="linenos"> 811</span></a>        <span class="n">output_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-812"><a href="#Interactor-812"><span class="linenos"> 812</span></a>        <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-813"><a href="#Interactor-813"><span class="linenos"> 813</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Interactor-814"><a href="#Interactor-814"><span class="linenos"> 814</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main universal gateway for all LLM interaction.&quot;&quot;&quot;</span>
</span><span id="Interactor-815"><a href="#Interactor-815"><span class="linenos"> 815</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_input</span><span class="p">:</span>
</span><span id="Interactor-816"><a href="#Interactor-816"><span class="linenos"> 816</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="Interactor-817"><a href="#Interactor-817"><span class="linenos"> 817</span></a>
</span><span id="Interactor-818"><a href="#Interactor-818"><span class="linenos"> 818</span></a>        <span class="c1"># Setup model if specified</span>
</span><span id="Interactor-819"><a href="#Interactor-819"><span class="linenos"> 819</span></a>        <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
</span><span id="Interactor-820"><a href="#Interactor-820"><span class="linenos"> 820</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_client</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="Interactor-821"><a href="#Interactor-821"><span class="linenos"> 821</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_encoding</span><span class="p">()</span>
</span><span id="Interactor-822"><a href="#Interactor-822"><span class="linenos"> 822</span></a>
</span><span id="Interactor-823"><a href="#Interactor-823"><span class="linenos"> 823</span></a>        <span class="c1"># Session handling</span>
</span><span id="Interactor-824"><a href="#Interactor-824"><span class="linenos"> 824</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="ow">and</span> <span class="n">session_id</span><span class="p">:</span>
</span><span id="Interactor-825"><a href="#Interactor-825"><span class="linenos"> 825</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span>
</span><span id="Interactor-826"><a href="#Interactor-826"><span class="linenos"> 826</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session_load</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Interactor-827"><a href="#Interactor-827"><span class="linenos"> 827</span></a>
</span><span id="Interactor-828"><a href="#Interactor-828"><span class="linenos"> 828</span></a>        <span class="c1"># Add user message using messages_add</span>
</span><span id="Interactor-829"><a href="#Interactor-829"><span class="linenos"> 829</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_input</span><span class="p">)</span>
</span><span id="Interactor-830"><a href="#Interactor-830"><span class="linenos"> 830</span></a>
</span><span id="Interactor-831"><a href="#Interactor-831"><span class="linenos"> 831</span></a>        <span class="c1"># Log token count estimate</span>
</span><span id="Interactor-832"><a href="#Interactor-832"><span class="linenos"> 832</span></a>        <span class="n">token_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_tokens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="Interactor-833"><a href="#Interactor-833"><span class="linenos"> 833</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="Interactor-834"><a href="#Interactor-834"><span class="linenos"> 834</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[dim]Estimated tokens in context: </span><span class="si">{</span><span class="n">token_count</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="si">}</span><span class="s2">[/dim]&quot;</span><span class="p">)</span>
</span><span id="Interactor-835"><a href="#Interactor-835"><span class="linenos"> 835</span></a>
</span><span id="Interactor-836"><a href="#Interactor-836"><span class="linenos"> 836</span></a>        <span class="c1"># Make sure we have enough context space</span>
</span><span id="Interactor-837"><a href="#Interactor-837"><span class="linenos"> 837</span></a>        <span class="k">if</span> <span class="n">token_count</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="p">:</span>
</span><span id="Interactor-838"><a href="#Interactor-838"><span class="linenos"> 838</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_messages</span><span class="p">():</span>
</span><span id="Interactor-839"><a href="#Interactor-839"><span class="linenos"> 839</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="Interactor-840"><a href="#Interactor-840"><span class="linenos"> 840</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[red]Context window exceeded. Cannot proceed.[/red]&quot;</span><span class="p">)</span>
</span><span id="Interactor-841"><a href="#Interactor-841"><span class="linenos"> 841</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="Interactor-842"><a href="#Interactor-842"><span class="linenos"> 842</span></a>
</span><span id="Interactor-843"><a href="#Interactor-843"><span class="linenos"> 843</span></a>        <span class="c1"># Log user input</span>
</span><span id="Interactor-844"><a href="#Interactor-844"><span class="linenos"> 844</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[USER] </span><span class="si">{</span><span class="n">user_input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-845"><a href="#Interactor-845"><span class="linenos"> 845</span></a>
</span><span id="Interactor-846"><a href="#Interactor-846"><span class="linenos"> 846</span></a>        <span class="c1"># Handle the actual interaction with complete streaming for all responses</span>
</span><span id="Interactor-847"><a href="#Interactor-847"><span class="linenos"> 847</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interact_async_core</span><span class="p">(</span>
</span><span id="Interactor-848"><a href="#Interactor-848"><span class="linenos"> 848</span></a>            <span class="n">user_input</span><span class="o">=</span><span class="n">user_input</span><span class="p">,</span>
</span><span id="Interactor-849"><a href="#Interactor-849"><span class="linenos"> 849</span></a>            <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
</span><span id="Interactor-850"><a href="#Interactor-850"><span class="linenos"> 850</span></a>            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
</span><span id="Interactor-851"><a href="#Interactor-851"><span class="linenos"> 851</span></a>            <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
</span><span id="Interactor-852"><a href="#Interactor-852"><span class="linenos"> 852</span></a>            <span class="n">markdown</span><span class="o">=</span><span class="n">markdown</span><span class="p">,</span>
</span><span id="Interactor-853"><a href="#Interactor-853"><span class="linenos"> 853</span></a>            <span class="n">output_callback</span><span class="o">=</span><span class="n">output_callback</span>
</span><span id="Interactor-854"><a href="#Interactor-854"><span class="linenos"> 854</span></a>        <span class="p">))</span>
</span><span id="Interactor-855"><a href="#Interactor-855"><span class="linenos"> 855</span></a>
</span><span id="Interactor-856"><a href="#Interactor-856"><span class="linenos"> 856</span></a>        <span class="c1"># Log completion for this interaction</span>
</span><span id="Interactor-857"><a href="#Interactor-857"><span class="linenos"> 857</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INTERACTION] Completed with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="s2"> total messages&quot;</span><span class="p">)</span>
</span><span id="Interactor-858"><a href="#Interactor-858"><span class="linenos"> 858</span></a>
</span><span id="Interactor-859"><a href="#Interactor-859"><span class="linenos"> 859</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="Interactor-860"><a href="#Interactor-860"><span class="linenos"> 860</span></a>
</span><span id="Interactor-861"><a href="#Interactor-861"><span class="linenos"> 861</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_interact_async_core</span><span class="p">(</span>
</span><span id="Interactor-862"><a href="#Interactor-862"><span class="linenos"> 862</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor-863"><a href="#Interactor-863"><span class="linenos"> 863</span></a>        <span class="n">user_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Interactor-864"><a href="#Interactor-864"><span class="linenos"> 864</span></a>        <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-865"><a href="#Interactor-865"><span class="linenos"> 865</span></a>        <span class="n">tools</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Interactor-866"><a href="#Interactor-866"><span class="linenos"> 866</span></a>        <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Interactor-867"><a href="#Interactor-867"><span class="linenos"> 867</span></a>        <span class="n">markdown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-868"><a href="#Interactor-868"><span class="linenos"> 868</span></a>        <span class="n">output_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-869"><a href="#Interactor-869"><span class="linenos"> 869</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Interactor-870"><a href="#Interactor-870"><span class="linenos"> 870</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main SDK-agnostic async execution pipeline with tool call looping support.&quot;&quot;&quot;</span>
</span><span id="Interactor-871"><a href="#Interactor-871"><span class="linenos"> 871</span></a>        <span class="c1"># Prepare display handler</span>
</span><span id="Interactor-872"><a href="#Interactor-872"><span class="linenos"> 872</span></a>        <span class="n">live</span> <span class="o">=</span> <span class="n">Live</span><span class="p">(</span><span class="n">console</span><span class="o">=</span><span class="n">console</span><span class="p">,</span> <span class="n">refresh_per_second</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">markdown</span> <span class="ow">and</span> <span class="n">stream</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Interactor-873"><a href="#Interactor-873"><span class="linenos"> 873</span></a>        <span class="k">if</span> <span class="n">live</span><span class="p">:</span>
</span><span id="Interactor-874"><a href="#Interactor-874"><span class="linenos"> 874</span></a>            <span class="n">live</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="Interactor-875"><a href="#Interactor-875"><span class="linenos"> 875</span></a>        
</span><span id="Interactor-876"><a href="#Interactor-876"><span class="linenos"> 876</span></a>        <span class="c1"># Initialize variables for iteration tracking</span>
</span><span id="Interactor-877"><a href="#Interactor-877"><span class="linenos"> 877</span></a>        <span class="n">full_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Interactor-878"><a href="#Interactor-878"><span class="linenos"> 878</span></a>        <span class="n">tool_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_supported</span> <span class="ow">and</span> <span class="n">tools</span>
</span><span id="Interactor-879"><a href="#Interactor-879"><span class="linenos"> 879</span></a>        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Prevent infinite loops</span>
</span><span id="Interactor-880"><a href="#Interactor-880"><span class="linenos"> 880</span></a>        <span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Interactor-881"><a href="#Interactor-881"><span class="linenos"> 881</span></a>        
</span><span id="Interactor-882"><a href="#Interactor-882"><span class="linenos"> 882</span></a>        <span class="c1"># Main interaction loop - continues until no more tool calls or max iterations reached</span>
</span><span id="Interactor-883"><a href="#Interactor-883"><span class="linenos"> 883</span></a>        <span class="k">while</span> <span class="n">iterations</span> <span class="o">&lt;</span> <span class="n">max_iterations</span><span class="p">:</span>
</span><span id="Interactor-884"><a href="#Interactor-884"><span class="linenos"> 884</span></a>            <span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Interactor-885"><a href="#Interactor-885"><span class="linenos"> 885</span></a>            
</span><span id="Interactor-886"><a href="#Interactor-886"><span class="linenos"> 886</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-887"><a href="#Interactor-887"><span class="linenos"> 887</span></a>                <span class="c1"># Execute the appropriate SDK runner - history is already normalized</span>
</span><span id="Interactor-888"><a href="#Interactor-888"><span class="linenos"> 888</span></a>                <span class="n">response_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk_runner</span><span class="p">(</span>
</span><span id="Interactor-889"><a href="#Interactor-889"><span class="linenos"> 889</span></a>                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="Interactor-890"><a href="#Interactor-890"><span class="linenos"> 890</span></a>                    <span class="n">messages</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
</span><span id="Interactor-891"><a href="#Interactor-891"><span class="linenos"> 891</span></a>                    <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
</span><span id="Interactor-892"><a href="#Interactor-892"><span class="linenos"> 892</span></a>                    <span class="n">markdown</span><span class="o">=</span><span class="n">markdown</span><span class="p">,</span>
</span><span id="Interactor-893"><a href="#Interactor-893"><span class="linenos"> 893</span></a>                    <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span> <span class="k">if</span> <span class="n">iterations</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-894"><a href="#Interactor-894"><span class="linenos"> 894</span></a>                    <span class="n">live</span><span class="o">=</span><span class="n">live</span><span class="p">,</span>
</span><span id="Interactor-895"><a href="#Interactor-895"><span class="linenos"> 895</span></a>                    <span class="n">output_callback</span><span class="o">=</span><span class="n">output_callback</span>
</span><span id="Interactor-896"><a href="#Interactor-896"><span class="linenos"> 896</span></a>                <span class="p">)</span>
</span><span id="Interactor-897"><a href="#Interactor-897"><span class="linenos"> 897</span></a>                
</span><span id="Interactor-898"><a href="#Interactor-898"><span class="linenos"> 898</span></a>                <span class="c1"># Extract response data</span>
</span><span id="Interactor-899"><a href="#Interactor-899"><span class="linenos"> 899</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">response_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-900"><a href="#Interactor-900"><span class="linenos"> 900</span></a>                <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">response_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Interactor-901"><a href="#Interactor-901"><span class="linenos"> 901</span></a>                
</span><span id="Interactor-902"><a href="#Interactor-902"><span class="linenos"> 902</span></a>                <span class="c1"># Log the response data for debugging</span>
</span><span id="Interactor-903"><a href="#Interactor-903"><span class="linenos"> 903</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ITERATION </span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s2">] Content: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars, Tool calls: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tool_calls</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-904"><a href="#Interactor-904"><span class="linenos"> 904</span></a>                
</span><span id="Interactor-905"><a href="#Interactor-905"><span class="linenos"> 905</span></a>                <span class="c1"># Add content to full response</span>
</span><span id="Interactor-906"><a href="#Interactor-906"><span class="linenos"> 906</span></a>                <span class="k">if</span> <span class="n">iterations</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Interactor-907"><a href="#Interactor-907"><span class="linenos"> 907</span></a>                    <span class="n">full_content</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="Interactor-908"><a href="#Interactor-908"><span class="linenos"> 908</span></a>                <span class="k">elif</span> <span class="n">content</span><span class="p">:</span>
</span><span id="Interactor-909"><a href="#Interactor-909"><span class="linenos"> 909</span></a>                    <span class="k">if</span> <span class="n">full_content</span> <span class="ow">and</span> <span class="n">content</span><span class="p">:</span>
</span><span id="Interactor-910"><a href="#Interactor-910"><span class="linenos"> 910</span></a>                        <span class="n">full_content</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Interactor-911"><a href="#Interactor-911"><span class="linenos"> 911</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-912"><a href="#Interactor-912"><span class="linenos"> 912</span></a>                        <span class="n">full_content</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="Interactor-913"><a href="#Interactor-913"><span class="linenos"> 913</span></a>                
</span><span id="Interactor-914"><a href="#Interactor-914"><span class="linenos"> 914</span></a>                <span class="c1"># Add assistant message with or without tool calls</span>
</span><span id="Interactor-915"><a href="#Interactor-915"><span class="linenos"> 915</span></a>                <span class="k">if</span> <span class="n">tool_calls</span><span class="p">:</span>
</span><span id="Interactor-916"><a href="#Interactor-916"><span class="linenos"> 916</span></a>                    <span class="c1"># Process each tool call</span>
</span><span id="Interactor-917"><a href="#Interactor-917"><span class="linenos"> 917</span></a>                    <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">tool_calls</span><span class="p">:</span>
</span><span id="Interactor-918"><a href="#Interactor-918"><span class="linenos"> 918</span></a>                        <span class="c1"># Add assistant message with tool call</span>
</span><span id="Interactor-919"><a href="#Interactor-919"><span class="linenos"> 919</span></a>                        <span class="n">tool_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-920"><a href="#Interactor-920"><span class="linenos"> 920</span></a>                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Interactor-921"><a href="#Interactor-921"><span class="linenos"> 921</span></a>                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Interactor-922"><a href="#Interactor-922"><span class="linenos"> 922</span></a>                            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>
</span><span id="Interactor-923"><a href="#Interactor-923"><span class="linenos"> 923</span></a>                        <span class="p">}</span>
</span><span id="Interactor-924"><a href="#Interactor-924"><span class="linenos"> 924</span></a>                        
</span><span id="Interactor-925"><a href="#Interactor-925"><span class="linenos"> 925</span></a>                        <span class="c1"># Add the assistant message with tool call</span>
</span><span id="Interactor-926"><a href="#Interactor-926"><span class="linenos"> 926</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span>
</span><span id="Interactor-927"><a href="#Interactor-927"><span class="linenos"> 927</span></a>                            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> 
</span><span id="Interactor-928"><a href="#Interactor-928"><span class="linenos"> 928</span></a>                            <span class="n">content</span><span class="o">=</span><span class="n">content</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tool_calls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Interactor-929"><a href="#Interactor-929"><span class="linenos"> 929</span></a>                            <span class="n">tool_info</span><span class="o">=</span><span class="n">tool_info</span>
</span><span id="Interactor-930"><a href="#Interactor-930"><span class="linenos"> 930</span></a>                        <span class="p">)</span>
</span><span id="Interactor-931"><a href="#Interactor-931"><span class="linenos"> 931</span></a>                        
</span><span id="Interactor-932"><a href="#Interactor-932"><span class="linenos"> 932</span></a>                        <span class="c1"># Execute the tool</span>
</span><span id="Interactor-933"><a href="#Interactor-933"><span class="linenos"> 933</span></a>                        <span class="n">call_name</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="Interactor-934"><a href="#Interactor-934"><span class="linenos"> 934</span></a>                        <span class="n">call_args</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>
</span><span id="Interactor-935"><a href="#Interactor-935"><span class="linenos"> 935</span></a>                        <span class="n">call_id</span> <span class="o">=</span> <span class="n">call</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
</span><span id="Interactor-936"><a href="#Interactor-936"><span class="linenos"> 936</span></a>                        
</span><span id="Interactor-937"><a href="#Interactor-937"><span class="linenos"> 937</span></a>                        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_tool_call_async</span><span class="p">(</span>
</span><span id="Interactor-938"><a href="#Interactor-938"><span class="linenos"> 938</span></a>                            <span class="n">call_name</span><span class="p">,</span> <span class="n">call_args</span><span class="p">,</span> <span class="n">call_id</span><span class="p">,</span>
</span><span id="Interactor-939"><a href="#Interactor-939"><span class="linenos"> 939</span></a>                            <span class="p">{</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="s2">&quot;stream&quot;</span><span class="p">:</span> <span class="n">stream</span><span class="p">},</span>
</span><span id="Interactor-940"><a href="#Interactor-940"><span class="linenos"> 940</span></a>                            <span class="n">markdown</span><span class="p">,</span> <span class="n">live</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">output_callback</span>
</span><span id="Interactor-941"><a href="#Interactor-941"><span class="linenos"> 941</span></a>                        <span class="p">)</span>
</span><span id="Interactor-942"><a href="#Interactor-942"><span class="linenos"> 942</span></a>                        
</span><span id="Interactor-943"><a href="#Interactor-943"><span class="linenos"> 943</span></a>                        <span class="c1"># Add tool result message</span>
</span><span id="Interactor-944"><a href="#Interactor-944"><span class="linenos"> 944</span></a>                        <span class="n">tool_result_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-945"><a href="#Interactor-945"><span class="linenos"> 945</span></a>                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">call_id</span><span class="p">,</span>
</span><span id="Interactor-946"><a href="#Interactor-946"><span class="linenos"> 946</span></a>                            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span>
</span><span id="Interactor-947"><a href="#Interactor-947"><span class="linenos"> 947</span></a>                        <span class="p">}</span>
</span><span id="Interactor-948"><a href="#Interactor-948"><span class="linenos"> 948</span></a>                        
</span><span id="Interactor-949"><a href="#Interactor-949"><span class="linenos"> 949</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span>
</span><span id="Interactor-950"><a href="#Interactor-950"><span class="linenos"> 950</span></a>                            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span>
</span><span id="Interactor-951"><a href="#Interactor-951"><span class="linenos"> 951</span></a>                            <span class="n">content</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
</span><span id="Interactor-952"><a href="#Interactor-952"><span class="linenos"> 952</span></a>                            <span class="n">tool_info</span><span class="o">=</span><span class="n">tool_result_info</span>
</span><span id="Interactor-953"><a href="#Interactor-953"><span class="linenos"> 953</span></a>                        <span class="p">)</span>
</span><span id="Interactor-954"><a href="#Interactor-954"><span class="linenos"> 954</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-955"><a href="#Interactor-955"><span class="linenos"> 955</span></a>                    <span class="c1"># Simple assistant response without tool calls</span>
</span><span id="Interactor-956"><a href="#Interactor-956"><span class="linenos"> 956</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
</span><span id="Interactor-957"><a href="#Interactor-957"><span class="linenos"> 957</span></a>                    <span class="k">break</span>  <span class="c1"># No more tools to process, we&#39;re done</span>
</span><span id="Interactor-958"><a href="#Interactor-958"><span class="linenos"> 958</span></a>                
</span><span id="Interactor-959"><a href="#Interactor-959"><span class="linenos"> 959</span></a>                <span class="c1"># Reset live display if needed</span>
</span><span id="Interactor-960"><a href="#Interactor-960"><span class="linenos"> 960</span></a>                <span class="k">if</span> <span class="n">stream</span> <span class="ow">and</span> <span class="n">live</span><span class="p">:</span>
</span><span id="Interactor-961"><a href="#Interactor-961"><span class="linenos"> 961</span></a>                    <span class="n">live</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="Interactor-962"><a href="#Interactor-962"><span class="linenos"> 962</span></a>                    <span class="n">live</span> <span class="o">=</span> <span class="n">Live</span><span class="p">(</span><span class="n">console</span><span class="o">=</span><span class="n">console</span><span class="p">,</span> <span class="n">refresh_per_second</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="Interactor-963"><a href="#Interactor-963"><span class="linenos"> 963</span></a>                    <span class="n">live</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="Interactor-964"><a href="#Interactor-964"><span class="linenos"> 964</span></a>            
</span><span id="Interactor-965"><a href="#Interactor-965"><span class="linenos"> 965</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-966"><a href="#Interactor-966"><span class="linenos"> 966</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sdk</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> ERROR] </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-967"><a href="#Interactor-967"><span class="linenos"> 967</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Error in interaction loop: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="Interactor-968"><a href="#Interactor-968"><span class="linenos"> 968</span></a>                <span class="k">if</span> <span class="n">live</span><span class="p">:</span>
</span><span id="Interactor-969"><a href="#Interactor-969"><span class="linenos"> 969</span></a>                    <span class="n">live</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="Interactor-970"><a href="#Interactor-970"><span class="linenos"> 970</span></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Interactor-971"><a href="#Interactor-971"><span class="linenos"> 971</span></a>        
</span><span id="Interactor-972"><a href="#Interactor-972"><span class="linenos"> 972</span></a>        <span class="c1"># Clean up display</span>
</span><span id="Interactor-973"><a href="#Interactor-973"><span class="linenos"> 973</span></a>        <span class="k">if</span> <span class="n">live</span><span class="p">:</span>
</span><span id="Interactor-974"><a href="#Interactor-974"><span class="linenos"> 974</span></a>            <span class="n">live</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="Interactor-975"><a href="#Interactor-975"><span class="linenos"> 975</span></a>        
</span><span id="Interactor-976"><a href="#Interactor-976"><span class="linenos"> 976</span></a>        <span class="k">return</span> <span class="n">full_content</span> <span class="ow">or</span> <span class="s2">&quot;No response.&quot;</span>
</span><span id="Interactor-977"><a href="#Interactor-977"><span class="linenos"> 977</span></a>
</span><span id="Interactor-978"><a href="#Interactor-978"><span class="linenos"> 978</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_openai_runner</span><span class="p">(</span>
</span><span id="Interactor-979"><a href="#Interactor-979"><span class="linenos"> 979</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor-980"><a href="#Interactor-980"><span class="linenos"> 980</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="Interactor-981"><a href="#Interactor-981"><span class="linenos"> 981</span></a>        <span class="n">model</span><span class="p">,</span>
</span><span id="Interactor-982"><a href="#Interactor-982"><span class="linenos"> 982</span></a>        <span class="n">messages</span><span class="p">,</span>
</span><span id="Interactor-983"><a href="#Interactor-983"><span class="linenos"> 983</span></a>        <span class="n">stream</span><span class="p">,</span>
</span><span id="Interactor-984"><a href="#Interactor-984"><span class="linenos"> 984</span></a>        <span class="n">markdown</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-985"><a href="#Interactor-985"><span class="linenos"> 985</span></a>        <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-986"><a href="#Interactor-986"><span class="linenos"> 986</span></a>        <span class="n">live</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-987"><a href="#Interactor-987"><span class="linenos"> 987</span></a>        <span class="n">output_callback</span><span class="o">=</span><span class="kc">None</span>
</span><span id="Interactor-988"><a href="#Interactor-988"><span class="linenos"> 988</span></a>    <span class="p">):</span>
</span><span id="Interactor-989"><a href="#Interactor-989"><span class="linenos"> 989</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle OpenAI-specific API interactions and response processing.&quot;&quot;&quot;</span>
</span><span id="Interactor-990"><a href="#Interactor-990"><span class="linenos"> 990</span></a>        <span class="c1"># Log what we&#39;re sending for debugging</span>
</span><span id="Interactor-991"><a href="#Interactor-991"><span class="linenos"> 991</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[OPENAI REQUEST] Sending request to </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
</span><span id="Interactor-992"><a href="#Interactor-992"><span class="linenos"> 992</span></a>
</span><span id="Interactor-993"><a href="#Interactor-993"><span class="linenos"> 993</span></a>        <span class="c1"># Prepare API parameters - history is already normalized by _normalizer</span>
</span><span id="Interactor-994"><a href="#Interactor-994"><span class="linenos"> 994</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-995"><a href="#Interactor-995"><span class="linenos"> 995</span></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
</span><span id="Interactor-996"><a href="#Interactor-996"><span class="linenos"> 996</span></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
</span><span id="Interactor-997"><a href="#Interactor-997"><span class="linenos"> 997</span></a>            <span class="s2">&quot;stream&quot;</span><span class="p">:</span> <span class="n">stream</span><span class="p">,</span>
</span><span id="Interactor-998"><a href="#Interactor-998"><span class="linenos"> 998</span></a>        <span class="p">}</span>
</span><span id="Interactor-999"><a href="#Interactor-999"><span class="linenos"> 999</span></a>
</span><span id="Interactor-1000"><a href="#Interactor-1000"><span class="linenos">1000</span></a>        <span class="c1"># Add tools if enabled</span>
</span><span id="Interactor-1001"><a href="#Interactor-1001"><span class="linenos">1001</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_supported</span><span class="p">:</span>
</span><span id="Interactor-1002"><a href="#Interactor-1002"><span class="linenos">1002</span></a>            <span class="n">enabled_tools</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_enabled_tools</span><span class="p">()</span>
</span><span id="Interactor-1003"><a href="#Interactor-1003"><span class="linenos">1003</span></a>            <span class="k">if</span> <span class="n">enabled_tools</span><span class="p">:</span>
</span><span id="Interactor-1004"><a href="#Interactor-1004"><span class="linenos">1004</span></a>                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;tools&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enabled_tools</span>
</span><span id="Interactor-1005"><a href="#Interactor-1005"><span class="linenos">1005</span></a>                <span class="n">params</span><span class="p">[</span><span class="s2">&quot;tool_choice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</span><span id="Interactor-1006"><a href="#Interactor-1006"><span class="linenos">1006</span></a>
</span><span id="Interactor-1007"><a href="#Interactor-1007"><span class="linenos">1007</span></a>        <span class="c1"># Call API with retry handling</span>
</span><span id="Interactor-1008"><a href="#Interactor-1008"><span class="linenos">1008</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-1009"><a href="#Interactor-1009"><span class="linenos">1009</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retry_with_backoff</span><span class="p">(</span>
</span><span id="Interactor-1010"><a href="#Interactor-1010"><span class="linenos">1010</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">async_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">,</span>
</span><span id="Interactor-1011"><a href="#Interactor-1011"><span class="linenos">1011</span></a>                <span class="o">**</span><span class="n">params</span>
</span><span id="Interactor-1012"><a href="#Interactor-1012"><span class="linenos">1012</span></a>            <span class="p">)</span>
</span><span id="Interactor-1013"><a href="#Interactor-1013"><span class="linenos">1013</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-1014"><a href="#Interactor-1014"><span class="linenos">1014</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[OPENAI ERROR] </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1015"><a href="#Interactor-1015"><span class="linenos">1015</span></a>            <span class="k">raise</span>
</span><span id="Interactor-1016"><a href="#Interactor-1016"><span class="linenos">1016</span></a>
</span><span id="Interactor-1017"><a href="#Interactor-1017"><span class="linenos">1017</span></a>        <span class="n">assistant_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Interactor-1018"><a href="#Interactor-1018"><span class="linenos">1018</span></a>        <span class="n">tool_calls_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Interactor-1019"><a href="#Interactor-1019"><span class="linenos">1019</span></a>
</span><span id="Interactor-1020"><a href="#Interactor-1020"><span class="linenos">1020</span></a>        <span class="c1"># Process streaming response</span>
</span><span id="Interactor-1021"><a href="#Interactor-1021"><span class="linenos">1021</span></a>        <span class="k">if</span> <span class="n">stream</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;__aiter__&quot;</span><span class="p">):</span>
</span><span id="Interactor-1022"><a href="#Interactor-1022"><span class="linenos">1022</span></a>            <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
</span><span id="Interactor-1023"><a href="#Interactor-1023"><span class="linenos">1023</span></a>                <span class="n">delta</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;delta&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-1024"><a href="#Interactor-1024"><span class="linenos">1024</span></a>                <span class="n">finish_reason</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;finish_reason&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-1025"><a href="#Interactor-1025"><span class="linenos">1025</span></a>
</span><span id="Interactor-1026"><a href="#Interactor-1026"><span class="linenos">1026</span></a>                <span class="c1"># Handle content chunks</span>
</span><span id="Interactor-1027"><a href="#Interactor-1027"><span class="linenos">1027</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">delta</span><span class="o">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Interactor-1028"><a href="#Interactor-1028"><span class="linenos">1028</span></a>                    <span class="n">text</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">content</span>
</span><span id="Interactor-1029"><a href="#Interactor-1029"><span class="linenos">1029</span></a>                    <span class="n">assistant_content</span> <span class="o">+=</span> <span class="n">text</span>
</span><span id="Interactor-1030"><a href="#Interactor-1030"><span class="linenos">1030</span></a>                    <span class="k">if</span> <span class="n">output_callback</span><span class="p">:</span>
</span><span id="Interactor-1031"><a href="#Interactor-1031"><span class="linenos">1031</span></a>                        <span class="n">output_callback</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="Interactor-1032"><a href="#Interactor-1032"><span class="linenos">1032</span></a>                    <span class="k">elif</span> <span class="n">live</span><span class="p">:</span>
</span><span id="Interactor-1033"><a href="#Interactor-1033"><span class="linenos">1033</span></a>                        <span class="n">live</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">assistant_content</span><span class="p">))</span>
</span><span id="Interactor-1034"><a href="#Interactor-1034"><span class="linenos">1034</span></a>                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">markdown</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="Interactor-1035"><a href="#Interactor-1035"><span class="linenos">1035</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-1036"><a href="#Interactor-1036"><span class="linenos">1036</span></a>
</span><span id="Interactor-1037"><a href="#Interactor-1037"><span class="linenos">1037</span></a>                <span class="c1"># Process tool calls</span>
</span><span id="Interactor-1038"><a href="#Interactor-1038"><span class="linenos">1038</span></a>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">delta</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
</span><span id="Interactor-1039"><a href="#Interactor-1039"><span class="linenos">1039</span></a>                    <span class="k">for</span> <span class="n">tool_call_delta</span> <span class="ow">in</span> <span class="n">delta</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
</span><span id="Interactor-1040"><a href="#Interactor-1040"><span class="linenos">1040</span></a>                        <span class="n">index</span> <span class="o">=</span> <span class="n">tool_call_delta</span><span class="o">.</span><span class="n">index</span>
</span><span id="Interactor-1041"><a href="#Interactor-1041"><span class="linenos">1041</span></a>                        <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tool_calls_dict</span><span class="p">:</span>
</span><span id="Interactor-1042"><a href="#Interactor-1042"><span class="linenos">1042</span></a>                            <span class="n">tool_calls_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1043"><a href="#Interactor-1043"><span class="linenos">1043</span></a>                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tool_call_delta</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tool_call_delta</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-1044"><a href="#Interactor-1044"><span class="linenos">1044</span></a>                                <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
</span><span id="Interactor-1045"><a href="#Interactor-1045"><span class="linenos">1045</span></a>                            <span class="p">}</span>
</span><span id="Interactor-1046"><a href="#Interactor-1046"><span class="linenos">1046</span></a>
</span><span id="Interactor-1047"><a href="#Interactor-1047"><span class="linenos">1047</span></a>                        <span class="n">function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tool_call_delta</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-1048"><a href="#Interactor-1048"><span class="linenos">1048</span></a>                        <span class="k">if</span> <span class="n">function</span><span class="p">:</span>
</span><span id="Interactor-1049"><a href="#Interactor-1049"><span class="linenos">1049</span></a>                            <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-1050"><a href="#Interactor-1050"><span class="linenos">1050</span></a>                            <span class="n">args</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-1051"><a href="#Interactor-1051"><span class="linenos">1051</span></a>                            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
</span><span id="Interactor-1052"><a href="#Interactor-1052"><span class="linenos">1052</span></a>                                <span class="n">tool_calls_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Interactor-1053"><a href="#Interactor-1053"><span class="linenos">1053</span></a>                            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
</span><span id="Interactor-1054"><a href="#Interactor-1054"><span class="linenos">1054</span></a>                                <span class="n">tool_calls_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">args</span>
</span><span id="Interactor-1055"><a href="#Interactor-1055"><span class="linenos">1055</span></a>                            <span class="k">if</span> <span class="n">tool_call_delta</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tool_calls_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span>
</span><span id="Interactor-1056"><a href="#Interactor-1056"><span class="linenos">1056</span></a>                                <span class="n">tool_calls_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_call_delta</span><span class="o">.</span><span class="n">id</span>
</span><span id="Interactor-1057"><a href="#Interactor-1057"><span class="linenos">1057</span></a>
</span><span id="Interactor-1058"><a href="#Interactor-1058"><span class="linenos">1058</span></a>                        <span class="c1"># Make sure the ID is set regardless</span>
</span><span id="Interactor-1059"><a href="#Interactor-1059"><span class="linenos">1059</span></a>                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tool_call_delta</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tool_call_delta</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tool_calls_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span>
</span><span id="Interactor-1060"><a href="#Interactor-1060"><span class="linenos">1060</span></a>                            <span class="n">tool_calls_dict</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_call_delta</span><span class="o">.</span><span class="n">id</span>
</span><span id="Interactor-1061"><a href="#Interactor-1061"><span class="linenos">1061</span></a>
</span><span id="Interactor-1062"><a href="#Interactor-1062"><span class="linenos">1062</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">output_callback</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">markdown</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="Interactor-1063"><a href="#Interactor-1063"><span class="linenos">1063</span></a>                <span class="nb">print</span><span class="p">()</span>
</span><span id="Interactor-1064"><a href="#Interactor-1064"><span class="linenos">1064</span></a>
</span><span id="Interactor-1065"><a href="#Interactor-1065"><span class="linenos">1065</span></a>        <span class="c1"># Process non-streaming response</span>
</span><span id="Interactor-1066"><a href="#Interactor-1066"><span class="linenos">1066</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1067"><a href="#Interactor-1067"><span class="linenos">1067</span></a>            <span class="n">message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
</span><span id="Interactor-1068"><a href="#Interactor-1068"><span class="linenos">1068</span></a>            <span class="n">assistant_content</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
</span><span id="Interactor-1069"><a href="#Interactor-1069"><span class="linenos">1069</span></a>
</span><span id="Interactor-1070"><a href="#Interactor-1070"><span class="linenos">1070</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
</span><span id="Interactor-1071"><a href="#Interactor-1071"><span class="linenos">1071</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">):</span>
</span><span id="Interactor-1072"><a href="#Interactor-1072"><span class="linenos">1072</span></a>                    <span class="n">tool_calls_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1073"><a href="#Interactor-1073"><span class="linenos">1073</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="Interactor-1074"><a href="#Interactor-1074"><span class="linenos">1074</span></a>                        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-1075"><a href="#Interactor-1075"><span class="linenos">1075</span></a>                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="Interactor-1076"><a href="#Interactor-1076"><span class="linenos">1076</span></a>                            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span>
</span><span id="Interactor-1077"><a href="#Interactor-1077"><span class="linenos">1077</span></a>                        <span class="p">}</span>
</span><span id="Interactor-1078"><a href="#Interactor-1078"><span class="linenos">1078</span></a>                    <span class="p">}</span>
</span><span id="Interactor-1079"><a href="#Interactor-1079"><span class="linenos">1079</span></a>
</span><span id="Interactor-1080"><a href="#Interactor-1080"><span class="linenos">1080</span></a>            <span class="k">if</span> <span class="n">output_callback</span><span class="p">:</span>
</span><span id="Interactor-1081"><a href="#Interactor-1081"><span class="linenos">1081</span></a>                <span class="n">output_callback</span><span class="p">(</span><span class="n">assistant_content</span><span class="p">)</span>
</span><span id="Interactor-1082"><a href="#Interactor-1082"><span class="linenos">1082</span></a>            <span class="k">elif</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="Interactor-1083"><a href="#Interactor-1083"><span class="linenos">1083</span></a>                <span class="nb">print</span><span class="p">(</span><span class="n">assistant_content</span><span class="p">)</span>
</span><span id="Interactor-1084"><a href="#Interactor-1084"><span class="linenos">1084</span></a>
</span><span id="Interactor-1085"><a href="#Interactor-1085"><span class="linenos">1085</span></a>        <span class="c1"># Log tool calls for debugging</span>
</span><span id="Interactor-1086"><a href="#Interactor-1086"><span class="linenos">1086</span></a>        <span class="k">if</span> <span class="n">tool_calls_dict</span><span class="p">:</span>
</span><span id="Interactor-1087"><a href="#Interactor-1087"><span class="linenos">1087</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[OPENAI TOOL CALLS] Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tool_calls_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"> tool calls&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
</span><span id="Interactor-1088"><a href="#Interactor-1088"><span class="linenos">1088</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">tool_calls_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Interactor-1089"><a href="#Interactor-1089"><span class="linenos">1089</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[OPENAI TOOL CALL </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">call</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with ID </span><span class="si">{</span><span class="n">call</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
</span><span id="Interactor-1090"><a href="#Interactor-1090"><span class="linenos">1090</span></a>
</span><span id="Interactor-1091"><a href="#Interactor-1091"><span class="linenos">1091</span></a>        <span class="c1"># Return standardized response format</span>
</span><span id="Interactor-1092"><a href="#Interactor-1092"><span class="linenos">1092</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Interactor-1093"><a href="#Interactor-1093"><span class="linenos">1093</span></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">assistant_content</span><span class="p">,</span>
</span><span id="Interactor-1094"><a href="#Interactor-1094"><span class="linenos">1094</span></a>            <span class="s2">&quot;tool_calls&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">tool_calls_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="Interactor-1095"><a href="#Interactor-1095"><span class="linenos">1095</span></a>        <span class="p">}</span>
</span><span id="Interactor-1096"><a href="#Interactor-1096"><span class="linenos">1096</span></a>
</span><span id="Interactor-1097"><a href="#Interactor-1097"><span class="linenos">1097</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_anthropic_runner</span><span class="p">(</span>
</span><span id="Interactor-1098"><a href="#Interactor-1098"><span class="linenos">1098</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor-1099"><a href="#Interactor-1099"><span class="linenos">1099</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="Interactor-1100"><a href="#Interactor-1100"><span class="linenos">1100</span></a>        <span class="n">model</span><span class="p">,</span>
</span><span id="Interactor-1101"><a href="#Interactor-1101"><span class="linenos">1101</span></a>        <span class="n">messages</span><span class="p">,</span>
</span><span id="Interactor-1102"><a href="#Interactor-1102"><span class="linenos">1102</span></a>        <span class="n">stream</span><span class="p">,</span>
</span><span id="Interactor-1103"><a href="#Interactor-1103"><span class="linenos">1103</span></a>        <span class="n">markdown</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-1104"><a href="#Interactor-1104"><span class="linenos">1104</span></a>        <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-1105"><a href="#Interactor-1105"><span class="linenos">1105</span></a>        <span class="n">live</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-1106"><a href="#Interactor-1106"><span class="linenos">1106</span></a>        <span class="n">output_callback</span><span class="o">=</span><span class="kc">None</span>
</span><span id="Interactor-1107"><a href="#Interactor-1107"><span class="linenos">1107</span></a>    <span class="p">):</span>
</span><span id="Interactor-1108"><a href="#Interactor-1108"><span class="linenos">1108</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle Anthropic-specific API interactions and response processing.&quot;&quot;&quot;</span>
</span><span id="Interactor-1109"><a href="#Interactor-1109"><span class="linenos">1109</span></a>        <span class="c1"># Log what we&#39;re sending for debugging</span>
</span><span id="Interactor-1110"><a href="#Interactor-1110"><span class="linenos">1110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ANTHROPIC REQUEST] Sending request to </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
</span><span id="Interactor-1111"><a href="#Interactor-1111"><span class="linenos">1111</span></a>        
</span><span id="Interactor-1112"><a href="#Interactor-1112"><span class="linenos">1112</span></a>        <span class="c1"># Prepare API parameters - history is already normalized by _normalizer</span>
</span><span id="Interactor-1113"><a href="#Interactor-1113"><span class="linenos">1113</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1114"><a href="#Interactor-1114"><span class="linenos">1114</span></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
</span><span id="Interactor-1115"><a href="#Interactor-1115"><span class="linenos">1115</span></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
</span><span id="Interactor-1116"><a href="#Interactor-1116"><span class="linenos">1116</span></a>            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">8192</span><span class="p">,</span>
</span><span id="Interactor-1117"><a href="#Interactor-1117"><span class="linenos">1117</span></a>            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
</span><span id="Interactor-1118"><a href="#Interactor-1118"><span class="linenos">1118</span></a>        <span class="p">}</span>
</span><span id="Interactor-1119"><a href="#Interactor-1119"><span class="linenos">1119</span></a>        
</span><span id="Interactor-1120"><a href="#Interactor-1120"><span class="linenos">1120</span></a>        <span class="c1"># Add tools support if needed</span>
</span><span id="Interactor-1121"><a href="#Interactor-1121"><span class="linenos">1121</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_supported</span><span class="p">:</span>
</span><span id="Interactor-1122"><a href="#Interactor-1122"><span class="linenos">1122</span></a>            <span class="n">enabled_tools</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-1123"><a href="#Interactor-1123"><span class="linenos">1123</span></a>            <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_enabled_tools</span><span class="p">():</span>
</span><span id="Interactor-1124"><a href="#Interactor-1124"><span class="linenos">1124</span></a>                <span class="n">format_tool</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1125"><a href="#Interactor-1125"><span class="linenos">1125</span></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Interactor-1126"><a href="#Interactor-1126"><span class="linenos">1126</span></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="Interactor-1127"><a href="#Interactor-1127"><span class="linenos">1127</span></a>                    <span class="s2">&quot;input_schema&quot;</span><span class="p">:</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span>
</span><span id="Interactor-1128"><a href="#Interactor-1128"><span class="linenos">1128</span></a>                <span class="p">}</span>
</span><span id="Interactor-1129"><a href="#Interactor-1129"><span class="linenos">1129</span></a>                <span class="n">enabled_tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_tool</span><span class="p">)</span>
</span><span id="Interactor-1130"><a href="#Interactor-1130"><span class="linenos">1130</span></a>
</span><span id="Interactor-1131"><a href="#Interactor-1131"><span class="linenos">1131</span></a>            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;tools&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enabled_tools</span>
</span><span id="Interactor-1132"><a href="#Interactor-1132"><span class="linenos">1132</span></a>
</span><span id="Interactor-1133"><a href="#Interactor-1133"><span class="linenos">1133</span></a>        <span class="n">assistant_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Interactor-1134"><a href="#Interactor-1134"><span class="linenos">1134</span></a>        <span class="n">tool_calls_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Interactor-1135"><a href="#Interactor-1135"><span class="linenos">1135</span></a>        
</span><span id="Interactor-1136"><a href="#Interactor-1136"><span class="linenos">1136</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-1137"><a href="#Interactor-1137"><span class="linenos">1137</span></a>            <span class="c1"># Process streaming response</span>
</span><span id="Interactor-1138"><a href="#Interactor-1138"><span class="linenos">1138</span></a>            <span class="k">if</span> <span class="n">stream</span><span class="p">:</span>
</span><span id="Interactor-1139"><a href="#Interactor-1139"><span class="linenos">1139</span></a>                <span class="n">stream_response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retry_with_backoff</span><span class="p">(</span>
</span><span id="Interactor-1140"><a href="#Interactor-1140"><span class="linenos">1140</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">async_client</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">,</span>
</span><span id="Interactor-1141"><a href="#Interactor-1141"><span class="linenos">1141</span></a>                    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Interactor-1142"><a href="#Interactor-1142"><span class="linenos">1142</span></a>                    <span class="o">**</span><span class="n">params</span>
</span><span id="Interactor-1143"><a href="#Interactor-1143"><span class="linenos">1143</span></a>                <span class="p">)</span>
</span><span id="Interactor-1144"><a href="#Interactor-1144"><span class="linenos">1144</span></a>               
</span><span id="Interactor-1145"><a href="#Interactor-1145"><span class="linenos">1145</span></a>                <span class="n">content_type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-1146"><a href="#Interactor-1146"><span class="linenos">1146</span></a>                <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream_response</span><span class="p">:</span>
</span><span id="Interactor-1147"><a href="#Interactor-1147"><span class="linenos">1147</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
</span><span id="Interactor-1148"><a href="#Interactor-1148"><span class="linenos">1148</span></a>                    <span class="n">chunk_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="Interactor-1149"><a href="#Interactor-1149"><span class="linenos">1149</span></a>                    <span class="n">stop_reason</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="s2">&quot;stop_reason&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-1150"><a href="#Interactor-1150"><span class="linenos">1150</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ANTHROPIC CHUNK] Type: </span><span class="si">{</span><span class="n">chunk_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
</span><span id="Interactor-1151"><a href="#Interactor-1151"><span class="linenos">1151</span></a>                    <span class="k">if</span> <span class="n">chunk_type</span> <span class="o">==</span> <span class="s2">&quot;content_block_start&quot;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">content_block</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">):</span>
</span><span id="Interactor-1152"><a href="#Interactor-1152"><span class="linenos">1152</span></a>                        <span class="n">content_type</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">content_block</span><span class="o">.</span><span class="n">type</span>
</span><span id="Interactor-1153"><a href="#Interactor-1153"><span class="linenos">1153</span></a>                        <span class="k">if</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;tool_use&quot;</span><span class="p">:</span>
</span><span id="Interactor-1154"><a href="#Interactor-1154"><span class="linenos">1154</span></a>                            <span class="n">tool_id</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">content_block</span><span class="o">.</span><span class="n">id</span>
</span><span id="Interactor-1155"><a href="#Interactor-1155"><span class="linenos">1155</span></a>                            <span class="n">tool_name</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">content_block</span><span class="o">.</span><span class="n">name</span>
</span><span id="Interactor-1156"><a href="#Interactor-1156"><span class="linenos">1156</span></a>                            <span class="n">tool_input</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">content_block</span><span class="o">.</span><span class="n">input</span>
</span><span id="Interactor-1157"><a href="#Interactor-1157"><span class="linenos">1157</span></a>                            <span class="n">tool_calls_dict</span><span class="p">[</span><span class="n">tool_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1158"><a href="#Interactor-1158"><span class="linenos">1158</span></a>                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tool_id</span><span class="p">,</span>
</span><span id="Interactor-1159"><a href="#Interactor-1159"><span class="linenos">1159</span></a>                                <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-1160"><a href="#Interactor-1160"><span class="linenos">1160</span></a>                                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool_name</span><span class="p">,</span>
</span><span id="Interactor-1161"><a href="#Interactor-1161"><span class="linenos">1161</span></a>                                    <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span id="Interactor-1162"><a href="#Interactor-1162"><span class="linenos">1162</span></a>                                <span class="p">}</span>
</span><span id="Interactor-1163"><a href="#Interactor-1163"><span class="linenos">1163</span></a>                            <span class="p">}</span>
</span><span id="Interactor-1164"><a href="#Interactor-1164"><span class="linenos">1164</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ANTHROPIC TOOL USE] Found complete tool use: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
</span><span id="Interactor-1165"><a href="#Interactor-1165"><span class="linenos">1165</span></a>                    
</span><span id="Interactor-1166"><a href="#Interactor-1166"><span class="linenos">1166</span></a>                    <span class="c1"># Handle text content</span>
</span><span id="Interactor-1167"><a href="#Interactor-1167"><span class="linenos">1167</span></a>                    <span class="k">if</span> <span class="n">chunk_type</span> <span class="o">==</span> <span class="s2">&quot;content_block_delta&quot;</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">):</span>
</span><span id="Interactor-1168"><a href="#Interactor-1168"><span class="linenos">1168</span></a>                        <span class="n">delta</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">text</span>
</span><span id="Interactor-1169"><a href="#Interactor-1169"><span class="linenos">1169</span></a>                        <span class="n">assistant_content</span> <span class="o">+=</span> <span class="n">delta</span>
</span><span id="Interactor-1170"><a href="#Interactor-1170"><span class="linenos">1170</span></a>                        <span class="k">if</span> <span class="n">output_callback</span><span class="p">:</span>
</span><span id="Interactor-1171"><a href="#Interactor-1171"><span class="linenos">1171</span></a>                            <span class="n">output_callback</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
</span><span id="Interactor-1172"><a href="#Interactor-1172"><span class="linenos">1172</span></a>                        <span class="k">elif</span> <span class="n">live</span><span class="p">:</span>
</span><span id="Interactor-1173"><a href="#Interactor-1173"><span class="linenos">1173</span></a>                            <span class="n">live</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">assistant_content</span><span class="p">))</span>
</span><span id="Interactor-1174"><a href="#Interactor-1174"><span class="linenos">1174</span></a>                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">markdown</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="Interactor-1175"><a href="#Interactor-1175"><span class="linenos">1175</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-1176"><a href="#Interactor-1176"><span class="linenos">1176</span></a>
</span><span id="Interactor-1177"><a href="#Interactor-1177"><span class="linenos">1177</span></a>                    <span class="c1"># Handle complete tool use</span>
</span><span id="Interactor-1178"><a href="#Interactor-1178"><span class="linenos">1178</span></a>                    <span class="k">elif</span> <span class="n">chunk_type</span> <span class="o">==</span> <span class="s2">&quot;content_block_delta&quot;</span> <span class="ow">and</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;tool_use&quot;</span><span class="p">:</span>
</span><span id="Interactor-1179"><a href="#Interactor-1179"><span class="linenos">1179</span></a>                        <span class="n">tool_calls_dict</span><span class="p">[</span><span class="n">tool_id</span><span class="p">][</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">partial_json</span>
</span><span id="Interactor-1180"><a href="#Interactor-1180"><span class="linenos">1180</span></a>
</span><span id="Interactor-1181"><a href="#Interactor-1181"><span class="linenos">1181</span></a>            <span class="c1"># Process non-streaming response</span>
</span><span id="Interactor-1182"><a href="#Interactor-1182"><span class="linenos">1182</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1183"><a href="#Interactor-1183"><span class="linenos">1183</span></a>                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retry_with_backoff</span><span class="p">(</span>
</span><span id="Interactor-1184"><a href="#Interactor-1184"><span class="linenos">1184</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">async_client</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">,</span>
</span><span id="Interactor-1185"><a href="#Interactor-1185"><span class="linenos">1185</span></a>                    <span class="o">**</span><span class="n">params</span>
</span><span id="Interactor-1186"><a href="#Interactor-1186"><span class="linenos">1186</span></a>                <span class="p">)</span>
</span><span id="Interactor-1187"><a href="#Interactor-1187"><span class="linenos">1187</span></a>                
</span><span id="Interactor-1188"><a href="#Interactor-1188"><span class="linenos">1188</span></a>                <span class="c1"># Extract text content</span>
</span><span id="Interactor-1189"><a href="#Interactor-1189"><span class="linenos">1189</span></a>                <span class="k">for</span> <span class="n">content_block</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span><span id="Interactor-1190"><a href="#Interactor-1190"><span class="linenos">1190</span></a>                    <span class="k">if</span> <span class="n">content_block</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
</span><span id="Interactor-1191"><a href="#Interactor-1191"><span class="linenos">1191</span></a>                        <span class="n">assistant_content</span> <span class="o">+=</span> <span class="n">content_block</span><span class="o">.</span><span class="n">text</span>
</span><span id="Interactor-1192"><a href="#Interactor-1192"><span class="linenos">1192</span></a>                
</span><span id="Interactor-1193"><a href="#Interactor-1193"><span class="linenos">1193</span></a>                <span class="c1"># Extract tool uses</span>
</span><span id="Interactor-1194"><a href="#Interactor-1194"><span class="linenos">1194</span></a>                <span class="n">tool_uses</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;tool_uses&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Interactor-1195"><a href="#Interactor-1195"><span class="linenos">1195</span></a>                <span class="k">if</span> <span class="n">tool_uses</span><span class="p">:</span>
</span><span id="Interactor-1196"><a href="#Interactor-1196"><span class="linenos">1196</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ANTHROPIC TOOL USES] Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tool_uses</span><span class="p">)</span><span class="si">}</span><span class="s2"> tool uses&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
</span><span id="Interactor-1197"><a href="#Interactor-1197"><span class="linenos">1197</span></a>                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tool_use</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tool_uses</span><span class="p">):</span>
</span><span id="Interactor-1198"><a href="#Interactor-1198"><span class="linenos">1198</span></a>                        <span class="c1"># Extract and format the tool use</span>
</span><span id="Interactor-1199"><a href="#Interactor-1199"><span class="linenos">1199</span></a>                        <span class="n">tool_id</span> <span class="o">=</span> <span class="n">tool_use</span><span class="o">.</span><span class="n">id</span>
</span><span id="Interactor-1200"><a href="#Interactor-1200"><span class="linenos">1200</span></a>                        <span class="n">tool_name</span> <span class="o">=</span> <span class="n">tool_use</span><span class="o">.</span><span class="n">name</span>
</span><span id="Interactor-1201"><a href="#Interactor-1201"><span class="linenos">1201</span></a>                        <span class="n">tool_input</span> <span class="o">=</span> <span class="n">tool_use</span><span class="o">.</span><span class="n">input</span>
</span><span id="Interactor-1202"><a href="#Interactor-1202"><span class="linenos">1202</span></a>                        
</span><span id="Interactor-1203"><a href="#Interactor-1203"><span class="linenos">1203</span></a>                        <span class="c1"># Format the input as JSON string</span>
</span><span id="Interactor-1204"><a href="#Interactor-1204"><span class="linenos">1204</span></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_input</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="Interactor-1205"><a href="#Interactor-1205"><span class="linenos">1205</span></a>                            <span class="n">input_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tool_input</span><span class="p">)</span>
</span><span id="Interactor-1206"><a href="#Interactor-1206"><span class="linenos">1206</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1207"><a href="#Interactor-1207"><span class="linenos">1207</span></a>                            <span class="n">input_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({})</span> <span class="k">if</span> <span class="n">tool_input</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">tool_input</span><span class="p">)</span>
</span><span id="Interactor-1208"><a href="#Interactor-1208"><span class="linenos">1208</span></a>                        
</span><span id="Interactor-1209"><a href="#Interactor-1209"><span class="linenos">1209</span></a>                        <span class="n">tool_calls_dict</span><span class="p">[</span><span class="n">tool_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1210"><a href="#Interactor-1210"><span class="linenos">1210</span></a>                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tool_id</span><span class="p">,</span>
</span><span id="Interactor-1211"><a href="#Interactor-1211"><span class="linenos">1211</span></a>                            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-1212"><a href="#Interactor-1212"><span class="linenos">1212</span></a>                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool_name</span><span class="p">,</span>
</span><span id="Interactor-1213"><a href="#Interactor-1213"><span class="linenos">1213</span></a>                                <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">input_json</span>
</span><span id="Interactor-1214"><a href="#Interactor-1214"><span class="linenos">1214</span></a>                            <span class="p">}</span>
</span><span id="Interactor-1215"><a href="#Interactor-1215"><span class="linenos">1215</span></a>                        <span class="p">}</span>
</span><span id="Interactor-1216"><a href="#Interactor-1216"><span class="linenos">1216</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ANTHROPIC TOOL USE] </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
</span><span id="Interactor-1217"><a href="#Interactor-1217"><span class="linenos">1217</span></a>                
</span><span id="Interactor-1218"><a href="#Interactor-1218"><span class="linenos">1218</span></a>                <span class="k">if</span> <span class="n">output_callback</span><span class="p">:</span>
</span><span id="Interactor-1219"><a href="#Interactor-1219"><span class="linenos">1219</span></a>                    <span class="n">output_callback</span><span class="p">(</span><span class="n">assistant_content</span><span class="p">)</span>
</span><span id="Interactor-1220"><a href="#Interactor-1220"><span class="linenos">1220</span></a>                <span class="k">elif</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="Interactor-1221"><a href="#Interactor-1221"><span class="linenos">1221</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="n">assistant_content</span><span class="p">)</span>
</span><span id="Interactor-1222"><a href="#Interactor-1222"><span class="linenos">1222</span></a>                    
</span><span id="Interactor-1223"><a href="#Interactor-1223"><span class="linenos">1223</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-1224"><a href="#Interactor-1224"><span class="linenos">1224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in Anthropic runner: </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1225"><a href="#Interactor-1225"><span class="linenos">1225</span></a>            <span class="c1"># Add more detailed logging</span>
</span><span id="Interactor-1226"><a href="#Interactor-1226"><span class="linenos">1226</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ANTHROPIC ERROR] </span><span class="si">{</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="Interactor-1227"><a href="#Interactor-1227"><span class="linenos">1227</span></a>            
</span><span id="Interactor-1228"><a href="#Interactor-1228"><span class="linenos">1228</span></a>            <span class="c1"># Return something usable even in case of error</span>
</span><span id="Interactor-1229"><a href="#Interactor-1229"><span class="linenos">1229</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="Interactor-1230"><a href="#Interactor-1230"><span class="linenos">1230</span></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error processing Anthropic response: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Interactor-1231"><a href="#Interactor-1231"><span class="linenos">1231</span></a>                <span class="s2">&quot;tool_calls&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="Interactor-1232"><a href="#Interactor-1232"><span class="linenos">1232</span></a>            <span class="p">}</span>
</span><span id="Interactor-1233"><a href="#Interactor-1233"><span class="linenos">1233</span></a>        
</span><span id="Interactor-1234"><a href="#Interactor-1234"><span class="linenos">1234</span></a>        <span class="c1"># Return standardized response format</span>
</span><span id="Interactor-1235"><a href="#Interactor-1235"><span class="linenos">1235</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Interactor-1236"><a href="#Interactor-1236"><span class="linenos">1236</span></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">assistant_content</span><span class="p">,</span>
</span><span id="Interactor-1237"><a href="#Interactor-1237"><span class="linenos">1237</span></a>            <span class="s2">&quot;tool_calls&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">tool_calls_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="Interactor-1238"><a href="#Interactor-1238"><span class="linenos">1238</span></a>        <span class="p">}</span>
</span><span id="Interactor-1239"><a href="#Interactor-1239"><span class="linenos">1239</span></a>
</span><span id="Interactor-1240"><a href="#Interactor-1240"><span class="linenos">1240</span></a>
</span><span id="Interactor-1241"><a href="#Interactor-1241"><span class="linenos">1241</span></a>
</span><span id="Interactor-1242"><a href="#Interactor-1242"><span class="linenos">1242</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_enabled_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
</span><span id="Interactor-1243"><a href="#Interactor-1243"><span class="linenos">1243</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the list of currently enabled tool function definitions.&quot;&quot;&quot;</span>
</span><span id="Interactor-1244"><a href="#Interactor-1244"><span class="linenos">1244</span></a>        <span class="k">return</span> <span class="p">[</span>
</span><span id="Interactor-1245"><a href="#Interactor-1245"><span class="linenos">1245</span></a>            <span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span>
</span><span id="Interactor-1246"><a href="#Interactor-1246"><span class="linenos">1246</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Interactor-1247"><a href="#Interactor-1247"><span class="linenos">1247</span></a>        <span class="p">]</span>
</span><span id="Interactor-1248"><a href="#Interactor-1248"><span class="linenos">1248</span></a>
</span><span id="Interactor-1249"><a href="#Interactor-1249"><span class="linenos">1249</span></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_tool_call_async</span><span class="p">(</span>
</span><span id="Interactor-1250"><a href="#Interactor-1250"><span class="linenos">1250</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor-1251"><a href="#Interactor-1251"><span class="linenos">1251</span></a>        <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Interactor-1252"><a href="#Interactor-1252"><span class="linenos">1252</span></a>        <span class="n">function_arguments</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Interactor-1253"><a href="#Interactor-1253"><span class="linenos">1253</span></a>        <span class="n">tool_call_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Interactor-1254"><a href="#Interactor-1254"><span class="linenos">1254</span></a>        <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="Interactor-1255"><a href="#Interactor-1255"><span class="linenos">1255</span></a>        <span class="n">markdown</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="Interactor-1256"><a href="#Interactor-1256"><span class="linenos">1256</span></a>        <span class="n">live</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Live</span><span class="p">],</span>
</span><span id="Interactor-1257"><a href="#Interactor-1257"><span class="linenos">1257</span></a>        <span class="n">safe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor-1258"><a href="#Interactor-1258"><span class="linenos">1258</span></a>        <span class="n">output_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-1259"><a href="#Interactor-1259"><span class="linenos">1259</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Interactor-1260"><a href="#Interactor-1260"><span class="linenos">1260</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a tool call asynchronously and return the result.</span>
</span><span id="Interactor-1261"><a href="#Interactor-1261"><span class="linenos">1261</span></a>
</span><span id="Interactor-1262"><a href="#Interactor-1262"><span class="linenos">1262</span></a><span class="sd">        Args:</span>
</span><span id="Interactor-1263"><a href="#Interactor-1263"><span class="linenos">1263</span></a><span class="sd">            function_name: Name of the function to call.</span>
</span><span id="Interactor-1264"><a href="#Interactor-1264"><span class="linenos">1264</span></a><span class="sd">            function_arguments: JSON string containing the function arguments.</span>
</span><span id="Interactor-1265"><a href="#Interactor-1265"><span class="linenos">1265</span></a><span class="sd">            tool_call_id: Unique identifier for this tool call.</span>
</span><span id="Interactor-1266"><a href="#Interactor-1266"><span class="linenos">1266</span></a><span class="sd">            params: Parameters used for the original API call.</span>
</span><span id="Interactor-1267"><a href="#Interactor-1267"><span class="linenos">1267</span></a><span class="sd">            markdown: If True, renders content as markdown.</span>
</span><span id="Interactor-1268"><a href="#Interactor-1268"><span class="linenos">1268</span></a><span class="sd">            live: Optional Live context for updating content in real-time.</span>
</span><span id="Interactor-1269"><a href="#Interactor-1269"><span class="linenos">1269</span></a><span class="sd">            safe: If True, prompts for confirmation before executing the tool call.</span>
</span><span id="Interactor-1270"><a href="#Interactor-1270"><span class="linenos">1270</span></a><span class="sd">            output_callback: Optional callback to handle the tool call result.</span>
</span><span id="Interactor-1271"><a href="#Interactor-1271"><span class="linenos">1271</span></a>
</span><span id="Interactor-1272"><a href="#Interactor-1272"><span class="linenos">1272</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-1273"><a href="#Interactor-1273"><span class="linenos">1273</span></a><span class="sd">            The result of the function call.</span>
</span><span id="Interactor-1274"><a href="#Interactor-1274"><span class="linenos">1274</span></a>
</span><span id="Interactor-1275"><a href="#Interactor-1275"><span class="linenos">1275</span></a><span class="sd">        Raises:</span>
</span><span id="Interactor-1276"><a href="#Interactor-1276"><span class="linenos">1276</span></a><span class="sd">            ValueError: If the function is not found or JSON is invalid.</span>
</span><span id="Interactor-1277"><a href="#Interactor-1277"><span class="linenos">1277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-1278"><a href="#Interactor-1278"><span class="linenos">1278</span></a>        <span class="n">live_was_active</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Interactor-1279"><a href="#Interactor-1279"><span class="linenos">1279</span></a>        
</span><span id="Interactor-1280"><a href="#Interactor-1280"><span class="linenos">1280</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-1281"><a href="#Interactor-1281"><span class="linenos">1281</span></a>            <span class="n">arguments</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">function_arguments</span> <span class="ow">or</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1282"><a href="#Interactor-1282"><span class="linenos">1282</span></a>        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-1283"><a href="#Interactor-1283"><span class="linenos">1283</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON in tool call arguments: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1284"><a href="#Interactor-1284"><span class="linenos">1284</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid JSON format in tool call arguments.&quot;</span><span class="p">}</span>
</span><span id="Interactor-1285"><a href="#Interactor-1285"><span class="linenos">1285</span></a>
</span><span id="Interactor-1286"><a href="#Interactor-1286"><span class="linenos">1286</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOOL:</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">] args=</span><span class="si">{</span><span class="n">arguments</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1287"><a href="#Interactor-1287"><span class="linenos">1287</span></a>
</span><span id="Interactor-1288"><a href="#Interactor-1288"><span class="linenos">1288</span></a>        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-1289"><a href="#Interactor-1289"><span class="linenos">1289</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
</span><span id="Interactor-1290"><a href="#Interactor-1290"><span class="linenos">1290</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>
</span><span id="Interactor-1291"><a href="#Interactor-1291"><span class="linenos">1291</span></a>
</span><span id="Interactor-1292"><a href="#Interactor-1292"><span class="linenos">1292</span></a>        <span class="c1"># Properly handle live display if it&#39;s active</span>
</span><span id="Interactor-1293"><a href="#Interactor-1293"><span class="linenos">1293</span></a>        <span class="k">if</span> <span class="n">live</span> <span class="ow">and</span> <span class="n">live</span><span class="o">.</span><span class="n">is_started</span><span class="p">:</span>
</span><span id="Interactor-1294"><a href="#Interactor-1294"><span class="linenos">1294</span></a>            <span class="n">live_was_active</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor-1295"><a href="#Interactor-1295"><span class="linenos">1295</span></a>            <span class="n">live</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="Interactor-1296"><a href="#Interactor-1296"><span class="linenos">1296</span></a>
</span><span id="Interactor-1297"><a href="#Interactor-1297"><span class="linenos">1297</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1298"><a href="#Interactor-1298"><span class="linenos">1298</span></a>
</span><span id="Interactor-1299"><a href="#Interactor-1299"><span class="linenos">1299</span></a>        <span class="k">if</span> <span class="n">output_callback</span><span class="p">:</span>
</span><span id="Interactor-1300"><a href="#Interactor-1300"><span class="linenos">1300</span></a>            <span class="n">notification</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="Interactor-1301"><a href="#Interactor-1301"><span class="linenos">1301</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;tool_call&quot;</span><span class="p">,</span>
</span><span id="Interactor-1302"><a href="#Interactor-1302"><span class="linenos">1302</span></a>                <span class="s2">&quot;tool_name&quot;</span><span class="p">:</span> <span class="n">function_name</span><span class="p">,</span>
</span><span id="Interactor-1303"><a href="#Interactor-1303"><span class="linenos">1303</span></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;started&quot;</span>
</span><span id="Interactor-1304"><a href="#Interactor-1304"><span class="linenos">1304</span></a>            <span class="p">})</span>
</span><span id="Interactor-1305"><a href="#Interactor-1305"><span class="linenos">1305</span></a>            <span class="n">output_callback</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
</span><span id="Interactor-1306"><a href="#Interactor-1306"><span class="linenos">1306</span></a>
</span><span id="Interactor-1307"><a href="#Interactor-1307"><span class="linenos">1307</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-1308"><a href="#Interactor-1308"><span class="linenos">1308</span></a>            <span class="k">if</span> <span class="n">safe</span><span class="p">:</span>
</span><span id="Interactor-1309"><a href="#Interactor-1309"><span class="linenos">1309</span></a>                <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[bold yellow]Proposed tool call:[/bold yellow] </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">[bold cyan]Execute? [y/n]: [/bold cyan]&quot;</span>
</span><span id="Interactor-1310"><a href="#Interactor-1310"><span class="linenos">1310</span></a>                <span class="n">confirmed</span> <span class="o">=</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Interactor-1311"><a href="#Interactor-1311"><span class="linenos">1311</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">confirmed</span><span class="p">:</span>
</span><span id="Interactor-1312"><a href="#Interactor-1312"><span class="linenos">1312</span></a>                    <span class="n">command_result</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1313"><a href="#Interactor-1313"><span class="linenos">1313</span></a>                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;cancelled&quot;</span><span class="p">,</span>
</span><span id="Interactor-1314"><a href="#Interactor-1314"><span class="linenos">1314</span></a>                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Tool call aborted by user&quot;</span>
</span><span id="Interactor-1315"><a href="#Interactor-1315"><span class="linenos">1315</span></a>                    <span class="p">}</span>
</span><span id="Interactor-1316"><a href="#Interactor-1316"><span class="linenos">1316</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[red]Tool call cancelled by user[/red]&quot;</span><span class="p">)</span>
</span><span id="Interactor-1317"><a href="#Interactor-1317"><span class="linenos">1317</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1318"><a href="#Interactor-1318"><span class="linenos">1318</span></a>                    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span><span id="Interactor-1319"><a href="#Interactor-1319"><span class="linenos">1319</span></a>                    <span class="n">command_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="p">))</span>
</span><span id="Interactor-1320"><a href="#Interactor-1320"><span class="linenos">1320</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1321"><a href="#Interactor-1321"><span class="linenos">1321</span></a>                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span><span id="Interactor-1322"><a href="#Interactor-1322"><span class="linenos">1322</span></a>                <span class="n">command_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">arguments</span><span class="p">))</span>
</span><span id="Interactor-1323"><a href="#Interactor-1323"><span class="linenos">1323</span></a>
</span><span id="Interactor-1324"><a href="#Interactor-1324"><span class="linenos">1324</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-1325"><a href="#Interactor-1325"><span class="linenos">1325</span></a>                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">command_result</span><span class="p">)</span>
</span><span id="Interactor-1326"><a href="#Interactor-1326"><span class="linenos">1326</span></a>            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-1327"><a href="#Interactor-1327"><span class="linenos">1327</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool call result not serializable: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1328"><a href="#Interactor-1328"><span class="linenos">1328</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Tool call returned unserializable data.&quot;</span><span class="p">}</span>
</span><span id="Interactor-1329"><a href="#Interactor-1329"><span class="linenos">1329</span></a>
</span><span id="Interactor-1330"><a href="#Interactor-1330"><span class="linenos">1330</span></a>            <span class="k">if</span> <span class="n">output_callback</span><span class="p">:</span>
</span><span id="Interactor-1331"><a href="#Interactor-1331"><span class="linenos">1331</span></a>                <span class="n">notification</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span id="Interactor-1332"><a href="#Interactor-1332"><span class="linenos">1332</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;tool_call&quot;</span><span class="p">,</span>
</span><span id="Interactor-1333"><a href="#Interactor-1333"><span class="linenos">1333</span></a>                    <span class="s2">&quot;tool_name&quot;</span><span class="p">:</span> <span class="n">function_name</span><span class="p">,</span>
</span><span id="Interactor-1334"><a href="#Interactor-1334"><span class="linenos">1334</span></a>                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span>
</span><span id="Interactor-1335"><a href="#Interactor-1335"><span class="linenos">1335</span></a>                <span class="p">})</span>
</span><span id="Interactor-1336"><a href="#Interactor-1336"><span class="linenos">1336</span></a>                <span class="n">output_callback</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
</span><span id="Interactor-1337"><a href="#Interactor-1337"><span class="linenos">1337</span></a>
</span><span id="Interactor-1338"><a href="#Interactor-1338"><span class="linenos">1338</span></a>            <span class="c1"># Restart live display if it was active before</span>
</span><span id="Interactor-1339"><a href="#Interactor-1339"><span class="linenos">1339</span></a>            <span class="k">if</span> <span class="n">live_was_active</span> <span class="ow">and</span> <span class="n">live</span><span class="p">:</span>
</span><span id="Interactor-1340"><a href="#Interactor-1340"><span class="linenos">1340</span></a>                <span class="n">live</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="Interactor-1341"><a href="#Interactor-1341"><span class="linenos">1341</span></a>
</span><span id="Interactor-1342"><a href="#Interactor-1342"><span class="linenos">1342</span></a>            <span class="k">return</span> <span class="n">command_result</span>
</span><span id="Interactor-1343"><a href="#Interactor-1343"><span class="linenos">1343</span></a>
</span><span id="Interactor-1344"><a href="#Interactor-1344"><span class="linenos">1344</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-1345"><a href="#Interactor-1345"><span class="linenos">1345</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Tool execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="Interactor-1346"><a href="#Interactor-1346"><span class="linenos">1346</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error executing tool function &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1347"><a href="#Interactor-1347"><span class="linenos">1347</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
</span><span id="Interactor-1348"><a href="#Interactor-1348"><span class="linenos">1348</span></a>
</span><span id="Interactor-1349"><a href="#Interactor-1349"><span class="linenos">1349</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Interactor-1350"><a href="#Interactor-1350"><span class="linenos">1350</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up the token encoding based on the current model.&quot;&quot;&quot;</span>
</span><span id="Interactor-1351"><a href="#Interactor-1351"><span class="linenos">1351</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-1352"><a href="#Interactor-1352"><span class="linenos">1352</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
</span><span id="Interactor-1353"><a href="#Interactor-1353"><span class="linenos">1353</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-1354"><a href="#Interactor-1354"><span class="linenos">1354</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">encoding_for_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="Interactor-1355"><a href="#Interactor-1355"><span class="linenos">1355</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ENCODING] Loaded tokenizer for OpenAI model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1356"><a href="#Interactor-1356"><span class="linenos">1356</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="Interactor-1357"><a href="#Interactor-1357"><span class="linenos">1357</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">get_encoding</span><span class="p">(</span><span class="s2">&quot;cl100k_base&quot;</span><span class="p">)</span>
</span><span id="Interactor-1358"><a href="#Interactor-1358"><span class="linenos">1358</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ENCODING] Fallback to cl100k_base for model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1359"><a href="#Interactor-1359"><span class="linenos">1359</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1360"><a href="#Interactor-1360"><span class="linenos">1360</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">get_encoding</span><span class="p">(</span><span class="s2">&quot;cl100k_base&quot;</span><span class="p">)</span>
</span><span id="Interactor-1361"><a href="#Interactor-1361"><span class="linenos">1361</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ENCODING] Defaulting to cl100k_base for non-OpenAI model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1362"><a href="#Interactor-1362"><span class="linenos">1362</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-1363"><a href="#Interactor-1363"><span class="linenos">1363</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to setup encoding: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1364"><a href="#Interactor-1364"><span class="linenos">1364</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">get_encoding</span><span class="p">(</span><span class="s2">&quot;cl100k_base&quot;</span><span class="p">)</span>
</span><span id="Interactor-1365"><a href="#Interactor-1365"><span class="linenos">1365</span></a>
</span><span id="Interactor-1366"><a href="#Interactor-1366"><span class="linenos">1366</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_estimate_tokens_tiktoken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Interactor-1367"><a href="#Interactor-1367"><span class="linenos">1367</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Rough token count estimate using tiktoken for OpenAI or fallback cases.&quot;&quot;&quot;</span>
</span><span id="Interactor-1368"><a href="#Interactor-1368"><span class="linenos">1368</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;encoding&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span>
</span><span id="Interactor-1369"><a href="#Interactor-1369"><span class="linenos">1369</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_encoding</span><span class="p">()</span>
</span><span id="Interactor-1370"><a href="#Interactor-1370"><span class="linenos">1370</span></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">),</span> <span class="nb">str</span><span class="p">))</span>
</span><span id="Interactor-1371"><a href="#Interactor-1371"><span class="linenos">1371</span></a>
</span><span id="Interactor-1372"><a href="#Interactor-1372"><span class="linenos">1372</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_count_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Interactor-1373"><a href="#Interactor-1373"><span class="linenos">1373</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Accurately estimate token count for messages including tool calls with caching support.</span>
</span><span id="Interactor-1374"><a href="#Interactor-1374"><span class="linenos">1374</span></a>
</span><span id="Interactor-1375"><a href="#Interactor-1375"><span class="linenos">1375</span></a><span class="sd">        Args:</span>
</span><span id="Interactor-1376"><a href="#Interactor-1376"><span class="linenos">1376</span></a><span class="sd">            messages: List of message objects in either OpenAI or Anthropic format.</span>
</span><span id="Interactor-1377"><a href="#Interactor-1377"><span class="linenos">1377</span></a><span class="sd">            use_cache: Whether to use and update the token count cache.</span>
</span><span id="Interactor-1378"><a href="#Interactor-1378"><span class="linenos">1378</span></a>
</span><span id="Interactor-1379"><a href="#Interactor-1379"><span class="linenos">1379</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-1380"><a href="#Interactor-1380"><span class="linenos">1380</span></a><span class="sd">            int: Estimated token count.</span>
</span><span id="Interactor-1381"><a href="#Interactor-1381"><span class="linenos">1381</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-1382"><a href="#Interactor-1382"><span class="linenos">1382</span></a>        <span class="c1"># Setup encoding if needed</span>
</span><span id="Interactor-1383"><a href="#Interactor-1383"><span class="linenos">1383</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;encoding&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span>
</span><span id="Interactor-1384"><a href="#Interactor-1384"><span class="linenos">1384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_encoding</span><span class="p">()</span>
</span><span id="Interactor-1385"><a href="#Interactor-1385"><span class="linenos">1385</span></a>        
</span><span id="Interactor-1386"><a href="#Interactor-1386"><span class="linenos">1386</span></a>        <span class="c1"># Initialize cache if it doesn&#39;t exist</span>
</span><span id="Interactor-1387"><a href="#Interactor-1387"><span class="linenos">1387</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_token_count_cache&quot;</span><span class="p">):</span>
</span><span id="Interactor-1388"><a href="#Interactor-1388"><span class="linenos">1388</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_token_count_cache</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Interactor-1389"><a href="#Interactor-1389"><span class="linenos">1389</span></a>        
</span><span id="Interactor-1390"><a href="#Interactor-1390"><span class="linenos">1390</span></a>        <span class="c1"># Generate a cache key based on message content hashes</span>
</span><span id="Interactor-1391"><a href="#Interactor-1391"><span class="linenos">1391</span></a>        <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
</span><span id="Interactor-1392"><a href="#Interactor-1392"><span class="linenos">1392</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-1393"><a href="#Interactor-1393"><span class="linenos">1393</span></a>                <span class="c1"># Create a cache key using message IDs if available, or content hashes</span>
</span><span id="Interactor-1394"><a href="#Interactor-1394"><span class="linenos">1394</span></a>                <span class="n">cache_key_parts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-1395"><a href="#Interactor-1395"><span class="linenos">1395</span></a>                <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="Interactor-1396"><a href="#Interactor-1396"><span class="linenos">1396</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="Interactor-1397"><a href="#Interactor-1397"><span class="linenos">1397</span></a>                        <span class="c1"># Try to use stable identifiers for cache key</span>
</span><span id="Interactor-1398"><a href="#Interactor-1398"><span class="linenos">1398</span></a>                        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-1399"><a href="#Interactor-1399"><span class="linenos">1399</span></a>                        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-1400"><a href="#Interactor-1400"><span class="linenos">1400</span></a>                        
</span><span id="Interactor-1401"><a href="#Interactor-1401"><span class="linenos">1401</span></a>                        <span class="k">if</span> <span class="n">msg_id</span> <span class="ow">and</span> <span class="n">timestamp</span><span class="p">:</span>
</span><span id="Interactor-1402"><a href="#Interactor-1402"><span class="linenos">1402</span></a>                            <span class="n">cache_key_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1403"><a href="#Interactor-1403"><span class="linenos">1403</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1404"><a href="#Interactor-1404"><span class="linenos">1404</span></a>                            <span class="c1"># Fall back to content-based hash if no stable IDs</span>
</span><span id="Interactor-1405"><a href="#Interactor-1405"><span class="linenos">1405</span></a>                            <span class="n">content_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</span><span id="Interactor-1406"><a href="#Interactor-1406"><span class="linenos">1406</span></a>                            <span class="n">role</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="Interactor-1407"><a href="#Interactor-1407"><span class="linenos">1407</span></a>                            <span class="n">cache_key_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">hash</span><span class="p">(</span><span class="n">content_str</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-1408"><a href="#Interactor-1408"><span class="linenos">1408</span></a>                
</span><span id="Interactor-1409"><a href="#Interactor-1409"><span class="linenos">1409</span></a>                <span class="n">cache_key</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_key_parts</span><span class="p">)</span>
</span><span id="Interactor-1410"><a href="#Interactor-1410"><span class="linenos">1410</span></a>                <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_count_cache</span><span class="p">:</span>
</span><span id="Interactor-1411"><a href="#Interactor-1411"><span class="linenos">1411</span></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_count_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
</span><span id="Interactor-1412"><a href="#Interactor-1412"><span class="linenos">1412</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-1413"><a href="#Interactor-1413"><span class="linenos">1413</span></a>                <span class="c1"># If caching fails, just continue with normal counting</span>
</span><span id="Interactor-1414"><a href="#Interactor-1414"><span class="linenos">1414</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOKEN COUNT] Cache key generation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
</span><span id="Interactor-1415"><a href="#Interactor-1415"><span class="linenos">1415</span></a>                <span class="n">use_cache</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Interactor-1416"><a href="#Interactor-1416"><span class="linenos">1416</span></a>        
</span><span id="Interactor-1417"><a href="#Interactor-1417"><span class="linenos">1417</span></a>        <span class="c1"># For Claude models, try to use their built-in token counter</span>
</span><span id="Interactor-1418"><a href="#Interactor-1418"><span class="linenos">1418</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;anthropic&quot;</span><span class="p">:</span>
</span><span id="Interactor-1419"><a href="#Interactor-1419"><span class="linenos">1419</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-1420"><a href="#Interactor-1420"><span class="linenos">1420</span></a>                <span class="c1"># Convert messages to Anthropic format if needed</span>
</span><span id="Interactor-1421"><a href="#Interactor-1421"><span class="linenos">1421</span></a>                <span class="n">anthropic_messages</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-1422"><a href="#Interactor-1422"><span class="linenos">1422</span></a>                <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="Interactor-1423"><a href="#Interactor-1423"><span class="linenos">1423</span></a>                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="Interactor-1424"><a href="#Interactor-1424"><span class="linenos">1424</span></a>                        <span class="k">continue</span>  <span class="c1"># System handled separately</span>
</span><span id="Interactor-1425"><a href="#Interactor-1425"><span class="linenos">1425</span></a>                    
</span><span id="Interactor-1426"><a href="#Interactor-1426"><span class="linenos">1426</span></a>                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tool&quot;</span><span class="p">:</span>
</span><span id="Interactor-1427"><a href="#Interactor-1427"><span class="linenos">1427</span></a>                        <span class="c1"># Skip tool messages in token count to avoid double-counting</span>
</span><span id="Interactor-1428"><a href="#Interactor-1428"><span class="linenos">1428</span></a>                        <span class="k">continue</span>
</span><span id="Interactor-1429"><a href="#Interactor-1429"><span class="linenos">1429</span></a>                    
</span><span id="Interactor-1430"><a href="#Interactor-1430"><span class="linenos">1430</span></a>                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Interactor-1431"><a href="#Interactor-1431"><span class="linenos">1431</span></a>                        <span class="c1"># Already in Anthropic format with tool_result</span>
</span><span id="Interactor-1432"><a href="#Interactor-1432"><span class="linenos">1432</span></a>                        <span class="n">anthropic_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Interactor-1433"><a href="#Interactor-1433"><span class="linenos">1433</span></a>                    <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;assistant&quot;</span><span class="p">]:</span>
</span><span id="Interactor-1434"><a href="#Interactor-1434"><span class="linenos">1434</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use&quot;</span><span class="p">):</span>
</span><span id="Interactor-1435"><a href="#Interactor-1435"><span class="linenos">1435</span></a>                            <span class="c1"># Simple message</span>
</span><span id="Interactor-1436"><a href="#Interactor-1436"><span class="linenos">1436</span></a>                            <span class="n">anthropic_messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-1437"><a href="#Interactor-1437"><span class="linenos">1437</span></a>                                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">),</span>
</span><span id="Interactor-1438"><a href="#Interactor-1438"><span class="linenos">1438</span></a>                                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-1439"><a href="#Interactor-1439"><span class="linenos">1439</span></a>                            <span class="p">})</span>
</span><span id="Interactor-1440"><a href="#Interactor-1440"><span class="linenos">1440</span></a>                
</span><span id="Interactor-1441"><a href="#Interactor-1441"><span class="linenos">1441</span></a>                <span class="c1"># Use Anthropic&#39;s token counter if messages exist</span>
</span><span id="Interactor-1442"><a href="#Interactor-1442"><span class="linenos">1442</span></a>                <span class="k">if</span> <span class="n">anthropic_messages</span><span class="p">:</span>
</span><span id="Interactor-1443"><a href="#Interactor-1443"><span class="linenos">1443</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">count_tokens</span><span class="p">(</span>
</span><span id="Interactor-1444"><a href="#Interactor-1444"><span class="linenos">1444</span></a>                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="Interactor-1445"><a href="#Interactor-1445"><span class="linenos">1445</span></a>                        <span class="n">messages</span><span class="o">=</span><span class="n">anthropic_messages</span><span class="p">,</span>
</span><span id="Interactor-1446"><a href="#Interactor-1446"><span class="linenos">1446</span></a>                        <span class="n">system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span>
</span><span id="Interactor-1447"><a href="#Interactor-1447"><span class="linenos">1447</span></a>                    <span class="p">)</span>
</span><span id="Interactor-1448"><a href="#Interactor-1448"><span class="linenos">1448</span></a>                    <span class="n">token_count</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">input_tokens</span>
</span><span id="Interactor-1449"><a href="#Interactor-1449"><span class="linenos">1449</span></a>                    
</span><span id="Interactor-1450"><a href="#Interactor-1450"><span class="linenos">1450</span></a>                    <span class="c1"># Cache the result for future use</span>
</span><span id="Interactor-1451"><a href="#Interactor-1451"><span class="linenos">1451</span></a>                    <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="s1">&#39;cache_key&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
</span><span id="Interactor-1452"><a href="#Interactor-1452"><span class="linenos">1452</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_token_count_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_count</span>
</span><span id="Interactor-1453"><a href="#Interactor-1453"><span class="linenos">1453</span></a>                    
</span><span id="Interactor-1454"><a href="#Interactor-1454"><span class="linenos">1454</span></a>                    <span class="k">return</span> <span class="n">token_count</span>
</span><span id="Interactor-1455"><a href="#Interactor-1455"><span class="linenos">1455</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-1456"><a href="#Interactor-1456"><span class="linenos">1456</span></a>                <span class="c1"># Fall back to our estimation</span>
</span><span id="Interactor-1457"><a href="#Interactor-1457"><span class="linenos">1457</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOKEN COUNT] Error using Anthropic token counter: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
</span><span id="Interactor-1458"><a href="#Interactor-1458"><span class="linenos">1458</span></a>        
</span><span id="Interactor-1459"><a href="#Interactor-1459"><span class="linenos">1459</span></a>        <span class="c1"># More accurate token counting for all message types</span>
</span><span id="Interactor-1460"><a href="#Interactor-1460"><span class="linenos">1460</span></a>        <span class="n">num_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Interactor-1461"><a href="#Interactor-1461"><span class="linenos">1461</span></a>        
</span><span id="Interactor-1462"><a href="#Interactor-1462"><span class="linenos">1462</span></a>        <span class="c1"># Count tokens for each message</span>
</span><span id="Interactor-1463"><a href="#Interactor-1463"><span class="linenos">1463</span></a>        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="Interactor-1464"><a href="#Interactor-1464"><span class="linenos">1464</span></a>            <span class="c1"># Base token count for message metadata (role + message format)</span>
</span><span id="Interactor-1465"><a href="#Interactor-1465"><span class="linenos">1465</span></a>            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="mi">4</span>  <span class="c1"># Message overhead</span>
</span><span id="Interactor-1466"><a href="#Interactor-1466"><span class="linenos">1466</span></a>            
</span><span id="Interactor-1467"><a href="#Interactor-1467"><span class="linenos">1467</span></a>            <span class="c1"># Add tokens for role name</span>
</span><span id="Interactor-1468"><a href="#Interactor-1468"><span class="linenos">1468</span></a>            <span class="n">role</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-1469"><a href="#Interactor-1469"><span class="linenos">1469</span></a>            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">role</span><span class="p">))</span>
</span><span id="Interactor-1470"><a href="#Interactor-1470"><span class="linenos">1470</span></a>            
</span><span id="Interactor-1471"><a href="#Interactor-1471"><span class="linenos">1471</span></a>            <span class="c1"># Count tokens in message content</span>
</span><span id="Interactor-1472"><a href="#Interactor-1472"><span class="linenos">1472</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor-1473"><a href="#Interactor-1473"><span class="linenos">1473</span></a>                <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-1474"><a href="#Interactor-1474"><span class="linenos">1474</span></a>                <span class="n">content_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
</span><span id="Interactor-1475"><a href="#Interactor-1475"><span class="linenos">1475</span></a>                <span class="n">num_tokens</span> <span class="o">+=</span> <span class="n">content_tokens</span>
</span><span id="Interactor-1476"><a href="#Interactor-1476"><span class="linenos">1476</span></a>                
</span><span id="Interactor-1477"><a href="#Interactor-1477"><span class="linenos">1477</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Interactor-1478"><a href="#Interactor-1478"><span class="linenos">1478</span></a>                <span class="c1"># Handle Anthropic-style content lists</span>
</span><span id="Interactor-1479"><a href="#Interactor-1479"><span class="linenos">1479</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Interactor-1480"><a href="#Interactor-1480"><span class="linenos">1480</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="Interactor-1481"><a href="#Interactor-1481"><span class="linenos">1481</span></a>                        <span class="c1"># Tool result or other structured content</span>
</span><span id="Interactor-1482"><a href="#Interactor-1482"><span class="linenos">1482</span></a>                        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tool_result&quot;</span><span class="p">:</span>
</span><span id="Interactor-1483"><a href="#Interactor-1483"><span class="linenos">1483</span></a>                            <span class="n">result_content</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-1484"><a href="#Interactor-1484"><span class="linenos">1484</span></a>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor-1485"><a href="#Interactor-1485"><span class="linenos">1485</span></a>                                <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">result_content</span><span class="p">))</span>
</span><span id="Interactor-1486"><a href="#Interactor-1486"><span class="linenos">1486</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1487"><a href="#Interactor-1487"><span class="linenos">1487</span></a>                                <span class="c1"># JSON serialization for dict/list content</span>
</span><span id="Interactor-1488"><a href="#Interactor-1488"><span class="linenos">1488</span></a>                                <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result_content</span><span class="p">)))</span>
</span><span id="Interactor-1489"><a href="#Interactor-1489"><span class="linenos">1489</span></a>                            <span class="c1"># Add tokens for tool_use_id and type fields</span>
</span><span id="Interactor-1490"><a href="#Interactor-1490"><span class="linenos">1490</span></a>                            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor-1491"><a href="#Interactor-1491"><span class="linenos">1491</span></a>                            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor-1492"><a href="#Interactor-1492"><span class="linenos">1492</span></a>                        
</span><span id="Interactor-1493"><a href="#Interactor-1493"><span class="linenos">1493</span></a>                        <span class="c1"># Text content type</span>
</span><span id="Interactor-1494"><a href="#Interactor-1494"><span class="linenos">1494</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
</span><span id="Interactor-1495"><a href="#Interactor-1495"><span class="linenos">1495</span></a>                            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor-1496"><a href="#Interactor-1496"><span class="linenos">1496</span></a>                        
</span><span id="Interactor-1497"><a href="#Interactor-1497"><span class="linenos">1497</span></a>                        <span class="c1"># Tool use type</span>
</span><span id="Interactor-1498"><a href="#Interactor-1498"><span class="linenos">1498</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tool_use&quot;</span><span class="p">:</span>
</span><span id="Interactor-1499"><a href="#Interactor-1499"><span class="linenos">1499</span></a>                            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor-1500"><a href="#Interactor-1500"><span class="linenos">1500</span></a>                            <span class="n">tool_input</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Interactor-1501"><a href="#Interactor-1501"><span class="linenos">1501</span></a>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor-1502"><a href="#Interactor-1502"><span class="linenos">1502</span></a>                                <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tool_input</span><span class="p">))</span>
</span><span id="Interactor-1503"><a href="#Interactor-1503"><span class="linenos">1503</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1504"><a href="#Interactor-1504"><span class="linenos">1504</span></a>                                <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tool_input</span><span class="p">)))</span>
</span><span id="Interactor-1505"><a href="#Interactor-1505"><span class="linenos">1505</span></a>                            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor-1506"><a href="#Interactor-1506"><span class="linenos">1506</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1507"><a href="#Interactor-1507"><span class="linenos">1507</span></a>                        <span class="c1"># Plain text content</span>
</span><span id="Interactor-1508"><a href="#Interactor-1508"><span class="linenos">1508</span></a>                        <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)))</span>
</span><span id="Interactor-1509"><a href="#Interactor-1509"><span class="linenos">1509</span></a>            
</span><span id="Interactor-1510"><a href="#Interactor-1510"><span class="linenos">1510</span></a>            <span class="c1"># Count tokens in tool calls for OpenAI format</span>
</span><span id="Interactor-1511"><a href="#Interactor-1511"><span class="linenos">1511</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">):</span>
</span><span id="Interactor-1512"><a href="#Interactor-1512"><span class="linenos">1512</span></a>                <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Interactor-1513"><a href="#Interactor-1513"><span class="linenos">1513</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_call</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="Interactor-1514"><a href="#Interactor-1514"><span class="linenos">1514</span></a>                        <span class="c1"># Count tokens for function name</span>
</span><span id="Interactor-1515"><a href="#Interactor-1515"><span class="linenos">1515</span></a>                        <span class="n">func_name</span> <span class="o">=</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-1516"><a href="#Interactor-1516"><span class="linenos">1516</span></a>                        <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">func_name</span><span class="p">))</span>
</span><span id="Interactor-1517"><a href="#Interactor-1517"><span class="linenos">1517</span></a>                        
</span><span id="Interactor-1518"><a href="#Interactor-1518"><span class="linenos">1518</span></a>                        <span class="c1"># Count tokens for arguments</span>
</span><span id="Interactor-1519"><a href="#Interactor-1519"><span class="linenos">1519</span></a>                        <span class="n">args</span> <span class="o">=</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-1520"><a href="#Interactor-1520"><span class="linenos">1520</span></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor-1521"><a href="#Interactor-1521"><span class="linenos">1521</span></a>                            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
</span><span id="Interactor-1522"><a href="#Interactor-1522"><span class="linenos">1522</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1523"><a href="#Interactor-1523"><span class="linenos">1523</span></a>                            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
</span><span id="Interactor-1524"><a href="#Interactor-1524"><span class="linenos">1524</span></a>                        
</span><span id="Interactor-1525"><a href="#Interactor-1525"><span class="linenos">1525</span></a>                        <span class="c1"># Add tokens for id and type fields</span>
</span><span id="Interactor-1526"><a href="#Interactor-1526"><span class="linenos">1526</span></a>                        <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor-1527"><a href="#Interactor-1527"><span class="linenos">1527</span></a>                        <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span><span class="p">)))</span>
</span><span id="Interactor-1528"><a href="#Interactor-1528"><span class="linenos">1528</span></a>            
</span><span id="Interactor-1529"><a href="#Interactor-1529"><span class="linenos">1529</span></a>            <span class="c1"># Count tokens in Anthropic tool_use field</span>
</span><span id="Interactor-1530"><a href="#Interactor-1530"><span class="linenos">1530</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use&quot;</span><span class="p">):</span>
</span><span id="Interactor-1531"><a href="#Interactor-1531"><span class="linenos">1531</span></a>                <span class="n">tool_use</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use&quot;</span><span class="p">)</span>
</span><span id="Interactor-1532"><a href="#Interactor-1532"><span class="linenos">1532</span></a>                <span class="c1"># Count tokens for name</span>
</span><span id="Interactor-1533"><a href="#Interactor-1533"><span class="linenos">1533</span></a>                <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tool_use</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor-1534"><a href="#Interactor-1534"><span class="linenos">1534</span></a>                
</span><span id="Interactor-1535"><a href="#Interactor-1535"><span class="linenos">1535</span></a>                <span class="c1"># Count tokens for input</span>
</span><span id="Interactor-1536"><a href="#Interactor-1536"><span class="linenos">1536</span></a>                <span class="n">tool_input</span> <span class="o">=</span> <span class="n">tool_use</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Interactor-1537"><a href="#Interactor-1537"><span class="linenos">1537</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor-1538"><a href="#Interactor-1538"><span class="linenos">1538</span></a>                    <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tool_input</span><span class="p">))</span>
</span><span id="Interactor-1539"><a href="#Interactor-1539"><span class="linenos">1539</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1540"><a href="#Interactor-1540"><span class="linenos">1540</span></a>                    <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tool_input</span><span class="p">)))</span>
</span><span id="Interactor-1541"><a href="#Interactor-1541"><span class="linenos">1541</span></a>                
</span><span id="Interactor-1542"><a href="#Interactor-1542"><span class="linenos">1542</span></a>                <span class="c1"># Add tokens for id field</span>
</span><span id="Interactor-1543"><a href="#Interactor-1543"><span class="linenos">1543</span></a>                <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tool_use</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor-1544"><a href="#Interactor-1544"><span class="linenos">1544</span></a>            
</span><span id="Interactor-1545"><a href="#Interactor-1545"><span class="linenos">1545</span></a>            <span class="c1"># Handle tool response message format</span>
</span><span id="Interactor-1546"><a href="#Interactor-1546"><span class="linenos">1546</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tool&quot;</span><span class="p">:</span>
</span><span id="Interactor-1547"><a href="#Interactor-1547"><span class="linenos">1547</span></a>                <span class="c1"># Add tokens for tool_call_id</span>
</span><span id="Interactor-1548"><a href="#Interactor-1548"><span class="linenos">1548</span></a>                <span class="n">tool_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-1549"><a href="#Interactor-1549"><span class="linenos">1549</span></a>                <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tool_id</span><span class="p">))</span>
</span><span id="Interactor-1550"><a href="#Interactor-1550"><span class="linenos">1550</span></a>        
</span><span id="Interactor-1551"><a href="#Interactor-1551"><span class="linenos">1551</span></a>        <span class="c1"># Add message end tokens</span>
</span><span id="Interactor-1552"><a href="#Interactor-1552"><span class="linenos">1552</span></a>        <span class="n">num_tokens</span> <span class="o">+=</span> <span class="mi">2</span>
</span><span id="Interactor-1553"><a href="#Interactor-1553"><span class="linenos">1553</span></a>        
</span><span id="Interactor-1554"><a href="#Interactor-1554"><span class="linenos">1554</span></a>        <span class="c1"># Cache the result for future use</span>
</span><span id="Interactor-1555"><a href="#Interactor-1555"><span class="linenos">1555</span></a>        <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">and</span> <span class="s1">&#39;cache_key&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
</span><span id="Interactor-1556"><a href="#Interactor-1556"><span class="linenos">1556</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_token_count_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_tokens</span>
</span><span id="Interactor-1557"><a href="#Interactor-1557"><span class="linenos">1557</span></a>        
</span><span id="Interactor-1558"><a href="#Interactor-1558"><span class="linenos">1558</span></a>        <span class="k">return</span> <span class="n">num_tokens</span>
</span><span id="Interactor-1559"><a href="#Interactor-1559"><span class="linenos">1559</span></a>
</span><span id="Interactor-1560"><a href="#Interactor-1560"><span class="linenos">1560</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_cycle_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Interactor-1561"><a href="#Interactor-1561"><span class="linenos">1561</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor-1562"><a href="#Interactor-1562"><span class="linenos">1562</span></a><span class="sd">        Intelligently trim the message history to fit within the allowed context length.</span>
</span><span id="Interactor-1563"><a href="#Interactor-1563"><span class="linenos">1563</span></a>
</span><span id="Interactor-1564"><a href="#Interactor-1564"><span class="linenos">1564</span></a><span class="sd">        This method implements a sophisticated trimming strategy:</span>
</span><span id="Interactor-1565"><a href="#Interactor-1565"><span class="linenos">1565</span></a><span class="sd">        1. Always preserves system messages</span>
</span><span id="Interactor-1566"><a href="#Interactor-1566"><span class="linenos">1566</span></a><span class="sd">        2. Always keeps the most recent complete conversation turn</span>
</span><span id="Interactor-1567"><a href="#Interactor-1567"><span class="linenos">1567</span></a><span class="sd">        3. Prioritizes keeping tool call chains intact</span>
</span><span id="Interactor-1568"><a href="#Interactor-1568"><span class="linenos">1568</span></a><span class="sd">        4. Preserves important context from earlier exchanges</span>
</span><span id="Interactor-1569"><a href="#Interactor-1569"><span class="linenos">1569</span></a><span class="sd">        5. Aggressively prunes redundant information before essential content</span>
</span><span id="Interactor-1570"><a href="#Interactor-1570"><span class="linenos">1570</span></a>
</span><span id="Interactor-1571"><a href="#Interactor-1571"><span class="linenos">1571</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-1572"><a href="#Interactor-1572"><span class="linenos">1572</span></a><span class="sd">            bool: True if all messages were trimmed (context exceeded), False otherwise.</span>
</span><span id="Interactor-1573"><a href="#Interactor-1573"><span class="linenos">1573</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-1574"><a href="#Interactor-1574"><span class="linenos">1574</span></a>        <span class="c1"># Check if we need to trim</span>
</span><span id="Interactor-1575"><a href="#Interactor-1575"><span class="linenos">1575</span></a>        <span class="n">token_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_tokens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="Interactor-1576"><a href="#Interactor-1576"><span class="linenos">1576</span></a>
</span><span id="Interactor-1577"><a href="#Interactor-1577"><span class="linenos">1577</span></a>        <span class="c1"># If we&#39;re already under the limit, return early</span>
</span><span id="Interactor-1578"><a href="#Interactor-1578"><span class="linenos">1578</span></a>        <span class="k">if</span> <span class="n">token_count</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="p">:</span>
</span><span id="Interactor-1579"><a href="#Interactor-1579"><span class="linenos">1579</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="Interactor-1580"><a href="#Interactor-1580"><span class="linenos">1580</span></a>
</span><span id="Interactor-1581"><a href="#Interactor-1581"><span class="linenos">1581</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TRIM] Starting message cycling: </span><span class="si">{</span><span class="n">token_count</span><span class="si">}</span><span class="s2"> tokens exceeds </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="si">}</span><span class="s2"> limit&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
</span><span id="Interactor-1582"><a href="#Interactor-1582"><span class="linenos">1582</span></a>
</span><span id="Interactor-1583"><a href="#Interactor-1583"><span class="linenos">1583</span></a>        <span class="c1"># We&#39;ll need to track tokens as we reconstruct the history</span>
</span><span id="Interactor-1584"><a href="#Interactor-1584"><span class="linenos">1584</span></a>        <span class="n">remaining_tokens</span> <span class="o">=</span> <span class="n">token_count</span>
</span><span id="Interactor-1585"><a href="#Interactor-1585"><span class="linenos">1585</span></a>        <span class="n">target_tokens</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context_length</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Target 80% or 1000 less than max</span>
</span><span id="Interactor-1586"><a href="#Interactor-1586"><span class="linenos">1586</span></a>
</span><span id="Interactor-1587"><a href="#Interactor-1587"><span class="linenos">1587</span></a>        <span class="c1"># First pass: identify critical messages we must keep</span>
</span><span id="Interactor-1588"><a href="#Interactor-1588"><span class="linenos">1588</span></a>        <span class="n">must_keep</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-1589"><a href="#Interactor-1589"><span class="linenos">1589</span></a>        <span class="n">tool_chain_groups</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Group related tool calls and their results</span>
</span><span id="Interactor-1590"><a href="#Interactor-1590"><span class="linenos">1590</span></a>
</span><span id="Interactor-1591"><a href="#Interactor-1591"><span class="linenos">1591</span></a>        <span class="c1"># Always keep system messages (should be first)</span>
</span><span id="Interactor-1592"><a href="#Interactor-1592"><span class="linenos">1592</span></a>        <span class="n">system_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-1593"><a href="#Interactor-1593"><span class="linenos">1593</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">):</span>
</span><span id="Interactor-1594"><a href="#Interactor-1594"><span class="linenos">1594</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="Interactor-1595"><a href="#Interactor-1595"><span class="linenos">1595</span></a>                <span class="n">system_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="Interactor-1596"><a href="#Interactor-1596"><span class="linenos">1596</span></a>                <span class="n">must_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="Interactor-1597"><a href="#Interactor-1597"><span class="linenos">1597</span></a>
</span><span id="Interactor-1598"><a href="#Interactor-1598"><span class="linenos">1598</span></a>        <span class="c1"># Identify the most recent complete exchange (user question + assistant response)</span>
</span><span id="Interactor-1599"><a href="#Interactor-1599"><span class="linenos">1599</span></a>        <span class="n">latest_exchange</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-1600"><a href="#Interactor-1600"><span class="linenos">1600</span></a>        <span class="c1"># Start from the end and work backward to find the last complete exchange</span>
</span><span id="Interactor-1601"><a href="#Interactor-1601"><span class="linenos">1601</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="Interactor-1602"><a href="#Interactor-1602"><span class="linenos">1602</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Interactor-1603"><a href="#Interactor-1603"><span class="linenos">1603</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">latest_exchange</span><span class="p">:</span>
</span><span id="Interactor-1604"><a href="#Interactor-1604"><span class="linenos">1604</span></a>                <span class="n">latest_exchange</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="Interactor-1605"><a href="#Interactor-1605"><span class="linenos">1605</span></a>            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span> <span class="ow">and</span> <span class="n">latest_exchange</span><span class="p">:</span>
</span><span id="Interactor-1606"><a href="#Interactor-1606"><span class="linenos">1606</span></a>                <span class="n">latest_exchange</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="Interactor-1607"><a href="#Interactor-1607"><span class="linenos">1607</span></a>                <span class="k">break</span>
</span><span id="Interactor-1608"><a href="#Interactor-1608"><span class="linenos">1608</span></a>
</span><span id="Interactor-1609"><a href="#Interactor-1609"><span class="linenos">1609</span></a>        <span class="c1"># Add the latest exchange to must-keep</span>
</span><span id="Interactor-1610"><a href="#Interactor-1610"><span class="linenos">1610</span></a>        <span class="n">must_keep</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">latest_exchange</span><span class="p">)</span>
</span><span id="Interactor-1611"><a href="#Interactor-1611"><span class="linenos">1611</span></a>
</span><span id="Interactor-1612"><a href="#Interactor-1612"><span class="linenos">1612</span></a>        <span class="c1"># Identify tool chains - track which messages belong to the same tool flow</span>
</span><span id="Interactor-1613"><a href="#Interactor-1613"><span class="linenos">1613</span></a>        <span class="n">tool_id_to_chain</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Interactor-1614"><a href="#Interactor-1614"><span class="linenos">1614</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">):</span>
</span><span id="Interactor-1615"><a href="#Interactor-1615"><span class="linenos">1615</span></a>            <span class="c1"># For assistant messages with tool calls</span>
</span><span id="Interactor-1616"><a href="#Interactor-1616"><span class="linenos">1616</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">):</span>
</span><span id="Interactor-1617"><a href="#Interactor-1617"><span class="linenos">1617</span></a>                <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">):</span>
</span><span id="Interactor-1618"><a href="#Interactor-1618"><span class="linenos">1618</span></a>                    <span class="n">tool_id</span> <span class="o">=</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
</span><span id="Interactor-1619"><a href="#Interactor-1619"><span class="linenos">1619</span></a>                    <span class="k">if</span> <span class="n">tool_id</span><span class="p">:</span>
</span><span id="Interactor-1620"><a href="#Interactor-1620"><span class="linenos">1620</span></a>                        <span class="n">tool_id_to_chain</span><span class="p">[</span><span class="n">tool_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_id_to_chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tool_id</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Interactor-1621"><a href="#Interactor-1621"><span class="linenos">1621</span></a>
</span><span id="Interactor-1622"><a href="#Interactor-1622"><span class="linenos">1622</span></a>            <span class="c1"># For tool response messages</span>
</span><span id="Interactor-1623"><a href="#Interactor-1623"><span class="linenos">1623</span></a>            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tool&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">):</span>
</span><span id="Interactor-1624"><a href="#Interactor-1624"><span class="linenos">1624</span></a>                <span class="n">tool_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">)</span>
</span><span id="Interactor-1625"><a href="#Interactor-1625"><span class="linenos">1625</span></a>                <span class="n">tool_id_to_chain</span><span class="p">[</span><span class="n">tool_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_id_to_chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tool_id</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Interactor-1626"><a href="#Interactor-1626"><span class="linenos">1626</span></a>
</span><span id="Interactor-1627"><a href="#Interactor-1627"><span class="linenos">1627</span></a>            <span class="c1"># For Anthropic format with tool use</span>
</span><span id="Interactor-1628"><a href="#Interactor-1628"><span class="linenos">1628</span></a>            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Interactor-1629"><a href="#Interactor-1629"><span class="linenos">1629</span></a>                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Interactor-1630"><a href="#Interactor-1630"><span class="linenos">1630</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tool_use&quot;</span><span class="p">:</span>
</span><span id="Interactor-1631"><a href="#Interactor-1631"><span class="linenos">1631</span></a>                        <span class="n">tool_id</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
</span><span id="Interactor-1632"><a href="#Interactor-1632"><span class="linenos">1632</span></a>                        <span class="k">if</span> <span class="n">tool_id</span><span class="p">:</span>
</span><span id="Interactor-1633"><a href="#Interactor-1633"><span class="linenos">1633</span></a>                            <span class="n">tool_id_to_chain</span><span class="p">[</span><span class="n">tool_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_id_to_chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tool_id</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Interactor-1634"><a href="#Interactor-1634"><span class="linenos">1634</span></a>
</span><span id="Interactor-1635"><a href="#Interactor-1635"><span class="linenos">1635</span></a>            <span class="c1"># For Anthropic tool result messages</span>
</span><span id="Interactor-1636"><a href="#Interactor-1636"><span class="linenos">1636</span></a>            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Interactor-1637"><a href="#Interactor-1637"><span class="linenos">1637</span></a>                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Interactor-1638"><a href="#Interactor-1638"><span class="linenos">1638</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tool_result&quot;</span><span class="p">:</span>
</span><span id="Interactor-1639"><a href="#Interactor-1639"><span class="linenos">1639</span></a>                        <span class="n">tool_id</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use_id&quot;</span><span class="p">)</span>
</span><span id="Interactor-1640"><a href="#Interactor-1640"><span class="linenos">1640</span></a>                        <span class="k">if</span> <span class="n">tool_id</span><span class="p">:</span>
</span><span id="Interactor-1641"><a href="#Interactor-1641"><span class="linenos">1641</span></a>                            <span class="n">tool_id_to_chain</span><span class="p">[</span><span class="n">tool_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_id_to_chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tool_id</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="Interactor-1642"><a href="#Interactor-1642"><span class="linenos">1642</span></a>
</span><span id="Interactor-1643"><a href="#Interactor-1643"><span class="linenos">1643</span></a>        <span class="c1"># Group together all indices for each tool chain</span>
</span><span id="Interactor-1644"><a href="#Interactor-1644"><span class="linenos">1644</span></a>        <span class="k">for</span> <span class="n">tool_id</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">tool_id_to_chain</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Interactor-1645"><a href="#Interactor-1645"><span class="linenos">1645</span></a>            <span class="n">chain_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;tool_</span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># Group by the earliest message</span>
</span><span id="Interactor-1646"><a href="#Interactor-1646"><span class="linenos">1646</span></a>            <span class="k">if</span> <span class="n">chain_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tool_chain_groups</span><span class="p">:</span>
</span><span id="Interactor-1647"><a href="#Interactor-1647"><span class="linenos">1647</span></a>                <span class="n">tool_chain_groups</span><span class="p">[</span><span class="n">chain_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="Interactor-1648"><a href="#Interactor-1648"><span class="linenos">1648</span></a>            <span class="n">tool_chain_groups</span><span class="p">[</span><span class="n">chain_key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="Interactor-1649"><a href="#Interactor-1649"><span class="linenos">1649</span></a>
</span><span id="Interactor-1650"><a href="#Interactor-1650"><span class="linenos">1650</span></a>        <span class="c1"># Second pass: calculate tokens for each message</span>
</span><span id="Interactor-1651"><a href="#Interactor-1651"><span class="linenos">1651</span></a>        <span class="n">message_tokens</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-1652"><a href="#Interactor-1652"><span class="linenos">1652</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">):</span>
</span><span id="Interactor-1653"><a href="#Interactor-1653"><span class="linenos">1653</span></a>            <span class="c1"># Count tokens for this individual message</span>
</span><span id="Interactor-1654"><a href="#Interactor-1654"><span class="linenos">1654</span></a>            <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_tokens</span><span class="p">([</span><span class="n">msg</span><span class="p">])</span>
</span><span id="Interactor-1655"><a href="#Interactor-1655"><span class="linenos">1655</span></a>            <span class="n">message_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">tokens</span><span class="p">))</span>
</span><span id="Interactor-1656"><a href="#Interactor-1656"><span class="linenos">1656</span></a>
</span><span id="Interactor-1657"><a href="#Interactor-1657"><span class="linenos">1657</span></a>        <span class="c1"># Keep the messages identified as must-keep</span>
</span><span id="Interactor-1658"><a href="#Interactor-1658"><span class="linenos">1658</span></a>        <span class="n">keep_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">must_keep</span><span class="p">)</span>
</span><span id="Interactor-1659"><a href="#Interactor-1659"><span class="linenos">1659</span></a>
</span><span id="Interactor-1660"><a href="#Interactor-1660"><span class="linenos">1660</span></a>        <span class="c1"># Calculate the tokens we&#39;ve committed to keeping</span>
</span><span id="Interactor-1661"><a href="#Interactor-1661"><span class="linenos">1661</span></a>        <span class="n">keep_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">message_tokens</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keep_indices</span><span class="p">)</span>
</span><span id="Interactor-1662"><a href="#Interactor-1662"><span class="linenos">1662</span></a>
</span><span id="Interactor-1663"><a href="#Interactor-1663"><span class="linenos">1663</span></a>        <span class="c1"># Check if we&#39;ve already exceeded the target with just must-keep messages</span>
</span><span id="Interactor-1664"><a href="#Interactor-1664"><span class="linenos">1664</span></a>        <span class="k">if</span> <span class="n">keep_tokens</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="p">:</span>
</span><span id="Interactor-1665"><a href="#Interactor-1665"><span class="linenos">1665</span></a>            <span class="c1"># We&#39;re in trouble - the essential messages alone exceed context</span>
</span><span id="Interactor-1666"><a href="#Interactor-1666"><span class="linenos">1666</span></a>            <span class="c1"># Drop older messages until we&#39;re under the limit</span>
</span><span id="Interactor-1667"><a href="#Interactor-1667"><span class="linenos">1667</span></a>            <span class="n">all_indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keep_indices</span><span class="p">)</span>
</span><span id="Interactor-1668"><a href="#Interactor-1668"><span class="linenos">1668</span></a>
</span><span id="Interactor-1669"><a href="#Interactor-1669"><span class="linenos">1669</span></a>            <span class="c1"># Start dropping oldest messages, but NEVER drop system messages</span>
</span><span id="Interactor-1670"><a href="#Interactor-1670"><span class="linenos">1670</span></a>            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">all_indices</span><span class="p">:</span>
</span><span id="Interactor-1671"><a href="#Interactor-1671"><span class="linenos">1671</span></a>                <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">system_indices</span><span class="p">:</span>
</span><span id="Interactor-1672"><a href="#Interactor-1672"><span class="linenos">1672</span></a>                    <span class="n">keep_indices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="Interactor-1673"><a href="#Interactor-1673"><span class="linenos">1673</span></a>                    <span class="n">keep_tokens</span> <span class="o">-=</span> <span class="n">message_tokens</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Interactor-1674"><a href="#Interactor-1674"><span class="linenos">1674</span></a>                    <span class="k">if</span> <span class="n">keep_tokens</span> <span class="o">&lt;=</span> <span class="n">target_tokens</span><span class="p">:</span>
</span><span id="Interactor-1675"><a href="#Interactor-1675"><span class="linenos">1675</span></a>                        <span class="k">break</span>
</span><span id="Interactor-1676"><a href="#Interactor-1676"><span class="linenos">1676</span></a>
</span><span id="Interactor-1677"><a href="#Interactor-1677"><span class="linenos">1677</span></a>            <span class="c1"># If we&#39;ve removed everything but system messages and still over limit</span>
</span><span id="Interactor-1678"><a href="#Interactor-1678"><span class="linenos">1678</span></a>            <span class="k">if</span> <span class="n">keep_tokens</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="p">:</span>
</span><span id="Interactor-1679"><a href="#Interactor-1679"><span class="linenos">1679</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TRIM] Critical failure: even with minimal context (</span><span class="si">{</span><span class="n">keep_tokens</span><span class="si">}</span><span class="s2"> tokens), we exceed the limit&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="Interactor-1680"><a href="#Interactor-1680"><span class="linenos">1680</span></a>                <span class="c1"># Keep only system messages if any</span>
</span><span id="Interactor-1681"><a href="#Interactor-1681"><span class="linenos">1681</span></a>                <span class="n">keep_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">system_indices</span><span class="p">)</span>
</span><span id="Interactor-1682"><a href="#Interactor-1682"><span class="linenos">1682</span></a>                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Context exceeded completely</span>
</span><span id="Interactor-1683"><a href="#Interactor-1683"><span class="linenos">1683</span></a>
</span><span id="Interactor-1684"><a href="#Interactor-1684"><span class="linenos">1684</span></a>        <span class="c1"># Third pass: keep the most important tool chains intact</span>
</span><span id="Interactor-1685"><a href="#Interactor-1685"><span class="linenos">1685</span></a>        <span class="n">available_tokens</span> <span class="o">=</span> <span class="n">target_tokens</span> <span class="o">-</span> <span class="n">keep_tokens</span>
</span><span id="Interactor-1686"><a href="#Interactor-1686"><span class="linenos">1686</span></a>        <span class="c1"># Sort tool chains by recency (assumed by the chain_key which uses the earliest message)</span>
</span><span id="Interactor-1687"><a href="#Interactor-1687"><span class="linenos">1687</span></a>        <span class="n">sorted_chains</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tool_chain_groups</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Interactor-1688"><a href="#Interactor-1688"><span class="linenos">1688</span></a>
</span><span id="Interactor-1689"><a href="#Interactor-1689"><span class="linenos">1689</span></a>        <span class="k">for</span> <span class="n">chain_key</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">sorted_chains</span><span class="p">:</span>
</span><span id="Interactor-1690"><a href="#Interactor-1690"><span class="linenos">1690</span></a>            <span class="c1"># Skip if we&#39;ve already decided to keep all messages in this chain</span>
</span><span id="Interactor-1691"><a href="#Interactor-1691"><span class="linenos">1691</span></a>            <span class="k">if</span> <span class="n">indices</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">keep_indices</span><span class="p">):</span>
</span><span id="Interactor-1692"><a href="#Interactor-1692"><span class="linenos">1692</span></a>                <span class="k">continue</span>
</span><span id="Interactor-1693"><a href="#Interactor-1693"><span class="linenos">1693</span></a>
</span><span id="Interactor-1694"><a href="#Interactor-1694"><span class="linenos">1694</span></a>            <span class="c1"># Calculate how many tokens this chain would add</span>
</span><span id="Interactor-1695"><a href="#Interactor-1695"><span class="linenos">1695</span></a>            <span class="n">chain_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tokens</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">message_tokens</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_indices</span><span class="p">)</span>
</span><span id="Interactor-1696"><a href="#Interactor-1696"><span class="linenos">1696</span></a>
</span><span id="Interactor-1697"><a href="#Interactor-1697"><span class="linenos">1697</span></a>            <span class="c1"># If we can fit the entire chain, keep it</span>
</span><span id="Interactor-1698"><a href="#Interactor-1698"><span class="linenos">1698</span></a>            <span class="k">if</span> <span class="n">chain_tokens</span> <span class="o">&lt;=</span> <span class="n">available_tokens</span><span class="p">:</span>
</span><span id="Interactor-1699"><a href="#Interactor-1699"><span class="linenos">1699</span></a>                <span class="n">keep_indices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
</span><span id="Interactor-1700"><a href="#Interactor-1700"><span class="linenos">1700</span></a>                <span class="n">available_tokens</span> <span class="o">-=</span> <span class="n">chain_tokens</span>
</span><span id="Interactor-1701"><a href="#Interactor-1701"><span class="linenos">1701</span></a>            <span class="c1"># Otherwise, we might want to keep partial chains in the future, but for now, skip</span>
</span><span id="Interactor-1702"><a href="#Interactor-1702"><span class="linenos">1702</span></a>
</span><span id="Interactor-1703"><a href="#Interactor-1703"><span class="linenos">1703</span></a>        <span class="c1"># Fourth pass: fill in with as many remaining messages as possible, prioritizing recency</span>
</span><span id="Interactor-1704"><a href="#Interactor-1704"><span class="linenos">1704</span></a>        <span class="c1"># Get remaining messages sorted by recency (newest first)</span>
</span><span id="Interactor-1705"><a href="#Interactor-1705"><span class="linenos">1705</span></a>        <span class="n">remaining_indices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">message_tokens</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_indices</span><span class="p">]</span>
</span><span id="Interactor-1706"><a href="#Interactor-1706"><span class="linenos">1706</span></a>        <span class="n">remaining_indices</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Sort newest first</span>
</span><span id="Interactor-1707"><a href="#Interactor-1707"><span class="linenos">1707</span></a>
</span><span id="Interactor-1708"><a href="#Interactor-1708"><span class="linenos">1708</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">remaining_indices</span><span class="p">:</span>
</span><span id="Interactor-1709"><a href="#Interactor-1709"><span class="linenos">1709</span></a>            <span class="k">if</span> <span class="n">tokens</span> <span class="o">&lt;=</span> <span class="n">available_tokens</span><span class="p">:</span>
</span><span id="Interactor-1710"><a href="#Interactor-1710"><span class="linenos">1710</span></a>                <span class="n">keep_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="Interactor-1711"><a href="#Interactor-1711"><span class="linenos">1711</span></a>                <span class="n">available_tokens</span> <span class="o">-=</span> <span class="n">tokens</span>
</span><span id="Interactor-1712"><a href="#Interactor-1712"><span class="linenos">1712</span></a>
</span><span id="Interactor-1713"><a href="#Interactor-1713"><span class="linenos">1713</span></a>        <span class="c1"># Final message reconstruction</span>
</span><span id="Interactor-1714"><a href="#Interactor-1714"><span class="linenos">1714</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TRIM] Keeping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">keep_indices</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages, estimated </span><span class="si">{</span><span class="n">target_tokens</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">available_tokens</span><span class="si">}</span><span class="s2"> tokens&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
</span><span id="Interactor-1715"><a href="#Interactor-1715"><span class="linenos">1715</span></a>
</span><span id="Interactor-1716"><a href="#Interactor-1716"><span class="linenos">1716</span></a>        <span class="c1"># Create new history with just the kept messages, preserving order</span>
</span><span id="Interactor-1717"><a href="#Interactor-1717"><span class="linenos">1717</span></a>        <span class="n">new_history</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keep_indices</span><span class="p">)]</span>
</span><span id="Interactor-1718"><a href="#Interactor-1718"><span class="linenos">1718</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">new_history</span>
</span><span id="Interactor-1719"><a href="#Interactor-1719"><span class="linenos">1719</span></a>
</span><span id="Interactor-1720"><a href="#Interactor-1720"><span class="linenos">1720</span></a>        <span class="c1"># Update session_history to match the pruned history</span>
</span><span id="Interactor-1721"><a href="#Interactor-1721"><span class="linenos">1721</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;session_history&quot;</span><span class="p">):</span>
</span><span id="Interactor-1722"><a href="#Interactor-1722"><span class="linenos">1722</span></a>            <span class="c1"># Map between history items and session_history</span>
</span><span id="Interactor-1723"><a href="#Interactor-1723"><span class="linenos">1723</span></a>            <span class="n">session_to_keep</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-1724"><a href="#Interactor-1724"><span class="linenos">1724</span></a>
</span><span id="Interactor-1725"><a href="#Interactor-1725"><span class="linenos">1725</span></a>            <span class="c1"># For each session history message, check if it corresponds to a kept message</span>
</span><span id="Interactor-1726"><a href="#Interactor-1726"><span class="linenos">1726</span></a>            <span class="k">for</span> <span class="n">session_msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="p">:</span>
</span><span id="Interactor-1727"><a href="#Interactor-1727"><span class="linenos">1727</span></a>                <span class="c1"># Keep system messages</span>
</span><span id="Interactor-1728"><a href="#Interactor-1728"><span class="linenos">1728</span></a>                <span class="k">if</span> <span class="n">session_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="Interactor-1729"><a href="#Interactor-1729"><span class="linenos">1729</span></a>                    <span class="n">session_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_msg</span><span class="p">)</span>
</span><span id="Interactor-1730"><a href="#Interactor-1730"><span class="linenos">1730</span></a>                    <span class="k">continue</span>
</span><span id="Interactor-1731"><a href="#Interactor-1731"><span class="linenos">1731</span></a>
</span><span id="Interactor-1732"><a href="#Interactor-1732"><span class="linenos">1732</span></a>                <span class="c1"># Try to match based on available IDs or content</span>
</span><span id="Interactor-1733"><a href="#Interactor-1733"><span class="linenos">1733</span></a>                <span class="n">msg_id</span> <span class="o">=</span> <span class="n">session_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
</span><span id="Interactor-1734"><a href="#Interactor-1734"><span class="linenos">1734</span></a>
</span><span id="Interactor-1735"><a href="#Interactor-1735"><span class="linenos">1735</span></a>                <span class="c1"># For tool messages, check tool_info.id against tool_call_id</span>
</span><span id="Interactor-1736"><a href="#Interactor-1736"><span class="linenos">1736</span></a>                <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">session_msg</span> <span class="ow">and</span> <span class="s2">&quot;tool_info&quot;</span> <span class="ow">in</span> <span class="n">session_msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]:</span>
</span><span id="Interactor-1737"><a href="#Interactor-1737"><span class="linenos">1737</span></a>                    <span class="n">tool_id</span> <span class="o">=</span> <span class="n">session_msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
</span><span id="Interactor-1738"><a href="#Interactor-1738"><span class="linenos">1738</span></a>
</span><span id="Interactor-1739"><a href="#Interactor-1739"><span class="linenos">1739</span></a>                    <span class="c1"># Check if this tool_id is still in the kept history</span>
</span><span id="Interactor-1740"><a href="#Interactor-1740"><span class="linenos">1740</span></a>                    <span class="k">for</span> <span class="n">history_msg</span> <span class="ow">in</span> <span class="n">new_history</span><span class="p">:</span>
</span><span id="Interactor-1741"><a href="#Interactor-1741"><span class="linenos">1741</span></a>                        <span class="c1"># Check standard ids</span>
</span><span id="Interactor-1742"><a href="#Interactor-1742"><span class="linenos">1742</span></a>                        <span class="n">history_tool_id</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-1743"><a href="#Interactor-1743"><span class="linenos">1743</span></a>
</span><span id="Interactor-1744"><a href="#Interactor-1744"><span class="linenos">1744</span></a>                        <span class="c1"># Check OpenAI format</span>
</span><span id="Interactor-1745"><a href="#Interactor-1745"><span class="linenos">1745</span></a>                        <span class="k">if</span> <span class="n">history_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tool&quot;</span><span class="p">:</span>
</span><span id="Interactor-1746"><a href="#Interactor-1746"><span class="linenos">1746</span></a>                            <span class="n">history_tool_id</span> <span class="o">=</span> <span class="n">history_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">)</span>
</span><span id="Interactor-1747"><a href="#Interactor-1747"><span class="linenos">1747</span></a>                        <span class="k">elif</span> <span class="n">history_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span> <span class="ow">and</span> <span class="n">history_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">):</span>
</span><span id="Interactor-1748"><a href="#Interactor-1748"><span class="linenos">1748</span></a>                            <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">history_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Interactor-1749"><a href="#Interactor-1749"><span class="linenos">1749</span></a>                                <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">tool_id</span><span class="p">:</span>
</span><span id="Interactor-1750"><a href="#Interactor-1750"><span class="linenos">1750</span></a>                                    <span class="n">history_tool_id</span> <span class="o">=</span> <span class="n">call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
</span><span id="Interactor-1751"><a href="#Interactor-1751"><span class="linenos">1751</span></a>                                    <span class="k">break</span>
</span><span id="Interactor-1752"><a href="#Interactor-1752"><span class="linenos">1752</span></a>
</span><span id="Interactor-1753"><a href="#Interactor-1753"><span class="linenos">1753</span></a>                        <span class="c1"># Check Anthropic format</span>
</span><span id="Interactor-1754"><a href="#Interactor-1754"><span class="linenos">1754</span></a>                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">history_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">),</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Interactor-1755"><a href="#Interactor-1755"><span class="linenos">1755</span></a>                            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">history_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Interactor-1756"><a href="#Interactor-1756"><span class="linenos">1756</span></a>                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="Interactor-1757"><a href="#Interactor-1757"><span class="linenos">1757</span></a>                                    <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tool_use&quot;</span> <span class="ow">and</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">tool_id</span><span class="p">:</span>
</span><span id="Interactor-1758"><a href="#Interactor-1758"><span class="linenos">1758</span></a>                                        <span class="n">history_tool_id</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
</span><span id="Interactor-1759"><a href="#Interactor-1759"><span class="linenos">1759</span></a>                                        <span class="k">break</span>
</span><span id="Interactor-1760"><a href="#Interactor-1760"><span class="linenos">1760</span></a>                                    <span class="k">elif</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;tool_result&quot;</span> <span class="ow">and</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use_id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">tool_id</span><span class="p">:</span>
</span><span id="Interactor-1761"><a href="#Interactor-1761"><span class="linenos">1761</span></a>                                        <span class="n">history_tool_id</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use_id&quot;</span><span class="p">)</span>
</span><span id="Interactor-1762"><a href="#Interactor-1762"><span class="linenos">1762</span></a>                                        <span class="k">break</span>
</span><span id="Interactor-1763"><a href="#Interactor-1763"><span class="linenos">1763</span></a>
</span><span id="Interactor-1764"><a href="#Interactor-1764"><span class="linenos">1764</span></a>                        <span class="k">if</span> <span class="n">history_tool_id</span> <span class="o">==</span> <span class="n">tool_id</span><span class="p">:</span>
</span><span id="Interactor-1765"><a href="#Interactor-1765"><span class="linenos">1765</span></a>                            <span class="n">session_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_msg</span><span class="p">)</span>
</span><span id="Interactor-1766"><a href="#Interactor-1766"><span class="linenos">1766</span></a>                            <span class="k">break</span>
</span><span id="Interactor-1767"><a href="#Interactor-1767"><span class="linenos">1767</span></a>
</span><span id="Interactor-1768"><a href="#Interactor-1768"><span class="linenos">1768</span></a>                <span class="c1"># For regular messages, try content matching as fallback</span>
</span><span id="Interactor-1769"><a href="#Interactor-1769"><span class="linenos">1769</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1770"><a href="#Interactor-1770"><span class="linenos">1770</span></a>                    <span class="n">content_match</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Interactor-1771"><a href="#Interactor-1771"><span class="linenos">1771</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">session_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">session_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">):</span>
</span><span id="Interactor-1772"><a href="#Interactor-1772"><span class="linenos">1772</span></a>                        <span class="k">for</span> <span class="n">history_msg</span> <span class="ow">in</span> <span class="n">new_history</span><span class="p">:</span>
</span><span id="Interactor-1773"><a href="#Interactor-1773"><span class="linenos">1773</span></a>                            <span class="k">if</span> <span class="n">history_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">session_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">history_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">session_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">):</span>
</span><span id="Interactor-1774"><a href="#Interactor-1774"><span class="linenos">1774</span></a>                                <span class="n">content_match</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor-1775"><a href="#Interactor-1775"><span class="linenos">1775</span></a>                                <span class="k">break</span>
</span><span id="Interactor-1776"><a href="#Interactor-1776"><span class="linenos">1776</span></a>
</span><span id="Interactor-1777"><a href="#Interactor-1777"><span class="linenos">1777</span></a>                    <span class="k">if</span> <span class="n">content_match</span><span class="p">:</span>
</span><span id="Interactor-1778"><a href="#Interactor-1778"><span class="linenos">1778</span></a>                        <span class="n">session_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_msg</span><span class="p">)</span>
</span><span id="Interactor-1779"><a href="#Interactor-1779"><span class="linenos">1779</span></a>
</span><span id="Interactor-1780"><a href="#Interactor-1780"><span class="linenos">1780</span></a>            <span class="c1"># Update session_history with kept messages</span>
</span><span id="Interactor-1781"><a href="#Interactor-1781"><span class="linenos">1781</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span> <span class="o">=</span> <span class="n">session_to_keep</span>
</span><span id="Interactor-1782"><a href="#Interactor-1782"><span class="linenos">1782</span></a>
</span><span id="Interactor-1783"><a href="#Interactor-1783"><span class="linenos">1783</span></a>            <span class="c1"># Re-normalize to ensure consistency</span>
</span><span id="Interactor-1784"><a href="#Interactor-1784"><span class="linenos">1784</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Interactor-1785"><a href="#Interactor-1785"><span class="linenos">1785</span></a>
</span><span id="Interactor-1786"><a href="#Interactor-1786"><span class="linenos">1786</span></a>        <span class="c1"># Verify our final token count</span>
</span><span id="Interactor-1787"><a href="#Interactor-1787"><span class="linenos">1787</span></a>        <span class="n">final_token_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_tokens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="Interactor-1788"><a href="#Interactor-1788"><span class="linenos">1788</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TRIM] Final history has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages, </span><span class="si">{</span><span class="n">final_token_count</span><span class="si">}</span><span class="s2"> tokens&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
</span><span id="Interactor-1789"><a href="#Interactor-1789"><span class="linenos">1789</span></a>
</span><span id="Interactor-1790"><a href="#Interactor-1790"><span class="linenos">1790</span></a>        <span class="c1"># Return whether we&#39;ve completely exceeded context</span>
</span><span id="Interactor-1791"><a href="#Interactor-1791"><span class="linenos">1791</span></a>        <span class="k">return</span> <span class="n">final_token_count</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_indices</span><span class="p">)</span>
</span><span id="Interactor-1792"><a href="#Interactor-1792"><span class="linenos">1792</span></a>
</span><span id="Interactor-1793"><a href="#Interactor-1793"><span class="linenos">1793</span></a>
</span><span id="Interactor-1794"><a href="#Interactor-1794"><span class="linenos">1794</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">messages_add</span><span class="p">(</span>
</span><span id="Interactor-1795"><a href="#Interactor-1795"><span class="linenos">1795</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor-1796"><a href="#Interactor-1796"><span class="linenos">1796</span></a>        <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Interactor-1797"><a href="#Interactor-1797"><span class="linenos">1797</span></a>        <span class="n">content</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="Interactor-1798"><a href="#Interactor-1798"><span class="linenos">1798</span></a>        <span class="n">tool_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor-1799"><a href="#Interactor-1799"><span class="linenos">1799</span></a>        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor-1800"><a href="#Interactor-1800"><span class="linenos">1800</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Interactor-1801"><a href="#Interactor-1801"><span class="linenos">1801</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor-1802"><a href="#Interactor-1802"><span class="linenos">1802</span></a><span class="sd">        Add a message to the standardized session_history and then update SDK-specific history.</span>
</span><span id="Interactor-1803"><a href="#Interactor-1803"><span class="linenos">1803</span></a><span class="sd">        </span>
</span><span id="Interactor-1804"><a href="#Interactor-1804"><span class="linenos">1804</span></a><span class="sd">        This method is the central point for all message additions to the conversation.</span>
</span><span id="Interactor-1805"><a href="#Interactor-1805"><span class="linenos">1805</span></a><span class="sd">        </span>
</span><span id="Interactor-1806"><a href="#Interactor-1806"><span class="linenos">1806</span></a><span class="sd">        Args:</span>
</span><span id="Interactor-1807"><a href="#Interactor-1807"><span class="linenos">1807</span></a><span class="sd">            role: The role of the message (&quot;user&quot;, &quot;assistant&quot;, &quot;system&quot;, &quot;tool&quot;)</span>
</span><span id="Interactor-1808"><a href="#Interactor-1808"><span class="linenos">1808</span></a><span class="sd">            content: The message content (text or structured)</span>
</span><span id="Interactor-1809"><a href="#Interactor-1809"><span class="linenos">1809</span></a><span class="sd">            tool_info: Optional tool-related metadata</span>
</span><span id="Interactor-1810"><a href="#Interactor-1810"><span class="linenos">1810</span></a><span class="sd">            normalize: Whether to normalize history after adding this message</span>
</span><span id="Interactor-1811"><a href="#Interactor-1811"><span class="linenos">1811</span></a><span class="sd">            </span>
</span><span id="Interactor-1812"><a href="#Interactor-1812"><span class="linenos">1812</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-1813"><a href="#Interactor-1813"><span class="linenos">1813</span></a><span class="sd">            str: Unique ID of the added message</span>
</span><span id="Interactor-1814"><a href="#Interactor-1814"><span class="linenos">1814</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-1815"><a href="#Interactor-1815"><span class="linenos">1815</span></a>        <span class="c1"># Generate a unique message ID</span>
</span><span id="Interactor-1816"><a href="#Interactor-1816"><span class="linenos">1816</span></a>        <span class="n">message_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="Interactor-1817"><a href="#Interactor-1817"><span class="linenos">1817</span></a>        
</span><span id="Interactor-1818"><a href="#Interactor-1818"><span class="linenos">1818</span></a>        <span class="c1"># Create the standardized message for session_history</span>
</span><span id="Interactor-1819"><a href="#Interactor-1819"><span class="linenos">1819</span></a>        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="Interactor-1820"><a href="#Interactor-1820"><span class="linenos">1820</span></a>        
</span><span id="Interactor-1821"><a href="#Interactor-1821"><span class="linenos">1821</span></a>        <span class="c1"># Store system messages directly</span>
</span><span id="Interactor-1822"><a href="#Interactor-1822"><span class="linenos">1822</span></a>        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="Interactor-1823"><a href="#Interactor-1823"><span class="linenos">1823</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="Interactor-1824"><a href="#Interactor-1824"><span class="linenos">1824</span></a>        
</span><span id="Interactor-1825"><a href="#Interactor-1825"><span class="linenos">1825</span></a>        <span class="c1"># Create standard format message</span>
</span><span id="Interactor-1826"><a href="#Interactor-1826"><span class="linenos">1826</span></a>        <span class="n">standard_message</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1827"><a href="#Interactor-1827"><span class="linenos">1827</span></a>            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
</span><span id="Interactor-1828"><a href="#Interactor-1828"><span class="linenos">1828</span></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
</span><span id="Interactor-1829"><a href="#Interactor-1829"><span class="linenos">1829</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">message_id</span><span class="p">,</span>
</span><span id="Interactor-1830"><a href="#Interactor-1830"><span class="linenos">1830</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span><span id="Interactor-1831"><a href="#Interactor-1831"><span class="linenos">1831</span></a>            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-1832"><a href="#Interactor-1832"><span class="linenos">1832</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span>
</span><span id="Interactor-1833"><a href="#Interactor-1833"><span class="linenos">1833</span></a>            <span class="p">}</span>
</span><span id="Interactor-1834"><a href="#Interactor-1834"><span class="linenos">1834</span></a>        <span class="p">}</span>
</span><span id="Interactor-1835"><a href="#Interactor-1835"><span class="linenos">1835</span></a>        
</span><span id="Interactor-1836"><a href="#Interactor-1836"><span class="linenos">1836</span></a>        <span class="c1"># Add tool info if provided</span>
</span><span id="Interactor-1837"><a href="#Interactor-1837"><span class="linenos">1837</span></a>        <span class="k">if</span> <span class="n">tool_info</span><span class="p">:</span>
</span><span id="Interactor-1838"><a href="#Interactor-1838"><span class="linenos">1838</span></a>            <span class="n">standard_message</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_info</span>
</span><span id="Interactor-1839"><a href="#Interactor-1839"><span class="linenos">1839</span></a>        
</span><span id="Interactor-1840"><a href="#Interactor-1840"><span class="linenos">1840</span></a>        <span class="c1"># Add to session_history</span>
</span><span id="Interactor-1841"><a href="#Interactor-1841"><span class="linenos">1841</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;session_history&quot;</span><span class="p">):</span>
</span><span id="Interactor-1842"><a href="#Interactor-1842"><span class="linenos">1842</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-1843"><a href="#Interactor-1843"><span class="linenos">1843</span></a>        
</span><span id="Interactor-1844"><a href="#Interactor-1844"><span class="linenos">1844</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">standard_message</span><span class="p">)</span>
</span><span id="Interactor-1845"><a href="#Interactor-1845"><span class="linenos">1845</span></a>        
</span><span id="Interactor-1846"><a href="#Interactor-1846"><span class="linenos">1846</span></a>        <span class="c1"># Save to persistent session if enabled</span>
</span><span id="Interactor-1847"><a href="#Interactor-1847"><span class="linenos">1847</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">:</span>
</span><span id="Interactor-1848"><a href="#Interactor-1848"><span class="linenos">1848</span></a>            <span class="c1"># Convert standard message to session-compatible format</span>
</span><span id="Interactor-1849"><a href="#Interactor-1849"><span class="linenos">1849</span></a>            <span class="n">session_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1850"><a href="#Interactor-1850"><span class="linenos">1850</span></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
</span><span id="Interactor-1851"><a href="#Interactor-1851"><span class="linenos">1851</span></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
</span><span id="Interactor-1852"><a href="#Interactor-1852"><span class="linenos">1852</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">message_id</span><span class="p">,</span>
</span><span id="Interactor-1853"><a href="#Interactor-1853"><span class="linenos">1853</span></a>                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span>
</span><span id="Interactor-1854"><a href="#Interactor-1854"><span class="linenos">1854</span></a>            <span class="p">}</span>
</span><span id="Interactor-1855"><a href="#Interactor-1855"><span class="linenos">1855</span></a>            
</span><span id="Interactor-1856"><a href="#Interactor-1856"><span class="linenos">1856</span></a>            <span class="c1"># Add tool-related fields if present</span>
</span><span id="Interactor-1857"><a href="#Interactor-1857"><span class="linenos">1857</span></a>            <span class="k">if</span> <span class="n">tool_info</span><span class="p">:</span>
</span><span id="Interactor-1858"><a href="#Interactor-1858"><span class="linenos">1858</span></a>                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tool_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Interactor-1859"><a href="#Interactor-1859"><span class="linenos">1859</span></a>                    <span class="n">session_msg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="Interactor-1860"><a href="#Interactor-1860"><span class="linenos">1860</span></a>            
</span><span id="Interactor-1861"><a href="#Interactor-1861"><span class="linenos">1861</span></a>            <span class="c1"># Store in session</span>
</span><span id="Interactor-1862"><a href="#Interactor-1862"><span class="linenos">1862</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">msg_insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">session_msg</span><span class="p">)</span>
</span><span id="Interactor-1863"><a href="#Interactor-1863"><span class="linenos">1863</span></a>        
</span><span id="Interactor-1864"><a href="#Interactor-1864"><span class="linenos">1864</span></a>        <span class="c1"># Update the SDK-specific format in self.history by running the normalizer</span>
</span><span id="Interactor-1865"><a href="#Interactor-1865"><span class="linenos">1865</span></a>        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
</span><span id="Interactor-1866"><a href="#Interactor-1866"><span class="linenos">1866</span></a>            <span class="c1"># We only need to normalize the most recent message for efficiency</span>
</span><span id="Interactor-1867"><a href="#Interactor-1867"><span class="linenos">1867</span></a>            <span class="c1"># Pass a flag indicating we&#39;re just normalizing a new message</span>
</span><span id="Interactor-1868"><a href="#Interactor-1868"><span class="linenos">1868</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">new_message_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Interactor-1869"><a href="#Interactor-1869"><span class="linenos">1869</span></a>        
</span><span id="Interactor-1870"><a href="#Interactor-1870"><span class="linenos">1870</span></a>        <span class="c1"># Log the added message</span>
</span><span id="Interactor-1871"><a href="#Interactor-1871"><span class="linenos">1871</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MESSAGE ADDED] </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="Interactor-1872"><a href="#Interactor-1872"><span class="linenos">1872</span></a>        
</span><span id="Interactor-1873"><a href="#Interactor-1873"><span class="linenos">1873</span></a>        <span class="k">return</span> <span class="n">message_id</span>
</span><span id="Interactor-1874"><a href="#Interactor-1874"><span class="linenos">1874</span></a>
</span><span id="Interactor-1875"><a href="#Interactor-1875"><span class="linenos">1875</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">messages_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor-1876"><a href="#Interactor-1876"><span class="linenos">1876</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set or retrieve the current system prompt.&quot;&quot;&quot;</span>
</span><span id="Interactor-1877"><a href="#Interactor-1877"><span class="linenos">1877</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">prompt</span><span class="p">:</span>
</span><span id="Interactor-1878"><a href="#Interactor-1878"><span class="linenos">1878</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
</span><span id="Interactor-1879"><a href="#Interactor-1879"><span class="linenos">1879</span></a>
</span><span id="Interactor-1880"><a href="#Interactor-1880"><span class="linenos">1880</span></a>        <span class="c1"># If the prompt hasn&#39;t changed, don&#39;t do anything</span>
</span><span id="Interactor-1881"><a href="#Interactor-1881"><span class="linenos">1881</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">==</span> <span class="n">prompt</span><span class="p">:</span>
</span><span id="Interactor-1882"><a href="#Interactor-1882"><span class="linenos">1882</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
</span><span id="Interactor-1883"><a href="#Interactor-1883"><span class="linenos">1883</span></a>
</span><span id="Interactor-1884"><a href="#Interactor-1884"><span class="linenos">1884</span></a>        <span class="c1"># Update the system prompt</span>
</span><span id="Interactor-1885"><a href="#Interactor-1885"><span class="linenos">1885</span></a>        <span class="n">old_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
</span><span id="Interactor-1886"><a href="#Interactor-1886"><span class="linenos">1886</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">prompt</span>
</span><span id="Interactor-1887"><a href="#Interactor-1887"><span class="linenos">1887</span></a>
</span><span id="Interactor-1888"><a href="#Interactor-1888"><span class="linenos">1888</span></a>        <span class="c1"># For OpenAI, update or insert the system message in history</span>
</span><span id="Interactor-1889"><a href="#Interactor-1889"><span class="linenos">1889</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
</span><span id="Interactor-1890"><a href="#Interactor-1890"><span class="linenos">1890</span></a>            <span class="c1"># Check if there&#39;s already a system message</span>
</span><span id="Interactor-1891"><a href="#Interactor-1891"><span class="linenos">1891</span></a>            <span class="n">system_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="Interactor-1892"><a href="#Interactor-1892"><span class="linenos">1892</span></a>                                <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-1893"><a href="#Interactor-1893"><span class="linenos">1893</span></a>
</span><span id="Interactor-1894"><a href="#Interactor-1894"><span class="linenos">1894</span></a>            <span class="k">if</span> <span class="n">system_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Interactor-1895"><a href="#Interactor-1895"><span class="linenos">1895</span></a>                <span class="c1"># Update existing system message</span>
</span><span id="Interactor-1896"><a href="#Interactor-1896"><span class="linenos">1896</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">system_index</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt</span>
</span><span id="Interactor-1897"><a href="#Interactor-1897"><span class="linenos">1897</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1898"><a href="#Interactor-1898"><span class="linenos">1898</span></a>                <span class="c1"># Insert new system message at the beginning</span>
</span><span id="Interactor-1899"><a href="#Interactor-1899"><span class="linenos">1899</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">})</span>
</span><span id="Interactor-1900"><a href="#Interactor-1900"><span class="linenos">1900</span></a>
</span><span id="Interactor-1901"><a href="#Interactor-1901"><span class="linenos">1901</span></a>        <span class="c1"># For Anthropic, system message is not part of history, just save it for API calls</span>
</span><span id="Interactor-1902"><a href="#Interactor-1902"><span class="linenos">1902</span></a>
</span><span id="Interactor-1903"><a href="#Interactor-1903"><span class="linenos">1903</span></a>        <span class="c1"># Log to session only if prompt actually changed</span>
</span><span id="Interactor-1904"><a href="#Interactor-1904"><span class="linenos">1904</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">and</span> <span class="n">old_system</span> <span class="o">!=</span> <span class="n">prompt</span><span class="p">:</span>
</span><span id="Interactor-1905"><a href="#Interactor-1905"><span class="linenos">1905</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">msg_insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">})</span>
</span><span id="Interactor-1906"><a href="#Interactor-1906"><span class="linenos">1906</span></a>
</span><span id="Interactor-1907"><a href="#Interactor-1907"><span class="linenos">1907</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
</span><span id="Interactor-1908"><a href="#Interactor-1908"><span class="linenos">1908</span></a>
</span><span id="Interactor-1909"><a href="#Interactor-1909"><span class="linenos">1909</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">messages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Interactor-1910"><a href="#Interactor-1910"><span class="linenos">1910</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return full session messages (persisted or in-memory).&quot;&quot;&quot;</span>
</span><span id="Interactor-1911"><a href="#Interactor-1911"><span class="linenos">1911</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">:</span>
</span><span id="Interactor-1912"><a href="#Interactor-1912"><span class="linenos">1912</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">load_full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Interactor-1913"><a href="#Interactor-1913"><span class="linenos">1913</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span>
</span><span id="Interactor-1914"><a href="#Interactor-1914"><span class="linenos">1914</span></a>
</span><span id="Interactor-1915"><a href="#Interactor-1915"><span class="linenos">1915</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">messages_length</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Interactor-1916"><a href="#Interactor-1916"><span class="linenos">1916</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the total token count for the message history.&quot;&quot;&quot;</span>
</span><span id="Interactor-1917"><a href="#Interactor-1917"><span class="linenos">1917</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span>
</span><span id="Interactor-1918"><a href="#Interactor-1918"><span class="linenos">1918</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="Interactor-1919"><a href="#Interactor-1919"><span class="linenos">1919</span></a>
</span><span id="Interactor-1920"><a href="#Interactor-1920"><span class="linenos">1920</span></a>        <span class="n">total_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Interactor-1921"><a href="#Interactor-1921"><span class="linenos">1921</span></a>        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
</span><span id="Interactor-1922"><a href="#Interactor-1922"><span class="linenos">1922</span></a>            <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">):</span>
</span><span id="Interactor-1923"><a href="#Interactor-1923"><span class="linenos">1923</span></a>                <span class="n">total_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]))</span>
</span><span id="Interactor-1924"><a href="#Interactor-1924"><span class="linenos">1924</span></a>            <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">):</span>
</span><span id="Interactor-1925"><a href="#Interactor-1925"><span class="linenos">1925</span></a>                <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">]:</span>
</span><span id="Interactor-1926"><a href="#Interactor-1926"><span class="linenos">1926</span></a>                    <span class="k">if</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">):</span>
</span><span id="Interactor-1927"><a href="#Interactor-1927"><span class="linenos">1927</span></a>                        <span class="n">total_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tool_call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor-1928"><a href="#Interactor-1928"><span class="linenos">1928</span></a>                        <span class="n">total_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tool_call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor-1929"><a href="#Interactor-1929"><span class="linenos">1929</span></a>        <span class="k">return</span> <span class="n">total_tokens</span>
</span><span id="Interactor-1930"><a href="#Interactor-1930"><span class="linenos">1930</span></a>
</span><span id="Interactor-1931"><a href="#Interactor-1931"><span class="linenos">1931</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">session_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
</span><span id="Interactor-1932"><a href="#Interactor-1932"><span class="linenos">1932</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load and normalize messages for a specific session.&quot;&quot;&quot;</span>
</span><span id="Interactor-1933"><a href="#Interactor-1933"><span class="linenos">1933</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span>
</span><span id="Interactor-1934"><a href="#Interactor-1934"><span class="linenos">1934</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_session_id</span> <span class="o">=</span> <span class="n">session_id</span>
</span><span id="Interactor-1935"><a href="#Interactor-1935"><span class="linenos">1935</span></a>        
</span><span id="Interactor-1936"><a href="#Interactor-1936"><span class="linenos">1936</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="ow">and</span> <span class="n">session_id</span><span class="p">:</span>
</span><span id="Interactor-1937"><a href="#Interactor-1937"><span class="linenos">1937</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-1938"><a href="#Interactor-1938"><span class="linenos">1938</span></a>                <span class="c1"># Load raw session data</span>
</span><span id="Interactor-1939"><a href="#Interactor-1939"><span class="linenos">1939</span></a>                <span class="n">session_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">load_full</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Interactor-1940"><a href="#Interactor-1940"><span class="linenos">1940</span></a>                <span class="n">messages</span> <span class="o">=</span> <span class="n">session_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Interactor-1941"><a href="#Interactor-1941"><span class="linenos">1941</span></a>                
</span><span id="Interactor-1942"><a href="#Interactor-1942"><span class="linenos">1942</span></a>                <span class="c1"># Convert session format to our standard format</span>
</span><span id="Interactor-1943"><a href="#Interactor-1943"><span class="linenos">1943</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-1944"><a href="#Interactor-1944"><span class="linenos">1944</span></a>                
</span><span id="Interactor-1945"><a href="#Interactor-1945"><span class="linenos">1945</span></a>                <span class="c1"># Track the most recent system message</span>
</span><span id="Interactor-1946"><a href="#Interactor-1946"><span class="linenos">1946</span></a>                <span class="n">latest_system_msg</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-1947"><a href="#Interactor-1947"><span class="linenos">1947</span></a>                
</span><span id="Interactor-1948"><a href="#Interactor-1948"><span class="linenos">1948</span></a>                <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="Interactor-1949"><a href="#Interactor-1949"><span class="linenos">1949</span></a>                    <span class="c1"># Extract fields</span>
</span><span id="Interactor-1950"><a href="#Interactor-1950"><span class="linenos">1950</span></a>                    <span class="n">role</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">)</span>
</span><span id="Interactor-1951"><a href="#Interactor-1951"><span class="linenos">1951</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor-1952"><a href="#Interactor-1952"><span class="linenos">1952</span></a>                    <span class="n">msg_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
</span><span id="Interactor-1953"><a href="#Interactor-1953"><span class="linenos">1953</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
</span><span id="Interactor-1954"><a href="#Interactor-1954"><span class="linenos">1954</span></a>                    
</span><span id="Interactor-1955"><a href="#Interactor-1955"><span class="linenos">1955</span></a>                    <span class="c1"># If this is a system message, track it but don&#39;t add to session_history yet</span>
</span><span id="Interactor-1956"><a href="#Interactor-1956"><span class="linenos">1956</span></a>                    <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="Interactor-1957"><a href="#Interactor-1957"><span class="linenos">1957</span></a>                        <span class="k">if</span> <span class="n">latest_system_msg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">latest_system_msg</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]:</span>
</span><span id="Interactor-1958"><a href="#Interactor-1958"><span class="linenos">1958</span></a>                            <span class="n">latest_system_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1959"><a href="#Interactor-1959"><span class="linenos">1959</span></a>                                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
</span><span id="Interactor-1960"><a href="#Interactor-1960"><span class="linenos">1960</span></a>                                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
</span><span id="Interactor-1961"><a href="#Interactor-1961"><span class="linenos">1961</span></a>                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">msg_id</span><span class="p">,</span>
</span><span id="Interactor-1962"><a href="#Interactor-1962"><span class="linenos">1962</span></a>                                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span><span id="Interactor-1963"><a href="#Interactor-1963"><span class="linenos">1963</span></a>                                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span><span class="p">}</span>
</span><span id="Interactor-1964"><a href="#Interactor-1964"><span class="linenos">1964</span></a>                            <span class="p">}</span>
</span><span id="Interactor-1965"><a href="#Interactor-1965"><span class="linenos">1965</span></a>                        <span class="k">continue</span>
</span><span id="Interactor-1966"><a href="#Interactor-1966"><span class="linenos">1966</span></a>                    
</span><span id="Interactor-1967"><a href="#Interactor-1967"><span class="linenos">1967</span></a>                    <span class="c1"># Build tool_info if present</span>
</span><span id="Interactor-1968"><a href="#Interactor-1968"><span class="linenos">1968</span></a>                    <span class="n">tool_info</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-1969"><a href="#Interactor-1969"><span class="linenos">1969</span></a>                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">msg</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tool_use_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;arguments&quot;</span><span class="p">]):</span>
</span><span id="Interactor-1970"><a href="#Interactor-1970"><span class="linenos">1970</span></a>                        <span class="n">tool_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1971"><a href="#Interactor-1971"><span class="linenos">1971</span></a>                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">),</span>
</span><span id="Interactor-1972"><a href="#Interactor-1972"><span class="linenos">1972</span></a>                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown_tool&quot;</span><span class="p">),</span>
</span><span id="Interactor-1973"><a href="#Interactor-1973"><span class="linenos">1973</span></a>                            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Interactor-1974"><a href="#Interactor-1974"><span class="linenos">1974</span></a>                        <span class="p">}</span>
</span><span id="Interactor-1975"><a href="#Interactor-1975"><span class="linenos">1975</span></a>                    
</span><span id="Interactor-1976"><a href="#Interactor-1976"><span class="linenos">1976</span></a>                    <span class="c1"># Create standard message</span>
</span><span id="Interactor-1977"><a href="#Interactor-1977"><span class="linenos">1977</span></a>                    <span class="n">standard_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-1978"><a href="#Interactor-1978"><span class="linenos">1978</span></a>                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
</span><span id="Interactor-1979"><a href="#Interactor-1979"><span class="linenos">1979</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
</span><span id="Interactor-1980"><a href="#Interactor-1980"><span class="linenos">1980</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">msg_id</span><span class="p">,</span>
</span><span id="Interactor-1981"><a href="#Interactor-1981"><span class="linenos">1981</span></a>                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span><span id="Interactor-1982"><a href="#Interactor-1982"><span class="linenos">1982</span></a>                        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-1983"><a href="#Interactor-1983"><span class="linenos">1983</span></a>                            <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span>
</span><span id="Interactor-1984"><a href="#Interactor-1984"><span class="linenos">1984</span></a>                        <span class="p">}</span>
</span><span id="Interactor-1985"><a href="#Interactor-1985"><span class="linenos">1985</span></a>                    <span class="p">}</span>
</span><span id="Interactor-1986"><a href="#Interactor-1986"><span class="linenos">1986</span></a>                    
</span><span id="Interactor-1987"><a href="#Interactor-1987"><span class="linenos">1987</span></a>                    <span class="k">if</span> <span class="n">tool_info</span><span class="p">:</span>
</span><span id="Interactor-1988"><a href="#Interactor-1988"><span class="linenos">1988</span></a>                        <span class="n">standard_msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_info</span>
</span><span id="Interactor-1989"><a href="#Interactor-1989"><span class="linenos">1989</span></a>                    
</span><span id="Interactor-1990"><a href="#Interactor-1990"><span class="linenos">1990</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">standard_msg</span><span class="p">)</span>
</span><span id="Interactor-1991"><a href="#Interactor-1991"><span class="linenos">1991</span></a>                
</span><span id="Interactor-1992"><a href="#Interactor-1992"><span class="linenos">1992</span></a>                <span class="c1"># If we found a system message, update the system property and add to history</span>
</span><span id="Interactor-1993"><a href="#Interactor-1993"><span class="linenos">1993</span></a>                <span class="k">if</span> <span class="n">latest_system_msg</span><span class="p">:</span>
</span><span id="Interactor-1994"><a href="#Interactor-1994"><span class="linenos">1994</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">latest_system_msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
</span><span id="Interactor-1995"><a href="#Interactor-1995"><span class="linenos">1995</span></a>                    <span class="c1"># Insert at the beginning of session_history</span>
</span><span id="Interactor-1996"><a href="#Interactor-1996"><span class="linenos">1996</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">latest_system_msg</span><span class="p">)</span>
</span><span id="Interactor-1997"><a href="#Interactor-1997"><span class="linenos">1997</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-1998"><a href="#Interactor-1998"><span class="linenos">1998</span></a>                    <span class="c1"># If no system message was found, add the current system message</span>
</span><span id="Interactor-1999"><a href="#Interactor-1999"><span class="linenos">1999</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
</span><span id="Interactor-2000"><a href="#Interactor-2000"><span class="linenos">2000</span></a>                
</span><span id="Interactor-2001"><a href="#Interactor-2001"><span class="linenos">2001</span></a>                <span class="c1"># Normalize to current SDK format</span>
</span><span id="Interactor-2002"><a href="#Interactor-2002"><span class="linenos">2002</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Interactor-2003"><a href="#Interactor-2003"><span class="linenos">2003</span></a>                
</span><span id="Interactor-2004"><a href="#Interactor-2004"><span class="linenos">2004</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SESSION] Switched to session &#39;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="Interactor-2005"><a href="#Interactor-2005"><span class="linenos">2005</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor-2006"><a href="#Interactor-2006"><span class="linenos">2006</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load session &#39;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-2007"><a href="#Interactor-2007"><span class="linenos">2007</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">session_reset</span><span class="p">()</span>
</span><span id="Interactor-2008"><a href="#Interactor-2008"><span class="linenos">2008</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2009"><a href="#Interactor-2009"><span class="linenos">2009</span></a>            <span class="c1"># Reset to empty state with system message</span>
</span><span id="Interactor-2010"><a href="#Interactor-2010"><span class="linenos">2010</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session_reset</span><span class="p">()</span>
</span><span id="Interactor-2011"><a href="#Interactor-2011"><span class="linenos">2011</span></a>
</span><span id="Interactor-2012"><a href="#Interactor-2012"><span class="linenos">2012</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">session_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Interactor-2013"><a href="#Interactor-2013"><span class="linenos">2013</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor-2014"><a href="#Interactor-2014"><span class="linenos">2014</span></a><span class="sd">        Reset the current session state and reinitialize to default system prompt.</span>
</span><span id="Interactor-2015"><a href="#Interactor-2015"><span class="linenos">2015</span></a>
</span><span id="Interactor-2016"><a href="#Interactor-2016"><span class="linenos">2016</span></a><span class="sd">        Clears history, disables session ID tracking, and returns to in-memory mode.</span>
</span><span id="Interactor-2017"><a href="#Interactor-2017"><span class="linenos">2017</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-2018"><a href="#Interactor-2018"><span class="linenos">2018</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-2019"><a href="#Interactor-2019"><span class="linenos">2019</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_session_id</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor-2020"><a href="#Interactor-2020"><span class="linenos">2020</span></a>        
</span><span id="Interactor-2021"><a href="#Interactor-2021"><span class="linenos">2021</span></a>        <span class="c1"># Clear histories</span>
</span><span id="Interactor-2022"><a href="#Interactor-2022"><span class="linenos">2022</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-2023"><a href="#Interactor-2023"><span class="linenos">2023</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-2024"><a href="#Interactor-2024"><span class="linenos">2024</span></a>        
</span><span id="Interactor-2025"><a href="#Interactor-2025"><span class="linenos">2025</span></a>        <span class="c1"># Reapply the system message</span>
</span><span id="Interactor-2026"><a href="#Interactor-2026"><span class="linenos">2026</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">:</span>
</span><span id="Interactor-2027"><a href="#Interactor-2027"><span class="linenos">2027</span></a>            <span class="c1"># Add to session_history</span>
</span><span id="Interactor-2028"><a href="#Interactor-2028"><span class="linenos">2028</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
</span><span id="Interactor-2029"><a href="#Interactor-2029"><span class="linenos">2029</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2030"><a href="#Interactor-2030"><span class="linenos">2030</span></a>            <span class="c1"># Ensure we have a default system message</span>
</span><span id="Interactor-2031"><a href="#Interactor-2031"><span class="linenos">2031</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;You are a helpful Assistant.&quot;</span>
</span><span id="Interactor-2032"><a href="#Interactor-2032"><span class="linenos">2032</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
</span><span id="Interactor-2033"><a href="#Interactor-2033"><span class="linenos">2033</span></a>        
</span><span id="Interactor-2034"><a href="#Interactor-2034"><span class="linenos">2034</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;[SESSION] Reset to in-memory mode&quot;</span><span class="p">)</span>
</span><span id="Interactor-2035"><a href="#Interactor-2035"><span class="linenos">2035</span></a>
</span><span id="Interactor-2036"><a href="#Interactor-2036"><span class="linenos">2036</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_normalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">new_message_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Interactor-2037"><a href="#Interactor-2037"><span class="linenos">2037</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor-2038"><a href="#Interactor-2038"><span class="linenos">2038</span></a><span class="sd">        Central normalization function that transforms the standard session_history</span>
</span><span id="Interactor-2039"><a href="#Interactor-2039"><span class="linenos">2039</span></a><span class="sd">        into the SDK-specific format needed in self.history.</span>
</span><span id="Interactor-2040"><a href="#Interactor-2040"><span class="linenos">2040</span></a><span class="sd">        </span>
</span><span id="Interactor-2041"><a href="#Interactor-2041"><span class="linenos">2041</span></a><span class="sd">        Args:</span>
</span><span id="Interactor-2042"><a href="#Interactor-2042"><span class="linenos">2042</span></a><span class="sd">            force (bool): If True, always normalize even if SDK hasn&#39;t changed.</span>
</span><span id="Interactor-2043"><a href="#Interactor-2043"><span class="linenos">2043</span></a><span class="sd">                         Default is False, which only normalizes on SDK change.</span>
</span><span id="Interactor-2044"><a href="#Interactor-2044"><span class="linenos">2044</span></a><span class="sd">            new_message_only (bool): If True, only normalize the most recent message</span>
</span><span id="Interactor-2045"><a href="#Interactor-2045"><span class="linenos">2045</span></a><span class="sd">                                   for efficiency when adding single messages.</span>
</span><span id="Interactor-2046"><a href="#Interactor-2046"><span class="linenos">2046</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-2047"><a href="#Interactor-2047"><span class="linenos">2047</span></a>        <span class="c1"># Skip normalization if SDK hasn&#39;t changed and force is False</span>
</span><span id="Interactor-2048"><a href="#Interactor-2048"><span class="linenos">2048</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_last_sdk&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_sdk</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span><span class="p">:</span>
</span><span id="Interactor-2049"><a href="#Interactor-2049"><span class="linenos">2049</span></a>            <span class="c1"># If we only need to normalize the most recent message</span>
</span><span id="Interactor-2050"><a href="#Interactor-2050"><span class="linenos">2050</span></a>            <span class="k">if</span> <span class="n">new_message_only</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="p">:</span>
</span><span id="Interactor-2051"><a href="#Interactor-2051"><span class="linenos">2051</span></a>                <span class="c1"># Get the most recent message from session_history</span>
</span><span id="Interactor-2052"><a href="#Interactor-2052"><span class="linenos">2052</span></a>                <span class="n">recent_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Interactor-2053"><a href="#Interactor-2053"><span class="linenos">2053</span></a>                
</span><span id="Interactor-2054"><a href="#Interactor-2054"><span class="linenos">2054</span></a>                <span class="c1"># Apply SDK-specific normalization for just this message</span>
</span><span id="Interactor-2055"><a href="#Interactor-2055"><span class="linenos">2055</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
</span><span id="Interactor-2056"><a href="#Interactor-2056"><span class="linenos">2056</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_openai_normalize_message</span><span class="p">(</span><span class="n">recent_msg</span><span class="p">)</span>
</span><span id="Interactor-2057"><a href="#Interactor-2057"><span class="linenos">2057</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;anthropic&quot;</span><span class="p">:</span>
</span><span id="Interactor-2058"><a href="#Interactor-2058"><span class="linenos">2058</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_anthropic_normalize_message</span><span class="p">(</span><span class="n">recent_msg</span><span class="p">)</span>
</span><span id="Interactor-2059"><a href="#Interactor-2059"><span class="linenos">2059</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2060"><a href="#Interactor-2060"><span class="linenos">2060</span></a>                    <span class="c1"># Generic handler for unknown SDKs</span>
</span><span id="Interactor-2061"><a href="#Interactor-2061"><span class="linenos">2061</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_generic_normalize_message</span><span class="p">(</span><span class="n">recent_msg</span><span class="p">)</span>
</span><span id="Interactor-2062"><a href="#Interactor-2062"><span class="linenos">2062</span></a>                    
</span><span id="Interactor-2063"><a href="#Interactor-2063"><span class="linenos">2063</span></a>                <span class="k">return</span>
</span><span id="Interactor-2064"><a href="#Interactor-2064"><span class="linenos">2064</span></a>        
</span><span id="Interactor-2065"><a href="#Interactor-2065"><span class="linenos">2065</span></a>        <span class="c1"># Record the current SDK to detect future changes</span>
</span><span id="Interactor-2066"><a href="#Interactor-2066"><span class="linenos">2066</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_sdk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span>
</span><span id="Interactor-2067"><a href="#Interactor-2067"><span class="linenos">2067</span></a>        
</span><span id="Interactor-2068"><a href="#Interactor-2068"><span class="linenos">2068</span></a>        <span class="c1"># For full normalization, clear current history and rebuild it</span>
</span><span id="Interactor-2069"><a href="#Interactor-2069"><span class="linenos">2069</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-2070"><a href="#Interactor-2070"><span class="linenos">2070</span></a>        
</span><span id="Interactor-2071"><a href="#Interactor-2071"><span class="linenos">2071</span></a>        <span class="c1"># Call the appropriate SDK-specific normalizer</span>
</span><span id="Interactor-2072"><a href="#Interactor-2072"><span class="linenos">2072</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
</span><span id="Interactor-2073"><a href="#Interactor-2073"><span class="linenos">2073</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_openai_normalizer</span><span class="p">()</span>
</span><span id="Interactor-2074"><a href="#Interactor-2074"><span class="linenos">2074</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;anthropic&quot;</span><span class="p">:</span>
</span><span id="Interactor-2075"><a href="#Interactor-2075"><span class="linenos">2075</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_anthropic_normalizer</span><span class="p">()</span>
</span><span id="Interactor-2076"><a href="#Interactor-2076"><span class="linenos">2076</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2077"><a href="#Interactor-2077"><span class="linenos">2077</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No normalizer available for SDK: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sdk</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor-2078"><a href="#Interactor-2078"><span class="linenos">2078</span></a>            <span class="c1"># Fallback to a simple conversion for unknown SDKs</span>
</span><span id="Interactor-2079"><a href="#Interactor-2079"><span class="linenos">2079</span></a>            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="p">:</span>
</span><span id="Interactor-2080"><a href="#Interactor-2080"><span class="linenos">2080</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_generic_normalize_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Interactor-2081"><a href="#Interactor-2081"><span class="linenos">2081</span></a>
</span><span id="Interactor-2082"><a href="#Interactor-2082"><span class="linenos">2082</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_openai_normalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Interactor-2083"><a href="#Interactor-2083"><span class="linenos">2083</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor-2084"><a href="#Interactor-2084"><span class="linenos">2084</span></a><span class="sd">        Convert standardized session_history to OpenAI-compatible format in self.history.</span>
</span><span id="Interactor-2085"><a href="#Interactor-2085"><span class="linenos">2085</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-2086"><a href="#Interactor-2086"><span class="linenos">2086</span></a>        <span class="c1"># For OpenAI, we need to include system message in the history</span>
</span><span id="Interactor-2087"><a href="#Interactor-2087"><span class="linenos">2087</span></a>        <span class="c1"># and convert tool calls/results to OpenAI format</span>
</span><span id="Interactor-2088"><a href="#Interactor-2088"><span class="linenos">2088</span></a>
</span><span id="Interactor-2089"><a href="#Interactor-2089"><span class="linenos">2089</span></a>        <span class="c1"># Start with empty history</span>
</span><span id="Interactor-2090"><a href="#Interactor-2090"><span class="linenos">2090</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-2091"><a href="#Interactor-2091"><span class="linenos">2091</span></a>
</span><span id="Interactor-2092"><a href="#Interactor-2092"><span class="linenos">2092</span></a>        <span class="c1"># First, add the current system message at position 0</span>
</span><span id="Interactor-2093"><a href="#Interactor-2093"><span class="linenos">2093</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2094"><a href="#Interactor-2094"><span class="linenos">2094</span></a>            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
</span><span id="Interactor-2095"><a href="#Interactor-2095"><span class="linenos">2095</span></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
</span><span id="Interactor-2096"><a href="#Interactor-2096"><span class="linenos">2096</span></a>        <span class="p">})</span>
</span><span id="Interactor-2097"><a href="#Interactor-2097"><span class="linenos">2097</span></a>
</span><span id="Interactor-2098"><a href="#Interactor-2098"><span class="linenos">2098</span></a>        <span class="c1"># Process all non-system messages</span>
</span><span id="Interactor-2099"><a href="#Interactor-2099"><span class="linenos">2099</span></a>        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="p">:</span>
</span><span id="Interactor-2100"><a href="#Interactor-2100"><span class="linenos">2100</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="Interactor-2101"><a href="#Interactor-2101"><span class="linenos">2101</span></a>                <span class="k">continue</span>  <span class="c1"># Skip system messages, already handled</span>
</span><span id="Interactor-2102"><a href="#Interactor-2102"><span class="linenos">2102</span></a>
</span><span id="Interactor-2103"><a href="#Interactor-2103"><span class="linenos">2103</span></a>            <span class="c1"># Handle different message types</span>
</span><span id="Interactor-2104"><a href="#Interactor-2104"><span class="linenos">2104</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
</span><span id="Interactor-2105"><a href="#Interactor-2105"><span class="linenos">2105</span></a>                <span class="c1"># User messages are straightforward</span>
</span><span id="Interactor-2106"><a href="#Interactor-2106"><span class="linenos">2106</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2107"><a href="#Interactor-2107"><span class="linenos">2107</span></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="Interactor-2108"><a href="#Interactor-2108"><span class="linenos">2108</span></a>                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
</span><span id="Interactor-2109"><a href="#Interactor-2109"><span class="linenos">2109</span></a>                <span class="p">})</span>
</span><span id="Interactor-2110"><a href="#Interactor-2110"><span class="linenos">2110</span></a>
</span><span id="Interactor-2111"><a href="#Interactor-2111"><span class="linenos">2111</span></a>            <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span><span class="p">:</span>
</span><span id="Interactor-2112"><a href="#Interactor-2112"><span class="linenos">2112</span></a>                <span class="c1"># For assistant messages with tool calls</span>
</span><span id="Interactor-2113"><a href="#Interactor-2113"><span class="linenos">2113</span></a>                <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_info&quot;</span><span class="p">):</span>
</span><span id="Interactor-2114"><a href="#Interactor-2114"><span class="linenos">2114</span></a>                    <span class="c1"># This is an assistant message with tool calls</span>
</span><span id="Interactor-2115"><a href="#Interactor-2115"><span class="linenos">2115</span></a>                    <span class="n">tool_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span>
</span><span id="Interactor-2116"><a href="#Interactor-2116"><span class="linenos">2116</span></a>
</span><span id="Interactor-2117"><a href="#Interactor-2117"><span class="linenos">2117</span></a>                    <span class="c1"># Create OpenAI assistant message with tool calls</span>
</span><span id="Interactor-2118"><a href="#Interactor-2118"><span class="linenos">2118</span></a>                    <span class="n">assistant_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-2119"><a href="#Interactor-2119"><span class="linenos">2119</span></a>                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="Interactor-2120"><a href="#Interactor-2120"><span class="linenos">2120</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Interactor-2121"><a href="#Interactor-2121"><span class="linenos">2121</span></a>                        <span class="s2">&quot;tool_calls&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span id="Interactor-2122"><a href="#Interactor-2122"><span class="linenos">2122</span></a>                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Interactor-2123"><a href="#Interactor-2123"><span class="linenos">2123</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="Interactor-2124"><a href="#Interactor-2124"><span class="linenos">2124</span></a>                            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-2125"><a href="#Interactor-2125"><span class="linenos">2125</span></a>                                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Interactor-2126"><a href="#Interactor-2126"><span class="linenos">2126</span></a>                                <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>
</span><span id="Interactor-2127"><a href="#Interactor-2127"><span class="linenos">2127</span></a>                            <span class="p">}</span>
</span><span id="Interactor-2128"><a href="#Interactor-2128"><span class="linenos">2128</span></a>                        <span class="p">}]</span>
</span><span id="Interactor-2129"><a href="#Interactor-2129"><span class="linenos">2129</span></a>                    <span class="p">}</span>
</span><span id="Interactor-2130"><a href="#Interactor-2130"><span class="linenos">2130</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assistant_msg</span><span class="p">)</span>
</span><span id="Interactor-2131"><a href="#Interactor-2131"><span class="linenos">2131</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2132"><a href="#Interactor-2132"><span class="linenos">2132</span></a>                    <span class="c1"># Regular assistant message</span>
</span><span id="Interactor-2133"><a href="#Interactor-2133"><span class="linenos">2133</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2134"><a href="#Interactor-2134"><span class="linenos">2134</span></a>                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="Interactor-2135"><a href="#Interactor-2135"><span class="linenos">2135</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
</span><span id="Interactor-2136"><a href="#Interactor-2136"><span class="linenos">2136</span></a>                    <span class="p">})</span>
</span><span id="Interactor-2137"><a href="#Interactor-2137"><span class="linenos">2137</span></a>
</span><span id="Interactor-2138"><a href="#Interactor-2138"><span class="linenos">2138</span></a>            <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;tool&quot;</span><span class="p">:</span>
</span><span id="Interactor-2139"><a href="#Interactor-2139"><span class="linenos">2139</span></a>                <span class="c1"># Tool response messages</span>
</span><span id="Interactor-2140"><a href="#Interactor-2140"><span class="linenos">2140</span></a>                <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="s2">&quot;tool_info&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]:</span>
</span><span id="Interactor-2141"><a href="#Interactor-2141"><span class="linenos">2141</span></a>                    <span class="n">tool_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-2142"><a href="#Interactor-2142"><span class="linenos">2142</span></a>                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
</span><span id="Interactor-2143"><a href="#Interactor-2143"><span class="linenos">2143</span></a>                        <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Interactor-2144"><a href="#Interactor-2144"><span class="linenos">2144</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
</span><span id="Interactor-2145"><a href="#Interactor-2145"><span class="linenos">2145</span></a>                    <span class="p">}</span>
</span><span id="Interactor-2146"><a href="#Interactor-2146"><span class="linenos">2146</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_msg</span><span class="p">)</span>
</span><span id="Interactor-2147"><a href="#Interactor-2147"><span class="linenos">2147</span></a>
</span><span id="Interactor-2148"><a href="#Interactor-2148"><span class="linenos">2148</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_anthropic_normalizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Interactor-2149"><a href="#Interactor-2149"><span class="linenos">2149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor-2150"><a href="#Interactor-2150"><span class="linenos">2150</span></a><span class="sd">        Convert standardized session_history to Anthropic-compatible format in self.history.</span>
</span><span id="Interactor-2151"><a href="#Interactor-2151"><span class="linenos">2151</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-2152"><a href="#Interactor-2152"><span class="linenos">2152</span></a>        <span class="c1"># For Anthropic, we don&#39;t include system message in the history</span>
</span><span id="Interactor-2153"><a href="#Interactor-2153"><span class="linenos">2153</span></a>        <span class="c1"># but need to handle content blocks for tool use/results</span>
</span><span id="Interactor-2154"><a href="#Interactor-2154"><span class="linenos">2154</span></a>        
</span><span id="Interactor-2155"><a href="#Interactor-2155"><span class="linenos">2155</span></a>        <span class="c1"># Start with empty history</span>
</span><span id="Interactor-2156"><a href="#Interactor-2156"><span class="linenos">2156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-2157"><a href="#Interactor-2157"><span class="linenos">2157</span></a>
</span><span id="Interactor-2158"><a href="#Interactor-2158"><span class="linenos">2158</span></a>        <span class="c1"># Process all non-system messages</span>
</span><span id="Interactor-2159"><a href="#Interactor-2159"><span class="linenos">2159</span></a>        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="p">:</span>
</span><span id="Interactor-2160"><a href="#Interactor-2160"><span class="linenos">2160</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="Interactor-2161"><a href="#Interactor-2161"><span class="linenos">2161</span></a>                <span class="c1"># Update system prompt if this is the most recent system message</span>
</span><span id="Interactor-2162"><a href="#Interactor-2162"><span class="linenos">2162</span></a>                <span class="c1"># (only apply the most recent system message if we have multiple)</span>
</span><span id="Interactor-2163"><a href="#Interactor-2163"><span class="linenos">2163</span></a>                <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;system&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]):</span>
</span><span id="Interactor-2164"><a href="#Interactor-2164"><span class="linenos">2164</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
</span><span id="Interactor-2165"><a href="#Interactor-2165"><span class="linenos">2165</span></a>                <span class="k">continue</span>  <span class="c1"># Skip system messages in history</span>
</span><span id="Interactor-2166"><a href="#Interactor-2166"><span class="linenos">2166</span></a>
</span><span id="Interactor-2167"><a href="#Interactor-2167"><span class="linenos">2167</span></a>            <span class="c1"># Handle different message types</span>
</span><span id="Interactor-2168"><a href="#Interactor-2168"><span class="linenos">2168</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
</span><span id="Interactor-2169"><a href="#Interactor-2169"><span class="linenos">2169</span></a>                <span class="c1"># User messages - check if it contains tool results</span>
</span><span id="Interactor-2170"><a href="#Interactor-2170"><span class="linenos">2170</span></a>                <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="s2">&quot;tool_info&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">):</span>
</span><span id="Interactor-2171"><a href="#Interactor-2171"><span class="linenos">2171</span></a>                    <span class="c1"># This is a tool result message</span>
</span><span id="Interactor-2172"><a href="#Interactor-2172"><span class="linenos">2172</span></a>                    <span class="n">tool_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span>
</span><span id="Interactor-2173"><a href="#Interactor-2173"><span class="linenos">2173</span></a>
</span><span id="Interactor-2174"><a href="#Interactor-2174"><span class="linenos">2174</span></a>                    <span class="c1"># Create Anthropic tool result format</span>
</span><span id="Interactor-2175"><a href="#Interactor-2175"><span class="linenos">2175</span></a>                    <span class="n">tool_result_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-2176"><a href="#Interactor-2176"><span class="linenos">2176</span></a>                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="Interactor-2177"><a href="#Interactor-2177"><span class="linenos">2177</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span id="Interactor-2178"><a href="#Interactor-2178"><span class="linenos">2178</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;tool_result&quot;</span><span class="p">,</span>
</span><span id="Interactor-2179"><a href="#Interactor-2179"><span class="linenos">2179</span></a>                            <span class="s2">&quot;tool_use_id&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Interactor-2180"><a href="#Interactor-2180"><span class="linenos">2180</span></a>                            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">])</span>
</span><span id="Interactor-2181"><a href="#Interactor-2181"><span class="linenos">2181</span></a>                        <span class="p">}]</span>
</span><span id="Interactor-2182"><a href="#Interactor-2182"><span class="linenos">2182</span></a>                    <span class="p">}</span>
</span><span id="Interactor-2183"><a href="#Interactor-2183"><span class="linenos">2183</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_result_msg</span><span class="p">)</span>
</span><span id="Interactor-2184"><a href="#Interactor-2184"><span class="linenos">2184</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2185"><a href="#Interactor-2185"><span class="linenos">2185</span></a>                    <span class="c1"># Regular user message</span>
</span><span id="Interactor-2186"><a href="#Interactor-2186"><span class="linenos">2186</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2187"><a href="#Interactor-2187"><span class="linenos">2187</span></a>                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="Interactor-2188"><a href="#Interactor-2188"><span class="linenos">2188</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
</span><span id="Interactor-2189"><a href="#Interactor-2189"><span class="linenos">2189</span></a>                    <span class="p">})</span>
</span><span id="Interactor-2190"><a href="#Interactor-2190"><span class="linenos">2190</span></a>            
</span><span id="Interactor-2191"><a href="#Interactor-2191"><span class="linenos">2191</span></a>            <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span><span class="p">:</span>
</span><span id="Interactor-2192"><a href="#Interactor-2192"><span class="linenos">2192</span></a>                <span class="c1"># For assistant messages, check for tool use</span>
</span><span id="Interactor-2193"><a href="#Interactor-2193"><span class="linenos">2193</span></a>                <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="s2">&quot;tool_info&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]:</span>
</span><span id="Interactor-2194"><a href="#Interactor-2194"><span class="linenos">2194</span></a>                    <span class="c1"># This is an assistant message with tool use</span>
</span><span id="Interactor-2195"><a href="#Interactor-2195"><span class="linenos">2195</span></a>                    <span class="n">tool_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span>
</span><span id="Interactor-2196"><a href="#Interactor-2196"><span class="linenos">2196</span></a>                    <span class="n">current_tool_use_id</span> <span class="o">=</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
</span><span id="Interactor-2197"><a href="#Interactor-2197"><span class="linenos">2197</span></a>
</span><span id="Interactor-2198"><a href="#Interactor-2198"><span class="linenos">2198</span></a>                    <span class="c1"># Build content blocks</span>
</span><span id="Interactor-2199"><a href="#Interactor-2199"><span class="linenos">2199</span></a>                    <span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-2200"><a href="#Interactor-2200"><span class="linenos">2200</span></a>
</span><span id="Interactor-2201"><a href="#Interactor-2201"><span class="linenos">2201</span></a>                    <span class="c1"># Add text content if present</span>
</span><span id="Interactor-2202"><a href="#Interactor-2202"><span class="linenos">2202</span></a>                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]:</span>
</span><span id="Interactor-2203"><a href="#Interactor-2203"><span class="linenos">2203</span></a>                        <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2204"><a href="#Interactor-2204"><span class="linenos">2204</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
</span><span id="Interactor-2205"><a href="#Interactor-2205"><span class="linenos">2205</span></a>                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="Interactor-2206"><a href="#Interactor-2206"><span class="linenos">2206</span></a>                        <span class="p">})</span>
</span><span id="Interactor-2207"><a href="#Interactor-2207"><span class="linenos">2207</span></a>
</span><span id="Interactor-2208"><a href="#Interactor-2208"><span class="linenos">2208</span></a>                    <span class="c1"># Add tool use block</span>
</span><span id="Interactor-2209"><a href="#Interactor-2209"><span class="linenos">2209</span></a>                    <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2210"><a href="#Interactor-2210"><span class="linenos">2210</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;tool_use&quot;</span><span class="p">,</span>
</span><span id="Interactor-2211"><a href="#Interactor-2211"><span class="linenos">2211</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Interactor-2212"><a href="#Interactor-2212"><span class="linenos">2212</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Interactor-2213"><a href="#Interactor-2213"><span class="linenos">2213</span></a>                        <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">])</span>
</span><span id="Interactor-2214"><a href="#Interactor-2214"><span class="linenos">2214</span></a>                    <span class="p">})</span>
</span><span id="Interactor-2215"><a href="#Interactor-2215"><span class="linenos">2215</span></a>
</span><span id="Interactor-2216"><a href="#Interactor-2216"><span class="linenos">2216</span></a>                    <span class="c1"># Create Anthropic assistant message with tool use</span>
</span><span id="Interactor-2217"><a href="#Interactor-2217"><span class="linenos">2217</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2218"><a href="#Interactor-2218"><span class="linenos">2218</span></a>                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="Interactor-2219"><a href="#Interactor-2219"><span class="linenos">2219</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content_blocks</span>
</span><span id="Interactor-2220"><a href="#Interactor-2220"><span class="linenos">2220</span></a>                    <span class="p">})</span>
</span><span id="Interactor-2221"><a href="#Interactor-2221"><span class="linenos">2221</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2222"><a href="#Interactor-2222"><span class="linenos">2222</span></a>                    <span class="c1"># Regular assistant message</span>
</span><span id="Interactor-2223"><a href="#Interactor-2223"><span class="linenos">2223</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2224"><a href="#Interactor-2224"><span class="linenos">2224</span></a>                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="Interactor-2225"><a href="#Interactor-2225"><span class="linenos">2225</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
</span><span id="Interactor-2226"><a href="#Interactor-2226"><span class="linenos">2226</span></a>                    <span class="p">})</span>
</span><span id="Interactor-2227"><a href="#Interactor-2227"><span class="linenos">2227</span></a>
</span><span id="Interactor-2228"><a href="#Interactor-2228"><span class="linenos">2228</span></a>            <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;tool&quot;</span><span class="p">:</span>
</span><span id="Interactor-2229"><a href="#Interactor-2229"><span class="linenos">2229</span></a>                <span class="c1"># Tool messages in standard format get converted to user messages with tool_result</span>
</span><span id="Interactor-2230"><a href="#Interactor-2230"><span class="linenos">2230</span></a>                <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="s2">&quot;tool_info&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]:</span>
</span><span id="Interactor-2231"><a href="#Interactor-2231"><span class="linenos">2231</span></a>                    <span class="n">tool_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span>
</span><span id="Interactor-2232"><a href="#Interactor-2232"><span class="linenos">2232</span></a>
</span><span id="Interactor-2233"><a href="#Interactor-2233"><span class="linenos">2233</span></a>                    <span class="c1"># Create Anthropic tool result message</span>
</span><span id="Interactor-2234"><a href="#Interactor-2234"><span class="linenos">2234</span></a>                    <span class="n">tool_result_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-2235"><a href="#Interactor-2235"><span class="linenos">2235</span></a>                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="Interactor-2236"><a href="#Interactor-2236"><span class="linenos">2236</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span id="Interactor-2237"><a href="#Interactor-2237"><span class="linenos">2237</span></a>                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;tool_result&quot;</span><span class="p">,</span>
</span><span id="Interactor-2238"><a href="#Interactor-2238"><span class="linenos">2238</span></a>                            <span class="s2">&quot;tool_use_id&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Interactor-2239"><a href="#Interactor-2239"><span class="linenos">2239</span></a>                            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>
</span><span id="Interactor-2240"><a href="#Interactor-2240"><span class="linenos">2240</span></a>                        <span class="p">}]</span>
</span><span id="Interactor-2241"><a href="#Interactor-2241"><span class="linenos">2241</span></a>                    <span class="p">}</span>
</span><span id="Interactor-2242"><a href="#Interactor-2242"><span class="linenos">2242</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_result_msg</span><span class="p">)</span>
</span><span id="Interactor-2243"><a href="#Interactor-2243"><span class="linenos">2243</span></a>
</span><span id="Interactor-2244"><a href="#Interactor-2244"><span class="linenos">2244</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_openai_normalize_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="Interactor-2245"><a href="#Interactor-2245"><span class="linenos">2245</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize a single message to OpenAI format and add to history.&quot;&quot;&quot;</span>
</span><span id="Interactor-2246"><a href="#Interactor-2246"><span class="linenos">2246</span></a>        <span class="n">role</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span>
</span><span id="Interactor-2247"><a href="#Interactor-2247"><span class="linenos">2247</span></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span>
</span><span id="Interactor-2248"><a href="#Interactor-2248"><span class="linenos">2248</span></a>
</span><span id="Interactor-2249"><a href="#Interactor-2249"><span class="linenos">2249</span></a>        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="Interactor-2250"><a href="#Interactor-2250"><span class="linenos">2250</span></a>            <span class="c1"># Check if we already have a system message in history</span>
</span><span id="Interactor-2251"><a href="#Interactor-2251"><span class="linenos">2251</span></a>            <span class="n">system_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="Interactor-2252"><a href="#Interactor-2252"><span class="linenos">2252</span></a>                                 <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor-2253"><a href="#Interactor-2253"><span class="linenos">2253</span></a>            <span class="k">if</span> <span class="n">system_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Interactor-2254"><a href="#Interactor-2254"><span class="linenos">2254</span></a>                <span class="c1"># Update existing system message</span>
</span><span id="Interactor-2255"><a href="#Interactor-2255"><span class="linenos">2255</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">system_index</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="Interactor-2256"><a href="#Interactor-2256"><span class="linenos">2256</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2257"><a href="#Interactor-2257"><span class="linenos">2257</span></a>                <span class="c1"># Insert new system message at the beginning</span>
</span><span id="Interactor-2258"><a href="#Interactor-2258"><span class="linenos">2258</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span>
</span><span id="Interactor-2259"><a href="#Interactor-2259"><span class="linenos">2259</span></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
</span><span id="Interactor-2260"><a href="#Interactor-2260"><span class="linenos">2260</span></a>                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span>
</span><span id="Interactor-2261"><a href="#Interactor-2261"><span class="linenos">2261</span></a>                <span class="p">})</span>
</span><span id="Interactor-2262"><a href="#Interactor-2262"><span class="linenos">2262</span></a>            <span class="c1"># Update the system property</span>
</span><span id="Interactor-2263"><a href="#Interactor-2263"><span class="linenos">2263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="Interactor-2264"><a href="#Interactor-2264"><span class="linenos">2264</span></a>
</span><span id="Interactor-2265"><a href="#Interactor-2265"><span class="linenos">2265</span></a>        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
</span><span id="Interactor-2266"><a href="#Interactor-2266"><span class="linenos">2266</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2267"><a href="#Interactor-2267"><span class="linenos">2267</span></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="Interactor-2268"><a href="#Interactor-2268"><span class="linenos">2268</span></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span>
</span><span id="Interactor-2269"><a href="#Interactor-2269"><span class="linenos">2269</span></a>            <span class="p">})</span>
</span><span id="Interactor-2270"><a href="#Interactor-2270"><span class="linenos">2270</span></a>
</span><span id="Interactor-2271"><a href="#Interactor-2271"><span class="linenos">2271</span></a>        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span><span class="p">:</span>
</span><span id="Interactor-2272"><a href="#Interactor-2272"><span class="linenos">2272</span></a>            <span class="c1"># For assistant messages, handle potential tool calls</span>
</span><span id="Interactor-2273"><a href="#Interactor-2273"><span class="linenos">2273</span></a>            <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_info&quot;</span><span class="p">):</span>
</span><span id="Interactor-2274"><a href="#Interactor-2274"><span class="linenos">2274</span></a>                <span class="c1"># This is an assistant message with tool calls</span>
</span><span id="Interactor-2275"><a href="#Interactor-2275"><span class="linenos">2275</span></a>                <span class="n">tool_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span>
</span><span id="Interactor-2276"><a href="#Interactor-2276"><span class="linenos">2276</span></a>                
</span><span id="Interactor-2277"><a href="#Interactor-2277"><span class="linenos">2277</span></a>                <span class="c1"># Create OpenAI assistant message with tool calls</span>
</span><span id="Interactor-2278"><a href="#Interactor-2278"><span class="linenos">2278</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-2279"><a href="#Interactor-2279"><span class="linenos">2279</span></a>                    <span class="n">arguments</span> <span class="o">=</span> <span class="n">tool_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Interactor-2280"><a href="#Interactor-2280"><span class="linenos">2280</span></a>                    <span class="n">arguments_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">arguments</span>
</span><span id="Interactor-2281"><a href="#Interactor-2281"><span class="linenos">2281</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="Interactor-2282"><a href="#Interactor-2282"><span class="linenos">2282</span></a>                    <span class="n">arguments_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
</span><span id="Interactor-2283"><a href="#Interactor-2283"><span class="linenos">2283</span></a>                    
</span><span id="Interactor-2284"><a href="#Interactor-2284"><span class="linenos">2284</span></a>                <span class="n">assistant_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-2285"><a href="#Interactor-2285"><span class="linenos">2285</span></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="Interactor-2286"><a href="#Interactor-2286"><span class="linenos">2286</span></a>                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Interactor-2287"><a href="#Interactor-2287"><span class="linenos">2287</span></a>                    <span class="s2">&quot;tool_calls&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span id="Interactor-2288"><a href="#Interactor-2288"><span class="linenos">2288</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Interactor-2289"><a href="#Interactor-2289"><span class="linenos">2289</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="Interactor-2290"><a href="#Interactor-2290"><span class="linenos">2290</span></a>                        <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-2291"><a href="#Interactor-2291"><span class="linenos">2291</span></a>                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Interactor-2292"><a href="#Interactor-2292"><span class="linenos">2292</span></a>                            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">arguments_str</span>
</span><span id="Interactor-2293"><a href="#Interactor-2293"><span class="linenos">2293</span></a>                        <span class="p">}</span>
</span><span id="Interactor-2294"><a href="#Interactor-2294"><span class="linenos">2294</span></a>                    <span class="p">}]</span>
</span><span id="Interactor-2295"><a href="#Interactor-2295"><span class="linenos">2295</span></a>                <span class="p">}</span>
</span><span id="Interactor-2296"><a href="#Interactor-2296"><span class="linenos">2296</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assistant_msg</span><span class="p">)</span>
</span><span id="Interactor-2297"><a href="#Interactor-2297"><span class="linenos">2297</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2298"><a href="#Interactor-2298"><span class="linenos">2298</span></a>                <span class="c1"># Regular assistant message</span>
</span><span id="Interactor-2299"><a href="#Interactor-2299"><span class="linenos">2299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2300"><a href="#Interactor-2300"><span class="linenos">2300</span></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="Interactor-2301"><a href="#Interactor-2301"><span class="linenos">2301</span></a>                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span>
</span><span id="Interactor-2302"><a href="#Interactor-2302"><span class="linenos">2302</span></a>                <span class="p">})</span>
</span><span id="Interactor-2303"><a href="#Interactor-2303"><span class="linenos">2303</span></a>            
</span><span id="Interactor-2304"><a href="#Interactor-2304"><span class="linenos">2304</span></a>        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;tool&quot;</span><span class="p">:</span>
</span><span id="Interactor-2305"><a href="#Interactor-2305"><span class="linenos">2305</span></a>            <span class="c1"># Tool response messages</span>
</span><span id="Interactor-2306"><a href="#Interactor-2306"><span class="linenos">2306</span></a>            <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="s2">&quot;tool_info&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]:</span>
</span><span id="Interactor-2307"><a href="#Interactor-2307"><span class="linenos">2307</span></a>                <span class="n">tool_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span>
</span><span id="Interactor-2308"><a href="#Interactor-2308"><span class="linenos">2308</span></a>                <span class="n">tool_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-2309"><a href="#Interactor-2309"><span class="linenos">2309</span></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;tool&quot;</span><span class="p">,</span>
</span><span id="Interactor-2310"><a href="#Interactor-2310"><span class="linenos">2310</span></a>                    <span class="s2">&quot;tool_call_id&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Interactor-2311"><a href="#Interactor-2311"><span class="linenos">2311</span></a>                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="Interactor-2312"><a href="#Interactor-2312"><span class="linenos">2312</span></a>                <span class="p">}</span>
</span><span id="Interactor-2313"><a href="#Interactor-2313"><span class="linenos">2313</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_msg</span><span class="p">)</span>
</span><span id="Interactor-2314"><a href="#Interactor-2314"><span class="linenos">2314</span></a>
</span><span id="Interactor-2315"><a href="#Interactor-2315"><span class="linenos">2315</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_anthropic_normalize_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="Interactor-2316"><a href="#Interactor-2316"><span class="linenos">2316</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize a single message to Anthropic format and add to history.&quot;&quot;&quot;</span>
</span><span id="Interactor-2317"><a href="#Interactor-2317"><span class="linenos">2317</span></a>        <span class="n">role</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span>
</span><span id="Interactor-2318"><a href="#Interactor-2318"><span class="linenos">2318</span></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span>
</span><span id="Interactor-2319"><a href="#Interactor-2319"><span class="linenos">2319</span></a>        
</span><span id="Interactor-2320"><a href="#Interactor-2320"><span class="linenos">2320</span></a>        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="Interactor-2321"><a href="#Interactor-2321"><span class="linenos">2321</span></a>            <span class="c1"># Store system prompt separately, not in history for Anthropic</span>
</span><span id="Interactor-2322"><a href="#Interactor-2322"><span class="linenos">2322</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="Interactor-2323"><a href="#Interactor-2323"><span class="linenos">2323</span></a>            
</span><span id="Interactor-2324"><a href="#Interactor-2324"><span class="linenos">2324</span></a>        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span>
</span><span id="Interactor-2325"><a href="#Interactor-2325"><span class="linenos">2325</span></a>            <span class="c1"># User messages - check if it contains tool results</span>
</span><span id="Interactor-2326"><a href="#Interactor-2326"><span class="linenos">2326</span></a>            <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="s2">&quot;tool_info&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]:</span>
</span><span id="Interactor-2327"><a href="#Interactor-2327"><span class="linenos">2327</span></a>                <span class="n">tool_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span>
</span><span id="Interactor-2328"><a href="#Interactor-2328"><span class="linenos">2328</span></a>                <span class="c1"># Check for result or directly use content</span>
</span><span id="Interactor-2329"><a href="#Interactor-2329"><span class="linenos">2329</span></a>                <span class="n">result_content</span> <span class="o">=</span> <span class="n">tool_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span><span id="Interactor-2330"><a href="#Interactor-2330"><span class="linenos">2330</span></a>                
</span><span id="Interactor-2331"><a href="#Interactor-2331"><span class="linenos">2331</span></a>                <span class="c1"># Create Anthropic tool result format</span>
</span><span id="Interactor-2332"><a href="#Interactor-2332"><span class="linenos">2332</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-2333"><a href="#Interactor-2333"><span class="linenos">2333</span></a>                    <span class="n">result_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result_content</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_content</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">result_content</span><span class="p">)</span>
</span><span id="Interactor-2334"><a href="#Interactor-2334"><span class="linenos">2334</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="Interactor-2335"><a href="#Interactor-2335"><span class="linenos">2335</span></a>                    <span class="n">result_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result_content</span><span class="p">)</span>
</span><span id="Interactor-2336"><a href="#Interactor-2336"><span class="linenos">2336</span></a>                    
</span><span id="Interactor-2337"><a href="#Interactor-2337"><span class="linenos">2337</span></a>                <span class="n">tool_result_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-2338"><a href="#Interactor-2338"><span class="linenos">2338</span></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="Interactor-2339"><a href="#Interactor-2339"><span class="linenos">2339</span></a>                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span id="Interactor-2340"><a href="#Interactor-2340"><span class="linenos">2340</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;tool_result&quot;</span><span class="p">,</span>
</span><span id="Interactor-2341"><a href="#Interactor-2341"><span class="linenos">2341</span></a>                        <span class="s2">&quot;tool_use_id&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Interactor-2342"><a href="#Interactor-2342"><span class="linenos">2342</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">result_str</span>
</span><span id="Interactor-2343"><a href="#Interactor-2343"><span class="linenos">2343</span></a>                    <span class="p">}]</span>
</span><span id="Interactor-2344"><a href="#Interactor-2344"><span class="linenos">2344</span></a>                <span class="p">}</span>
</span><span id="Interactor-2345"><a href="#Interactor-2345"><span class="linenos">2345</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_result_msg</span><span class="p">)</span>
</span><span id="Interactor-2346"><a href="#Interactor-2346"><span class="linenos">2346</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2347"><a href="#Interactor-2347"><span class="linenos">2347</span></a>                <span class="c1"># Regular user message</span>
</span><span id="Interactor-2348"><a href="#Interactor-2348"><span class="linenos">2348</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2349"><a href="#Interactor-2349"><span class="linenos">2349</span></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="Interactor-2350"><a href="#Interactor-2350"><span class="linenos">2350</span></a>                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span>
</span><span id="Interactor-2351"><a href="#Interactor-2351"><span class="linenos">2351</span></a>                <span class="p">})</span>
</span><span id="Interactor-2352"><a href="#Interactor-2352"><span class="linenos">2352</span></a>                
</span><span id="Interactor-2353"><a href="#Interactor-2353"><span class="linenos">2353</span></a>        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span><span class="p">:</span>
</span><span id="Interactor-2354"><a href="#Interactor-2354"><span class="linenos">2354</span></a>            <span class="c1"># For assistant messages, check for tool use</span>
</span><span id="Interactor-2355"><a href="#Interactor-2355"><span class="linenos">2355</span></a>            <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="s2">&quot;tool_info&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]:</span>
</span><span id="Interactor-2356"><a href="#Interactor-2356"><span class="linenos">2356</span></a>                <span class="c1"># This is an assistant message with tool use</span>
</span><span id="Interactor-2357"><a href="#Interactor-2357"><span class="linenos">2357</span></a>                <span class="n">tool_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span>
</span><span id="Interactor-2358"><a href="#Interactor-2358"><span class="linenos">2358</span></a>                
</span><span id="Interactor-2359"><a href="#Interactor-2359"><span class="linenos">2359</span></a>                <span class="c1"># Build content blocks</span>
</span><span id="Interactor-2360"><a href="#Interactor-2360"><span class="linenos">2360</span></a>                <span class="n">content_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-2361"><a href="#Interactor-2361"><span class="linenos">2361</span></a>                
</span><span id="Interactor-2362"><a href="#Interactor-2362"><span class="linenos">2362</span></a>                <span class="c1"># Add text content if present</span>
</span><span id="Interactor-2363"><a href="#Interactor-2363"><span class="linenos">2363</span></a>                <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
</span><span id="Interactor-2364"><a href="#Interactor-2364"><span class="linenos">2364</span></a>                    <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2365"><a href="#Interactor-2365"><span class="linenos">2365</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
</span><span id="Interactor-2366"><a href="#Interactor-2366"><span class="linenos">2366</span></a>                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">content</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="Interactor-2367"><a href="#Interactor-2367"><span class="linenos">2367</span></a>                    <span class="p">})</span>
</span><span id="Interactor-2368"><a href="#Interactor-2368"><span class="linenos">2368</span></a>                    
</span><span id="Interactor-2369"><a href="#Interactor-2369"><span class="linenos">2369</span></a>                <span class="c1"># Add tool use block - safely convert arguments</span>
</span><span id="Interactor-2370"><a href="#Interactor-2370"><span class="linenos">2370</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-2371"><a href="#Interactor-2371"><span class="linenos">2371</span></a>                    <span class="c1"># Parse arguments to ensure it&#39;s a dictionary</span>
</span><span id="Interactor-2372"><a href="#Interactor-2372"><span class="linenos">2372</span></a>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor-2373"><a href="#Interactor-2373"><span class="linenos">2373</span></a>                        <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-2374"><a href="#Interactor-2374"><span class="linenos">2374</span></a>                            <span class="n">args_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">])</span>
</span><span id="Interactor-2375"><a href="#Interactor-2375"><span class="linenos">2375</span></a>                        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
</span><span id="Interactor-2376"><a href="#Interactor-2376"><span class="linenos">2376</span></a>                            <span class="n">args_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]}</span>
</span><span id="Interactor-2377"><a href="#Interactor-2377"><span class="linenos">2377</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2378"><a href="#Interactor-2378"><span class="linenos">2378</span></a>                        <span class="n">args_dict</span> <span class="o">=</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;arguments&quot;</span><span class="p">]</span>
</span><span id="Interactor-2379"><a href="#Interactor-2379"><span class="linenos">2379</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="Interactor-2380"><a href="#Interactor-2380"><span class="linenos">2380</span></a>                    <span class="n">args_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Failed to parse arguments&quot;</span><span class="p">}</span>
</span><span id="Interactor-2381"><a href="#Interactor-2381"><span class="linenos">2381</span></a>                    
</span><span id="Interactor-2382"><a href="#Interactor-2382"><span class="linenos">2382</span></a>                <span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2383"><a href="#Interactor-2383"><span class="linenos">2383</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;tool_use&quot;</span><span class="p">,</span>
</span><span id="Interactor-2384"><a href="#Interactor-2384"><span class="linenos">2384</span></a>                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Interactor-2385"><a href="#Interactor-2385"><span class="linenos">2385</span></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Interactor-2386"><a href="#Interactor-2386"><span class="linenos">2386</span></a>                    <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">args_dict</span>
</span><span id="Interactor-2387"><a href="#Interactor-2387"><span class="linenos">2387</span></a>                <span class="p">})</span>
</span><span id="Interactor-2388"><a href="#Interactor-2388"><span class="linenos">2388</span></a>                
</span><span id="Interactor-2389"><a href="#Interactor-2389"><span class="linenos">2389</span></a>                <span class="c1"># Create Anthropic assistant message with tool use</span>
</span><span id="Interactor-2390"><a href="#Interactor-2390"><span class="linenos">2390</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2391"><a href="#Interactor-2391"><span class="linenos">2391</span></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="Interactor-2392"><a href="#Interactor-2392"><span class="linenos">2392</span></a>                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content_blocks</span>
</span><span id="Interactor-2393"><a href="#Interactor-2393"><span class="linenos">2393</span></a>                <span class="p">})</span>
</span><span id="Interactor-2394"><a href="#Interactor-2394"><span class="linenos">2394</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2395"><a href="#Interactor-2395"><span class="linenos">2395</span></a>                <span class="c1"># Regular assistant message</span>
</span><span id="Interactor-2396"><a href="#Interactor-2396"><span class="linenos">2396</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2397"><a href="#Interactor-2397"><span class="linenos">2397</span></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="Interactor-2398"><a href="#Interactor-2398"><span class="linenos">2398</span></a>                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span>
</span><span id="Interactor-2399"><a href="#Interactor-2399"><span class="linenos">2399</span></a>                <span class="p">})</span>
</span><span id="Interactor-2400"><a href="#Interactor-2400"><span class="linenos">2400</span></a>                
</span><span id="Interactor-2401"><a href="#Interactor-2401"><span class="linenos">2401</span></a>        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;tool&quot;</span><span class="p">:</span>
</span><span id="Interactor-2402"><a href="#Interactor-2402"><span class="linenos">2402</span></a>            <span class="c1"># Tool messages in standard format get converted to user messages with tool_result</span>
</span><span id="Interactor-2403"><a href="#Interactor-2403"><span class="linenos">2403</span></a>            <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="s2">&quot;tool_info&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]:</span>
</span><span id="Interactor-2404"><a href="#Interactor-2404"><span class="linenos">2404</span></a>                <span class="n">tool_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span>
</span><span id="Interactor-2405"><a href="#Interactor-2405"><span class="linenos">2405</span></a>                
</span><span id="Interactor-2406"><a href="#Interactor-2406"><span class="linenos">2406</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor-2407"><a href="#Interactor-2407"><span class="linenos">2407</span></a>                    <span class="n">result_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="Interactor-2408"><a href="#Interactor-2408"><span class="linenos">2408</span></a>                <span class="k">except</span><span class="p">:</span>
</span><span id="Interactor-2409"><a href="#Interactor-2409"><span class="linenos">2409</span></a>                    <span class="n">result_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="Interactor-2410"><a href="#Interactor-2410"><span class="linenos">2410</span></a>                    
</span><span id="Interactor-2411"><a href="#Interactor-2411"><span class="linenos">2411</span></a>                <span class="c1"># Create Anthropic tool result message</span>
</span><span id="Interactor-2412"><a href="#Interactor-2412"><span class="linenos">2412</span></a>                <span class="n">tool_result_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-2413"><a href="#Interactor-2413"><span class="linenos">2413</span></a>                    <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="Interactor-2414"><a href="#Interactor-2414"><span class="linenos">2414</span></a>                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span id="Interactor-2415"><a href="#Interactor-2415"><span class="linenos">2415</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;tool_result&quot;</span><span class="p">,</span>
</span><span id="Interactor-2416"><a href="#Interactor-2416"><span class="linenos">2416</span></a>                        <span class="s2">&quot;tool_use_id&quot;</span><span class="p">:</span> <span class="n">tool_info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Interactor-2417"><a href="#Interactor-2417"><span class="linenos">2417</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">result_str</span>
</span><span id="Interactor-2418"><a href="#Interactor-2418"><span class="linenos">2418</span></a>                    <span class="p">}]</span>
</span><span id="Interactor-2419"><a href="#Interactor-2419"><span class="linenos">2419</span></a>                <span class="p">}</span>
</span><span id="Interactor-2420"><a href="#Interactor-2420"><span class="linenos">2420</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_result_msg</span><span class="p">)</span>
</span><span id="Interactor-2421"><a href="#Interactor-2421"><span class="linenos">2421</span></a>
</span><span id="Interactor-2422"><a href="#Interactor-2422"><span class="linenos">2422</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generic_normalize_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="Interactor-2423"><a href="#Interactor-2423"><span class="linenos">2423</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generic normalizer for unknown SDKs.&quot;&quot;&quot;</span>
</span><span id="Interactor-2424"><a href="#Interactor-2424"><span class="linenos">2424</span></a>        <span class="n">role</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span>
</span><span id="Interactor-2425"><a href="#Interactor-2425"><span class="linenos">2425</span></a>        <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span>
</span><span id="Interactor-2426"><a href="#Interactor-2426"><span class="linenos">2426</span></a>        
</span><span id="Interactor-2427"><a href="#Interactor-2427"><span class="linenos">2427</span></a>        <span class="k">if</span> <span class="n">role</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">]:</span>
</span><span id="Interactor-2428"><a href="#Interactor-2428"><span class="linenos">2428</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2429"><a href="#Interactor-2429"><span class="linenos">2429</span></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
</span><span id="Interactor-2430"><a href="#Interactor-2430"><span class="linenos">2430</span></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span>
</span><span id="Interactor-2431"><a href="#Interactor-2431"><span class="linenos">2431</span></a>            <span class="p">})</span>
</span><span id="Interactor-2432"><a href="#Interactor-2432"><span class="linenos">2432</span></a>
</span><span id="Interactor-2433"><a href="#Interactor-2433"><span class="linenos">2433</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">track_token_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Interactor-2434"><a href="#Interactor-2434"><span class="linenos">2434</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Track and return token usage across the conversation history.</span>
</span><span id="Interactor-2435"><a href="#Interactor-2435"><span class="linenos">2435</span></a><span class="sd">        </span>
</span><span id="Interactor-2436"><a href="#Interactor-2436"><span class="linenos">2436</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-2437"><a href="#Interactor-2437"><span class="linenos">2437</span></a><span class="sd">            dict: Dictionary containing current token counts, limits, and history.</span>
</span><span id="Interactor-2438"><a href="#Interactor-2438"><span class="linenos">2438</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-2439"><a href="#Interactor-2439"><span class="linenos">2439</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_token_history&quot;</span><span class="p">):</span>
</span><span id="Interactor-2440"><a href="#Interactor-2440"><span class="linenos">2440</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor-2441"><a href="#Interactor-2441"><span class="linenos">2441</span></a>        
</span><span id="Interactor-2442"><a href="#Interactor-2442"><span class="linenos">2442</span></a>        <span class="c1"># Count current tokens</span>
</span><span id="Interactor-2443"><a href="#Interactor-2443"><span class="linenos">2443</span></a>        <span class="n">current_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_tokens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="Interactor-2444"><a href="#Interactor-2444"><span class="linenos">2444</span></a>        
</span><span id="Interactor-2445"><a href="#Interactor-2445"><span class="linenos">2445</span></a>        <span class="c1"># Add to history</span>
</span><span id="Interactor-2446"><a href="#Interactor-2446"><span class="linenos">2446</span></a>        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="Interactor-2447"><a href="#Interactor-2447"><span class="linenos">2447</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2448"><a href="#Interactor-2448"><span class="linenos">2448</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span><span id="Interactor-2449"><a href="#Interactor-2449"><span class="linenos">2449</span></a>            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">current_count</span><span class="p">,</span>
</span><span id="Interactor-2450"><a href="#Interactor-2450"><span class="linenos">2450</span></a>            <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="p">,</span>
</span><span id="Interactor-2451"><a href="#Interactor-2451"><span class="linenos">2451</span></a>            <span class="s2">&quot;provider&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
</span><span id="Interactor-2452"><a href="#Interactor-2452"><span class="linenos">2452</span></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</span><span id="Interactor-2453"><a href="#Interactor-2453"><span class="linenos">2453</span></a>        <span class="p">})</span>
</span><span id="Interactor-2454"><a href="#Interactor-2454"><span class="linenos">2454</span></a>        
</span><span id="Interactor-2455"><a href="#Interactor-2455"><span class="linenos">2455</span></a>        <span class="c1"># Keep only the last 100 measurements to avoid unlimited growth</span>
</span><span id="Interactor-2456"><a href="#Interactor-2456"><span class="linenos">2456</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="Interactor-2457"><a href="#Interactor-2457"><span class="linenos">2457</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
</span><span id="Interactor-2458"><a href="#Interactor-2458"><span class="linenos">2458</span></a>        
</span><span id="Interactor-2459"><a href="#Interactor-2459"><span class="linenos">2459</span></a>        <span class="c1"># Return current tracking info</span>
</span><span id="Interactor-2460"><a href="#Interactor-2460"><span class="linenos">2460</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Interactor-2461"><a href="#Interactor-2461"><span class="linenos">2461</span></a>            <span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="n">current_count</span><span class="p">,</span>
</span><span id="Interactor-2462"><a href="#Interactor-2462"><span class="linenos">2462</span></a>            <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="p">,</span>
</span><span id="Interactor-2463"><a href="#Interactor-2463"><span class="linenos">2463</span></a>            <span class="s2">&quot;percentage&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">current_count</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor-2464"><a href="#Interactor-2464"><span class="linenos">2464</span></a>            <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:],</span>  <span class="c1"># Return last 10 measurements</span>
</span><span id="Interactor-2465"><a href="#Interactor-2465"><span class="linenos">2465</span></a>            <span class="s2">&quot;provider&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
</span><span id="Interactor-2466"><a href="#Interactor-2466"><span class="linenos">2466</span></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</span><span id="Interactor-2467"><a href="#Interactor-2467"><span class="linenos">2467</span></a>        <span class="p">}</span>
</span><span id="Interactor-2468"><a href="#Interactor-2468"><span class="linenos">2468</span></a>
</span><span id="Interactor-2469"><a href="#Interactor-2469"><span class="linenos">2469</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_message_token_breakdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Interactor-2470"><a href="#Interactor-2470"><span class="linenos">2470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze token usage by message type and provide a detailed breakdown.</span>
</span><span id="Interactor-2471"><a href="#Interactor-2471"><span class="linenos">2471</span></a><span class="sd">        </span>
</span><span id="Interactor-2472"><a href="#Interactor-2472"><span class="linenos">2472</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor-2473"><a href="#Interactor-2473"><span class="linenos">2473</span></a><span class="sd">            dict: Token usage broken down by message types and roles.</span>
</span><span id="Interactor-2474"><a href="#Interactor-2474"><span class="linenos">2474</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor-2475"><a href="#Interactor-2475"><span class="linenos">2475</span></a>        <span class="n">breakdown</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor-2476"><a href="#Interactor-2476"><span class="linenos">2476</span></a>            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor-2477"><a href="#Interactor-2477"><span class="linenos">2477</span></a>            <span class="s2">&quot;by_role&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-2478"><a href="#Interactor-2478"><span class="linenos">2478</span></a>                <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor-2479"><a href="#Interactor-2479"><span class="linenos">2479</span></a>                <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor-2480"><a href="#Interactor-2480"><span class="linenos">2480</span></a>                <span class="s2">&quot;assistant&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor-2481"><a href="#Interactor-2481"><span class="linenos">2481</span></a>                <span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="Interactor-2482"><a href="#Interactor-2482"><span class="linenos">2482</span></a>            <span class="p">},</span>
</span><span id="Interactor-2483"><a href="#Interactor-2483"><span class="linenos">2483</span></a>            <span class="s2">&quot;by_type&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor-2484"><a href="#Interactor-2484"><span class="linenos">2484</span></a>                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor-2485"><a href="#Interactor-2485"><span class="linenos">2485</span></a>                <span class="s2">&quot;tool_calls&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor-2486"><a href="#Interactor-2486"><span class="linenos">2486</span></a>                <span class="s2">&quot;tool_results&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="Interactor-2487"><a href="#Interactor-2487"><span class="linenos">2487</span></a>            <span class="p">},</span>
</span><span id="Interactor-2488"><a href="#Interactor-2488"><span class="linenos">2488</span></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="Interactor-2489"><a href="#Interactor-2489"><span class="linenos">2489</span></a>        <span class="p">}</span>
</span><span id="Interactor-2490"><a href="#Interactor-2490"><span class="linenos">2490</span></a>        
</span><span id="Interactor-2491"><a href="#Interactor-2491"><span class="linenos">2491</span></a>        <span class="c1"># Analyze each message</span>
</span><span id="Interactor-2492"><a href="#Interactor-2492"><span class="linenos">2492</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">):</span>
</span><span id="Interactor-2493"><a href="#Interactor-2493"><span class="linenos">2493</span></a>            <span class="n">msg_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_tokens</span><span class="p">([</span><span class="n">msg</span><span class="p">])</span>
</span><span id="Interactor-2494"><a href="#Interactor-2494"><span class="linenos">2494</span></a>            <span class="n">role</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="Interactor-2495"><a href="#Interactor-2495"><span class="linenos">2495</span></a>            
</span><span id="Interactor-2496"><a href="#Interactor-2496"><span class="linenos">2496</span></a>            <span class="c1"># Track by role</span>
</span><span id="Interactor-2497"><a href="#Interactor-2497"><span class="linenos">2497</span></a>            <span class="k">if</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;by_role&quot;</span><span class="p">]:</span>
</span><span id="Interactor-2498"><a href="#Interactor-2498"><span class="linenos">2498</span></a>                <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;by_role&quot;</span><span class="p">][</span><span class="n">role</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg_tokens</span>
</span><span id="Interactor-2499"><a href="#Interactor-2499"><span class="linenos">2499</span></a>            
</span><span id="Interactor-2500"><a href="#Interactor-2500"><span class="linenos">2500</span></a>            <span class="c1"># Track by content type</span>
</span><span id="Interactor-2501"><a href="#Interactor-2501"><span class="linenos">2501</span></a>            <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">):</span>
</span><span id="Interactor-2502"><a href="#Interactor-2502"><span class="linenos">2502</span></a>                <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;by_type&quot;</span><span class="p">][</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg_tokens</span>
</span><span id="Interactor-2503"><a href="#Interactor-2503"><span class="linenos">2503</span></a>            <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;tool&quot;</span><span class="p">:</span>
</span><span id="Interactor-2504"><a href="#Interactor-2504"><span class="linenos">2504</span></a>                <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;by_type&quot;</span><span class="p">][</span><span class="s2">&quot;tool_results&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg_tokens</span>
</span><span id="Interactor-2505"><a href="#Interactor-2505"><span class="linenos">2505</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor-2506"><a href="#Interactor-2506"><span class="linenos">2506</span></a>                <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;by_type&quot;</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg_tokens</span>
</span><span id="Interactor-2507"><a href="#Interactor-2507"><span class="linenos">2507</span></a>            
</span><span id="Interactor-2508"><a href="#Interactor-2508"><span class="linenos">2508</span></a>            <span class="c1"># Add individual message data</span>
</span><span id="Interactor-2509"><a href="#Interactor-2509"><span class="linenos">2509</span></a>            <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor-2510"><a href="#Interactor-2510"><span class="linenos">2510</span></a>                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
</span><span id="Interactor-2511"><a href="#Interactor-2511"><span class="linenos">2511</span></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
</span><span id="Interactor-2512"><a href="#Interactor-2512"><span class="linenos">2512</span></a>                <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="n">msg_tokens</span><span class="p">,</span>
</span><span id="Interactor-2513"><a href="#Interactor-2513"><span class="linenos">2513</span></a>                <span class="s2">&quot;has_tools&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use&quot;</span><span class="p">)</span> <span class="ow">or</span> 
</span><span id="Interactor-2514"><a href="#Interactor-2514"><span class="linenos">2514</span></a>                                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">),</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> 
</span><span id="Interactor-2515"><a href="#Interactor-2515"><span class="linenos">2515</span></a>                                 <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tool_use&quot;</span><span class="p">,</span> <span class="s2">&quot;tool_result&quot;</span><span class="p">]</span> 
</span><span id="Interactor-2516"><a href="#Interactor-2516"><span class="linenos">2516</span></a>                                     <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[]))))</span>
</span><span id="Interactor-2517"><a href="#Interactor-2517"><span class="linenos">2517</span></a>            <span class="p">})</span>
</span><span id="Interactor-2518"><a href="#Interactor-2518"><span class="linenos">2518</span></a>            
</span><span id="Interactor-2519"><a href="#Interactor-2519"><span class="linenos">2519</span></a>            <span class="c1"># Update tota?</span>
</span><span id="Interactor-2520"><a href="#Interactor-2520"><span class="linenos">2520</span></a>            <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg_tokens</span>
</span><span id="Interactor-2521"><a href="#Interactor-2521"><span class="linenos">2521</span></a>        
</span><span id="Interactor-2522"><a href="#Interactor-2522"><span class="linenos">2522</span></a>        <span class="k">return</span> <span class="n">breakdown</span>
</span></pre></div>


    

                            <div id="Interactor.__init__" class="classattr">
                                        <input id="Interactor.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Interactor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">base_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;openai:gpt-4o-mini&#39;</span>,</span><span class="param">	<span class="n">fallback_model</span><span class="o">=</span><span class="s1">&#39;ollama:mistral-nemo:latest&#39;</span>,</span><span class="param">	<span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">context_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128000</span>,</span><span class="param">	<span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">retry_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">log_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Interactor.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.__init__-62"><a href="#Interactor.__init__-62"><span class="linenos"> 62</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Interactor.__init__-63"><a href="#Interactor.__init__-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor.__init__-64"><a href="#Interactor.__init__-64"><span class="linenos"> 64</span></a>        <span class="n">base_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor.__init__-65"><a href="#Interactor.__init__-65"><span class="linenos"> 65</span></a>        <span class="n">api_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor.__init__-66"><a href="#Interactor.__init__-66"><span class="linenos"> 66</span></a>        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;openai:gpt-4o-mini&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-67"><a href="#Interactor.__init__-67"><span class="linenos"> 67</span></a>        <span class="n">fallback_model</span> <span class="o">=</span> <span class="s2">&quot;ollama:mistral-nemo:latest&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-68"><a href="#Interactor.__init__-68"><span class="linenos"> 68</span></a>        <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Interactor.__init__-69"><a href="#Interactor.__init__-69"><span class="linenos"> 69</span></a>        <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Interactor.__init__-70"><a href="#Interactor.__init__-70"><span class="linenos"> 70</span></a>        <span class="n">context_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">,</span>
</span><span id="Interactor.__init__-71"><a href="#Interactor.__init__-71"><span class="linenos"> 71</span></a>        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="Interactor.__init__-72"><a href="#Interactor.__init__-72"><span class="linenos"> 72</span></a>        <span class="n">retry_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="Interactor.__init__-73"><a href="#Interactor.__init__-73"><span class="linenos"> 73</span></a>        <span class="n">log_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor.__init__-74"><a href="#Interactor.__init__-74"><span class="linenos"> 74</span></a>        <span class="n">session_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor.__init__-75"><a href="#Interactor.__init__-75"><span class="linenos"> 75</span></a>        <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor.__init__-76"><a href="#Interactor.__init__-76"><span class="linenos"> 76</span></a>        <span class="n">session_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.__init__-77"><a href="#Interactor.__init__-77"><span class="linenos"> 77</span></a>    <span class="p">):</span>
</span><span id="Interactor.__init__-78"><a href="#Interactor.__init__-78"><span class="linenos"> 78</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the universal AI interaction client.</span>
</span><span id="Interactor.__init__-79"><a href="#Interactor.__init__-79"><span class="linenos"> 79</span></a>
</span><span id="Interactor.__init__-80"><a href="#Interactor.__init__-80"><span class="linenos"> 80</span></a><span class="sd">        Args:</span>
</span><span id="Interactor.__init__-81"><a href="#Interactor.__init__-81"><span class="linenos"> 81</span></a><span class="sd">            base_url: Optional base URL for the API. If None, uses the provider&#39;s default URL.</span>
</span><span id="Interactor.__init__-82"><a href="#Interactor.__init__-82"><span class="linenos"> 82</span></a><span class="sd">            api_key: Optional API key. If None, attempts to use environment variables based on provider.</span>
</span><span id="Interactor.__init__-83"><a href="#Interactor.__init__-83"><span class="linenos"> 83</span></a><span class="sd">            model: Model identifier in format &quot;provider:model_name&quot; (e.g., &quot;openai:gpt-4o-mini&quot;).</span>
</span><span id="Interactor.__init__-84"><a href="#Interactor.__init__-84"><span class="linenos"> 84</span></a><span class="sd">            tools: Enable (True) or disable (False) tool calling; None for auto-detection based on model support.</span>
</span><span id="Interactor.__init__-85"><a href="#Interactor.__init__-85"><span class="linenos"> 85</span></a><span class="sd">            stream: Enable (True) or disable (False) streaming responses.</span>
</span><span id="Interactor.__init__-86"><a href="#Interactor.__init__-86"><span class="linenos"> 86</span></a><span class="sd">            context_length: Maximum number of tokens to maintain in conversation history.</span>
</span><span id="Interactor.__init__-87"><a href="#Interactor.__init__-87"><span class="linenos"> 87</span></a><span class="sd">            max_retries: Maximum number of retries for failed API calls.</span>
</span><span id="Interactor.__init__-88"><a href="#Interactor.__init__-88"><span class="linenos"> 88</span></a><span class="sd">            retry_delay: Initial delay (in seconds) for exponential backoff retries.</span>
</span><span id="Interactor.__init__-89"><a href="#Interactor.__init__-89"><span class="linenos"> 89</span></a><span class="sd">            session_enabled: Enable persistent session support.</span>
</span><span id="Interactor.__init__-90"><a href="#Interactor.__init__-90"><span class="linenos"> 90</span></a><span class="sd">            session_id: Optional session ID to load messages from.</span>
</span><span id="Interactor.__init__-91"><a href="#Interactor.__init__-91"><span class="linenos"> 91</span></a>
</span><span id="Interactor.__init__-92"><a href="#Interactor.__init__-92"><span class="linenos"> 92</span></a><span class="sd">        Raises:</span>
</span><span id="Interactor.__init__-93"><a href="#Interactor.__init__-93"><span class="linenos"> 93</span></a><span class="sd">            ValueError: If provider is not supported or API key is missing for non-Ollama providers.</span>
</span><span id="Interactor.__init__-94"><a href="#Interactor.__init__-94"><span class="linenos"> 94</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor.__init__-95"><a href="#Interactor.__init__-95"><span class="linenos"> 95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;You are a helpful Assistant.&quot;</span>
</span><span id="Interactor.__init__-96"><a href="#Interactor.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;InteractorLogger_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor.__init__-97"><a href="#Interactor.__init__-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span id="Interactor.__init__-98"><a href="#Interactor.__init__-98"><span class="linenos"> 98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">providers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor.__init__-99"><a href="#Interactor.__init__-99"><span class="linenos"> 99</span></a>            <span class="s2">&quot;openai&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.__init__-100"><a href="#Interactor.__init__-100"><span class="linenos">100</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-101"><a href="#Interactor.__init__-101"><span class="linenos">101</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.openai.com/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-102"><a href="#Interactor.__init__-102"><span class="linenos">102</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor.__init__-103"><a href="#Interactor.__init__-103"><span class="linenos">103</span></a>            <span class="p">},</span>
</span><span id="Interactor.__init__-104"><a href="#Interactor.__init__-104"><span class="linenos">104</span></a>           <span class="s2">&quot;ollama&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.__init__-105"><a href="#Interactor.__init__-105"><span class="linenos">105</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-106"><a href="#Interactor.__init__-106"><span class="linenos">106</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://localhost:11434/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-107"><a href="#Interactor.__init__-107"><span class="linenos">107</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="s2">&quot;ollama&quot;</span>
</span><span id="Interactor.__init__-108"><a href="#Interactor.__init__-108"><span class="linenos">108</span></a>            <span class="p">},</span>
</span><span id="Interactor.__init__-109"><a href="#Interactor.__init__-109"><span class="linenos">109</span></a>            <span class="s2">&quot;nvidia&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.__init__-110"><a href="#Interactor.__init__-110"><span class="linenos">110</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-111"><a href="#Interactor.__init__-111"><span class="linenos">111</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://integrate.api.nvidia.com/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-112"><a href="#Interactor.__init__-112"><span class="linenos">112</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NVIDIA_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor.__init__-113"><a href="#Interactor.__init__-113"><span class="linenos">113</span></a>            <span class="p">},</span>
</span><span id="Interactor.__init__-114"><a href="#Interactor.__init__-114"><span class="linenos">114</span></a>            <span class="s2">&quot;google&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.__init__-115"><a href="#Interactor.__init__-115"><span class="linenos">115</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-116"><a href="#Interactor.__init__-116"><span class="linenos">116</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://generativelanguage.googleapis.com/v1beta/openai&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-117"><a href="#Interactor.__init__-117"><span class="linenos">117</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GEMINI_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor.__init__-118"><a href="#Interactor.__init__-118"><span class="linenos">118</span></a>            <span class="p">},</span>
</span><span id="Interactor.__init__-119"><a href="#Interactor.__init__-119"><span class="linenos">119</span></a>            <span class="s2">&quot;anthropic&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.__init__-120"><a href="#Interactor.__init__-120"><span class="linenos">120</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;anthropic&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-121"><a href="#Interactor.__init__-121"><span class="linenos">121</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.anthropic.com/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-122"><a href="#Interactor.__init__-122"><span class="linenos">122</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor.__init__-123"><a href="#Interactor.__init__-123"><span class="linenos">123</span></a>            <span class="p">},</span>
</span><span id="Interactor.__init__-124"><a href="#Interactor.__init__-124"><span class="linenos">124</span></a>            <span class="s2">&quot;mistral&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.__init__-125"><a href="#Interactor.__init__-125"><span class="linenos">125</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-126"><a href="#Interactor.__init__-126"><span class="linenos">126</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.mistral.ai/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-127"><a href="#Interactor.__init__-127"><span class="linenos">127</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MISTRAL_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor.__init__-128"><a href="#Interactor.__init__-128"><span class="linenos">128</span></a>            <span class="p">},</span>
</span><span id="Interactor.__init__-129"><a href="#Interactor.__init__-129"><span class="linenos">129</span></a>            <span class="s2">&quot;deepseek&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.__init__-130"><a href="#Interactor.__init__-130"><span class="linenos">130</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;openai&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-131"><a href="#Interactor.__init__-131"><span class="linenos">131</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.deepseek.com&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-132"><a href="#Interactor.__init__-132"><span class="linenos">132</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor.__init__-133"><a href="#Interactor.__init__-133"><span class="linenos">133</span></a>            <span class="p">},</span>
</span><span id="Interactor.__init__-134"><a href="#Interactor.__init__-134"><span class="linenos">134</span></a>            <span class="s2">&quot;grok&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.__init__-135"><a href="#Interactor.__init__-135"><span class="linenos">135</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="s2">&quot;grok&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-136"><a href="#Interactor.__init__-136"><span class="linenos">136</span></a>                <span class="s2">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.x.ai/v1&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-137"><a href="#Interactor.__init__-137"><span class="linenos">137</span></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GROK_API_KEY&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="Interactor.__init__-138"><a href="#Interactor.__init__-138"><span class="linenos">138</span></a>            <span class="p">}</span>
</span><span id="Interactor.__init__-139"><a href="#Interactor.__init__-139"><span class="linenos">139</span></a>        <span class="p">}</span>
</span><span id="Interactor.__init__-140"><a href="#Interactor.__init__-140"><span class="linenos">140</span></a>
</span><span id="Interactor.__init__-141"><a href="#Interactor.__init__-141"><span class="linenos">141</span></a>
</span><span id="Interactor.__init__-142"><a href="#Interactor.__init__-142"><span class="linenos">142</span></a>        <span class="c1"># Console log handler (always enabled at WARNING+)</span>
</span><span id="Interactor.__init__-143"><a href="#Interactor.__init__-143"><span class="linenos">143</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
</span><span id="Interactor.__init__-144"><a href="#Interactor.__init__-144"><span class="linenos">144</span></a>            <span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</span><span id="Interactor.__init__-145"><a href="#Interactor.__init__-145"><span class="linenos">145</span></a>            <span class="n">console_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
</span><span id="Interactor.__init__-146"><a href="#Interactor.__init__-146"><span class="linenos">146</span></a>            <span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(levelname)s</span><span class="s2">: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">))</span>
</span><span id="Interactor.__init__-147"><a href="#Interactor.__init__-147"><span class="linenos">147</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>
</span><span id="Interactor.__init__-148"><a href="#Interactor.__init__-148"><span class="linenos">148</span></a>
</span><span id="Interactor.__init__-149"><a href="#Interactor.__init__-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_enabled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Interactor.__init__-150"><a href="#Interactor.__init__-150"><span class="linenos">150</span></a>        <span class="k">if</span> <span class="n">log_path</span><span class="p">:</span>
</span><span id="Interactor.__init__-151"><a href="#Interactor.__init__-151"><span class="linenos">151</span></a>            <span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_path</span><span class="p">)</span>
</span><span id="Interactor.__init__-152"><a href="#Interactor.__init__-152"><span class="linenos">152</span></a>            <span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span id="Interactor.__init__-153"><a href="#Interactor.__init__-153"><span class="linenos">153</span></a>            <span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
</span><span id="Interactor.__init__-154"><a href="#Interactor.__init__-154"><span class="linenos">154</span></a>                <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Interactor.__init__-155"><a href="#Interactor.__init__-155"><span class="linenos">155</span></a>                <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span>
</span><span id="Interactor.__init__-156"><a href="#Interactor.__init__-156"><span class="linenos">156</span></a>            <span class="p">))</span>
</span><span id="Interactor.__init__-157"><a href="#Interactor.__init__-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
</span><span id="Interactor.__init__-158"><a href="#Interactor.__init__-158"><span class="linenos">158</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log_enabled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor.__init__-159"><a href="#Interactor.__init__-159"><span class="linenos">159</span></a>
</span><span id="Interactor.__init__-160"><a href="#Interactor.__init__-160"><span class="linenos">160</span></a>
</span><span id="Interactor.__init__-161"><a href="#Interactor.__init__-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_estimate</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Interactor.__init__-162"><a href="#Interactor.__init__-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_token_estimate</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Interactor.__init__-163"><a href="#Interactor.__init__-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span>
</span><span id="Interactor.__init__-164"><a href="#Interactor.__init__-164"><span class="linenos">164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor.__init__-165"><a href="#Interactor.__init__-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor.__init__-166"><a href="#Interactor.__init__-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor.__init__-167"><a href="#Interactor.__init__-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span> <span class="o">=</span> <span class="n">context_length</span>
</span><span id="Interactor.__init__-168"><a href="#Interactor.__init__-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.__init__-169"><a href="#Interactor.__init__-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
</span><span id="Interactor.__init__-170"><a href="#Interactor.__init__-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">retry_delay</span> <span class="o">=</span> <span class="n">retry_delay</span>
</span><span id="Interactor.__init__-171"><a href="#Interactor.__init__-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reveal_tool</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor.__init__-172"><a href="#Interactor.__init__-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fallback_model</span> <span class="o">=</span> <span class="n">fallback_model</span>
</span><span id="Interactor.__init__-173"><a href="#Interactor.__init__-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.__init__-174"><a href="#Interactor.__init__-174"><span class="linenos">174</span></a>
</span><span id="Interactor.__init__-175"><a href="#Interactor.__init__-175"><span class="linenos">175</span></a>        <span class="c1"># Session support</span>
</span><span id="Interactor.__init__-176"><a href="#Interactor.__init__-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="o">=</span> <span class="n">session_enabled</span>
</span><span id="Interactor.__init__-177"><a href="#Interactor.__init__-177"><span class="linenos">177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span>
</span><span id="Interactor.__init__-178"><a href="#Interactor.__init__-178"><span class="linenos">178</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_session_id</span> <span class="o">=</span> <span class="n">session_id</span>
</span><span id="Interactor.__init__-179"><a href="#Interactor.__init__-179"><span class="linenos">179</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">session_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">session_enabled</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Interactor.__init__-180"><a href="#Interactor.__init__-180"><span class="linenos">180</span></a>
</span><span id="Interactor.__init__-181"><a href="#Interactor.__init__-181"><span class="linenos">181</span></a>
</span><span id="Interactor.__init__-182"><a href="#Interactor.__init__-182"><span class="linenos">182</span></a>        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Interactor.__init__-183"><a href="#Interactor.__init__-183"><span class="linenos">183</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;openai:gpt-4o-mini&quot;</span>
</span><span id="Interactor.__init__-184"><a href="#Interactor.__init__-184"><span class="linenos">184</span></a>
</span><span id="Interactor.__init__-185"><a href="#Interactor.__init__-185"><span class="linenos">185</span></a>        <span class="c1"># Initialize model + encoding</span>
</span><span id="Interactor.__init__-186"><a href="#Interactor.__init__-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_client</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
</span><span id="Interactor.__init__-187"><a href="#Interactor.__init__-187"><span class="linenos">187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tools_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_supported</span> <span class="k">if</span> <span class="n">tools</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tools</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_supported</span>
</span><span id="Interactor.__init__-188"><a href="#Interactor.__init__-188"><span class="linenos">188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_encoding</span><span class="p">()</span>
</span><span id="Interactor.__init__-189"><a href="#Interactor.__init__-189"><span class="linenos">189</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the universal AI interaction client.</p>

<p>Args:
    base_url: Optional base URL for the API. If None, uses the provider's default URL.
    api_key: Optional API key. If None, attempts to use environment variables based on provider.
    model: Model identifier in format "provider:model_name" (e.g., "openai:gpt-4o-mini").
    tools: Enable (True) or disable (False) tool calling; None for auto-detection based on model support.
    stream: Enable (True) or disable (False) streaming responses.
    context_length: Maximum number of tokens to maintain in conversation history.
    max_retries: Maximum number of retries for failed API calls.
    retry_delay: Initial delay (in seconds) for exponential backoff retries.
    session_enabled: Enable persistent session support.
    session_id: Optional session ID to load messages from.</p>

<p>Raises:
    ValueError: If provider is not supported or API key is missing for non-Ollama providers.</p>
</div>


                            </div>
                            <div id="Interactor.system" class="classattr">
                                <div class="attr variable">
            <span class="name">system</span>

        
    </div>
    <a class="headerlink" href="#Interactor.system"></a>
    
    

                            </div>
                            <div id="Interactor.logger" class="classattr">
                                <div class="attr variable">
            <span class="name">logger</span>

        
    </div>
    <a class="headerlink" href="#Interactor.logger"></a>
    
    

                            </div>
                            <div id="Interactor.providers" class="classattr">
                                <div class="attr variable">
            <span class="name">providers</span>

        
    </div>
    <a class="headerlink" href="#Interactor.providers"></a>
    
    

                            </div>
                            <div id="Interactor.token_estimate" class="classattr">
                                <div class="attr variable">
            <span class="name">token_estimate</span>

        
    </div>
    <a class="headerlink" href="#Interactor.token_estimate"></a>
    
    

                            </div>
                            <div id="Interactor.last_token_estimate" class="classattr">
                                <div class="attr variable">
            <span class="name">last_token_estimate</span>

        
    </div>
    <a class="headerlink" href="#Interactor.last_token_estimate"></a>
    
    

                            </div>
                            <div id="Interactor.stream" class="classattr">
                                <div class="attr variable">
            <span class="name">stream</span>

        
    </div>
    <a class="headerlink" href="#Interactor.stream"></a>
    
    

                            </div>
                            <div id="Interactor.tools" class="classattr">
                                <div class="attr variable">
            <span class="name">tools</span>

        
    </div>
    <a class="headerlink" href="#Interactor.tools"></a>
    
    

                            </div>
                            <div id="Interactor.session_history" class="classattr">
                                <div class="attr variable">
            <span class="name">session_history</span>

        
    </div>
    <a class="headerlink" href="#Interactor.session_history"></a>
    
    

                            </div>
                            <div id="Interactor.history" class="classattr">
                                <div class="attr variable">
            <span class="name">history</span>

        
    </div>
    <a class="headerlink" href="#Interactor.history"></a>
    
    

                            </div>
                            <div id="Interactor.context_length" class="classattr">
                                <div class="attr variable">
            <span class="name">context_length</span>

        
    </div>
    <a class="headerlink" href="#Interactor.context_length"></a>
    
    

                            </div>
                            <div id="Interactor.encoding" class="classattr">
                                <div class="attr variable">
            <span class="name">encoding</span>

        
    </div>
    <a class="headerlink" href="#Interactor.encoding"></a>
    
    

                            </div>
                            <div id="Interactor.max_retries" class="classattr">
                                <div class="attr variable">
            <span class="name">max_retries</span>

        
    </div>
    <a class="headerlink" href="#Interactor.max_retries"></a>
    
    

                            </div>
                            <div id="Interactor.retry_delay" class="classattr">
                                <div class="attr variable">
            <span class="name">retry_delay</span>

        
    </div>
    <a class="headerlink" href="#Interactor.retry_delay"></a>
    
    

                            </div>
                            <div id="Interactor.reveal_tool" class="classattr">
                                <div class="attr variable">
            <span class="name">reveal_tool</span>

        
    </div>
    <a class="headerlink" href="#Interactor.reveal_tool"></a>
    
    

                            </div>
                            <div id="Interactor.fallback_model" class="classattr">
                                <div class="attr variable">
            <span class="name">fallback_model</span>

        
    </div>
    <a class="headerlink" href="#Interactor.fallback_model"></a>
    
    

                            </div>
                            <div id="Interactor.sdk" class="classattr">
                                <div class="attr variable">
            <span class="name">sdk</span>

        
    </div>
    <a class="headerlink" href="#Interactor.sdk"></a>
    
    

                            </div>
                            <div id="Interactor.session_enabled" class="classattr">
                                <div class="attr variable">
            <span class="name">session_enabled</span>

        
    </div>
    <a class="headerlink" href="#Interactor.session_enabled"></a>
    
    

                            </div>
                            <div id="Interactor.session_id" class="classattr">
                                <div class="attr variable">
            <span class="name">session_id</span>

        
    </div>
    <a class="headerlink" href="#Interactor.session_id"></a>
    
    

                            </div>
                            <div id="Interactor.session" class="classattr">
                                <div class="attr variable">
            <span class="name">session</span>

        
    </div>
    <a class="headerlink" href="#Interactor.session"></a>
    
    

                            </div>
                            <div id="Interactor.tools_enabled" class="classattr">
                                <div class="attr variable">
            <span class="name">tools_enabled</span>

        
    </div>
    <a class="headerlink" href="#Interactor.tools_enabled"></a>
    
    

                            </div>
                            <div id="Interactor.add_function" class="classattr">
                                        <input id="Interactor.add_function-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_function</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">external_callable</span><span class="p">:</span> <span class="n">Callable</span>,</span><span class="param">	<span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">override</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">schema_extensions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Interactor.add_function-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.add_function"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.add_function-347"><a href="#Interactor.add_function-347"><span class="linenos">347</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_function</span><span class="p">(</span>
</span><span id="Interactor.add_function-348"><a href="#Interactor.add_function-348"><span class="linenos">348</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor.add_function-349"><a href="#Interactor.add_function-349"><span class="linenos">349</span></a>        <span class="n">external_callable</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
</span><span id="Interactor.add_function-350"><a href="#Interactor.add_function-350"><span class="linenos">350</span></a>        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor.add_function-351"><a href="#Interactor.add_function-351"><span class="linenos">351</span></a>        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor.add_function-352"><a href="#Interactor.add_function-352"><span class="linenos">352</span></a>        <span class="n">override</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor.add_function-353"><a href="#Interactor.add_function-353"><span class="linenos">353</span></a>        <span class="n">disabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor.add_function-354"><a href="#Interactor.add_function-354"><span class="linenos">354</span></a>        <span class="n">schema_extensions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.add_function-355"><a href="#Interactor.add_function-355"><span class="linenos">355</span></a>    <span class="p">):</span>
</span><span id="Interactor.add_function-356"><a href="#Interactor.add_function-356"><span class="linenos">356</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor.add_function-357"><a href="#Interactor.add_function-357"><span class="linenos">357</span></a><span class="sd">        Register a function for LLM tool calling with full type hints and metadata.</span>
</span><span id="Interactor.add_function-358"><a href="#Interactor.add_function-358"><span class="linenos">358</span></a>
</span><span id="Interactor.add_function-359"><a href="#Interactor.add_function-359"><span class="linenos">359</span></a><span class="sd">        Args:</span>
</span><span id="Interactor.add_function-360"><a href="#Interactor.add_function-360"><span class="linenos">360</span></a><span class="sd">            external_callable (Callable): The function to register.</span>
</span><span id="Interactor.add_function-361"><a href="#Interactor.add_function-361"><span class="linenos">361</span></a><span class="sd">            name (Optional[str]): Optional custom name. Defaults to function&#39;s __name__.</span>
</span><span id="Interactor.add_function-362"><a href="#Interactor.add_function-362"><span class="linenos">362</span></a><span class="sd">            description (Optional[str]): Optional custom description. Defaults to first line of docstring.</span>
</span><span id="Interactor.add_function-363"><a href="#Interactor.add_function-363"><span class="linenos">363</span></a><span class="sd">            override (bool): If True, replaces an existing tool with the same name.</span>
</span><span id="Interactor.add_function-364"><a href="#Interactor.add_function-364"><span class="linenos">364</span></a><span class="sd">            disabled (bool): If True, registers the function in a disabled state.</span>
</span><span id="Interactor.add_function-365"><a href="#Interactor.add_function-365"><span class="linenos">365</span></a><span class="sd">            schema_extensions (Optional[Dict[str, Any]]): Optional dictionary mapping parameter names to </span>
</span><span id="Interactor.add_function-366"><a href="#Interactor.add_function-366"><span class="linenos">366</span></a><span class="sd">                schema extensions that override or add to the auto-generated schema.</span>
</span><span id="Interactor.add_function-367"><a href="#Interactor.add_function-367"><span class="linenos">367</span></a>
</span><span id="Interactor.add_function-368"><a href="#Interactor.add_function-368"><span class="linenos">368</span></a><span class="sd">        Raises:</span>
</span><span id="Interactor.add_function-369"><a href="#Interactor.add_function-369"><span class="linenos">369</span></a><span class="sd">            ValueError: If the callable is invalid or duplicate name found without override.</span>
</span><span id="Interactor.add_function-370"><a href="#Interactor.add_function-370"><span class="linenos">370</span></a>
</span><span id="Interactor.add_function-371"><a href="#Interactor.add_function-371"><span class="linenos">371</span></a><span class="sd">        Example:</span>
</span><span id="Interactor.add_function-372"><a href="#Interactor.add_function-372"><span class="linenos">372</span></a><span class="sd">            interactor.add_function(</span>
</span><span id="Interactor.add_function-373"><a href="#Interactor.add_function-373"><span class="linenos">373</span></a><span class="sd">                my_tool, </span>
</span><span id="Interactor.add_function-374"><a href="#Interactor.add_function-374"><span class="linenos">374</span></a><span class="sd">                override=True, </span>
</span><span id="Interactor.add_function-375"><a href="#Interactor.add_function-375"><span class="linenos">375</span></a><span class="sd">                disabled=False,</span>
</span><span id="Interactor.add_function-376"><a href="#Interactor.add_function-376"><span class="linenos">376</span></a><span class="sd">                schema_extensions={</span>
</span><span id="Interactor.add_function-377"><a href="#Interactor.add_function-377"><span class="linenos">377</span></a><span class="sd">                    &quot;param1&quot;: {&quot;minimum&quot;: 0, &quot;maximum&quot;: 100},</span>
</span><span id="Interactor.add_function-378"><a href="#Interactor.add_function-378"><span class="linenos">378</span></a><span class="sd">                    &quot;param2&quot;: {&quot;format&quot;: &quot;email&quot;}</span>
</span><span id="Interactor.add_function-379"><a href="#Interactor.add_function-379"><span class="linenos">379</span></a><span class="sd">                }</span>
</span><span id="Interactor.add_function-380"><a href="#Interactor.add_function-380"><span class="linenos">380</span></a><span class="sd">            )</span>
</span><span id="Interactor.add_function-381"><a href="#Interactor.add_function-381"><span class="linenos">381</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor.add_function-382"><a href="#Interactor.add_function-382"><span class="linenos">382</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_python_type_to_schema</span><span class="p">(</span><span class="n">ptype</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="Interactor.add_function-383"><a href="#Interactor.add_function-383"><span class="linenos">383</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Convert a Python type annotation to OpenAI-compatible JSON Schema.&quot;&quot;&quot;</span>
</span><span id="Interactor.add_function-384"><a href="#Interactor.add_function-384"><span class="linenos">384</span></a>            <span class="c1"># Handle None case</span>
</span><span id="Interactor.add_function-385"><a href="#Interactor.add_function-385"><span class="linenos">385</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Interactor.add_function-386"><a href="#Interactor.add_function-386"><span class="linenos">386</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;null&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-387"><a href="#Interactor.add_function-387"><span class="linenos">387</span></a>            
</span><span id="Interactor.add_function-388"><a href="#Interactor.add_function-388"><span class="linenos">388</span></a>            <span class="c1"># Get the origin and arguments of the type</span>
</span><span id="Interactor.add_function-389"><a href="#Interactor.add_function-389"><span class="linenos">389</span></a>            <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
</span><span id="Interactor.add_function-390"><a href="#Interactor.add_function-390"><span class="linenos">390</span></a>            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
</span><span id="Interactor.add_function-391"><a href="#Interactor.add_function-391"><span class="linenos">391</span></a>            
</span><span id="Interactor.add_function-392"><a href="#Interactor.add_function-392"><span class="linenos">392</span></a>            <span class="c1"># Handle Union types (including Optional)</span>
</span><span id="Interactor.add_function-393"><a href="#Interactor.add_function-393"><span class="linenos">393</span></a>            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Union</span><span class="p">:</span>
</span><span id="Interactor.add_function-394"><a href="#Interactor.add_function-394"><span class="linenos">394</span></a>                <span class="c1"># Check for Optional (Union with None)</span>
</span><span id="Interactor.add_function-395"><a href="#Interactor.add_function-395"><span class="linenos">395</span></a>                <span class="n">none_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor.add_function-396"><a href="#Interactor.add_function-396"><span class="linenos">396</span></a>                <span class="k">if</span> <span class="n">none_type</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
</span><span id="Interactor.add_function-397"><a href="#Interactor.add_function-397"><span class="linenos">397</span></a>                    <span class="n">non_none</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">none_type</span><span class="p">]</span>
</span><span id="Interactor.add_function-398"><a href="#Interactor.add_function-398"><span class="linenos">398</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_none</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Interactor.add_function-399"><a href="#Interactor.add_function-399"><span class="linenos">399</span></a>                        <span class="n">inner</span> <span class="o">=</span> <span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">non_none</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="Interactor.add_function-400"><a href="#Interactor.add_function-400"><span class="linenos">400</span></a>                        <span class="n">inner_copy</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Interactor.add_function-401"><a href="#Interactor.add_function-401"><span class="linenos">401</span></a>                        <span class="n">inner_copy</span><span class="p">[</span><span class="s2">&quot;nullable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor.add_function-402"><a href="#Interactor.add_function-402"><span class="linenos">402</span></a>                        <span class="k">return</span> <span class="n">inner_copy</span>
</span><span id="Interactor.add_function-403"><a href="#Interactor.add_function-403"><span class="linenos">403</span></a>                    <span class="c1"># Multiple types excluding None</span>
</span><span id="Interactor.add_function-404"><a href="#Interactor.add_function-404"><span class="linenos">404</span></a>                    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">non_none</span><span class="p">]</span>
</span><span id="Interactor.add_function-405"><a href="#Interactor.add_function-405"><span class="linenos">405</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;anyOf&quot;</span><span class="p">:</span> <span class="n">types</span><span class="p">,</span> <span class="s2">&quot;nullable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span><span id="Interactor.add_function-406"><a href="#Interactor.add_function-406"><span class="linenos">406</span></a>                <span class="c1"># Regular Union without None</span>
</span><span id="Interactor.add_function-407"><a href="#Interactor.add_function-407"><span class="linenos">407</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;anyOf&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]}</span>
</span><span id="Interactor.add_function-408"><a href="#Interactor.add_function-408"><span class="linenos">408</span></a>            
</span><span id="Interactor.add_function-409"><a href="#Interactor.add_function-409"><span class="linenos">409</span></a>            <span class="c1"># Handle List and similar container types</span>
</span><span id="Interactor.add_function-410"><a href="#Interactor.add_function-410"><span class="linenos">410</span></a>            <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
</span><span id="Interactor.add_function-411"><a href="#Interactor.add_function-411"><span class="linenos">411</span></a>                <span class="n">item_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="n">Any</span>
</span><span id="Interactor.add_function-412"><a href="#Interactor.add_function-412"><span class="linenos">412</span></a>                <span class="k">if</span> <span class="n">item_type</span> <span class="ow">is</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="Interactor.add_function-413"><a href="#Interactor.add_function-413"><span class="linenos">413</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-414"><a href="#Interactor.add_function-414"><span class="linenos">414</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">item_type</span><span class="p">)}</span>
</span><span id="Interactor.add_function-415"><a href="#Interactor.add_function-415"><span class="linenos">415</span></a>            
</span><span id="Interactor.add_function-416"><a href="#Interactor.add_function-416"><span class="linenos">416</span></a>            <span class="c1"># Handle Dict types with typing info</span>
</span><span id="Interactor.add_function-417"><a href="#Interactor.add_function-417"><span class="linenos">417</span></a>            <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
</span><span id="Interactor.add_function-418"><a href="#Interactor.add_function-418"><span class="linenos">418</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Interactor.add_function-419"><a href="#Interactor.add_function-419"><span class="linenos">419</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-420"><a href="#Interactor.add_function-420"><span class="linenos">420</span></a>                
</span><span id="Interactor.add_function-421"><a href="#Interactor.add_function-421"><span class="linenos">421</span></a>                <span class="n">key_type</span><span class="p">,</span> <span class="n">val_type</span> <span class="o">=</span> <span class="n">args</span>
</span><span id="Interactor.add_function-422"><a href="#Interactor.add_function-422"><span class="linenos">422</span></a>                <span class="c1"># We can only really use val_type in JSON Schema</span>
</span><span id="Interactor.add_function-423"><a href="#Interactor.add_function-423"><span class="linenos">423</span></a>                <span class="k">if</span> <span class="n">val_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Any</span> <span class="ow">and</span> <span class="n">val_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">object</span><span class="p">:</span>
</span><span id="Interactor.add_function-424"><a href="#Interactor.add_function-424"><span class="linenos">424</span></a>                    <span class="k">return</span> <span class="p">{</span>
</span><span id="Interactor.add_function-425"><a href="#Interactor.add_function-425"><span class="linenos">425</span></a>                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="Interactor.add_function-426"><a href="#Interactor.add_function-426"><span class="linenos">426</span></a>                        <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">val_type</span><span class="p">)</span>
</span><span id="Interactor.add_function-427"><a href="#Interactor.add_function-427"><span class="linenos">427</span></a>                    <span class="p">}</span>
</span><span id="Interactor.add_function-428"><a href="#Interactor.add_function-428"><span class="linenos">428</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-429"><a href="#Interactor.add_function-429"><span class="linenos">429</span></a>            
</span><span id="Interactor.add_function-430"><a href="#Interactor.add_function-430"><span class="linenos">430</span></a>            <span class="c1"># Handle Literal types for enums</span>
</span><span id="Interactor.add_function-431"><a href="#Interactor.add_function-431"><span class="linenos">431</span></a>            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Literal</span><span class="p">:</span>
</span><span id="Interactor.add_function-432"><a href="#Interactor.add_function-432"><span class="linenos">432</span></a>                <span class="n">values</span> <span class="o">=</span> <span class="n">args</span>
</span><span id="Interactor.add_function-433"><a href="#Interactor.add_function-433"><span class="linenos">433</span></a>                <span class="c1"># Try to determine type from values</span>
</span><span id="Interactor.add_function-434"><a href="#Interactor.add_function-434"><span class="linenos">434</span></a>                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">):</span>
</span><span id="Interactor.add_function-435"><a href="#Interactor.add_function-435"><span class="linenos">435</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)}</span>
</span><span id="Interactor.add_function-436"><a href="#Interactor.add_function-436"><span class="linenos">436</span></a>                <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">):</span>
</span><span id="Interactor.add_function-437"><a href="#Interactor.add_function-437"><span class="linenos">437</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)}</span>
</span><span id="Interactor.add_function-438"><a href="#Interactor.add_function-438"><span class="linenos">438</span></a>                <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">):</span>
</span><span id="Interactor.add_function-439"><a href="#Interactor.add_function-439"><span class="linenos">439</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)}</span>
</span><span id="Interactor.add_function-440"><a href="#Interactor.add_function-440"><span class="linenos">440</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor.add_function-441"><a href="#Interactor.add_function-441"><span class="linenos">441</span></a>                    <span class="c1"># Mixed types, use anyOf</span>
</span><span id="Interactor.add_function-442"><a href="#Interactor.add_function-442"><span class="linenos">442</span></a>                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;anyOf&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">_get_json_type</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span><span class="p">]}</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]}</span>
</span><span id="Interactor.add_function-443"><a href="#Interactor.add_function-443"><span class="linenos">443</span></a>            
</span><span id="Interactor.add_function-444"><a href="#Interactor.add_function-444"><span class="linenos">444</span></a>            <span class="c1"># Handle basic types</span>
</span><span id="Interactor.add_function-445"><a href="#Interactor.add_function-445"><span class="linenos">445</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Interactor.add_function-446"><a href="#Interactor.add_function-446"><span class="linenos">446</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-447"><a href="#Interactor.add_function-447"><span class="linenos">447</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Interactor.add_function-448"><a href="#Interactor.add_function-448"><span class="linenos">448</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-449"><a href="#Interactor.add_function-449"><span class="linenos">449</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Interactor.add_function-450"><a href="#Interactor.add_function-450"><span class="linenos">450</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-451"><a href="#Interactor.add_function-451"><span class="linenos">451</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Interactor.add_function-452"><a href="#Interactor.add_function-452"><span class="linenos">452</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-453"><a href="#Interactor.add_function-453"><span class="linenos">453</span></a>            
</span><span id="Interactor.add_function-454"><a href="#Interactor.add_function-454"><span class="linenos">454</span></a>            <span class="c1"># Handle common datetime types</span>
</span><span id="Interactor.add_function-455"><a href="#Interactor.add_function-455"><span class="linenos">455</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="n">datetime</span><span class="p">:</span>
</span><span id="Interactor.add_function-456"><a href="#Interactor.add_function-456"><span class="linenos">456</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;date-time&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-457"><a href="#Interactor.add_function-457"><span class="linenos">457</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="n">date</span><span class="p">:</span>
</span><span id="Interactor.add_function-458"><a href="#Interactor.add_function-458"><span class="linenos">458</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-459"><a href="#Interactor.add_function-459"><span class="linenos">459</span></a>            
</span><span id="Interactor.add_function-460"><a href="#Interactor.add_function-460"><span class="linenos">460</span></a>            <span class="c1"># Handle UUID</span>
</span><span id="Interactor.add_function-461"><a href="#Interactor.add_function-461"><span class="linenos">461</span></a>            <span class="k">if</span> <span class="n">ptype</span> <span class="ow">is</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">:</span>
</span><span id="Interactor.add_function-462"><a href="#Interactor.add_function-462"><span class="linenos">462</span></a>                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;uuid&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-463"><a href="#Interactor.add_function-463"><span class="linenos">463</span></a>            
</span><span id="Interactor.add_function-464"><a href="#Interactor.add_function-464"><span class="linenos">464</span></a>            <span class="c1"># Default to object for any other types</span>
</span><span id="Interactor.add_function-465"><a href="#Interactor.add_function-465"><span class="linenos">465</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>
</span><span id="Interactor.add_function-466"><a href="#Interactor.add_function-466"><span class="linenos">466</span></a>        
</span><span id="Interactor.add_function-467"><a href="#Interactor.add_function-467"><span class="linenos">467</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_get_json_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span><span id="Interactor.add_function-468"><a href="#Interactor.add_function-468"><span class="linenos">468</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Get the JSON Schema type name for a Python value.&quot;&quot;&quot;</span>
</span><span id="Interactor.add_function-469"><a href="#Interactor.add_function-469"><span class="linenos">469</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor.add_function-470"><a href="#Interactor.add_function-470"><span class="linenos">470</span></a>                <span class="k">return</span> <span class="s2">&quot;string&quot;</span>
</span><span id="Interactor.add_function-471"><a href="#Interactor.add_function-471"><span class="linenos">471</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
</span><span id="Interactor.add_function-472"><a href="#Interactor.add_function-472"><span class="linenos">472</span></a>                <span class="k">return</span> <span class="s2">&quot;boolean&quot;</span>
</span><span id="Interactor.add_function-473"><a href="#Interactor.add_function-473"><span class="linenos">473</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
</span><span id="Interactor.add_function-474"><a href="#Interactor.add_function-474"><span class="linenos">474</span></a>                <span class="k">return</span> <span class="s2">&quot;number&quot;</span>
</span><span id="Interactor.add_function-475"><a href="#Interactor.add_function-475"><span class="linenos">475</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Interactor.add_function-476"><a href="#Interactor.add_function-476"><span class="linenos">476</span></a>                <span class="k">return</span> <span class="s2">&quot;array&quot;</span>
</span><span id="Interactor.add_function-477"><a href="#Interactor.add_function-477"><span class="linenos">477</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="Interactor.add_function-478"><a href="#Interactor.add_function-478"><span class="linenos">478</span></a>                <span class="k">return</span> <span class="s2">&quot;object&quot;</span>
</span><span id="Interactor.add_function-479"><a href="#Interactor.add_function-479"><span class="linenos">479</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor.add_function-480"><a href="#Interactor.add_function-480"><span class="linenos">480</span></a>                <span class="k">return</span> <span class="s2">&quot;object&quot;</span>  <span class="c1"># Default</span>
</span><span id="Interactor.add_function-481"><a href="#Interactor.add_function-481"><span class="linenos">481</span></a>        
</span><span id="Interactor.add_function-482"><a href="#Interactor.add_function-482"><span class="linenos">482</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">_parse_param_docs</span><span class="p">(</span><span class="n">docstring</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="Interactor.add_function-483"><a href="#Interactor.add_function-483"><span class="linenos">483</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Extract parameter descriptions from a docstring.&quot;&quot;&quot;</span>
</span><span id="Interactor.add_function-484"><a href="#Interactor.add_function-484"><span class="linenos">484</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">docstring</span><span class="p">:</span>
</span><span id="Interactor.add_function-485"><a href="#Interactor.add_function-485"><span class="linenos">485</span></a>                <span class="k">return</span> <span class="p">{}</span>
</span><span id="Interactor.add_function-486"><a href="#Interactor.add_function-486"><span class="linenos">486</span></a>            
</span><span id="Interactor.add_function-487"><a href="#Interactor.add_function-487"><span class="linenos">487</span></a>            <span class="n">lines</span> <span class="o">=</span> <span class="n">docstring</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span><span id="Interactor.add_function-488"><a href="#Interactor.add_function-488"><span class="linenos">488</span></a>            <span class="n">param_docs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Interactor.add_function-489"><a href="#Interactor.add_function-489"><span class="linenos">489</span></a>            <span class="n">current_param</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.add_function-490"><a href="#Interactor.add_function-490"><span class="linenos">490</span></a>            <span class="n">in_params</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Interactor.add_function-491"><a href="#Interactor.add_function-491"><span class="linenos">491</span></a>            
</span><span id="Interactor.add_function-492"><a href="#Interactor.add_function-492"><span class="linenos">492</span></a>            <span class="c1"># Regular expressions for finding parameter sections and param lines</span>
</span><span id="Interactor.add_function-493"><a href="#Interactor.add_function-493"><span class="linenos">493</span></a>            <span class="n">param_section_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(Args|Parameters):\s*$&quot;</span><span class="p">)</span>
</span><span id="Interactor.add_function-494"><a href="#Interactor.add_function-494"><span class="linenos">494</span></a>            <span class="n">param_line_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s</span><span class="si">{4}</span><span class="s2">(\w+)\s*(?:\([^\)]*\))?:\s*(.*)&quot;</span><span class="p">)</span>
</span><span id="Interactor.add_function-495"><a href="#Interactor.add_function-495"><span class="linenos">495</span></a>            
</span><span id="Interactor.add_function-496"><a href="#Interactor.add_function-496"><span class="linenos">496</span></a>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span id="Interactor.add_function-497"><a href="#Interactor.add_function-497"><span class="linenos">497</span></a>                <span class="c1"># Check if we&#39;re entering the parameters section</span>
</span><span id="Interactor.add_function-498"><a href="#Interactor.add_function-498"><span class="linenos">498</span></a>                <span class="k">if</span> <span class="n">param_section_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
</span><span id="Interactor.add_function-499"><a href="#Interactor.add_function-499"><span class="linenos">499</span></a>                    <span class="n">in_params</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor.add_function-500"><a href="#Interactor.add_function-500"><span class="linenos">500</span></a>                    <span class="k">continue</span>
</span><span id="Interactor.add_function-501"><a href="#Interactor.add_function-501"><span class="linenos">501</span></a>                    
</span><span id="Interactor.add_function-502"><a href="#Interactor.add_function-502"><span class="linenos">502</span></a>                <span class="k">if</span> <span class="n">in_params</span><span class="p">:</span>
</span><span id="Interactor.add_function-503"><a href="#Interactor.add_function-503"><span class="linenos">503</span></a>                    <span class="c1"># Skip empty lines</span>
</span><span id="Interactor.add_function-504"><a href="#Interactor.add_function-504"><span class="linenos">504</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span><span id="Interactor.add_function-505"><a href="#Interactor.add_function-505"><span class="linenos">505</span></a>                        <span class="k">continue</span>
</span><span id="Interactor.add_function-506"><a href="#Interactor.add_function-506"><span class="linenos">506</span></a>                        
</span><span id="Interactor.add_function-507"><a href="#Interactor.add_function-507"><span class="linenos">507</span></a>                    <span class="c1"># Check for a parameter definition line</span>
</span><span id="Interactor.add_function-508"><a href="#Interactor.add_function-508"><span class="linenos">508</span></a>                    <span class="n">match</span> <span class="o">=</span> <span class="n">param_line_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="Interactor.add_function-509"><a href="#Interactor.add_function-509"><span class="linenos">509</span></a>                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
</span><span id="Interactor.add_function-510"><a href="#Interactor.add_function-510"><span class="linenos">510</span></a>                        <span class="n">current_param</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Interactor.add_function-511"><a href="#Interactor.add_function-511"><span class="linenos">511</span></a>                        <span class="n">param_docs</span><span class="p">[</span><span class="n">current_param</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="Interactor.add_function-512"><a href="#Interactor.add_function-512"><span class="linenos">512</span></a>                    <span class="c1"># Check for continuation of a parameter description</span>
</span><span id="Interactor.add_function-513"><a href="#Interactor.add_function-513"><span class="linenos">513</span></a>                    <span class="k">elif</span> <span class="n">current_param</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">):</span>
</span><span id="Interactor.add_function-514"><a href="#Interactor.add_function-514"><span class="linenos">514</span></a>                        <span class="n">param_docs</span><span class="p">[</span><span class="n">current_param</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="Interactor.add_function-515"><a href="#Interactor.add_function-515"><span class="linenos">515</span></a>                    <span class="c1"># If we see a line that doesn&#39;t match our patterns, we&#39;re out of the params section</span>
</span><span id="Interactor.add_function-516"><a href="#Interactor.add_function-516"><span class="linenos">516</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor.add_function-517"><a href="#Interactor.add_function-517"><span class="linenos">517</span></a>                        <span class="n">current_param</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.add_function-518"><a href="#Interactor.add_function-518"><span class="linenos">518</span></a>            
</span><span id="Interactor.add_function-519"><a href="#Interactor.add_function-519"><span class="linenos">519</span></a>            <span class="k">return</span> <span class="n">param_docs</span>
</span><span id="Interactor.add_function-520"><a href="#Interactor.add_function-520"><span class="linenos">520</span></a>        
</span><span id="Interactor.add_function-521"><a href="#Interactor.add_function-521"><span class="linenos">521</span></a>        <span class="c1"># Start of main function logic</span>
</span><span id="Interactor.add_function-522"><a href="#Interactor.add_function-522"><span class="linenos">522</span></a>        
</span><span id="Interactor.add_function-523"><a href="#Interactor.add_function-523"><span class="linenos">523</span></a>        <span class="c1"># Skip if tools are disabled</span>
</span><span id="Interactor.add_function-524"><a href="#Interactor.add_function-524"><span class="linenos">524</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools_enabled</span><span class="p">:</span>
</span><span id="Interactor.add_function-525"><a href="#Interactor.add_function-525"><span class="linenos">525</span></a>            <span class="k">return</span>
</span><span id="Interactor.add_function-526"><a href="#Interactor.add_function-526"><span class="linenos">526</span></a>            
</span><span id="Interactor.add_function-527"><a href="#Interactor.add_function-527"><span class="linenos">527</span></a>        <span class="c1"># Validate input callable</span>
</span><span id="Interactor.add_function-528"><a href="#Interactor.add_function-528"><span class="linenos">528</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">external_callable</span><span class="p">:</span>
</span><span id="Interactor.add_function-529"><a href="#Interactor.add_function-529"><span class="linenos">529</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A valid external callable must be provided.&quot;</span><span class="p">)</span>
</span><span id="Interactor.add_function-530"><a href="#Interactor.add_function-530"><span class="linenos">530</span></a>        
</span><span id="Interactor.add_function-531"><a href="#Interactor.add_function-531"><span class="linenos">531</span></a>        <span class="c1"># Set function name, either from parameter or from callable&#39;s __name__</span>
</span><span id="Interactor.add_function-532"><a href="#Interactor.add_function-532"><span class="linenos">532</span></a>        <span class="n">function_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">external_callable</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="Interactor.add_function-533"><a href="#Interactor.add_function-533"><span class="linenos">533</span></a>        
</span><span id="Interactor.add_function-534"><a href="#Interactor.add_function-534"><span class="linenos">534</span></a>        <span class="c1"># Try to get docstring and extract description</span>
</span><span id="Interactor.add_function-535"><a href="#Interactor.add_function-535"><span class="linenos">535</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor.add_function-536"><a href="#Interactor.add_function-536"><span class="linenos">536</span></a>            <span class="n">docstring</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">external_callable</span><span class="p">)</span>
</span><span id="Interactor.add_function-537"><a href="#Interactor.add_function-537"><span class="linenos">537</span></a>            <span class="n">description</span> <span class="o">=</span> <span class="n">description</span> <span class="ow">or</span> <span class="p">(</span><span class="n">docstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">docstring</span> <span class="k">else</span> <span class="s2">&quot;No description provided.&quot;</span><span class="p">)</span>
</span><span id="Interactor.add_function-538"><a href="#Interactor.add_function-538"><span class="linenos">538</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor.add_function-539"><a href="#Interactor.add_function-539"><span class="linenos">539</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOOL] Warning: Could not extract docstring from </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
</span><span id="Interactor.add_function-540"><a href="#Interactor.add_function-540"><span class="linenos">540</span></a>            <span class="n">docstring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Interactor.add_function-541"><a href="#Interactor.add_function-541"><span class="linenos">541</span></a>            <span class="n">description</span> <span class="o">=</span> <span class="n">description</span> <span class="ow">or</span> <span class="s2">&quot;No description provided.&quot;</span>
</span><span id="Interactor.add_function-542"><a href="#Interactor.add_function-542"><span class="linenos">542</span></a>        
</span><span id="Interactor.add_function-543"><a href="#Interactor.add_function-543"><span class="linenos">543</span></a>        <span class="c1"># Extract parameter documentation from docstring</span>
</span><span id="Interactor.add_function-544"><a href="#Interactor.add_function-544"><span class="linenos">544</span></a>        <span class="n">param_docs</span> <span class="o">=</span> <span class="n">_parse_param_docs</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span>
</span><span id="Interactor.add_function-545"><a href="#Interactor.add_function-545"><span class="linenos">545</span></a>        
</span><span id="Interactor.add_function-546"><a href="#Interactor.add_function-546"><span class="linenos">546</span></a>        <span class="c1"># Handle conflicts with existing functions</span>
</span><span id="Interactor.add_function-547"><a href="#Interactor.add_function-547"><span class="linenos">547</span></a>        <span class="k">if</span> <span class="n">override</span><span class="p">:</span>
</span><span id="Interactor.add_function-548"><a href="#Interactor.add_function-548"><span class="linenos">548</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delete_function</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
</span><span id="Interactor.add_function-549"><a href="#Interactor.add_function-549"><span class="linenos">549</span></a>        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">function_name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">):</span>
</span><span id="Interactor.add_function-550"><a href="#Interactor.add_function-550"><span class="linenos">550</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39; is already registered. Use override=True to replace.&quot;</span><span class="p">)</span>
</span><span id="Interactor.add_function-551"><a href="#Interactor.add_function-551"><span class="linenos">551</span></a>        
</span><span id="Interactor.add_function-552"><a href="#Interactor.add_function-552"><span class="linenos">552</span></a>        <span class="c1"># Try to get function signature for parameter info</span>
</span><span id="Interactor.add_function-553"><a href="#Interactor.add_function-553"><span class="linenos">553</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor.add_function-554"><a href="#Interactor.add_function-554"><span class="linenos">554</span></a>            <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">external_callable</span><span class="p">)</span>
</span><span id="Interactor.add_function-555"><a href="#Interactor.add_function-555"><span class="linenos">555</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor.add_function-556"><a href="#Interactor.add_function-556"><span class="linenos">556</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot inspect callable &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor.add_function-557"><a href="#Interactor.add_function-557"><span class="linenos">557</span></a>        
</span><span id="Interactor.add_function-558"><a href="#Interactor.add_function-558"><span class="linenos">558</span></a>        <span class="c1"># Process parameters to build schema</span>
</span><span id="Interactor.add_function-559"><a href="#Interactor.add_function-559"><span class="linenos">559</span></a>        <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Interactor.add_function-560"><a href="#Interactor.add_function-560"><span class="linenos">560</span></a>        <span class="n">required</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor.add_function-561"><a href="#Interactor.add_function-561"><span class="linenos">561</span></a>        
</span><span id="Interactor.add_function-562"><a href="#Interactor.add_function-562"><span class="linenos">562</span></a>        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Interactor.add_function-563"><a href="#Interactor.add_function-563"><span class="linenos">563</span></a>            <span class="c1"># Skip self, cls parameters for instance/class methods</span>
</span><span id="Interactor.add_function-564"><a href="#Interactor.add_function-564"><span class="linenos">564</span></a>            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">:</span>
</span><span id="Interactor.add_function-565"><a href="#Interactor.add_function-565"><span class="linenos">565</span></a>                <span class="k">continue</span>
</span><span id="Interactor.add_function-566"><a href="#Interactor.add_function-566"><span class="linenos">566</span></a>                
</span><span id="Interactor.add_function-567"><a href="#Interactor.add_function-567"><span class="linenos">567</span></a>            <span class="c1"># Get parameter annotation, defaulting to Any</span>
</span><span id="Interactor.add_function-568"><a href="#Interactor.add_function-568"><span class="linenos">568</span></a>            <span class="n">annotation</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">Any</span>
</span><span id="Interactor.add_function-569"><a href="#Interactor.add_function-569"><span class="linenos">569</span></a>            
</span><span id="Interactor.add_function-570"><a href="#Interactor.add_function-570"><span class="linenos">570</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor.add_function-571"><a href="#Interactor.add_function-571"><span class="linenos">571</span></a>                <span class="c1"># Convert Python type to JSON Schema</span>
</span><span id="Interactor.add_function-572"><a href="#Interactor.add_function-572"><span class="linenos">572</span></a>                <span class="n">schema</span> <span class="o">=</span> <span class="n">_python_type_to_schema</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
</span><span id="Interactor.add_function-573"><a href="#Interactor.add_function-573"><span class="linenos">573</span></a>                
</span><span id="Interactor.add_function-574"><a href="#Interactor.add_function-574"><span class="linenos">574</span></a>                <span class="c1"># Add description from docstring or create a default one</span>
</span><span id="Interactor.add_function-575"><a href="#Interactor.add_function-575"><span class="linenos">575</span></a>                <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_docs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> parameter&quot;</span><span class="p">)</span>
</span><span id="Interactor.add_function-576"><a href="#Interactor.add_function-576"><span class="linenos">576</span></a>                
</span><span id="Interactor.add_function-577"><a href="#Interactor.add_function-577"><span class="linenos">577</span></a>                <span class="c1"># Add to properties</span>
</span><span id="Interactor.add_function-578"><a href="#Interactor.add_function-578"><span class="linenos">578</span></a>                <span class="n">properties</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema</span>
</span><span id="Interactor.add_function-579"><a href="#Interactor.add_function-579"><span class="linenos">579</span></a>                
</span><span id="Interactor.add_function-580"><a href="#Interactor.add_function-580"><span class="linenos">580</span></a>                <span class="c1"># If no default, add to required list</span>
</span><span id="Interactor.add_function-581"><a href="#Interactor.add_function-581"><span class="linenos">581</span></a>                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="Interactor.add_function-582"><a href="#Interactor.add_function-582"><span class="linenos">582</span></a>                    <span class="n">required</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
</span><span id="Interactor.add_function-583"><a href="#Interactor.add_function-583"><span class="linenos">583</span></a>                    
</span><span id="Interactor.add_function-584"><a href="#Interactor.add_function-584"><span class="linenos">584</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor.add_function-585"><a href="#Interactor.add_function-585"><span class="linenos">585</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOOL] Error processing parameter </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="Interactor.add_function-586"><a href="#Interactor.add_function-586"><span class="linenos">586</span></a>                <span class="c1"># Add a basic object schema as fallback</span>
</span><span id="Interactor.add_function-587"><a href="#Interactor.add_function-587"><span class="linenos">587</span></a>                <span class="n">properties</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor.add_function-588"><a href="#Interactor.add_function-588"><span class="linenos">588</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="Interactor.add_function-589"><a href="#Interactor.add_function-589"><span class="linenos">589</span></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> parameter (type conversion failed)&quot;</span>
</span><span id="Interactor.add_function-590"><a href="#Interactor.add_function-590"><span class="linenos">590</span></a>                <span class="p">}</span>
</span><span id="Interactor.add_function-591"><a href="#Interactor.add_function-591"><span class="linenos">591</span></a>        
</span><span id="Interactor.add_function-592"><a href="#Interactor.add_function-592"><span class="linenos">592</span></a>        <span class="c1"># Apply schema extensions if provided</span>
</span><span id="Interactor.add_function-593"><a href="#Interactor.add_function-593"><span class="linenos">593</span></a>        <span class="k">if</span> <span class="n">schema_extensions</span><span class="p">:</span>
</span><span id="Interactor.add_function-594"><a href="#Interactor.add_function-594"><span class="linenos">594</span></a>            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">extensions</span> <span class="ow">in</span> <span class="n">schema_extensions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Interactor.add_function-595"><a href="#Interactor.add_function-595"><span class="linenos">595</span></a>                <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
</span><span id="Interactor.add_function-596"><a href="#Interactor.add_function-596"><span class="linenos">596</span></a>                    <span class="n">properties</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>
</span><span id="Interactor.add_function-597"><a href="#Interactor.add_function-597"><span class="linenos">597</span></a>        
</span><span id="Interactor.add_function-598"><a href="#Interactor.add_function-598"><span class="linenos">598</span></a>        <span class="c1"># Build the final tool specification</span>
</span><span id="Interactor.add_function-599"><a href="#Interactor.add_function-599"><span class="linenos">599</span></a>        <span class="n">tool_spec</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor.add_function-600"><a href="#Interactor.add_function-600"><span class="linenos">600</span></a>            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="Interactor.add_function-601"><a href="#Interactor.add_function-601"><span class="linenos">601</span></a>            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.add_function-602"><a href="#Interactor.add_function-602"><span class="linenos">602</span></a>                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">function_name</span><span class="p">,</span>
</span><span id="Interactor.add_function-603"><a href="#Interactor.add_function-603"><span class="linenos">603</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
</span><span id="Interactor.add_function-604"><a href="#Interactor.add_function-604"><span class="linenos">604</span></a>                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.add_function-605"><a href="#Interactor.add_function-605"><span class="linenos">605</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
</span><span id="Interactor.add_function-606"><a href="#Interactor.add_function-606"><span class="linenos">606</span></a>                    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="n">properties</span><span class="p">,</span>
</span><span id="Interactor.add_function-607"><a href="#Interactor.add_function-607"><span class="linenos">607</span></a>                    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="n">required</span>
</span><span id="Interactor.add_function-608"><a href="#Interactor.add_function-608"><span class="linenos">608</span></a>                <span class="p">}</span>
</span><span id="Interactor.add_function-609"><a href="#Interactor.add_function-609"><span class="linenos">609</span></a>            <span class="p">}</span>
</span><span id="Interactor.add_function-610"><a href="#Interactor.add_function-610"><span class="linenos">610</span></a>        <span class="p">}</span>
</span><span id="Interactor.add_function-611"><a href="#Interactor.add_function-611"><span class="linenos">611</span></a>        
</span><span id="Interactor.add_function-612"><a href="#Interactor.add_function-612"><span class="linenos">612</span></a>        <span class="c1"># Set disabled flag if requested</span>
</span><span id="Interactor.add_function-613"><a href="#Interactor.add_function-613"><span class="linenos">613</span></a>        <span class="k">if</span> <span class="n">disabled</span><span class="p">:</span>
</span><span id="Interactor.add_function-614"><a href="#Interactor.add_function-614"><span class="linenos">614</span></a>            <span class="n">tool_spec</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;disabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor.add_function-615"><a href="#Interactor.add_function-615"><span class="linenos">615</span></a>        
</span><span id="Interactor.add_function-616"><a href="#Interactor.add_function-616"><span class="linenos">616</span></a>        <span class="c1"># Add to tools list</span>
</span><span id="Interactor.add_function-617"><a href="#Interactor.add_function-617"><span class="linenos">617</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_spec</span><span class="p">)</span>
</span><span id="Interactor.add_function-618"><a href="#Interactor.add_function-618"><span class="linenos">618</span></a>        
</span><span id="Interactor.add_function-619"><a href="#Interactor.add_function-619"><span class="linenos">619</span></a>        <span class="c1"># Make the function available as an attribute on the instance</span>
</span><span id="Interactor.add_function-620"><a href="#Interactor.add_function-620"><span class="linenos">620</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">external_callable</span><span class="p">)</span>
</span><span id="Interactor.add_function-621"><a href="#Interactor.add_function-621"><span class="linenos">621</span></a>        
</span><span id="Interactor.add_function-622"><a href="#Interactor.add_function-622"><span class="linenos">622</span></a>        <span class="c1"># Log the registration</span>
</span><span id="Interactor.add_function-623"><a href="#Interactor.add_function-623"><span class="linenos">623</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TOOL] Registered function &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39; with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span><span class="si">}</span><span class="s2"> parameters&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
</span><span id="Interactor.add_function-624"><a href="#Interactor.add_function-624"><span class="linenos">624</span></a>        
</span><span id="Interactor.add_function-625"><a href="#Interactor.add_function-625"><span class="linenos">625</span></a>        <span class="k">return</span> <span class="n">function_name</span>  <span class="c1"># Return the name for reference</span>
</span></pre></div>


            <div class="docstring"><p>Register a function for LLM tool calling with full type hints and metadata.</p>

<p>Args:
    external_callable (Callable): The function to register.
    name (Optional[str]): Optional custom name. Defaults to function's __name__.
    description (Optional[str]): Optional custom description. Defaults to first line of docstring.
    override (bool): If True, replaces an existing tool with the same name.
    disabled (bool): If True, registers the function in a disabled state.
    schema_extensions (Optional[Dict[str, Any]]): Optional dictionary mapping parameter names to 
        schema extensions that override or add to the auto-generated schema.</p>

<p>Raises:
    ValueError: If the callable is invalid or duplicate name found without override.</p>

<p>Example:
    interactor.add_function(
        my_tool, 
        override=True, 
        disabled=False,
        schema_extensions={
            "param1": {"minimum": 0, "maximum": 100},
            "param2": {"format": "email"}
        }
    )</p>
</div>


                            </div>
                            <div id="Interactor.disable_function" class="classattr">
                                        <input id="Interactor.disable_function-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">disable_function</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Interactor.disable_function-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.disable_function"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.disable_function-628"><a href="#Interactor.disable_function-628"><span class="linenos">628</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">disable_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Interactor.disable_function-629"><a href="#Interactor.disable_function-629"><span class="linenos">629</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor.disable_function-630"><a href="#Interactor.disable_function-630"><span class="linenos">630</span></a><span class="sd">        Disable a registered tool function by name.</span>
</span><span id="Interactor.disable_function-631"><a href="#Interactor.disable_function-631"><span class="linenos">631</span></a>
</span><span id="Interactor.disable_function-632"><a href="#Interactor.disable_function-632"><span class="linenos">632</span></a><span class="sd">        This marks the function as inactive for tool calling without removing it from the internal registry.</span>
</span><span id="Interactor.disable_function-633"><a href="#Interactor.disable_function-633"><span class="linenos">633</span></a><span class="sd">        The function remains visible in the tool listing but is skipped during tool selection by the LLM.</span>
</span><span id="Interactor.disable_function-634"><a href="#Interactor.disable_function-634"><span class="linenos">634</span></a>
</span><span id="Interactor.disable_function-635"><a href="#Interactor.disable_function-635"><span class="linenos">635</span></a><span class="sd">        Args:</span>
</span><span id="Interactor.disable_function-636"><a href="#Interactor.disable_function-636"><span class="linenos">636</span></a><span class="sd">            name (str): The name of the function to disable.</span>
</span><span id="Interactor.disable_function-637"><a href="#Interactor.disable_function-637"><span class="linenos">637</span></a>
</span><span id="Interactor.disable_function-638"><a href="#Interactor.disable_function-638"><span class="linenos">638</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor.disable_function-639"><a href="#Interactor.disable_function-639"><span class="linenos">639</span></a><span class="sd">            bool: True if the function was found and disabled, False otherwise.</span>
</span><span id="Interactor.disable_function-640"><a href="#Interactor.disable_function-640"><span class="linenos">640</span></a>
</span><span id="Interactor.disable_function-641"><a href="#Interactor.disable_function-641"><span class="linenos">641</span></a><span class="sd">        Example:</span>
</span><span id="Interactor.disable_function-642"><a href="#Interactor.disable_function-642"><span class="linenos">642</span></a><span class="sd">            interactor.disable_function(&quot;extract_text&quot;)</span>
</span><span id="Interactor.disable_function-643"><a href="#Interactor.disable_function-643"><span class="linenos">643</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor.disable_function-644"><a href="#Interactor.disable_function-644"><span class="linenos">644</span></a>        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
</span><span id="Interactor.disable_function-645"><a href="#Interactor.disable_function-645"><span class="linenos">645</span></a>            <span class="k">if</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span><span id="Interactor.disable_function-646"><a href="#Interactor.disable_function-646"><span class="linenos">646</span></a>                <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;disabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor.disable_function-647"><a href="#Interactor.disable_function-647"><span class="linenos">647</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="Interactor.disable_function-648"><a href="#Interactor.disable_function-648"><span class="linenos">648</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Disable a registered tool function by name.</p>

<p>This marks the function as inactive for tool calling without removing it from the internal registry.
The function remains visible in the tool listing but is skipped during tool selection by the LLM.</p>

<p>Args:
    name (str): The name of the function to disable.</p>

<p>Returns:
    bool: True if the function was found and disabled, False otherwise.</p>

<p>Example:
    interactor.disable_function("extract_text")</p>
</div>


                            </div>
                            <div id="Interactor.enable_function" class="classattr">
                                        <input id="Interactor.enable_function-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">enable_function</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Interactor.enable_function-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.enable_function"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.enable_function-651"><a href="#Interactor.enable_function-651"><span class="linenos">651</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">enable_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Interactor.enable_function-652"><a href="#Interactor.enable_function-652"><span class="linenos">652</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor.enable_function-653"><a href="#Interactor.enable_function-653"><span class="linenos">653</span></a><span class="sd">        Re-enable a previously disabled tool function by name.</span>
</span><span id="Interactor.enable_function-654"><a href="#Interactor.enable_function-654"><span class="linenos">654</span></a>
</span><span id="Interactor.enable_function-655"><a href="#Interactor.enable_function-655"><span class="linenos">655</span></a><span class="sd">        This removes the &#39;disabled&#39; flag from a tool function, making it available again for LLM use.</span>
</span><span id="Interactor.enable_function-656"><a href="#Interactor.enable_function-656"><span class="linenos">656</span></a>
</span><span id="Interactor.enable_function-657"><a href="#Interactor.enable_function-657"><span class="linenos">657</span></a><span class="sd">        Args:</span>
</span><span id="Interactor.enable_function-658"><a href="#Interactor.enable_function-658"><span class="linenos">658</span></a><span class="sd">            name (str): The name of the function to enable.</span>
</span><span id="Interactor.enable_function-659"><a href="#Interactor.enable_function-659"><span class="linenos">659</span></a>
</span><span id="Interactor.enable_function-660"><a href="#Interactor.enable_function-660"><span class="linenos">660</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor.enable_function-661"><a href="#Interactor.enable_function-661"><span class="linenos">661</span></a><span class="sd">            bool: True if the function was found and enabled, False otherwise.</span>
</span><span id="Interactor.enable_function-662"><a href="#Interactor.enable_function-662"><span class="linenos">662</span></a>
</span><span id="Interactor.enable_function-663"><a href="#Interactor.enable_function-663"><span class="linenos">663</span></a><span class="sd">        Example:</span>
</span><span id="Interactor.enable_function-664"><a href="#Interactor.enable_function-664"><span class="linenos">664</span></a><span class="sd">            interactor.enable_function(&quot;extract_text&quot;)</span>
</span><span id="Interactor.enable_function-665"><a href="#Interactor.enable_function-665"><span class="linenos">665</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor.enable_function-666"><a href="#Interactor.enable_function-666"><span class="linenos">666</span></a>        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
</span><span id="Interactor.enable_function-667"><a href="#Interactor.enable_function-667"><span class="linenos">667</span></a>            <span class="k">if</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span><span id="Interactor.enable_function-668"><a href="#Interactor.enable_function-668"><span class="linenos">668</span></a>                <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor.enable_function-669"><a href="#Interactor.enable_function-669"><span class="linenos">669</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="Interactor.enable_function-670"><a href="#Interactor.enable_function-670"><span class="linenos">670</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Re-enable a previously disabled tool function by name.</p>

<p>This removes the 'disabled' flag from a tool function, making it available again for LLM use.</p>

<p>Args:
    name (str): The name of the function to enable.</p>

<p>Returns:
    bool: True if the function was found and enabled, False otherwise.</p>

<p>Example:
    interactor.enable_function("extract_text")</p>
</div>


                            </div>
                            <div id="Interactor.delete_function" class="classattr">
                                        <input id="Interactor.delete_function-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_function</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Interactor.delete_function-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.delete_function"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.delete_function-673"><a href="#Interactor.delete_function-673"><span class="linenos">673</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Interactor.delete_function-674"><a href="#Interactor.delete_function-674"><span class="linenos">674</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor.delete_function-675"><a href="#Interactor.delete_function-675"><span class="linenos">675</span></a><span class="sd">        Permanently remove a registered tool function from the Interactor.</span>
</span><span id="Interactor.delete_function-676"><a href="#Interactor.delete_function-676"><span class="linenos">676</span></a>
</span><span id="Interactor.delete_function-677"><a href="#Interactor.delete_function-677"><span class="linenos">677</span></a><span class="sd">        This deletes both the tool metadata and the callable attribute, making it fully inaccessible</span>
</span><span id="Interactor.delete_function-678"><a href="#Interactor.delete_function-678"><span class="linenos">678</span></a><span class="sd">        from the active session. Useful for dynamically trimming the toolset.</span>
</span><span id="Interactor.delete_function-679"><a href="#Interactor.delete_function-679"><span class="linenos">679</span></a>
</span><span id="Interactor.delete_function-680"><a href="#Interactor.delete_function-680"><span class="linenos">680</span></a><span class="sd">        Args:</span>
</span><span id="Interactor.delete_function-681"><a href="#Interactor.delete_function-681"><span class="linenos">681</span></a><span class="sd">            name (str): The name of the function to delete.</span>
</span><span id="Interactor.delete_function-682"><a href="#Interactor.delete_function-682"><span class="linenos">682</span></a>
</span><span id="Interactor.delete_function-683"><a href="#Interactor.delete_function-683"><span class="linenos">683</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor.delete_function-684"><a href="#Interactor.delete_function-684"><span class="linenos">684</span></a><span class="sd">            bool: True if the function was found and removed, False otherwise.</span>
</span><span id="Interactor.delete_function-685"><a href="#Interactor.delete_function-685"><span class="linenos">685</span></a>
</span><span id="Interactor.delete_function-686"><a href="#Interactor.delete_function-686"><span class="linenos">686</span></a><span class="sd">        Example:</span>
</span><span id="Interactor.delete_function-687"><a href="#Interactor.delete_function-687"><span class="linenos">687</span></a><span class="sd">            interactor.delete_function(&quot;extract_text&quot;)</span>
</span><span id="Interactor.delete_function-688"><a href="#Interactor.delete_function-688"><span class="linenos">688</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor.delete_function-689"><a href="#Interactor.delete_function-689"><span class="linenos">689</span></a>        <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span>
</span><span id="Interactor.delete_function-690"><a href="#Interactor.delete_function-690"><span class="linenos">690</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span> <span class="k">if</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">name</span><span class="p">]</span>
</span><span id="Interactor.delete_function-691"><a href="#Interactor.delete_function-691"><span class="linenos">691</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="Interactor.delete_function-692"><a href="#Interactor.delete_function-692"><span class="linenos">692</span></a>            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="Interactor.delete_function-693"><a href="#Interactor.delete_function-693"><span class="linenos">693</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">before</span>
</span></pre></div>


            <div class="docstring"><p>Permanently remove a registered tool function from the Interactor.</p>

<p>This deletes both the tool metadata and the callable attribute, making it fully inaccessible
from the active session. Useful for dynamically trimming the toolset.</p>

<p>Args:
    name (str): The name of the function to delete.</p>

<p>Returns:
    bool: True if the function was found and removed, False otherwise.</p>

<p>Example:
    interactor.delete_function("extract_text")</p>
</div>


                            </div>
                            <div id="Interactor.list_functions" class="classattr">
                                        <input id="Interactor.list_functions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">list_functions</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Interactor.list_functions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.list_functions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.list_functions-696"><a href="#Interactor.list_functions-696"><span class="linenos">696</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">list_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="Interactor.list_functions-697"><a href="#Interactor.list_functions-697"><span class="linenos">697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of registered functions for tool calling.</span>
</span><span id="Interactor.list_functions-698"><a href="#Interactor.list_functions-698"><span class="linenos">698</span></a>
</span><span id="Interactor.list_functions-699"><a href="#Interactor.list_functions-699"><span class="linenos">699</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor.list_functions-700"><a href="#Interactor.list_functions-700"><span class="linenos">700</span></a><span class="sd">            List[Dict[str, Any]]: List of registered functions.</span>
</span><span id="Interactor.list_functions-701"><a href="#Interactor.list_functions-701"><span class="linenos">701</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor.list_functions-702"><a href="#Interactor.list_functions-702"><span class="linenos">702</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span>
</span></pre></div>


            <div class="docstring"><p>Get the list of registered functions for tool calling.</p>

<p>Returns:
    List[Dict[str, Any]]: List of registered functions.</p>
</div>


                            </div>
                            <div id="Interactor.list_models" class="classattr">
                                        <input id="Interactor.list_models-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">list_models</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">providers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Interactor.list_models-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.list_models"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.list_models-704"><a href="#Interactor.list_models-704"><span class="linenos">704</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">list_models</span><span class="p">(</span>
</span><span id="Interactor.list_models-705"><a href="#Interactor.list_models-705"><span class="linenos">705</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor.list_models-706"><a href="#Interactor.list_models-706"><span class="linenos">706</span></a>        <span class="n">providers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor.list_models-707"><a href="#Interactor.list_models-707"><span class="linenos">707</span></a>        <span class="nb">filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.list_models-708"><a href="#Interactor.list_models-708"><span class="linenos">708</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Interactor.list_models-709"><a href="#Interactor.list_models-709"><span class="linenos">709</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve available models from configured providers.</span>
</span><span id="Interactor.list_models-710"><a href="#Interactor.list_models-710"><span class="linenos">710</span></a>
</span><span id="Interactor.list_models-711"><a href="#Interactor.list_models-711"><span class="linenos">711</span></a><span class="sd">        Args:</span>
</span><span id="Interactor.list_models-712"><a href="#Interactor.list_models-712"><span class="linenos">712</span></a><span class="sd">            providers: Provider name or list of provider names. If None, all are queried.</span>
</span><span id="Interactor.list_models-713"><a href="#Interactor.list_models-713"><span class="linenos">713</span></a><span class="sd">            filter: Optional regex to filter model names.</span>
</span><span id="Interactor.list_models-714"><a href="#Interactor.list_models-714"><span class="linenos">714</span></a>
</span><span id="Interactor.list_models-715"><a href="#Interactor.list_models-715"><span class="linenos">715</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor.list_models-716"><a href="#Interactor.list_models-716"><span class="linenos">716</span></a><span class="sd">            List[str]: Sorted list of &quot;provider:model_id&quot; strings.</span>
</span><span id="Interactor.list_models-717"><a href="#Interactor.list_models-717"><span class="linenos">717</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor.list_models-718"><a href="#Interactor.list_models-718"><span class="linenos">718</span></a>        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor.list_models-719"><a href="#Interactor.list_models-719"><span class="linenos">719</span></a>
</span><span id="Interactor.list_models-720"><a href="#Interactor.list_models-720"><span class="linenos">720</span></a>        <span class="k">if</span> <span class="n">providers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Interactor.list_models-721"><a href="#Interactor.list_models-721"><span class="linenos">721</span></a>            <span class="n">providers_to_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span>
</span><span id="Interactor.list_models-722"><a href="#Interactor.list_models-722"><span class="linenos">722</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">providers</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor.list_models-723"><a href="#Interactor.list_models-723"><span class="linenos">723</span></a>            <span class="n">providers_to_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">providers</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">providers</span><span class="p">)}</span>
</span><span id="Interactor.list_models-724"><a href="#Interactor.list_models-724"><span class="linenos">724</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">providers</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="Interactor.list_models-725"><a href="#Interactor.list_models-725"><span class="linenos">725</span></a>            <span class="n">providers_to_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers</span><span class="p">}</span>
</span><span id="Interactor.list_models-726"><a href="#Interactor.list_models-726"><span class="linenos">726</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor.list_models-727"><a href="#Interactor.list_models-727"><span class="linenos">727</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="Interactor.list_models-728"><a href="#Interactor.list_models-728"><span class="linenos">728</span></a>
</span><span id="Interactor.list_models-729"><a href="#Interactor.list_models-729"><span class="linenos">729</span></a>        <span class="n">invalid_providers</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">providers_to_list</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">providers</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Interactor.list_models-730"><a href="#Interactor.list_models-730"><span class="linenos">730</span></a>        <span class="k">if</span> <span class="n">invalid_providers</span><span class="p">:</span>
</span><span id="Interactor.list_models-731"><a href="#Interactor.list_models-731"><span class="linenos">731</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid providers: </span><span class="si">{</span><span class="n">invalid_providers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor.list_models-732"><a href="#Interactor.list_models-732"><span class="linenos">732</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="Interactor.list_models-733"><a href="#Interactor.list_models-733"><span class="linenos">733</span></a>
</span><span id="Interactor.list_models-734"><a href="#Interactor.list_models-734"><span class="linenos">734</span></a>        <span class="n">regex_pattern</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.list_models-735"><a href="#Interactor.list_models-735"><span class="linenos">735</span></a>        <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
</span><span id="Interactor.list_models-736"><a href="#Interactor.list_models-736"><span class="linenos">736</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor.list_models-737"><a href="#Interactor.list_models-737"><span class="linenos">737</span></a>                <span class="n">regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span><span id="Interactor.list_models-738"><a href="#Interactor.list_models-738"><span class="linenos">738</span></a>            <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor.list_models-739"><a href="#Interactor.list_models-739"><span class="linenos">739</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor.list_models-740"><a href="#Interactor.list_models-740"><span class="linenos">740</span></a>                <span class="k">return</span> <span class="p">[]</span>
</span><span id="Interactor.list_models-741"><a href="#Interactor.list_models-741"><span class="linenos">741</span></a>
</span><span id="Interactor.list_models-742"><a href="#Interactor.list_models-742"><span class="linenos">742</span></a>        <span class="k">for</span> <span class="n">provider_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">providers_to_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Interactor.list_models-743"><a href="#Interactor.list_models-743"><span class="linenos">743</span></a>            <span class="n">sdk</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sdk&quot;</span><span class="p">,</span> <span class="s2">&quot;openai&quot;</span><span class="p">)</span>
</span><span id="Interactor.list_models-744"><a href="#Interactor.list_models-744"><span class="linenos">744</span></a>            <span class="n">base_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_url&quot;</span><span class="p">)</span>
</span><span id="Interactor.list_models-745"><a href="#Interactor.list_models-745"><span class="linenos">745</span></a>            <span class="n">api_key</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key&quot;</span><span class="p">)</span>
</span><span id="Interactor.list_models-746"><a href="#Interactor.list_models-746"><span class="linenos">746</span></a>
</span><span id="Interactor.list_models-747"><a href="#Interactor.list_models-747"><span class="linenos">747</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor.list_models-748"><a href="#Interactor.list_models-748"><span class="linenos">748</span></a>                <span class="k">if</span> <span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
</span><span id="Interactor.list_models-749"><a href="#Interactor.list_models-749"><span class="linenos">749</span></a>                    <span class="n">client</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">)</span>
</span><span id="Interactor.list_models-750"><a href="#Interactor.list_models-750"><span class="linenos">750</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</span><span id="Interactor.list_models-751"><a href="#Interactor.list_models-751"><span class="linenos">751</span></a>                    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
</span><span id="Interactor.list_models-752"><a href="#Interactor.list_models-752"><span class="linenos">752</span></a>                        <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Interactor.list_models-753"><a href="#Interactor.list_models-753"><span class="linenos">753</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_pattern</span> <span class="ow">or</span> <span class="n">regex_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">model_id</span><span class="p">):</span>
</span><span id="Interactor.list_models-754"><a href="#Interactor.list_models-754"><span class="linenos">754</span></a>                            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
</span><span id="Interactor.list_models-755"><a href="#Interactor.list_models-755"><span class="linenos">755</span></a>
</span><span id="Interactor.list_models-756"><a href="#Interactor.list_models-756"><span class="linenos">756</span></a>                <span class="k">elif</span> <span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;anthropic&quot;</span><span class="p">:</span>
</span><span id="Interactor.list_models-757"><a href="#Interactor.list_models-757"><span class="linenos">757</span></a>                    <span class="n">client</span> <span class="o">=</span> <span class="n">Anthropic</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
</span><span id="Interactor.list_models-758"><a href="#Interactor.list_models-758"><span class="linenos">758</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</span><span id="Interactor.list_models-759"><a href="#Interactor.list_models-759"><span class="linenos">759</span></a>                    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
</span><span id="Interactor.list_models-760"><a href="#Interactor.list_models-760"><span class="linenos">760</span></a>                        <span class="n">model_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Interactor.list_models-761"><a href="#Interactor.list_models-761"><span class="linenos">761</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_pattern</span> <span class="ow">or</span> <span class="n">regex_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">model_id</span><span class="p">):</span>
</span><span id="Interactor.list_models-762"><a href="#Interactor.list_models-762"><span class="linenos">762</span></a>                            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
</span><span id="Interactor.list_models-763"><a href="#Interactor.list_models-763"><span class="linenos">763</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor.list_models-764"><a href="#Interactor.list_models-764"><span class="linenos">764</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SDK &#39;</span><span class="si">{</span><span class="n">sdk</span><span class="si">}</span><span class="s2">&#39; for provider &#39;</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2">&#39; is not supported by list_models()&quot;</span><span class="p">)</span>
</span><span id="Interactor.list_models-765"><a href="#Interactor.list_models-765"><span class="linenos">765</span></a>
</span><span id="Interactor.list_models-766"><a href="#Interactor.list_models-766"><span class="linenos">766</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor.list_models-767"><a href="#Interactor.list_models-767"><span class="linenos">767</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to list models for </span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor.list_models-768"><a href="#Interactor.list_models-768"><span class="linenos">768</span></a>
</span><span id="Interactor.list_models-769"><a href="#Interactor.list_models-769"><span class="linenos">769</span></a>        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Retrieve available models from configured providers.</p>

<p>Args:
    providers: Provider name or list of provider names. If None, all are queried.
    filter: Optional regex to filter model names.</p>

<p>Returns:
    List[str]: Sorted list of "provider:model_id" strings.</p>
</div>


                            </div>
                            <div id="Interactor.interact" class="classattr">
                                        <input id="Interactor.interact-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">interact</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">user_input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>,</span><span class="param">	<span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">tools</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">markdown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">output_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Interactor.interact-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.interact"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.interact-803"><a href="#Interactor.interact-803"><span class="linenos">803</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">interact</span><span class="p">(</span>
</span><span id="Interactor.interact-804"><a href="#Interactor.interact-804"><span class="linenos">804</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor.interact-805"><a href="#Interactor.interact-805"><span class="linenos">805</span></a>        <span class="n">user_input</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="Interactor.interact-806"><a href="#Interactor.interact-806"><span class="linenos">806</span></a>        <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor.interact-807"><a href="#Interactor.interact-807"><span class="linenos">807</span></a>        <span class="n">tools</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Interactor.interact-808"><a href="#Interactor.interact-808"><span class="linenos">808</span></a>        <span class="n">stream</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="Interactor.interact-809"><a href="#Interactor.interact-809"><span class="linenos">809</span></a>        <span class="n">markdown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Interactor.interact-810"><a href="#Interactor.interact-810"><span class="linenos">810</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor.interact-811"><a href="#Interactor.interact-811"><span class="linenos">811</span></a>        <span class="n">output_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor.interact-812"><a href="#Interactor.interact-812"><span class="linenos">812</span></a>        <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.interact-813"><a href="#Interactor.interact-813"><span class="linenos">813</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Interactor.interact-814"><a href="#Interactor.interact-814"><span class="linenos">814</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main universal gateway for all LLM interaction.&quot;&quot;&quot;</span>
</span><span id="Interactor.interact-815"><a href="#Interactor.interact-815"><span class="linenos">815</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_input</span><span class="p">:</span>
</span><span id="Interactor.interact-816"><a href="#Interactor.interact-816"><span class="linenos">816</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="Interactor.interact-817"><a href="#Interactor.interact-817"><span class="linenos">817</span></a>
</span><span id="Interactor.interact-818"><a href="#Interactor.interact-818"><span class="linenos">818</span></a>        <span class="c1"># Setup model if specified</span>
</span><span id="Interactor.interact-819"><a href="#Interactor.interact-819"><span class="linenos">819</span></a>        <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
</span><span id="Interactor.interact-820"><a href="#Interactor.interact-820"><span class="linenos">820</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_client</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="Interactor.interact-821"><a href="#Interactor.interact-821"><span class="linenos">821</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_encoding</span><span class="p">()</span>
</span><span id="Interactor.interact-822"><a href="#Interactor.interact-822"><span class="linenos">822</span></a>
</span><span id="Interactor.interact-823"><a href="#Interactor.interact-823"><span class="linenos">823</span></a>        <span class="c1"># Session handling</span>
</span><span id="Interactor.interact-824"><a href="#Interactor.interact-824"><span class="linenos">824</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="ow">and</span> <span class="n">session_id</span><span class="p">:</span>
</span><span id="Interactor.interact-825"><a href="#Interactor.interact-825"><span class="linenos">825</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span>
</span><span id="Interactor.interact-826"><a href="#Interactor.interact-826"><span class="linenos">826</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session_load</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Interactor.interact-827"><a href="#Interactor.interact-827"><span class="linenos">827</span></a>
</span><span id="Interactor.interact-828"><a href="#Interactor.interact-828"><span class="linenos">828</span></a>        <span class="c1"># Add user message using messages_add</span>
</span><span id="Interactor.interact-829"><a href="#Interactor.interact-829"><span class="linenos">829</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">user_input</span><span class="p">)</span>
</span><span id="Interactor.interact-830"><a href="#Interactor.interact-830"><span class="linenos">830</span></a>
</span><span id="Interactor.interact-831"><a href="#Interactor.interact-831"><span class="linenos">831</span></a>        <span class="c1"># Log token count estimate</span>
</span><span id="Interactor.interact-832"><a href="#Interactor.interact-832"><span class="linenos">832</span></a>        <span class="n">token_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_tokens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="Interactor.interact-833"><a href="#Interactor.interact-833"><span class="linenos">833</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="Interactor.interact-834"><a href="#Interactor.interact-834"><span class="linenos">834</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[dim]Estimated tokens in context: </span><span class="si">{</span><span class="n">token_count</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="si">}</span><span class="s2">[/dim]&quot;</span><span class="p">)</span>
</span><span id="Interactor.interact-835"><a href="#Interactor.interact-835"><span class="linenos">835</span></a>
</span><span id="Interactor.interact-836"><a href="#Interactor.interact-836"><span class="linenos">836</span></a>        <span class="c1"># Make sure we have enough context space</span>
</span><span id="Interactor.interact-837"><a href="#Interactor.interact-837"><span class="linenos">837</span></a>        <span class="k">if</span> <span class="n">token_count</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="p">:</span>
</span><span id="Interactor.interact-838"><a href="#Interactor.interact-838"><span class="linenos">838</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cycle_messages</span><span class="p">():</span>
</span><span id="Interactor.interact-839"><a href="#Interactor.interact-839"><span class="linenos">839</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="Interactor.interact-840"><a href="#Interactor.interact-840"><span class="linenos">840</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[red]Context window exceeded. Cannot proceed.[/red]&quot;</span><span class="p">)</span>
</span><span id="Interactor.interact-841"><a href="#Interactor.interact-841"><span class="linenos">841</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="Interactor.interact-842"><a href="#Interactor.interact-842"><span class="linenos">842</span></a>
</span><span id="Interactor.interact-843"><a href="#Interactor.interact-843"><span class="linenos">843</span></a>        <span class="c1"># Log user input</span>
</span><span id="Interactor.interact-844"><a href="#Interactor.interact-844"><span class="linenos">844</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[USER] </span><span class="si">{</span><span class="n">user_input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor.interact-845"><a href="#Interactor.interact-845"><span class="linenos">845</span></a>
</span><span id="Interactor.interact-846"><a href="#Interactor.interact-846"><span class="linenos">846</span></a>        <span class="c1"># Handle the actual interaction with complete streaming for all responses</span>
</span><span id="Interactor.interact-847"><a href="#Interactor.interact-847"><span class="linenos">847</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_interact_async_core</span><span class="p">(</span>
</span><span id="Interactor.interact-848"><a href="#Interactor.interact-848"><span class="linenos">848</span></a>            <span class="n">user_input</span><span class="o">=</span><span class="n">user_input</span><span class="p">,</span>
</span><span id="Interactor.interact-849"><a href="#Interactor.interact-849"><span class="linenos">849</span></a>            <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
</span><span id="Interactor.interact-850"><a href="#Interactor.interact-850"><span class="linenos">850</span></a>            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
</span><span id="Interactor.interact-851"><a href="#Interactor.interact-851"><span class="linenos">851</span></a>            <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
</span><span id="Interactor.interact-852"><a href="#Interactor.interact-852"><span class="linenos">852</span></a>            <span class="n">markdown</span><span class="o">=</span><span class="n">markdown</span><span class="p">,</span>
</span><span id="Interactor.interact-853"><a href="#Interactor.interact-853"><span class="linenos">853</span></a>            <span class="n">output_callback</span><span class="o">=</span><span class="n">output_callback</span>
</span><span id="Interactor.interact-854"><a href="#Interactor.interact-854"><span class="linenos">854</span></a>        <span class="p">))</span>
</span><span id="Interactor.interact-855"><a href="#Interactor.interact-855"><span class="linenos">855</span></a>
</span><span id="Interactor.interact-856"><a href="#Interactor.interact-856"><span class="linenos">856</span></a>        <span class="c1"># Log completion for this interaction</span>
</span><span id="Interactor.interact-857"><a href="#Interactor.interact-857"><span class="linenos">857</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INTERACTION] Completed with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span><span class="si">}</span><span class="s2"> total messages&quot;</span><span class="p">)</span>
</span><span id="Interactor.interact-858"><a href="#Interactor.interact-858"><span class="linenos">858</span></a>
</span><span id="Interactor.interact-859"><a href="#Interactor.interact-859"><span class="linenos">859</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Main universal gateway for all LLM interaction.</p>
</div>


                            </div>
                            <div id="Interactor.messages_add" class="classattr">
                                        <input id="Interactor.messages_add-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">messages_add</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">role</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">content</span><span class="p">:</span> <span class="n">Any</span>,</span><span class="param">	<span class="n">tool_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Interactor.messages_add-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.messages_add"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.messages_add-1794"><a href="#Interactor.messages_add-1794"><span class="linenos">1794</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">messages_add</span><span class="p">(</span>
</span><span id="Interactor.messages_add-1795"><a href="#Interactor.messages_add-1795"><span class="linenos">1795</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Interactor.messages_add-1796"><a href="#Interactor.messages_add-1796"><span class="linenos">1796</span></a>        <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Interactor.messages_add-1797"><a href="#Interactor.messages_add-1797"><span class="linenos">1797</span></a>        <span class="n">content</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="Interactor.messages_add-1798"><a href="#Interactor.messages_add-1798"><span class="linenos">1798</span></a>        <span class="n">tool_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Interactor.messages_add-1799"><a href="#Interactor.messages_add-1799"><span class="linenos">1799</span></a>        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Interactor.messages_add-1800"><a href="#Interactor.messages_add-1800"><span class="linenos">1800</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Interactor.messages_add-1801"><a href="#Interactor.messages_add-1801"><span class="linenos">1801</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor.messages_add-1802"><a href="#Interactor.messages_add-1802"><span class="linenos">1802</span></a><span class="sd">        Add a message to the standardized session_history and then update SDK-specific history.</span>
</span><span id="Interactor.messages_add-1803"><a href="#Interactor.messages_add-1803"><span class="linenos">1803</span></a><span class="sd">        </span>
</span><span id="Interactor.messages_add-1804"><a href="#Interactor.messages_add-1804"><span class="linenos">1804</span></a><span class="sd">        This method is the central point for all message additions to the conversation.</span>
</span><span id="Interactor.messages_add-1805"><a href="#Interactor.messages_add-1805"><span class="linenos">1805</span></a><span class="sd">        </span>
</span><span id="Interactor.messages_add-1806"><a href="#Interactor.messages_add-1806"><span class="linenos">1806</span></a><span class="sd">        Args:</span>
</span><span id="Interactor.messages_add-1807"><a href="#Interactor.messages_add-1807"><span class="linenos">1807</span></a><span class="sd">            role: The role of the message (&quot;user&quot;, &quot;assistant&quot;, &quot;system&quot;, &quot;tool&quot;)</span>
</span><span id="Interactor.messages_add-1808"><a href="#Interactor.messages_add-1808"><span class="linenos">1808</span></a><span class="sd">            content: The message content (text or structured)</span>
</span><span id="Interactor.messages_add-1809"><a href="#Interactor.messages_add-1809"><span class="linenos">1809</span></a><span class="sd">            tool_info: Optional tool-related metadata</span>
</span><span id="Interactor.messages_add-1810"><a href="#Interactor.messages_add-1810"><span class="linenos">1810</span></a><span class="sd">            normalize: Whether to normalize history after adding this message</span>
</span><span id="Interactor.messages_add-1811"><a href="#Interactor.messages_add-1811"><span class="linenos">1811</span></a><span class="sd">            </span>
</span><span id="Interactor.messages_add-1812"><a href="#Interactor.messages_add-1812"><span class="linenos">1812</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor.messages_add-1813"><a href="#Interactor.messages_add-1813"><span class="linenos">1813</span></a><span class="sd">            str: Unique ID of the added message</span>
</span><span id="Interactor.messages_add-1814"><a href="#Interactor.messages_add-1814"><span class="linenos">1814</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor.messages_add-1815"><a href="#Interactor.messages_add-1815"><span class="linenos">1815</span></a>        <span class="c1"># Generate a unique message ID</span>
</span><span id="Interactor.messages_add-1816"><a href="#Interactor.messages_add-1816"><span class="linenos">1816</span></a>        <span class="n">message_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="Interactor.messages_add-1817"><a href="#Interactor.messages_add-1817"><span class="linenos">1817</span></a>        
</span><span id="Interactor.messages_add-1818"><a href="#Interactor.messages_add-1818"><span class="linenos">1818</span></a>        <span class="c1"># Create the standardized message for session_history</span>
</span><span id="Interactor.messages_add-1819"><a href="#Interactor.messages_add-1819"><span class="linenos">1819</span></a>        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="Interactor.messages_add-1820"><a href="#Interactor.messages_add-1820"><span class="linenos">1820</span></a>        
</span><span id="Interactor.messages_add-1821"><a href="#Interactor.messages_add-1821"><span class="linenos">1821</span></a>        <span class="c1"># Store system messages directly</span>
</span><span id="Interactor.messages_add-1822"><a href="#Interactor.messages_add-1822"><span class="linenos">1822</span></a>        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="Interactor.messages_add-1823"><a href="#Interactor.messages_add-1823"><span class="linenos">1823</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">content</span>
</span><span id="Interactor.messages_add-1824"><a href="#Interactor.messages_add-1824"><span class="linenos">1824</span></a>        
</span><span id="Interactor.messages_add-1825"><a href="#Interactor.messages_add-1825"><span class="linenos">1825</span></a>        <span class="c1"># Create standard format message</span>
</span><span id="Interactor.messages_add-1826"><a href="#Interactor.messages_add-1826"><span class="linenos">1826</span></a>        <span class="n">standard_message</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor.messages_add-1827"><a href="#Interactor.messages_add-1827"><span class="linenos">1827</span></a>            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
</span><span id="Interactor.messages_add-1828"><a href="#Interactor.messages_add-1828"><span class="linenos">1828</span></a>            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
</span><span id="Interactor.messages_add-1829"><a href="#Interactor.messages_add-1829"><span class="linenos">1829</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">message_id</span><span class="p">,</span>
</span><span id="Interactor.messages_add-1830"><a href="#Interactor.messages_add-1830"><span class="linenos">1830</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span><span id="Interactor.messages_add-1831"><a href="#Interactor.messages_add-1831"><span class="linenos">1831</span></a>            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.messages_add-1832"><a href="#Interactor.messages_add-1832"><span class="linenos">1832</span></a>                <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span>
</span><span id="Interactor.messages_add-1833"><a href="#Interactor.messages_add-1833"><span class="linenos">1833</span></a>            <span class="p">}</span>
</span><span id="Interactor.messages_add-1834"><a href="#Interactor.messages_add-1834"><span class="linenos">1834</span></a>        <span class="p">}</span>
</span><span id="Interactor.messages_add-1835"><a href="#Interactor.messages_add-1835"><span class="linenos">1835</span></a>        
</span><span id="Interactor.messages_add-1836"><a href="#Interactor.messages_add-1836"><span class="linenos">1836</span></a>        <span class="c1"># Add tool info if provided</span>
</span><span id="Interactor.messages_add-1837"><a href="#Interactor.messages_add-1837"><span class="linenos">1837</span></a>        <span class="k">if</span> <span class="n">tool_info</span><span class="p">:</span>
</span><span id="Interactor.messages_add-1838"><a href="#Interactor.messages_add-1838"><span class="linenos">1838</span></a>            <span class="n">standard_message</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_info</span>
</span><span id="Interactor.messages_add-1839"><a href="#Interactor.messages_add-1839"><span class="linenos">1839</span></a>        
</span><span id="Interactor.messages_add-1840"><a href="#Interactor.messages_add-1840"><span class="linenos">1840</span></a>        <span class="c1"># Add to session_history</span>
</span><span id="Interactor.messages_add-1841"><a href="#Interactor.messages_add-1841"><span class="linenos">1841</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;session_history&quot;</span><span class="p">):</span>
</span><span id="Interactor.messages_add-1842"><a href="#Interactor.messages_add-1842"><span class="linenos">1842</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor.messages_add-1843"><a href="#Interactor.messages_add-1843"><span class="linenos">1843</span></a>        
</span><span id="Interactor.messages_add-1844"><a href="#Interactor.messages_add-1844"><span class="linenos">1844</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">standard_message</span><span class="p">)</span>
</span><span id="Interactor.messages_add-1845"><a href="#Interactor.messages_add-1845"><span class="linenos">1845</span></a>        
</span><span id="Interactor.messages_add-1846"><a href="#Interactor.messages_add-1846"><span class="linenos">1846</span></a>        <span class="c1"># Save to persistent session if enabled</span>
</span><span id="Interactor.messages_add-1847"><a href="#Interactor.messages_add-1847"><span class="linenos">1847</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">:</span>
</span><span id="Interactor.messages_add-1848"><a href="#Interactor.messages_add-1848"><span class="linenos">1848</span></a>            <span class="c1"># Convert standard message to session-compatible format</span>
</span><span id="Interactor.messages_add-1849"><a href="#Interactor.messages_add-1849"><span class="linenos">1849</span></a>            <span class="n">session_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor.messages_add-1850"><a href="#Interactor.messages_add-1850"><span class="linenos">1850</span></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
</span><span id="Interactor.messages_add-1851"><a href="#Interactor.messages_add-1851"><span class="linenos">1851</span></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
</span><span id="Interactor.messages_add-1852"><a href="#Interactor.messages_add-1852"><span class="linenos">1852</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">message_id</span><span class="p">,</span>
</span><span id="Interactor.messages_add-1853"><a href="#Interactor.messages_add-1853"><span class="linenos">1853</span></a>                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span>
</span><span id="Interactor.messages_add-1854"><a href="#Interactor.messages_add-1854"><span class="linenos">1854</span></a>            <span class="p">}</span>
</span><span id="Interactor.messages_add-1855"><a href="#Interactor.messages_add-1855"><span class="linenos">1855</span></a>            
</span><span id="Interactor.messages_add-1856"><a href="#Interactor.messages_add-1856"><span class="linenos">1856</span></a>            <span class="c1"># Add tool-related fields if present</span>
</span><span id="Interactor.messages_add-1857"><a href="#Interactor.messages_add-1857"><span class="linenos">1857</span></a>            <span class="k">if</span> <span class="n">tool_info</span><span class="p">:</span>
</span><span id="Interactor.messages_add-1858"><a href="#Interactor.messages_add-1858"><span class="linenos">1858</span></a>                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tool_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Interactor.messages_add-1859"><a href="#Interactor.messages_add-1859"><span class="linenos">1859</span></a>                    <span class="n">session_msg</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="Interactor.messages_add-1860"><a href="#Interactor.messages_add-1860"><span class="linenos">1860</span></a>            
</span><span id="Interactor.messages_add-1861"><a href="#Interactor.messages_add-1861"><span class="linenos">1861</span></a>            <span class="c1"># Store in session</span>
</span><span id="Interactor.messages_add-1862"><a href="#Interactor.messages_add-1862"><span class="linenos">1862</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">msg_insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">session_msg</span><span class="p">)</span>
</span><span id="Interactor.messages_add-1863"><a href="#Interactor.messages_add-1863"><span class="linenos">1863</span></a>        
</span><span id="Interactor.messages_add-1864"><a href="#Interactor.messages_add-1864"><span class="linenos">1864</span></a>        <span class="c1"># Update the SDK-specific format in self.history by running the normalizer</span>
</span><span id="Interactor.messages_add-1865"><a href="#Interactor.messages_add-1865"><span class="linenos">1865</span></a>        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
</span><span id="Interactor.messages_add-1866"><a href="#Interactor.messages_add-1866"><span class="linenos">1866</span></a>            <span class="c1"># We only need to normalize the most recent message for efficiency</span>
</span><span id="Interactor.messages_add-1867"><a href="#Interactor.messages_add-1867"><span class="linenos">1867</span></a>            <span class="c1"># Pass a flag indicating we&#39;re just normalizing a new message</span>
</span><span id="Interactor.messages_add-1868"><a href="#Interactor.messages_add-1868"><span class="linenos">1868</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">new_message_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Interactor.messages_add-1869"><a href="#Interactor.messages_add-1869"><span class="linenos">1869</span></a>        
</span><span id="Interactor.messages_add-1870"><a href="#Interactor.messages_add-1870"><span class="linenos">1870</span></a>        <span class="c1"># Log the added message</span>
</span><span id="Interactor.messages_add-1871"><a href="#Interactor.messages_add-1871"><span class="linenos">1871</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[MESSAGE ADDED] </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="Interactor.messages_add-1872"><a href="#Interactor.messages_add-1872"><span class="linenos">1872</span></a>        
</span><span id="Interactor.messages_add-1873"><a href="#Interactor.messages_add-1873"><span class="linenos">1873</span></a>        <span class="k">return</span> <span class="n">message_id</span>
</span></pre></div>


            <div class="docstring"><p>Add a message to the standardized session_history and then update SDK-specific history.</p>

<p>This method is the central point for all message additions to the conversation.</p>

<p>Args:
    role: The role of the message ("user", "assistant", "system", "tool")
    content: The message content (text or structured)
    tool_info: Optional tool-related metadata
    normalize: Whether to normalize history after adding this message</p>

<p>Returns:
    str: Unique ID of the added message</p>
</div>


                            </div>
                            <div id="Interactor.messages_system" class="classattr">
                                        <input id="Interactor.messages_system-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">messages_system</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Interactor.messages_system-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.messages_system"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.messages_system-1875"><a href="#Interactor.messages_system-1875"><span class="linenos">1875</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">messages_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Interactor.messages_system-1876"><a href="#Interactor.messages_system-1876"><span class="linenos">1876</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set or retrieve the current system prompt.&quot;&quot;&quot;</span>
</span><span id="Interactor.messages_system-1877"><a href="#Interactor.messages_system-1877"><span class="linenos">1877</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">prompt</span><span class="p">:</span>
</span><span id="Interactor.messages_system-1878"><a href="#Interactor.messages_system-1878"><span class="linenos">1878</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
</span><span id="Interactor.messages_system-1879"><a href="#Interactor.messages_system-1879"><span class="linenos">1879</span></a>
</span><span id="Interactor.messages_system-1880"><a href="#Interactor.messages_system-1880"><span class="linenos">1880</span></a>        <span class="c1"># If the prompt hasn&#39;t changed, don&#39;t do anything</span>
</span><span id="Interactor.messages_system-1881"><a href="#Interactor.messages_system-1881"><span class="linenos">1881</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">==</span> <span class="n">prompt</span><span class="p">:</span>
</span><span id="Interactor.messages_system-1882"><a href="#Interactor.messages_system-1882"><span class="linenos">1882</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
</span><span id="Interactor.messages_system-1883"><a href="#Interactor.messages_system-1883"><span class="linenos">1883</span></a>
</span><span id="Interactor.messages_system-1884"><a href="#Interactor.messages_system-1884"><span class="linenos">1884</span></a>        <span class="c1"># Update the system prompt</span>
</span><span id="Interactor.messages_system-1885"><a href="#Interactor.messages_system-1885"><span class="linenos">1885</span></a>        <span class="n">old_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
</span><span id="Interactor.messages_system-1886"><a href="#Interactor.messages_system-1886"><span class="linenos">1886</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">prompt</span>
</span><span id="Interactor.messages_system-1887"><a href="#Interactor.messages_system-1887"><span class="linenos">1887</span></a>
</span><span id="Interactor.messages_system-1888"><a href="#Interactor.messages_system-1888"><span class="linenos">1888</span></a>        <span class="c1"># For OpenAI, update or insert the system message in history</span>
</span><span id="Interactor.messages_system-1889"><a href="#Interactor.messages_system-1889"><span class="linenos">1889</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span><span class="p">:</span>
</span><span id="Interactor.messages_system-1890"><a href="#Interactor.messages_system-1890"><span class="linenos">1890</span></a>            <span class="c1"># Check if there&#39;s already a system message</span>
</span><span id="Interactor.messages_system-1891"><a href="#Interactor.messages_system-1891"><span class="linenos">1891</span></a>            <span class="n">system_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="Interactor.messages_system-1892"><a href="#Interactor.messages_system-1892"><span class="linenos">1892</span></a>                                <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Interactor.messages_system-1893"><a href="#Interactor.messages_system-1893"><span class="linenos">1893</span></a>
</span><span id="Interactor.messages_system-1894"><a href="#Interactor.messages_system-1894"><span class="linenos">1894</span></a>            <span class="k">if</span> <span class="n">system_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Interactor.messages_system-1895"><a href="#Interactor.messages_system-1895"><span class="linenos">1895</span></a>                <span class="c1"># Update existing system message</span>
</span><span id="Interactor.messages_system-1896"><a href="#Interactor.messages_system-1896"><span class="linenos">1896</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">system_index</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt</span>
</span><span id="Interactor.messages_system-1897"><a href="#Interactor.messages_system-1897"><span class="linenos">1897</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor.messages_system-1898"><a href="#Interactor.messages_system-1898"><span class="linenos">1898</span></a>                <span class="c1"># Insert new system message at the beginning</span>
</span><span id="Interactor.messages_system-1899"><a href="#Interactor.messages_system-1899"><span class="linenos">1899</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">})</span>
</span><span id="Interactor.messages_system-1900"><a href="#Interactor.messages_system-1900"><span class="linenos">1900</span></a>
</span><span id="Interactor.messages_system-1901"><a href="#Interactor.messages_system-1901"><span class="linenos">1901</span></a>        <span class="c1"># For Anthropic, system message is not part of history, just save it for API calls</span>
</span><span id="Interactor.messages_system-1902"><a href="#Interactor.messages_system-1902"><span class="linenos">1902</span></a>
</span><span id="Interactor.messages_system-1903"><a href="#Interactor.messages_system-1903"><span class="linenos">1903</span></a>        <span class="c1"># Log to session only if prompt actually changed</span>
</span><span id="Interactor.messages_system-1904"><a href="#Interactor.messages_system-1904"><span class="linenos">1904</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">and</span> <span class="n">old_system</span> <span class="o">!=</span> <span class="n">prompt</span><span class="p">:</span>
</span><span id="Interactor.messages_system-1905"><a href="#Interactor.messages_system-1905"><span class="linenos">1905</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">msg_insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">})</span>
</span><span id="Interactor.messages_system-1906"><a href="#Interactor.messages_system-1906"><span class="linenos">1906</span></a>
</span><span id="Interactor.messages_system-1907"><a href="#Interactor.messages_system-1907"><span class="linenos">1907</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span>
</span></pre></div>


            <div class="docstring"><p>Set or retrieve the current system prompt.</p>
</div>


                            </div>
                            <div id="Interactor.messages" class="classattr">
                                        <input id="Interactor.messages-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">messages</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="Interactor.messages-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.messages"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.messages-1909"><a href="#Interactor.messages-1909"><span class="linenos">1909</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">messages</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="Interactor.messages-1910"><a href="#Interactor.messages-1910"><span class="linenos">1910</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return full session messages (persisted or in-memory).&quot;&quot;&quot;</span>
</span><span id="Interactor.messages-1911"><a href="#Interactor.messages-1911"><span class="linenos">1911</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">:</span>
</span><span id="Interactor.messages-1912"><a href="#Interactor.messages-1912"><span class="linenos">1912</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">load_full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Interactor.messages-1913"><a href="#Interactor.messages-1913"><span class="linenos">1913</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span>
</span></pre></div>


            <div class="docstring"><p>Return full session messages (persisted or in-memory).</p>
</div>


                            </div>
                            <div id="Interactor.messages_length" class="classattr">
                                        <input id="Interactor.messages_length-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">messages_length</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="Interactor.messages_length-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.messages_length"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.messages_length-1915"><a href="#Interactor.messages_length-1915"><span class="linenos">1915</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">messages_length</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Interactor.messages_length-1916"><a href="#Interactor.messages_length-1916"><span class="linenos">1916</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the total token count for the message history.&quot;&quot;&quot;</span>
</span><span id="Interactor.messages_length-1917"><a href="#Interactor.messages_length-1917"><span class="linenos">1917</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span>
</span><span id="Interactor.messages_length-1918"><a href="#Interactor.messages_length-1918"><span class="linenos">1918</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="Interactor.messages_length-1919"><a href="#Interactor.messages_length-1919"><span class="linenos">1919</span></a>
</span><span id="Interactor.messages_length-1920"><a href="#Interactor.messages_length-1920"><span class="linenos">1920</span></a>        <span class="n">total_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Interactor.messages_length-1921"><a href="#Interactor.messages_length-1921"><span class="linenos">1921</span></a>        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">:</span>
</span><span id="Interactor.messages_length-1922"><a href="#Interactor.messages_length-1922"><span class="linenos">1922</span></a>            <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">):</span>
</span><span id="Interactor.messages_length-1923"><a href="#Interactor.messages_length-1923"><span class="linenos">1923</span></a>                <span class="n">total_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]))</span>
</span><span id="Interactor.messages_length-1924"><a href="#Interactor.messages_length-1924"><span class="linenos">1924</span></a>            <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">):</span>
</span><span id="Interactor.messages_length-1925"><a href="#Interactor.messages_length-1925"><span class="linenos">1925</span></a>                <span class="k">for</span> <span class="n">tool_call</span> <span class="ow">in</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">]:</span>
</span><span id="Interactor.messages_length-1926"><a href="#Interactor.messages_length-1926"><span class="linenos">1926</span></a>                    <span class="k">if</span> <span class="n">tool_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">):</span>
</span><span id="Interactor.messages_length-1927"><a href="#Interactor.messages_length-1927"><span class="linenos">1927</span></a>                        <span class="n">total_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tool_call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor.messages_length-1928"><a href="#Interactor.messages_length-1928"><span class="linenos">1928</span></a>                        <span class="n">total_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tool_call</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="Interactor.messages_length-1929"><a href="#Interactor.messages_length-1929"><span class="linenos">1929</span></a>        <span class="k">return</span> <span class="n">total_tokens</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the total token count for the message history.</p>
</div>


                            </div>
                            <div id="Interactor.session_load" class="classattr">
                                        <input id="Interactor.session_load-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">session_load</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Interactor.session_load-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.session_load"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.session_load-1931"><a href="#Interactor.session_load-1931"><span class="linenos">1931</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">session_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
</span><span id="Interactor.session_load-1932"><a href="#Interactor.session_load-1932"><span class="linenos">1932</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load and normalize messages for a specific session.&quot;&quot;&quot;</span>
</span><span id="Interactor.session_load-1933"><a href="#Interactor.session_load-1933"><span class="linenos">1933</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span>
</span><span id="Interactor.session_load-1934"><a href="#Interactor.session_load-1934"><span class="linenos">1934</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_session_id</span> <span class="o">=</span> <span class="n">session_id</span>
</span><span id="Interactor.session_load-1935"><a href="#Interactor.session_load-1935"><span class="linenos">1935</span></a>        
</span><span id="Interactor.session_load-1936"><a href="#Interactor.session_load-1936"><span class="linenos">1936</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_enabled</span> <span class="ow">and</span> <span class="n">session_id</span><span class="p">:</span>
</span><span id="Interactor.session_load-1937"><a href="#Interactor.session_load-1937"><span class="linenos">1937</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Interactor.session_load-1938"><a href="#Interactor.session_load-1938"><span class="linenos">1938</span></a>                <span class="c1"># Load raw session data</span>
</span><span id="Interactor.session_load-1939"><a href="#Interactor.session_load-1939"><span class="linenos">1939</span></a>                <span class="n">session_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">load_full</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Interactor.session_load-1940"><a href="#Interactor.session_load-1940"><span class="linenos">1940</span></a>                <span class="n">messages</span> <span class="o">=</span> <span class="n">session_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Interactor.session_load-1941"><a href="#Interactor.session_load-1941"><span class="linenos">1941</span></a>                
</span><span id="Interactor.session_load-1942"><a href="#Interactor.session_load-1942"><span class="linenos">1942</span></a>                <span class="c1"># Convert session format to our standard format</span>
</span><span id="Interactor.session_load-1943"><a href="#Interactor.session_load-1943"><span class="linenos">1943</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor.session_load-1944"><a href="#Interactor.session_load-1944"><span class="linenos">1944</span></a>                
</span><span id="Interactor.session_load-1945"><a href="#Interactor.session_load-1945"><span class="linenos">1945</span></a>                <span class="c1"># Track the most recent system message</span>
</span><span id="Interactor.session_load-1946"><a href="#Interactor.session_load-1946"><span class="linenos">1946</span></a>                <span class="n">latest_system_msg</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.session_load-1947"><a href="#Interactor.session_load-1947"><span class="linenos">1947</span></a>                
</span><span id="Interactor.session_load-1948"><a href="#Interactor.session_load-1948"><span class="linenos">1948</span></a>                <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="Interactor.session_load-1949"><a href="#Interactor.session_load-1949"><span class="linenos">1949</span></a>                    <span class="c1"># Extract fields</span>
</span><span id="Interactor.session_load-1950"><a href="#Interactor.session_load-1950"><span class="linenos">1950</span></a>                    <span class="n">role</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">)</span>
</span><span id="Interactor.session_load-1951"><a href="#Interactor.session_load-1951"><span class="linenos">1951</span></a>                    <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="Interactor.session_load-1952"><a href="#Interactor.session_load-1952"><span class="linenos">1952</span></a>                    <span class="n">msg_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
</span><span id="Interactor.session_load-1953"><a href="#Interactor.session_load-1953"><span class="linenos">1953</span></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
</span><span id="Interactor.session_load-1954"><a href="#Interactor.session_load-1954"><span class="linenos">1954</span></a>                    
</span><span id="Interactor.session_load-1955"><a href="#Interactor.session_load-1955"><span class="linenos">1955</span></a>                    <span class="c1"># If this is a system message, track it but don&#39;t add to session_history yet</span>
</span><span id="Interactor.session_load-1956"><a href="#Interactor.session_load-1956"><span class="linenos">1956</span></a>                    <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;system&quot;</span><span class="p">:</span>
</span><span id="Interactor.session_load-1957"><a href="#Interactor.session_load-1957"><span class="linenos">1957</span></a>                        <span class="k">if</span> <span class="n">latest_system_msg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">latest_system_msg</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]:</span>
</span><span id="Interactor.session_load-1958"><a href="#Interactor.session_load-1958"><span class="linenos">1958</span></a>                            <span class="n">latest_system_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor.session_load-1959"><a href="#Interactor.session_load-1959"><span class="linenos">1959</span></a>                                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
</span><span id="Interactor.session_load-1960"><a href="#Interactor.session_load-1960"><span class="linenos">1960</span></a>                                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
</span><span id="Interactor.session_load-1961"><a href="#Interactor.session_load-1961"><span class="linenos">1961</span></a>                                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">msg_id</span><span class="p">,</span>
</span><span id="Interactor.session_load-1962"><a href="#Interactor.session_load-1962"><span class="linenos">1962</span></a>                                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span><span id="Interactor.session_load-1963"><a href="#Interactor.session_load-1963"><span class="linenos">1963</span></a>                                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span><span class="p">}</span>
</span><span id="Interactor.session_load-1964"><a href="#Interactor.session_load-1964"><span class="linenos">1964</span></a>                            <span class="p">}</span>
</span><span id="Interactor.session_load-1965"><a href="#Interactor.session_load-1965"><span class="linenos">1965</span></a>                        <span class="k">continue</span>
</span><span id="Interactor.session_load-1966"><a href="#Interactor.session_load-1966"><span class="linenos">1966</span></a>                    
</span><span id="Interactor.session_load-1967"><a href="#Interactor.session_load-1967"><span class="linenos">1967</span></a>                    <span class="c1"># Build tool_info if present</span>
</span><span id="Interactor.session_load-1968"><a href="#Interactor.session_load-1968"><span class="linenos">1968</span></a>                    <span class="n">tool_info</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.session_load-1969"><a href="#Interactor.session_load-1969"><span class="linenos">1969</span></a>                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">msg</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tool_use_id&quot;</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;arguments&quot;</span><span class="p">]):</span>
</span><span id="Interactor.session_load-1970"><a href="#Interactor.session_load-1970"><span class="linenos">1970</span></a>                        <span class="n">tool_info</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor.session_load-1971"><a href="#Interactor.session_load-1971"><span class="linenos">1971</span></a>                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_call_id&quot;</span><span class="p">),</span>
</span><span id="Interactor.session_load-1972"><a href="#Interactor.session_load-1972"><span class="linenos">1972</span></a>                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown_tool&quot;</span><span class="p">),</span>
</span><span id="Interactor.session_load-1973"><a href="#Interactor.session_load-1973"><span class="linenos">1973</span></a>                            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="Interactor.session_load-1974"><a href="#Interactor.session_load-1974"><span class="linenos">1974</span></a>                        <span class="p">}</span>
</span><span id="Interactor.session_load-1975"><a href="#Interactor.session_load-1975"><span class="linenos">1975</span></a>                    
</span><span id="Interactor.session_load-1976"><a href="#Interactor.session_load-1976"><span class="linenos">1976</span></a>                    <span class="c1"># Create standard message</span>
</span><span id="Interactor.session_load-1977"><a href="#Interactor.session_load-1977"><span class="linenos">1977</span></a>                    <span class="n">standard_msg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor.session_load-1978"><a href="#Interactor.session_load-1978"><span class="linenos">1978</span></a>                        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
</span><span id="Interactor.session_load-1979"><a href="#Interactor.session_load-1979"><span class="linenos">1979</span></a>                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span>
</span><span id="Interactor.session_load-1980"><a href="#Interactor.session_load-1980"><span class="linenos">1980</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">msg_id</span><span class="p">,</span>
</span><span id="Interactor.session_load-1981"><a href="#Interactor.session_load-1981"><span class="linenos">1981</span></a>                        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span><span id="Interactor.session_load-1982"><a href="#Interactor.session_load-1982"><span class="linenos">1982</span></a>                        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.session_load-1983"><a href="#Interactor.session_load-1983"><span class="linenos">1983</span></a>                            <span class="s2">&quot;sdk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdk</span>
</span><span id="Interactor.session_load-1984"><a href="#Interactor.session_load-1984"><span class="linenos">1984</span></a>                        <span class="p">}</span>
</span><span id="Interactor.session_load-1985"><a href="#Interactor.session_load-1985"><span class="linenos">1985</span></a>                    <span class="p">}</span>
</span><span id="Interactor.session_load-1986"><a href="#Interactor.session_load-1986"><span class="linenos">1986</span></a>                    
</span><span id="Interactor.session_load-1987"><a href="#Interactor.session_load-1987"><span class="linenos">1987</span></a>                    <span class="k">if</span> <span class="n">tool_info</span><span class="p">:</span>
</span><span id="Interactor.session_load-1988"><a href="#Interactor.session_load-1988"><span class="linenos">1988</span></a>                        <span class="n">standard_msg</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;tool_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_info</span>
</span><span id="Interactor.session_load-1989"><a href="#Interactor.session_load-1989"><span class="linenos">1989</span></a>                    
</span><span id="Interactor.session_load-1990"><a href="#Interactor.session_load-1990"><span class="linenos">1990</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">standard_msg</span><span class="p">)</span>
</span><span id="Interactor.session_load-1991"><a href="#Interactor.session_load-1991"><span class="linenos">1991</span></a>                
</span><span id="Interactor.session_load-1992"><a href="#Interactor.session_load-1992"><span class="linenos">1992</span></a>                <span class="c1"># If we found a system message, update the system property and add to history</span>
</span><span id="Interactor.session_load-1993"><a href="#Interactor.session_load-1993"><span class="linenos">1993</span></a>                <span class="k">if</span> <span class="n">latest_system_msg</span><span class="p">:</span>
</span><span id="Interactor.session_load-1994"><a href="#Interactor.session_load-1994"><span class="linenos">1994</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="n">latest_system_msg</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
</span><span id="Interactor.session_load-1995"><a href="#Interactor.session_load-1995"><span class="linenos">1995</span></a>                    <span class="c1"># Insert at the beginning of session_history</span>
</span><span id="Interactor.session_load-1996"><a href="#Interactor.session_load-1996"><span class="linenos">1996</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">latest_system_msg</span><span class="p">)</span>
</span><span id="Interactor.session_load-1997"><a href="#Interactor.session_load-1997"><span class="linenos">1997</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor.session_load-1998"><a href="#Interactor.session_load-1998"><span class="linenos">1998</span></a>                    <span class="c1"># If no system message was found, add the current system message</span>
</span><span id="Interactor.session_load-1999"><a href="#Interactor.session_load-1999"><span class="linenos">1999</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
</span><span id="Interactor.session_load-2000"><a href="#Interactor.session_load-2000"><span class="linenos">2000</span></a>                
</span><span id="Interactor.session_load-2001"><a href="#Interactor.session_load-2001"><span class="linenos">2001</span></a>                <span class="c1"># Normalize to current SDK format</span>
</span><span id="Interactor.session_load-2002"><a href="#Interactor.session_load-2002"><span class="linenos">2002</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Interactor.session_load-2003"><a href="#Interactor.session_load-2003"><span class="linenos">2003</span></a>                
</span><span id="Interactor.session_load-2004"><a href="#Interactor.session_load-2004"><span class="linenos">2004</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SESSION] Switched to session &#39;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="Interactor.session_load-2005"><a href="#Interactor.session_load-2005"><span class="linenos">2005</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Interactor.session_load-2006"><a href="#Interactor.session_load-2006"><span class="linenos">2006</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load session &#39;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Interactor.session_load-2007"><a href="#Interactor.session_load-2007"><span class="linenos">2007</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">session_reset</span><span class="p">()</span>
</span><span id="Interactor.session_load-2008"><a href="#Interactor.session_load-2008"><span class="linenos">2008</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor.session_load-2009"><a href="#Interactor.session_load-2009"><span class="linenos">2009</span></a>            <span class="c1"># Reset to empty state with system message</span>
</span><span id="Interactor.session_load-2010"><a href="#Interactor.session_load-2010"><span class="linenos">2010</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">session_reset</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Load and normalize messages for a specific session.</p>
</div>


                            </div>
                            <div id="Interactor.session_reset" class="classattr">
                                        <input id="Interactor.session_reset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">session_reset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Interactor.session_reset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.session_reset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.session_reset-2012"><a href="#Interactor.session_reset-2012"><span class="linenos">2012</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">session_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Interactor.session_reset-2013"><a href="#Interactor.session_reset-2013"><span class="linenos">2013</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Interactor.session_reset-2014"><a href="#Interactor.session_reset-2014"><span class="linenos">2014</span></a><span class="sd">        Reset the current session state and reinitialize to default system prompt.</span>
</span><span id="Interactor.session_reset-2015"><a href="#Interactor.session_reset-2015"><span class="linenos">2015</span></a>
</span><span id="Interactor.session_reset-2016"><a href="#Interactor.session_reset-2016"><span class="linenos">2016</span></a><span class="sd">        Clears history, disables session ID tracking, and returns to in-memory mode.</span>
</span><span id="Interactor.session_reset-2017"><a href="#Interactor.session_reset-2017"><span class="linenos">2017</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor.session_reset-2018"><a href="#Interactor.session_reset-2018"><span class="linenos">2018</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.session_reset-2019"><a href="#Interactor.session_reset-2019"><span class="linenos">2019</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last_session_id</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Interactor.session_reset-2020"><a href="#Interactor.session_reset-2020"><span class="linenos">2020</span></a>        
</span><span id="Interactor.session_reset-2021"><a href="#Interactor.session_reset-2021"><span class="linenos">2021</span></a>        <span class="c1"># Clear histories</span>
</span><span id="Interactor.session_reset-2022"><a href="#Interactor.session_reset-2022"><span class="linenos">2022</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">session_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor.session_reset-2023"><a href="#Interactor.session_reset-2023"><span class="linenos">2023</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor.session_reset-2024"><a href="#Interactor.session_reset-2024"><span class="linenos">2024</span></a>        
</span><span id="Interactor.session_reset-2025"><a href="#Interactor.session_reset-2025"><span class="linenos">2025</span></a>        <span class="c1"># Reapply the system message</span>
</span><span id="Interactor.session_reset-2026"><a href="#Interactor.session_reset-2026"><span class="linenos">2026</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;system&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">:</span>
</span><span id="Interactor.session_reset-2027"><a href="#Interactor.session_reset-2027"><span class="linenos">2027</span></a>            <span class="c1"># Add to session_history</span>
</span><span id="Interactor.session_reset-2028"><a href="#Interactor.session_reset-2028"><span class="linenos">2028</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
</span><span id="Interactor.session_reset-2029"><a href="#Interactor.session_reset-2029"><span class="linenos">2029</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor.session_reset-2030"><a href="#Interactor.session_reset-2030"><span class="linenos">2030</span></a>            <span class="c1"># Ensure we have a default system message</span>
</span><span id="Interactor.session_reset-2031"><a href="#Interactor.session_reset-2031"><span class="linenos">2031</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;You are a helpful Assistant.&quot;</span>
</span><span id="Interactor.session_reset-2032"><a href="#Interactor.session_reset-2032"><span class="linenos">2032</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">)</span>
</span><span id="Interactor.session_reset-2033"><a href="#Interactor.session_reset-2033"><span class="linenos">2033</span></a>        
</span><span id="Interactor.session_reset-2034"><a href="#Interactor.session_reset-2034"><span class="linenos">2034</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="s2">&quot;[SESSION] Reset to in-memory mode&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reset the current session state and reinitialize to default system prompt.</p>

<p>Clears history, disables session ID tracking, and returns to in-memory mode.</p>
</div>


                            </div>
                            <div id="Interactor.track_token_usage" class="classattr">
                                        <input id="Interactor.track_token_usage-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">track_token_usage</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Interactor.track_token_usage-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.track_token_usage"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.track_token_usage-2433"><a href="#Interactor.track_token_usage-2433"><span class="linenos">2433</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">track_token_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Interactor.track_token_usage-2434"><a href="#Interactor.track_token_usage-2434"><span class="linenos">2434</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Track and return token usage across the conversation history.</span>
</span><span id="Interactor.track_token_usage-2435"><a href="#Interactor.track_token_usage-2435"><span class="linenos">2435</span></a><span class="sd">        </span>
</span><span id="Interactor.track_token_usage-2436"><a href="#Interactor.track_token_usage-2436"><span class="linenos">2436</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor.track_token_usage-2437"><a href="#Interactor.track_token_usage-2437"><span class="linenos">2437</span></a><span class="sd">            dict: Dictionary containing current token counts, limits, and history.</span>
</span><span id="Interactor.track_token_usage-2438"><a href="#Interactor.track_token_usage-2438"><span class="linenos">2438</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor.track_token_usage-2439"><a href="#Interactor.track_token_usage-2439"><span class="linenos">2439</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_token_history&quot;</span><span class="p">):</span>
</span><span id="Interactor.track_token_usage-2440"><a href="#Interactor.track_token_usage-2440"><span class="linenos">2440</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Interactor.track_token_usage-2441"><a href="#Interactor.track_token_usage-2441"><span class="linenos">2441</span></a>        
</span><span id="Interactor.track_token_usage-2442"><a href="#Interactor.track_token_usage-2442"><span class="linenos">2442</span></a>        <span class="c1"># Count current tokens</span>
</span><span id="Interactor.track_token_usage-2443"><a href="#Interactor.track_token_usage-2443"><span class="linenos">2443</span></a>        <span class="n">current_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_tokens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="Interactor.track_token_usage-2444"><a href="#Interactor.track_token_usage-2444"><span class="linenos">2444</span></a>        
</span><span id="Interactor.track_token_usage-2445"><a href="#Interactor.track_token_usage-2445"><span class="linenos">2445</span></a>        <span class="c1"># Add to history</span>
</span><span id="Interactor.track_token_usage-2446"><a href="#Interactor.track_token_usage-2446"><span class="linenos">2446</span></a>        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="Interactor.track_token_usage-2447"><a href="#Interactor.track_token_usage-2447"><span class="linenos">2447</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor.track_token_usage-2448"><a href="#Interactor.track_token_usage-2448"><span class="linenos">2448</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span><span id="Interactor.track_token_usage-2449"><a href="#Interactor.track_token_usage-2449"><span class="linenos">2449</span></a>            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">current_count</span><span class="p">,</span>
</span><span id="Interactor.track_token_usage-2450"><a href="#Interactor.track_token_usage-2450"><span class="linenos">2450</span></a>            <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="p">,</span>
</span><span id="Interactor.track_token_usage-2451"><a href="#Interactor.track_token_usage-2451"><span class="linenos">2451</span></a>            <span class="s2">&quot;provider&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
</span><span id="Interactor.track_token_usage-2452"><a href="#Interactor.track_token_usage-2452"><span class="linenos">2452</span></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</span><span id="Interactor.track_token_usage-2453"><a href="#Interactor.track_token_usage-2453"><span class="linenos">2453</span></a>        <span class="p">})</span>
</span><span id="Interactor.track_token_usage-2454"><a href="#Interactor.track_token_usage-2454"><span class="linenos">2454</span></a>        
</span><span id="Interactor.track_token_usage-2455"><a href="#Interactor.track_token_usage-2455"><span class="linenos">2455</span></a>        <span class="c1"># Keep only the last 100 measurements to avoid unlimited growth</span>
</span><span id="Interactor.track_token_usage-2456"><a href="#Interactor.track_token_usage-2456"><span class="linenos">2456</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="Interactor.track_token_usage-2457"><a href="#Interactor.track_token_usage-2457"><span class="linenos">2457</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
</span><span id="Interactor.track_token_usage-2458"><a href="#Interactor.track_token_usage-2458"><span class="linenos">2458</span></a>        
</span><span id="Interactor.track_token_usage-2459"><a href="#Interactor.track_token_usage-2459"><span class="linenos">2459</span></a>        <span class="c1"># Return current tracking info</span>
</span><span id="Interactor.track_token_usage-2460"><a href="#Interactor.track_token_usage-2460"><span class="linenos">2460</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Interactor.track_token_usage-2461"><a href="#Interactor.track_token_usage-2461"><span class="linenos">2461</span></a>            <span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="n">current_count</span><span class="p">,</span>
</span><span id="Interactor.track_token_usage-2462"><a href="#Interactor.track_token_usage-2462"><span class="linenos">2462</span></a>            <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="p">,</span>
</span><span id="Interactor.track_token_usage-2463"><a href="#Interactor.track_token_usage-2463"><span class="linenos">2463</span></a>            <span class="s2">&quot;percentage&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">current_count</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_length</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor.track_token_usage-2464"><a href="#Interactor.track_token_usage-2464"><span class="linenos">2464</span></a>            <span class="s2">&quot;history&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_history</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:],</span>  <span class="c1"># Return last 10 measurements</span>
</span><span id="Interactor.track_token_usage-2465"><a href="#Interactor.track_token_usage-2465"><span class="linenos">2465</span></a>            <span class="s2">&quot;provider&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
</span><span id="Interactor.track_token_usage-2466"><a href="#Interactor.track_token_usage-2466"><span class="linenos">2466</span></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
</span><span id="Interactor.track_token_usage-2467"><a href="#Interactor.track_token_usage-2467"><span class="linenos">2467</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Track and return token usage across the conversation history.</p>

<p>Returns:
    dict: Dictionary containing current token counts, limits, and history.</p>
</div>


                            </div>
                            <div id="Interactor.get_message_token_breakdown" class="classattr">
                                        <input id="Interactor.get_message_token_breakdown-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_message_token_breakdown</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Interactor.get_message_token_breakdown-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Interactor.get_message_token_breakdown"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Interactor.get_message_token_breakdown-2469"><a href="#Interactor.get_message_token_breakdown-2469"><span class="linenos">2469</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_message_token_breakdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Interactor.get_message_token_breakdown-2470"><a href="#Interactor.get_message_token_breakdown-2470"><span class="linenos">2470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze token usage by message type and provide a detailed breakdown.</span>
</span><span id="Interactor.get_message_token_breakdown-2471"><a href="#Interactor.get_message_token_breakdown-2471"><span class="linenos">2471</span></a><span class="sd">        </span>
</span><span id="Interactor.get_message_token_breakdown-2472"><a href="#Interactor.get_message_token_breakdown-2472"><span class="linenos">2472</span></a><span class="sd">        Returns:</span>
</span><span id="Interactor.get_message_token_breakdown-2473"><a href="#Interactor.get_message_token_breakdown-2473"><span class="linenos">2473</span></a><span class="sd">            dict: Token usage broken down by message types and roles.</span>
</span><span id="Interactor.get_message_token_breakdown-2474"><a href="#Interactor.get_message_token_breakdown-2474"><span class="linenos">2474</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Interactor.get_message_token_breakdown-2475"><a href="#Interactor.get_message_token_breakdown-2475"><span class="linenos">2475</span></a>        <span class="n">breakdown</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Interactor.get_message_token_breakdown-2476"><a href="#Interactor.get_message_token_breakdown-2476"><span class="linenos">2476</span></a>            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor.get_message_token_breakdown-2477"><a href="#Interactor.get_message_token_breakdown-2477"><span class="linenos">2477</span></a>            <span class="s2">&quot;by_role&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.get_message_token_breakdown-2478"><a href="#Interactor.get_message_token_breakdown-2478"><span class="linenos">2478</span></a>                <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor.get_message_token_breakdown-2479"><a href="#Interactor.get_message_token_breakdown-2479"><span class="linenos">2479</span></a>                <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor.get_message_token_breakdown-2480"><a href="#Interactor.get_message_token_breakdown-2480"><span class="linenos">2480</span></a>                <span class="s2">&quot;assistant&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor.get_message_token_breakdown-2481"><a href="#Interactor.get_message_token_breakdown-2481"><span class="linenos">2481</span></a>                <span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="Interactor.get_message_token_breakdown-2482"><a href="#Interactor.get_message_token_breakdown-2482"><span class="linenos">2482</span></a>            <span class="p">},</span>
</span><span id="Interactor.get_message_token_breakdown-2483"><a href="#Interactor.get_message_token_breakdown-2483"><span class="linenos">2483</span></a>            <span class="s2">&quot;by_type&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="Interactor.get_message_token_breakdown-2484"><a href="#Interactor.get_message_token_breakdown-2484"><span class="linenos">2484</span></a>                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor.get_message_token_breakdown-2485"><a href="#Interactor.get_message_token_breakdown-2485"><span class="linenos">2485</span></a>                <span class="s2">&quot;tool_calls&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="Interactor.get_message_token_breakdown-2486"><a href="#Interactor.get_message_token_breakdown-2486"><span class="linenos">2486</span></a>                <span class="s2">&quot;tool_results&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="Interactor.get_message_token_breakdown-2487"><a href="#Interactor.get_message_token_breakdown-2487"><span class="linenos">2487</span></a>            <span class="p">},</span>
</span><span id="Interactor.get_message_token_breakdown-2488"><a href="#Interactor.get_message_token_breakdown-2488"><span class="linenos">2488</span></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="Interactor.get_message_token_breakdown-2489"><a href="#Interactor.get_message_token_breakdown-2489"><span class="linenos">2489</span></a>        <span class="p">}</span>
</span><span id="Interactor.get_message_token_breakdown-2490"><a href="#Interactor.get_message_token_breakdown-2490"><span class="linenos">2490</span></a>        
</span><span id="Interactor.get_message_token_breakdown-2491"><a href="#Interactor.get_message_token_breakdown-2491"><span class="linenos">2491</span></a>        <span class="c1"># Analyze each message</span>
</span><span id="Interactor.get_message_token_breakdown-2492"><a href="#Interactor.get_message_token_breakdown-2492"><span class="linenos">2492</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">):</span>
</span><span id="Interactor.get_message_token_breakdown-2493"><a href="#Interactor.get_message_token_breakdown-2493"><span class="linenos">2493</span></a>            <span class="n">msg_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_tokens</span><span class="p">([</span><span class="n">msg</span><span class="p">])</span>
</span><span id="Interactor.get_message_token_breakdown-2494"><a href="#Interactor.get_message_token_breakdown-2494"><span class="linenos">2494</span></a>            <span class="n">role</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
</span><span id="Interactor.get_message_token_breakdown-2495"><a href="#Interactor.get_message_token_breakdown-2495"><span class="linenos">2495</span></a>            
</span><span id="Interactor.get_message_token_breakdown-2496"><a href="#Interactor.get_message_token_breakdown-2496"><span class="linenos">2496</span></a>            <span class="c1"># Track by role</span>
</span><span id="Interactor.get_message_token_breakdown-2497"><a href="#Interactor.get_message_token_breakdown-2497"><span class="linenos">2497</span></a>            <span class="k">if</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;by_role&quot;</span><span class="p">]:</span>
</span><span id="Interactor.get_message_token_breakdown-2498"><a href="#Interactor.get_message_token_breakdown-2498"><span class="linenos">2498</span></a>                <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;by_role&quot;</span><span class="p">][</span><span class="n">role</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg_tokens</span>
</span><span id="Interactor.get_message_token_breakdown-2499"><a href="#Interactor.get_message_token_breakdown-2499"><span class="linenos">2499</span></a>            
</span><span id="Interactor.get_message_token_breakdown-2500"><a href="#Interactor.get_message_token_breakdown-2500"><span class="linenos">2500</span></a>            <span class="c1"># Track by content type</span>
</span><span id="Interactor.get_message_token_breakdown-2501"><a href="#Interactor.get_message_token_breakdown-2501"><span class="linenos">2501</span></a>            <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">):</span>
</span><span id="Interactor.get_message_token_breakdown-2502"><a href="#Interactor.get_message_token_breakdown-2502"><span class="linenos">2502</span></a>                <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;by_type&quot;</span><span class="p">][</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg_tokens</span>
</span><span id="Interactor.get_message_token_breakdown-2503"><a href="#Interactor.get_message_token_breakdown-2503"><span class="linenos">2503</span></a>            <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;tool&quot;</span><span class="p">:</span>
</span><span id="Interactor.get_message_token_breakdown-2504"><a href="#Interactor.get_message_token_breakdown-2504"><span class="linenos">2504</span></a>                <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;by_type&quot;</span><span class="p">][</span><span class="s2">&quot;tool_results&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg_tokens</span>
</span><span id="Interactor.get_message_token_breakdown-2505"><a href="#Interactor.get_message_token_breakdown-2505"><span class="linenos">2505</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Interactor.get_message_token_breakdown-2506"><a href="#Interactor.get_message_token_breakdown-2506"><span class="linenos">2506</span></a>                <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;by_type&quot;</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg_tokens</span>
</span><span id="Interactor.get_message_token_breakdown-2507"><a href="#Interactor.get_message_token_breakdown-2507"><span class="linenos">2507</span></a>            
</span><span id="Interactor.get_message_token_breakdown-2508"><a href="#Interactor.get_message_token_breakdown-2508"><span class="linenos">2508</span></a>            <span class="c1"># Add individual message data</span>
</span><span id="Interactor.get_message_token_breakdown-2509"><a href="#Interactor.get_message_token_breakdown-2509"><span class="linenos">2509</span></a>            <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Interactor.get_message_token_breakdown-2510"><a href="#Interactor.get_message_token_breakdown-2510"><span class="linenos">2510</span></a>                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
</span><span id="Interactor.get_message_token_breakdown-2511"><a href="#Interactor.get_message_token_breakdown-2511"><span class="linenos">2511</span></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span>
</span><span id="Interactor.get_message_token_breakdown-2512"><a href="#Interactor.get_message_token_breakdown-2512"><span class="linenos">2512</span></a>                <span class="s2">&quot;tokens&quot;</span><span class="p">:</span> <span class="n">msg_tokens</span><span class="p">,</span>
</span><span id="Interactor.get_message_token_breakdown-2513"><a href="#Interactor.get_message_token_breakdown-2513"><span class="linenos">2513</span></a>                <span class="s2">&quot;has_tools&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_calls&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool_use&quot;</span><span class="p">)</span> <span class="ow">or</span> 
</span><span id="Interactor.get_message_token_breakdown-2514"><a href="#Interactor.get_message_token_breakdown-2514"><span class="linenos">2514</span></a>                                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">),</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> 
</span><span id="Interactor.get_message_token_breakdown-2515"><a href="#Interactor.get_message_token_breakdown-2515"><span class="linenos">2515</span></a>                                 <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tool_use&quot;</span><span class="p">,</span> <span class="s2">&quot;tool_result&quot;</span><span class="p">]</span> 
</span><span id="Interactor.get_message_token_breakdown-2516"><a href="#Interactor.get_message_token_breakdown-2516"><span class="linenos">2516</span></a>                                     <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="p">[]))))</span>
</span><span id="Interactor.get_message_token_breakdown-2517"><a href="#Interactor.get_message_token_breakdown-2517"><span class="linenos">2517</span></a>            <span class="p">})</span>
</span><span id="Interactor.get_message_token_breakdown-2518"><a href="#Interactor.get_message_token_breakdown-2518"><span class="linenos">2518</span></a>            
</span><span id="Interactor.get_message_token_breakdown-2519"><a href="#Interactor.get_message_token_breakdown-2519"><span class="linenos">2519</span></a>            <span class="c1"># Update tota?</span>
</span><span id="Interactor.get_message_token_breakdown-2520"><a href="#Interactor.get_message_token_breakdown-2520"><span class="linenos">2520</span></a>            <span class="n">breakdown</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">msg_tokens</span>
</span><span id="Interactor.get_message_token_breakdown-2521"><a href="#Interactor.get_message_token_breakdown-2521"><span class="linenos">2521</span></a>        
</span><span id="Interactor.get_message_token_breakdown-2522"><a href="#Interactor.get_message_token_breakdown-2522"><span class="linenos">2522</span></a>        <span class="k">return</span> <span class="n">breakdown</span>
</span></pre></div>


            <div class="docstring"><p>Analyze token usage by message type and provide a detailed breakdown.</p>

<p>Returns:
    dict: Token usage broken down by message types and roles.</p>
</div>


                            </div>
                </section>
                <section id="Session">
                            <input id="Session-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Session</span>:

                <label class="view-source-button" for="Session-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session-19"><a href="#Session-19"><span class="linenos"> 19</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Session</span><span class="p">:</span>
</span><span id="Session-20"><a href="#Session-20"><span class="linenos"> 20</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Session-21"><a href="#Session-21"><span class="linenos"> 21</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-22"><a href="#Session-22"><span class="linenos"> 22</span></a><span class="sd">        Initialize the session manager and ensure the session directory exists.</span>
</span><span id="Session-23"><a href="#Session-23"><span class="linenos"> 23</span></a>
</span><span id="Session-24"><a href="#Session-24"><span class="linenos"> 24</span></a><span class="sd">        Args:</span>
</span><span id="Session-25"><a href="#Session-25"><span class="linenos"> 25</span></a><span class="sd">            directory (str): Filesystem path for session storage. Must not be None or empty.</span>
</span><span id="Session-26"><a href="#Session-26"><span class="linenos"> 26</span></a>
</span><span id="Session-27"><a href="#Session-27"><span class="linenos"> 27</span></a><span class="sd">        Raises:</span>
</span><span id="Session-28"><a href="#Session-28"><span class="linenos"> 28</span></a><span class="sd">            ValueError: If directory is None or not a string.</span>
</span><span id="Session-29"><a href="#Session-29"><span class="linenos"> 29</span></a><span class="sd">            OSError: If the directory cannot be created or accessed.</span>
</span><span id="Session-30"><a href="#Session-30"><span class="linenos"> 30</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-31"><a href="#Session-31"><span class="linenos"> 31</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="p">:</span>
</span><span id="Session-32"><a href="#Session-32"><span class="linenos"> 32</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Session directory must be a valid non-empty string path.&quot;</span><span class="p">)</span>
</span><span id="Session-33"><a href="#Session-33"><span class="linenos"> 33</span></a>
</span><span id="Session-34"><a href="#Session-34"><span class="linenos"> 34</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Session-35"><a href="#Session-35"><span class="linenos"> 35</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
</span><span id="Session-36"><a href="#Session-36"><span class="linenos"> 36</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Session-37"><a href="#Session-37"><span class="linenos"> 37</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Session-38"><a href="#Session-38"><span class="linenos"> 38</span></a>            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize session directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Session-39"><a href="#Session-39"><span class="linenos"> 39</span></a>
</span><span id="Session-40"><a href="#Session-40"><span class="linenos"> 40</span></a>    <span class="c1"># ---------------------------</span>
</span><span id="Session-41"><a href="#Session-41"><span class="linenos"> 41</span></a>    <span class="c1"># Core CRUD</span>
</span><span id="Session-42"><a href="#Session-42"><span class="linenos"> 42</span></a>    <span class="c1"># ---------------------------</span>
</span><span id="Session-43"><a href="#Session-43"><span class="linenos"> 43</span></a>
</span><span id="Session-44"><a href="#Session-44"><span class="linenos"> 44</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Session-45"><a href="#Session-45"><span class="linenos"> 45</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-46"><a href="#Session-46"><span class="linenos"> 46</span></a><span class="sd">        Return metadata for all sessions in the directory.</span>
</span><span id="Session-47"><a href="#Session-47"><span class="linenos"> 47</span></a>
</span><span id="Session-48"><a href="#Session-48"><span class="linenos"> 48</span></a><span class="sd">        Returns:</span>
</span><span id="Session-49"><a href="#Session-49"><span class="linenos"> 49</span></a><span class="sd">            List[Dict]: Sorted list of session metadata dictionaries.</span>
</span><span id="Session-50"><a href="#Session-50"><span class="linenos"> 50</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-51"><a href="#Session-51"><span class="linenos"> 51</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Session-52"><a href="#Session-52"><span class="linenos"> 52</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">):</span>
</span><span id="Session-53"><a href="#Session-53"><span class="linenos"> 53</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Session-54"><a href="#Session-54"><span class="linenos"> 54</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="Session-55"><a href="#Session-55"><span class="linenos"> 55</span></a>                    <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="Session-56"><a href="#Session-56"><span class="linenos"> 56</span></a>                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Session-57"><a href="#Session-57"><span class="linenos"> 57</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
</span><span id="Session-58"><a href="#Session-58"><span class="linenos"> 58</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
</span><span id="Session-59"><a href="#Session-59"><span class="linenos"> 59</span></a>                        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;created&quot;</span><span class="p">),</span>
</span><span id="Session-60"><a href="#Session-60"><span class="linenos"> 60</span></a>                        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Session-61"><a href="#Session-61"><span class="linenos"> 61</span></a>                        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
</span><span id="Session-62"><a href="#Session-62"><span class="linenos"> 62</span></a>                    <span class="p">})</span>
</span><span id="Session-63"><a href="#Session-63"><span class="linenos"> 63</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Session-64"><a href="#Session-64"><span class="linenos"> 64</span></a>                <span class="k">continue</span>
</span><span id="Session-65"><a href="#Session-65"><span class="linenos"> 65</span></a>        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Session-66"><a href="#Session-66"><span class="linenos"> 66</span></a>
</span><span id="Session-67"><a href="#Session-67"><span class="linenos"> 67</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Session-68"><a href="#Session-68"><span class="linenos"> 68</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-69"><a href="#Session-69"><span class="linenos"> 69</span></a><span class="sd">        Create and persist a new session.</span>
</span><span id="Session-70"><a href="#Session-70"><span class="linenos"> 70</span></a>
</span><span id="Session-71"><a href="#Session-71"><span class="linenos"> 71</span></a><span class="sd">        Args:</span>
</span><span id="Session-72"><a href="#Session-72"><span class="linenos"> 72</span></a><span class="sd">            name (str): Name of the new session.</span>
</span><span id="Session-73"><a href="#Session-73"><span class="linenos"> 73</span></a><span class="sd">            tags (List[str], optional): Optional list of tags.</span>
</span><span id="Session-74"><a href="#Session-74"><span class="linenos"> 74</span></a>
</span><span id="Session-75"><a href="#Session-75"><span class="linenos"> 75</span></a><span class="sd">        Returns:</span>
</span><span id="Session-76"><a href="#Session-76"><span class="linenos"> 76</span></a><span class="sd">            str: Unique session ID of the new session.</span>
</span><span id="Session-77"><a href="#Session-77"><span class="linenos"> 77</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-78"><a href="#Session-78"><span class="linenos"> 78</span></a>        <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="Session-79"><a href="#Session-79"><span class="linenos"> 79</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Session-80"><a href="#Session-80"><span class="linenos"> 80</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span>
</span><span id="Session-81"><a href="#Session-81"><span class="linenos"> 81</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
</span><span id="Session-82"><a href="#Session-82"><span class="linenos"> 82</span></a>            <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="Session-83"><a href="#Session-83"><span class="linenos"> 83</span></a>            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Session-84"><a href="#Session-84"><span class="linenos"> 84</span></a>            <span class="s2">&quot;branch_point&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Session-85"><a href="#Session-85"><span class="linenos"> 85</span></a>            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">[],</span>
</span><span id="Session-86"><a href="#Session-86"><span class="linenos"> 86</span></a>            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Session-87"><a href="#Session-87"><span class="linenos"> 87</span></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="Session-88"><a href="#Session-88"><span class="linenos"> 88</span></a>        <span class="p">}</span>
</span><span id="Session-89"><a href="#Session-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span id="Session-90"><a href="#Session-90"><span class="linenos"> 90</span></a>        <span class="k">return</span> <span class="n">sid</span>
</span><span id="Session-91"><a href="#Session-91"><span class="linenos"> 91</span></a>
</span><span id="Session-92"><a href="#Session-92"><span class="linenos"> 92</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Session-93"><a href="#Session-93"><span class="linenos"> 93</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-94"><a href="#Session-94"><span class="linenos"> 94</span></a><span class="sd">        Return OpenAI-compatible message list from a session.</span>
</span><span id="Session-95"><a href="#Session-95"><span class="linenos"> 95</span></a>
</span><span id="Session-96"><a href="#Session-96"><span class="linenos"> 96</span></a><span class="sd">        Filters out internal keys and leaves only standard API-compatible fields.</span>
</span><span id="Session-97"><a href="#Session-97"><span class="linenos"> 97</span></a>
</span><span id="Session-98"><a href="#Session-98"><span class="linenos"> 98</span></a><span class="sd">        Args:</span>
</span><span id="Session-99"><a href="#Session-99"><span class="linenos"> 99</span></a><span class="sd">            session_id (str): ID of the session to load.</span>
</span><span id="Session-100"><a href="#Session-100"><span class="linenos">100</span></a>
</span><span id="Session-101"><a href="#Session-101"><span class="linenos">101</span></a><span class="sd">        Returns:</span>
</span><span id="Session-102"><a href="#Session-102"><span class="linenos">102</span></a><span class="sd">            List[Dict]: List of clean message dictionaries.</span>
</span><span id="Session-103"><a href="#Session-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-104"><a href="#Session-104"><span class="linenos">104</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session-105"><a href="#Session-105"><span class="linenos">105</span></a>        <span class="k">return</span> <span class="p">[</span>
</span><span id="Session-106"><a href="#Session-106"><span class="linenos">106</span></a>            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">{</span>
</span><span id="Session-107"><a href="#Session-107"><span class="linenos">107</span></a>                <span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;function_call&quot;</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span>
</span><span id="Session-108"><a href="#Session-108"><span class="linenos">108</span></a>            <span class="p">}}</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Session-109"><a href="#Session-109"><span class="linenos">109</span></a>        <span class="p">]</span>
</span><span id="Session-110"><a href="#Session-110"><span class="linenos">110</span></a>
</span><span id="Session-111"><a href="#Session-111"><span class="linenos">111</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Session-112"><a href="#Session-112"><span class="linenos">112</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-113"><a href="#Session-113"><span class="linenos">113</span></a><span class="sd">        Return the complete session file as-is.</span>
</span><span id="Session-114"><a href="#Session-114"><span class="linenos">114</span></a>
</span><span id="Session-115"><a href="#Session-115"><span class="linenos">115</span></a><span class="sd">        Args:</span>
</span><span id="Session-116"><a href="#Session-116"><span class="linenos">116</span></a><span class="sd">            session_id (str): ID of the session.</span>
</span><span id="Session-117"><a href="#Session-117"><span class="linenos">117</span></a>
</span><span id="Session-118"><a href="#Session-118"><span class="linenos">118</span></a><span class="sd">        Returns:</span>
</span><span id="Session-119"><a href="#Session-119"><span class="linenos">119</span></a><span class="sd">            Dict: Entire raw session data.</span>
</span><span id="Session-120"><a href="#Session-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-121"><a href="#Session-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session-122"><a href="#Session-122"><span class="linenos">122</span></a>
</span><span id="Session-123"><a href="#Session-123"><span class="linenos">123</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Session-124"><a href="#Session-124"><span class="linenos">124</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-125"><a href="#Session-125"><span class="linenos">125</span></a><span class="sd">        Delete a session file from disk.</span>
</span><span id="Session-126"><a href="#Session-126"><span class="linenos">126</span></a>
</span><span id="Session-127"><a href="#Session-127"><span class="linenos">127</span></a><span class="sd">        Args:</span>
</span><span id="Session-128"><a href="#Session-128"><span class="linenos">128</span></a><span class="sd">            session_id (str): ID of the session to delete.</span>
</span><span id="Session-129"><a href="#Session-129"><span class="linenos">129</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-130"><a href="#Session-130"><span class="linenos">130</span></a>        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">.json&quot;</span>
</span><span id="Session-131"><a href="#Session-131"><span class="linenos">131</span></a>        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Session-132"><a href="#Session-132"><span class="linenos">132</span></a>            <span class="n">file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span><span id="Session-133"><a href="#Session-133"><span class="linenos">133</span></a>
</span><span id="Session-134"><a href="#Session-134"><span class="linenos">134</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span id="Session-135"><a href="#Session-135"><span class="linenos">135</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-136"><a href="#Session-136"><span class="linenos">136</span></a><span class="sd">        Update a top-level key in a session file.</span>
</span><span id="Session-137"><a href="#Session-137"><span class="linenos">137</span></a>
</span><span id="Session-138"><a href="#Session-138"><span class="linenos">138</span></a><span class="sd">        Args:</span>
</span><span id="Session-139"><a href="#Session-139"><span class="linenos">139</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session-140"><a href="#Session-140"><span class="linenos">140</span></a><span class="sd">            key (str): Field to update.</span>
</span><span id="Session-141"><a href="#Session-141"><span class="linenos">141</span></a><span class="sd">            value (Any): New value for the field.</span>
</span><span id="Session-142"><a href="#Session-142"><span class="linenos">142</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-143"><a href="#Session-143"><span class="linenos">143</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session-144"><a href="#Session-144"><span class="linenos">144</span></a>        <span class="n">session</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="Session-145"><a href="#Session-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span id="Session-146"><a href="#Session-146"><span class="linenos">146</span></a>
</span><span id="Session-147"><a href="#Session-147"><span class="linenos">147</span></a>    <span class="c1"># ---------------------------</span>
</span><span id="Session-148"><a href="#Session-148"><span class="linenos">148</span></a>    <span class="c1"># Message Operations</span>
</span><span id="Session-149"><a href="#Session-149"><span class="linenos">149</span></a>    <span class="c1"># ---------------------------</span>
</span><span id="Session-150"><a href="#Session-150"><span class="linenos">150</span></a>
</span><span id="Session-151"><a href="#Session-151"><span class="linenos">151</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">msg_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Session-152"><a href="#Session-152"><span class="linenos">152</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-153"><a href="#Session-153"><span class="linenos">153</span></a><span class="sd">        Insert a new message into a session.</span>
</span><span id="Session-154"><a href="#Session-154"><span class="linenos">154</span></a>
</span><span id="Session-155"><a href="#Session-155"><span class="linenos">155</span></a><span class="sd">        Args:</span>
</span><span id="Session-156"><a href="#Session-156"><span class="linenos">156</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session-157"><a href="#Session-157"><span class="linenos">157</span></a><span class="sd">            message (Dict): Message dictionary to insert.</span>
</span><span id="Session-158"><a href="#Session-158"><span class="linenos">158</span></a>
</span><span id="Session-159"><a href="#Session-159"><span class="linenos">159</span></a><span class="sd">        Returns:</span>
</span><span id="Session-160"><a href="#Session-160"><span class="linenos">160</span></a><span class="sd">            str: ID of the inserted message.</span>
</span><span id="Session-161"><a href="#Session-161"><span class="linenos">161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-162"><a href="#Session-162"><span class="linenos">162</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session-163"><a href="#Session-163"><span class="linenos">163</span></a>        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Session-164"><a href="#Session-164"><span class="linenos">164</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span id="Session-165"><a href="#Session-165"><span class="linenos">165</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="Session-166"><a href="#Session-166"><span class="linenos">166</span></a>            <span class="o">**</span><span class="n">message</span>
</span><span id="Session-167"><a href="#Session-167"><span class="linenos">167</span></a>        <span class="p">}</span>
</span><span id="Session-168"><a href="#Session-168"><span class="linenos">168</span></a>        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span><span id="Session-169"><a href="#Session-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span id="Session-170"><a href="#Session-170"><span class="linenos">170</span></a>        <span class="k">return</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
</span><span id="Session-171"><a href="#Session-171"><span class="linenos">171</span></a>
</span><span id="Session-172"><a href="#Session-172"><span class="linenos">172</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">msg_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Session-173"><a href="#Session-173"><span class="linenos">173</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-174"><a href="#Session-174"><span class="linenos">174</span></a><span class="sd">        Retrieve a specific message from a session.</span>
</span><span id="Session-175"><a href="#Session-175"><span class="linenos">175</span></a>
</span><span id="Session-176"><a href="#Session-176"><span class="linenos">176</span></a><span class="sd">        Args:</span>
</span><span id="Session-177"><a href="#Session-177"><span class="linenos">177</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session-178"><a href="#Session-178"><span class="linenos">178</span></a><span class="sd">            message_id (str): ID of the message to retrieve.</span>
</span><span id="Session-179"><a href="#Session-179"><span class="linenos">179</span></a>
</span><span id="Session-180"><a href="#Session-180"><span class="linenos">180</span></a><span class="sd">        Returns:</span>
</span><span id="Session-181"><a href="#Session-181"><span class="linenos">181</span></a><span class="sd">            Optional[Dict]: The message if found, else None.</span>
</span><span id="Session-182"><a href="#Session-182"><span class="linenos">182</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-183"><a href="#Session-183"><span class="linenos">183</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session-184"><a href="#Session-184"><span class="linenos">184</span></a>        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Session-185"><a href="#Session-185"><span class="linenos">185</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">message_id</span><span class="p">:</span>
</span><span id="Session-186"><a href="#Session-186"><span class="linenos">186</span></a>                <span class="k">return</span> <span class="n">msg</span>
</span><span id="Session-187"><a href="#Session-187"><span class="linenos">187</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="Session-188"><a href="#Session-188"><span class="linenos">188</span></a>
</span><span id="Session-189"><a href="#Session-189"><span class="linenos">189</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">msg_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="Session-190"><a href="#Session-190"><span class="linenos">190</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-191"><a href="#Session-191"><span class="linenos">191</span></a><span class="sd">        Get the index of a message within a session.</span>
</span><span id="Session-192"><a href="#Session-192"><span class="linenos">192</span></a>
</span><span id="Session-193"><a href="#Session-193"><span class="linenos">193</span></a><span class="sd">        Args:</span>
</span><span id="Session-194"><a href="#Session-194"><span class="linenos">194</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session-195"><a href="#Session-195"><span class="linenos">195</span></a><span class="sd">            message_id (str): Message ID.</span>
</span><span id="Session-196"><a href="#Session-196"><span class="linenos">196</span></a>
</span><span id="Session-197"><a href="#Session-197"><span class="linenos">197</span></a><span class="sd">        Returns:</span>
</span><span id="Session-198"><a href="#Session-198"><span class="linenos">198</span></a><span class="sd">            Optional[int]: Index if found, else None.</span>
</span><span id="Session-199"><a href="#Session-199"><span class="linenos">199</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-200"><a href="#Session-200"><span class="linenos">200</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session-201"><a href="#Session-201"><span class="linenos">201</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])):</span>
</span><span id="Session-202"><a href="#Session-202"><span class="linenos">202</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">message_id</span><span class="p">:</span>
</span><span id="Session-203"><a href="#Session-203"><span class="linenos">203</span></a>                <span class="k">return</span> <span class="n">i</span>
</span><span id="Session-204"><a href="#Session-204"><span class="linenos">204</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="Session-205"><a href="#Session-205"><span class="linenos">205</span></a>
</span><span id="Session-206"><a href="#Session-206"><span class="linenos">206</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">msg_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Session-207"><a href="#Session-207"><span class="linenos">207</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-208"><a href="#Session-208"><span class="linenos">208</span></a><span class="sd">        Update the content of a specific message.</span>
</span><span id="Session-209"><a href="#Session-209"><span class="linenos">209</span></a>
</span><span id="Session-210"><a href="#Session-210"><span class="linenos">210</span></a><span class="sd">        Args:</span>
</span><span id="Session-211"><a href="#Session-211"><span class="linenos">211</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session-212"><a href="#Session-212"><span class="linenos">212</span></a><span class="sd">            message_id (str): Message ID.</span>
</span><span id="Session-213"><a href="#Session-213"><span class="linenos">213</span></a><span class="sd">            new_content (str): New content for the message.</span>
</span><span id="Session-214"><a href="#Session-214"><span class="linenos">214</span></a>
</span><span id="Session-215"><a href="#Session-215"><span class="linenos">215</span></a><span class="sd">        Returns:</span>
</span><span id="Session-216"><a href="#Session-216"><span class="linenos">216</span></a><span class="sd">            bool: True if update succeeded, False otherwise.</span>
</span><span id="Session-217"><a href="#Session-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-218"><a href="#Session-218"><span class="linenos">218</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session-219"><a href="#Session-219"><span class="linenos">219</span></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]:</span>
</span><span id="Session-220"><a href="#Session-220"><span class="linenos">220</span></a>            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">message_id</span><span class="p">:</span>
</span><span id="Session-221"><a href="#Session-221"><span class="linenos">221</span></a>                <span class="n">m</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_content</span>
</span><span id="Session-222"><a href="#Session-222"><span class="linenos">222</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span id="Session-223"><a href="#Session-223"><span class="linenos">223</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="Session-224"><a href="#Session-224"><span class="linenos">224</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Session-225"><a href="#Session-225"><span class="linenos">225</span></a>
</span><span id="Session-226"><a href="#Session-226"><span class="linenos">226</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">msg_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Session-227"><a href="#Session-227"><span class="linenos">227</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-228"><a href="#Session-228"><span class="linenos">228</span></a><span class="sd">        Delete a message from a session.</span>
</span><span id="Session-229"><a href="#Session-229"><span class="linenos">229</span></a>
</span><span id="Session-230"><a href="#Session-230"><span class="linenos">230</span></a><span class="sd">        Args:</span>
</span><span id="Session-231"><a href="#Session-231"><span class="linenos">231</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session-232"><a href="#Session-232"><span class="linenos">232</span></a><span class="sd">            message_id (str): Message ID.</span>
</span><span id="Session-233"><a href="#Session-233"><span class="linenos">233</span></a>
</span><span id="Session-234"><a href="#Session-234"><span class="linenos">234</span></a><span class="sd">        Returns:</span>
</span><span id="Session-235"><a href="#Session-235"><span class="linenos">235</span></a><span class="sd">            bool: True if deletion occurred, False otherwise.</span>
</span><span id="Session-236"><a href="#Session-236"><span class="linenos">236</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-237"><a href="#Session-237"><span class="linenos">237</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session-238"><a href="#Session-238"><span class="linenos">238</span></a>        <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>
</span><span id="Session-239"><a href="#Session-239"><span class="linenos">239</span></a>        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">message_id</span><span class="p">]</span>
</span><span id="Session-240"><a href="#Session-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span id="Session-241"><a href="#Session-241"><span class="linenos">241</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">before</span>
</span><span id="Session-242"><a href="#Session-242"><span class="linenos">242</span></a>
</span><span id="Session-243"><a href="#Session-243"><span class="linenos">243</span></a>    <span class="c1"># ---------------------------</span>
</span><span id="Session-244"><a href="#Session-244"><span class="linenos">244</span></a>    <span class="c1"># Branching &amp; Summarization</span>
</span><span id="Session-245"><a href="#Session-245"><span class="linenos">245</span></a>    <span class="c1"># ---------------------------</span>
</span><span id="Session-246"><a href="#Session-246"><span class="linenos">246</span></a>
</span><span id="Session-247"><a href="#Session-247"><span class="linenos">247</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Session-248"><a href="#Session-248"><span class="linenos">248</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-249"><a href="#Session-249"><span class="linenos">249</span></a><span class="sd">        Create a new session by branching from a specific message.</span>
</span><span id="Session-250"><a href="#Session-250"><span class="linenos">250</span></a>
</span><span id="Session-251"><a href="#Session-251"><span class="linenos">251</span></a><span class="sd">        Args:</span>
</span><span id="Session-252"><a href="#Session-252"><span class="linenos">252</span></a><span class="sd">            from_id (str): ID of the base session.</span>
</span><span id="Session-253"><a href="#Session-253"><span class="linenos">253</span></a><span class="sd">            message_id (str): Message ID to branch from.</span>
</span><span id="Session-254"><a href="#Session-254"><span class="linenos">254</span></a><span class="sd">            new_name (str): Name of the new session.</span>
</span><span id="Session-255"><a href="#Session-255"><span class="linenos">255</span></a>
</span><span id="Session-256"><a href="#Session-256"><span class="linenos">256</span></a><span class="sd">        Returns:</span>
</span><span id="Session-257"><a href="#Session-257"><span class="linenos">257</span></a><span class="sd">            str: ID of the new session.</span>
</span><span id="Session-258"><a href="#Session-258"><span class="linenos">258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-259"><a href="#Session-259"><span class="linenos">259</span></a>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">from_id</span><span class="p">)</span>
</span><span id="Session-260"><a href="#Session-260"><span class="linenos">260</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">message_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Session-261"><a href="#Session-261"><span class="linenos">261</span></a>        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Session-262"><a href="#Session-262"><span class="linenos">262</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message ID </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2"> not found in session </span><span class="si">{</span><span class="n">from_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="Session-263"><a href="#Session-263"><span class="linenos">263</span></a>        <span class="n">partial</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Session-264"><a href="#Session-264"><span class="linenos">264</span></a>        <span class="n">new_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="Session-265"><a href="#Session-265"><span class="linenos">265</span></a>        <span class="n">branch</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Session-266"><a href="#Session-266"><span class="linenos">266</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">new_id</span><span class="p">,</span>
</span><span id="Session-267"><a href="#Session-267"><span class="linenos">267</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">new_name</span><span class="p">,</span>
</span><span id="Session-268"><a href="#Session-268"><span class="linenos">268</span></a>            <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="Session-269"><a href="#Session-269"><span class="linenos">269</span></a>            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">from_id</span><span class="p">,</span>
</span><span id="Session-270"><a href="#Session-270"><span class="linenos">270</span></a>            <span class="s2">&quot;branch_point&quot;</span><span class="p">:</span> <span class="n">message_id</span><span class="p">,</span>
</span><span id="Session-271"><a href="#Session-271"><span class="linenos">271</span></a>            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Session-272"><a href="#Session-272"><span class="linenos">272</span></a>            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Session-273"><a href="#Session-273"><span class="linenos">273</span></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">partial</span>
</span><span id="Session-274"><a href="#Session-274"><span class="linenos">274</span></a>        <span class="p">}</span>
</span><span id="Session-275"><a href="#Session-275"><span class="linenos">275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">new_id</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
</span><span id="Session-276"><a href="#Session-276"><span class="linenos">276</span></a>        <span class="k">return</span> <span class="n">new_id</span>
</span><span id="Session-277"><a href="#Session-277"><span class="linenos">277</span></a>
</span><span id="Session-278"><a href="#Session-278"><span class="linenos">278</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interactor</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Session-279"><a href="#Session-279"><span class="linenos">279</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-280"><a href="#Session-280"><span class="linenos">280</span></a><span class="sd">        Summarize the conversation in a session using the Interactor.</span>
</span><span id="Session-281"><a href="#Session-281"><span class="linenos">281</span></a>
</span><span id="Session-282"><a href="#Session-282"><span class="linenos">282</span></a><span class="sd">        Args:</span>
</span><span id="Session-283"><a href="#Session-283"><span class="linenos">283</span></a><span class="sd">            interactor: An instance of the Interactor class with messaging methods.</span>
</span><span id="Session-284"><a href="#Session-284"><span class="linenos">284</span></a><span class="sd">            session_id (str): ID of the session to summarize.</span>
</span><span id="Session-285"><a href="#Session-285"><span class="linenos">285</span></a>
</span><span id="Session-286"><a href="#Session-286"><span class="linenos">286</span></a><span class="sd">        Returns:</span>
</span><span id="Session-287"><a href="#Session-287"><span class="linenos">287</span></a><span class="sd">            str: Generated summary string.</span>
</span><span id="Session-288"><a href="#Session-288"><span class="linenos">288</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-289"><a href="#Session-289"><span class="linenos">289</span></a>        <span class="n">clean_messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session-290"><a href="#Session-290"><span class="linenos">290</span></a>        <span class="n">summary_prompt</span> <span class="o">=</span> <span class="s2">&quot;Summarize the following interaction in 3-4 sentences.&quot;</span>
</span><span id="Session-291"><a href="#Session-291"><span class="linenos">291</span></a>        <span class="n">interactor</span><span class="o">.</span><span class="n">messages_flush</span><span class="p">()</span>
</span><span id="Session-292"><a href="#Session-292"><span class="linenos">292</span></a>        <span class="n">interactor</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">summary_prompt</span><span class="p">)</span>
</span><span id="Session-293"><a href="#Session-293"><span class="linenos">293</span></a>        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">clean_messages</span><span class="p">:</span>
</span><span id="Session-294"><a href="#Session-294"><span class="linenos">294</span></a>            <span class="n">interactor</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="o">**</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Session-295"><a href="#Session-295"><span class="linenos">295</span></a>        <span class="n">summary</span> <span class="o">=</span> <span class="n">interactor</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">user_input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Session-296"><a href="#Session-296"><span class="linenos">296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="n">summary</span><span class="p">)</span>
</span><span id="Session-297"><a href="#Session-297"><span class="linenos">297</span></a>        <span class="k">return</span> <span class="n">summary</span>
</span><span id="Session-298"><a href="#Session-298"><span class="linenos">298</span></a>
</span><span id="Session-299"><a href="#Session-299"><span class="linenos">299</span></a>    <span class="c1"># ---------------------------</span>
</span><span id="Session-300"><a href="#Session-300"><span class="linenos">300</span></a>    <span class="c1"># Search Capabilities</span>
</span><span id="Session-301"><a href="#Session-301"><span class="linenos">301</span></a>    <span class="c1"># ---------------------------</span>
</span><span id="Session-302"><a href="#Session-302"><span class="linenos">302</span></a>
</span><span id="Session-303"><a href="#Session-303"><span class="linenos">303</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Session-304"><a href="#Session-304"><span class="linenos">304</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-305"><a href="#Session-305"><span class="linenos">305</span></a><span class="sd">        Search messages for a text query across sessions or within a specific session.</span>
</span><span id="Session-306"><a href="#Session-306"><span class="linenos">306</span></a>
</span><span id="Session-307"><a href="#Session-307"><span class="linenos">307</span></a><span class="sd">        Args:</span>
</span><span id="Session-308"><a href="#Session-308"><span class="linenos">308</span></a><span class="sd">            query (str): Search term (case-insensitive).</span>
</span><span id="Session-309"><a href="#Session-309"><span class="linenos">309</span></a><span class="sd">            session_id (str, optional): If specified, restrict search to that session.</span>
</span><span id="Session-310"><a href="#Session-310"><span class="linenos">310</span></a>
</span><span id="Session-311"><a href="#Session-311"><span class="linenos">311</span></a><span class="sd">        Returns:</span>
</span><span id="Session-312"><a href="#Session-312"><span class="linenos">312</span></a><span class="sd">            List[Dict]: List of session dicts containing only matching messages.</span>
</span><span id="Session-313"><a href="#Session-313"><span class="linenos">313</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-314"><a href="#Session-314"><span class="linenos">314</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Session-315"><a href="#Session-315"><span class="linenos">315</span></a>        <span class="n">sessions</span> <span class="o">=</span> <span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="k">if</span> <span class="n">session_id</span> <span class="k">else</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">)]</span>
</span><span id="Session-316"><a href="#Session-316"><span class="linenos">316</span></a>
</span><span id="Session-317"><a href="#Session-317"><span class="linenos">317</span></a>        <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
</span><span id="Session-318"><a href="#Session-318"><span class="linenos">318</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Session-319"><a href="#Session-319"><span class="linenos">319</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
</span><span id="Session-320"><a href="#Session-320"><span class="linenos">320</span></a>                <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Session-321"><a href="#Session-321"><span class="linenos">321</span></a>                    <span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Session-322"><a href="#Session-322"><span class="linenos">322</span></a>                    <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Session-323"><a href="#Session-323"><span class="linenos">323</span></a>                <span class="p">]</span>
</span><span id="Session-324"><a href="#Session-324"><span class="linenos">324</span></a>                <span class="k">if</span> <span class="n">matching</span><span class="p">:</span>
</span><span id="Session-325"><a href="#Session-325"><span class="linenos">325</span></a>                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Session-326"><a href="#Session-326"><span class="linenos">326</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Session-327"><a href="#Session-327"><span class="linenos">327</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Session-328"><a href="#Session-328"><span class="linenos">328</span></a>                        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">],</span>
</span><span id="Session-329"><a href="#Session-329"><span class="linenos">329</span></a>                        <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">),</span>
</span><span id="Session-330"><a href="#Session-330"><span class="linenos">330</span></a>                        <span class="s2">&quot;branch_point&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;branch_point&quot;</span><span class="p">),</span>
</span><span id="Session-331"><a href="#Session-331"><span class="linenos">331</span></a>                        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Session-332"><a href="#Session-332"><span class="linenos">332</span></a>                        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">),</span>
</span><span id="Session-333"><a href="#Session-333"><span class="linenos">333</span></a>                        <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">matching</span>
</span><span id="Session-334"><a href="#Session-334"><span class="linenos">334</span></a>                    <span class="p">})</span>
</span><span id="Session-335"><a href="#Session-335"><span class="linenos">335</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Session-336"><a href="#Session-336"><span class="linenos">336</span></a>                <span class="k">continue</span>
</span><span id="Session-337"><a href="#Session-337"><span class="linenos">337</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="Session-338"><a href="#Session-338"><span class="linenos">338</span></a>
</span><span id="Session-339"><a href="#Session-339"><span class="linenos">339</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Session-340"><a href="#Session-340"><span class="linenos">340</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-341"><a href="#Session-341"><span class="linenos">341</span></a><span class="sd">        Search session metadata fields: name, tags, and summary.</span>
</span><span id="Session-342"><a href="#Session-342"><span class="linenos">342</span></a>
</span><span id="Session-343"><a href="#Session-343"><span class="linenos">343</span></a><span class="sd">        Args:</span>
</span><span id="Session-344"><a href="#Session-344"><span class="linenos">344</span></a><span class="sd">            query (str): Case-insensitive search term.</span>
</span><span id="Session-345"><a href="#Session-345"><span class="linenos">345</span></a>
</span><span id="Session-346"><a href="#Session-346"><span class="linenos">346</span></a><span class="sd">        Returns:</span>
</span><span id="Session-347"><a href="#Session-347"><span class="linenos">347</span></a><span class="sd">            List[Dict]: Matching sessions (without message contents).</span>
</span><span id="Session-348"><a href="#Session-348"><span class="linenos">348</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-349"><a href="#Session-349"><span class="linenos">349</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Session-350"><a href="#Session-350"><span class="linenos">350</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">):</span>
</span><span id="Session-351"><a href="#Session-351"><span class="linenos">351</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Session-352"><a href="#Session-352"><span class="linenos">352</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
</span><span id="Session-353"><a href="#Session-353"><span class="linenos">353</span></a>                <span class="n">searchable</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
</span><span id="Session-354"><a href="#Session-354"><span class="linenos">354</span></a>                    <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="Session-355"><a href="#Session-355"><span class="linenos">355</span></a>                    <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Session-356"><a href="#Session-356"><span class="linenos">356</span></a>                    <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]))</span>
</span><span id="Session-357"><a href="#Session-357"><span class="linenos">357</span></a>                <span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Session-358"><a href="#Session-358"><span class="linenos">358</span></a>                <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">searchable</span><span class="p">:</span>
</span><span id="Session-359"><a href="#Session-359"><span class="linenos">359</span></a>                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Session-360"><a href="#Session-360"><span class="linenos">360</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Session-361"><a href="#Session-361"><span class="linenos">361</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Session-362"><a href="#Session-362"><span class="linenos">362</span></a>                        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">],</span>
</span><span id="Session-363"><a href="#Session-363"><span class="linenos">363</span></a>                        <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">),</span>
</span><span id="Session-364"><a href="#Session-364"><span class="linenos">364</span></a>                        <span class="s2">&quot;branch_point&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;branch_point&quot;</span><span class="p">),</span>
</span><span id="Session-365"><a href="#Session-365"><span class="linenos">365</span></a>                        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Session-366"><a href="#Session-366"><span class="linenos">366</span></a>                        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
</span><span id="Session-367"><a href="#Session-367"><span class="linenos">367</span></a>                    <span class="p">})</span>
</span><span id="Session-368"><a href="#Session-368"><span class="linenos">368</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Session-369"><a href="#Session-369"><span class="linenos">369</span></a>                <span class="k">continue</span>
</span><span id="Session-370"><a href="#Session-370"><span class="linenos">370</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="Session-371"><a href="#Session-371"><span class="linenos">371</span></a>
</span><span id="Session-372"><a href="#Session-372"><span class="linenos">372</span></a>    <span class="c1"># ---------------------------</span>
</span><span id="Session-373"><a href="#Session-373"><span class="linenos">373</span></a>    <span class="c1"># Internal I/O</span>
</span><span id="Session-374"><a href="#Session-374"><span class="linenos">374</span></a>    <span class="c1"># ---------------------------</span>
</span><span id="Session-375"><a href="#Session-375"><span class="linenos">375</span></a>
</span><span id="Session-376"><a href="#Session-376"><span class="linenos">376</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_read_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Session-377"><a href="#Session-377"><span class="linenos">377</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-378"><a href="#Session-378"><span class="linenos">378</span></a><span class="sd">        Load a session file from disk.</span>
</span><span id="Session-379"><a href="#Session-379"><span class="linenos">379</span></a>
</span><span id="Session-380"><a href="#Session-380"><span class="linenos">380</span></a><span class="sd">        Args:</span>
</span><span id="Session-381"><a href="#Session-381"><span class="linenos">381</span></a><span class="sd">            session_id (str): ID of the session file to read.</span>
</span><span id="Session-382"><a href="#Session-382"><span class="linenos">382</span></a>
</span><span id="Session-383"><a href="#Session-383"><span class="linenos">383</span></a><span class="sd">        Returns:</span>
</span><span id="Session-384"><a href="#Session-384"><span class="linenos">384</span></a><span class="sd">            Dict: Parsed session data.</span>
</span><span id="Session-385"><a href="#Session-385"><span class="linenos">385</span></a>
</span><span id="Session-386"><a href="#Session-386"><span class="linenos">386</span></a><span class="sd">        Raises:</span>
</span><span id="Session-387"><a href="#Session-387"><span class="linenos">387</span></a><span class="sd">            FileNotFoundError: If the session file doesn&#39;t exist.</span>
</span><span id="Session-388"><a href="#Session-388"><span class="linenos">388</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-389"><a href="#Session-389"><span class="linenos">389</span></a>        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">.json&quot;</span>
</span><span id="Session-390"><a href="#Session-390"><span class="linenos">390</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Session-391"><a href="#Session-391"><span class="linenos">391</span></a>            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
</span><span id="Session-392"><a href="#Session-392"><span class="linenos">392</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="Session-393"><a href="#Session-393"><span class="linenos">393</span></a>            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="Session-394"><a href="#Session-394"><span class="linenos">394</span></a>
</span><span id="Session-395"><a href="#Session-395"><span class="linenos">395</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_save_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
</span><span id="Session-396"><a href="#Session-396"><span class="linenos">396</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session-397"><a href="#Session-397"><span class="linenos">397</span></a><span class="sd">        Write session data to disk.</span>
</span><span id="Session-398"><a href="#Session-398"><span class="linenos">398</span></a>
</span><span id="Session-399"><a href="#Session-399"><span class="linenos">399</span></a><span class="sd">        Args:</span>
</span><span id="Session-400"><a href="#Session-400"><span class="linenos">400</span></a><span class="sd">            session_id (str): ID of the session file to write.</span>
</span><span id="Session-401"><a href="#Session-401"><span class="linenos">401</span></a><span class="sd">            data (Dict): Session content to save.</span>
</span><span id="Session-402"><a href="#Session-402"><span class="linenos">402</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session-403"><a href="#Session-403"><span class="linenos">403</span></a>        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">.json&quot;</span>
</span><span id="Session-404"><a href="#Session-404"><span class="linenos">404</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="Session-405"><a href="#Session-405"><span class="linenos">405</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></pre></div>


    

                            <div id="Session.__init__" class="classattr">
                                        <input id="Session.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Session</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Session.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.__init__-20"><a href="#Session.__init__-20"><span class="linenos">20</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Session.__init__-21"><a href="#Session.__init__-21"><span class="linenos">21</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.__init__-22"><a href="#Session.__init__-22"><span class="linenos">22</span></a><span class="sd">        Initialize the session manager and ensure the session directory exists.</span>
</span><span id="Session.__init__-23"><a href="#Session.__init__-23"><span class="linenos">23</span></a>
</span><span id="Session.__init__-24"><a href="#Session.__init__-24"><span class="linenos">24</span></a><span class="sd">        Args:</span>
</span><span id="Session.__init__-25"><a href="#Session.__init__-25"><span class="linenos">25</span></a><span class="sd">            directory (str): Filesystem path for session storage. Must not be None or empty.</span>
</span><span id="Session.__init__-26"><a href="#Session.__init__-26"><span class="linenos">26</span></a>
</span><span id="Session.__init__-27"><a href="#Session.__init__-27"><span class="linenos">27</span></a><span class="sd">        Raises:</span>
</span><span id="Session.__init__-28"><a href="#Session.__init__-28"><span class="linenos">28</span></a><span class="sd">            ValueError: If directory is None or not a string.</span>
</span><span id="Session.__init__-29"><a href="#Session.__init__-29"><span class="linenos">29</span></a><span class="sd">            OSError: If the directory cannot be created or accessed.</span>
</span><span id="Session.__init__-30"><a href="#Session.__init__-30"><span class="linenos">30</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.__init__-31"><a href="#Session.__init__-31"><span class="linenos">31</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="p">:</span>
</span><span id="Session.__init__-32"><a href="#Session.__init__-32"><span class="linenos">32</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Session directory must be a valid non-empty string path.&quot;</span><span class="p">)</span>
</span><span id="Session.__init__-33"><a href="#Session.__init__-33"><span class="linenos">33</span></a>
</span><span id="Session.__init__-34"><a href="#Session.__init__-34"><span class="linenos">34</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Session.__init__-35"><a href="#Session.__init__-35"><span class="linenos">35</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
</span><span id="Session.__init__-36"><a href="#Session.__init__-36"><span class="linenos">36</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Session.__init__-37"><a href="#Session.__init__-37"><span class="linenos">37</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Session.__init__-38"><a href="#Session.__init__-38"><span class="linenos">38</span></a>            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize session directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the session manager and ensure the session directory exists.</p>

<p>Args:
    directory (str): Filesystem path for session storage. Must not be None or empty.</p>

<p>Raises:
    ValueError: If directory is None or not a string.
    OSError: If the directory cannot be created or accessed.</p>
</div>


                            </div>
                            <div id="Session.list" class="classattr">
                                        <input id="Session.list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Session.list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.list-44"><a href="#Session.list-44"><span class="linenos">44</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Session.list-45"><a href="#Session.list-45"><span class="linenos">45</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.list-46"><a href="#Session.list-46"><span class="linenos">46</span></a><span class="sd">        Return metadata for all sessions in the directory.</span>
</span><span id="Session.list-47"><a href="#Session.list-47"><span class="linenos">47</span></a>
</span><span id="Session.list-48"><a href="#Session.list-48"><span class="linenos">48</span></a><span class="sd">        Returns:</span>
</span><span id="Session.list-49"><a href="#Session.list-49"><span class="linenos">49</span></a><span class="sd">            List[Dict]: Sorted list of session metadata dictionaries.</span>
</span><span id="Session.list-50"><a href="#Session.list-50"><span class="linenos">50</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.list-51"><a href="#Session.list-51"><span class="linenos">51</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Session.list-52"><a href="#Session.list-52"><span class="linenos">52</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">):</span>
</span><span id="Session.list-53"><a href="#Session.list-53"><span class="linenos">53</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Session.list-54"><a href="#Session.list-54"><span class="linenos">54</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="Session.list-55"><a href="#Session.list-55"><span class="linenos">55</span></a>                    <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="Session.list-56"><a href="#Session.list-56"><span class="linenos">56</span></a>                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Session.list-57"><a href="#Session.list-57"><span class="linenos">57</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
</span><span id="Session.list-58"><a href="#Session.list-58"><span class="linenos">58</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
</span><span id="Session.list-59"><a href="#Session.list-59"><span class="linenos">59</span></a>                        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;created&quot;</span><span class="p">),</span>
</span><span id="Session.list-60"><a href="#Session.list-60"><span class="linenos">60</span></a>                        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Session.list-61"><a href="#Session.list-61"><span class="linenos">61</span></a>                        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
</span><span id="Session.list-62"><a href="#Session.list-62"><span class="linenos">62</span></a>                    <span class="p">})</span>
</span><span id="Session.list-63"><a href="#Session.list-63"><span class="linenos">63</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Session.list-64"><a href="#Session.list-64"><span class="linenos">64</span></a>                <span class="k">continue</span>
</span><span id="Session.list-65"><a href="#Session.list-65"><span class="linenos">65</span></a>        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return metadata for all sessions in the directory.</p>

<p>Returns:
    List[Dict]: Sorted list of session metadata dictionaries.</p>
</div>


                            </div>
                            <div id="Session.create" class="classattr">
                                        <input id="Session.create-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Session.create-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.create"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.create-67"><a href="#Session.create-67"><span class="linenos">67</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Session.create-68"><a href="#Session.create-68"><span class="linenos">68</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.create-69"><a href="#Session.create-69"><span class="linenos">69</span></a><span class="sd">        Create and persist a new session.</span>
</span><span id="Session.create-70"><a href="#Session.create-70"><span class="linenos">70</span></a>
</span><span id="Session.create-71"><a href="#Session.create-71"><span class="linenos">71</span></a><span class="sd">        Args:</span>
</span><span id="Session.create-72"><a href="#Session.create-72"><span class="linenos">72</span></a><span class="sd">            name (str): Name of the new session.</span>
</span><span id="Session.create-73"><a href="#Session.create-73"><span class="linenos">73</span></a><span class="sd">            tags (List[str], optional): Optional list of tags.</span>
</span><span id="Session.create-74"><a href="#Session.create-74"><span class="linenos">74</span></a>
</span><span id="Session.create-75"><a href="#Session.create-75"><span class="linenos">75</span></a><span class="sd">        Returns:</span>
</span><span id="Session.create-76"><a href="#Session.create-76"><span class="linenos">76</span></a><span class="sd">            str: Unique session ID of the new session.</span>
</span><span id="Session.create-77"><a href="#Session.create-77"><span class="linenos">77</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.create-78"><a href="#Session.create-78"><span class="linenos">78</span></a>        <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="Session.create-79"><a href="#Session.create-79"><span class="linenos">79</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Session.create-80"><a href="#Session.create-80"><span class="linenos">80</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span>
</span><span id="Session.create-81"><a href="#Session.create-81"><span class="linenos">81</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
</span><span id="Session.create-82"><a href="#Session.create-82"><span class="linenos">82</span></a>            <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="Session.create-83"><a href="#Session.create-83"><span class="linenos">83</span></a>            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Session.create-84"><a href="#Session.create-84"><span class="linenos">84</span></a>            <span class="s2">&quot;branch_point&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Session.create-85"><a href="#Session.create-85"><span class="linenos">85</span></a>            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">[],</span>
</span><span id="Session.create-86"><a href="#Session.create-86"><span class="linenos">86</span></a>            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Session.create-87"><a href="#Session.create-87"><span class="linenos">87</span></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span id="Session.create-88"><a href="#Session.create-88"><span class="linenos">88</span></a>        <span class="p">}</span>
</span><span id="Session.create-89"><a href="#Session.create-89"><span class="linenos">89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span id="Session.create-90"><a href="#Session.create-90"><span class="linenos">90</span></a>        <span class="k">return</span> <span class="n">sid</span>
</span></pre></div>


            <div class="docstring"><p>Create and persist a new session.</p>

<p>Args:
    name (str): Name of the new session.
    tags (List[str], optional): Optional list of tags.</p>

<p>Returns:
    str: Unique session ID of the new session.</p>
</div>


                            </div>
                            <div id="Session.load" class="classattr">
                                        <input id="Session.load-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Session.load-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.load"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.load-92"><a href="#Session.load-92"><span class="linenos"> 92</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Session.load-93"><a href="#Session.load-93"><span class="linenos"> 93</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.load-94"><a href="#Session.load-94"><span class="linenos"> 94</span></a><span class="sd">        Return OpenAI-compatible message list from a session.</span>
</span><span id="Session.load-95"><a href="#Session.load-95"><span class="linenos"> 95</span></a>
</span><span id="Session.load-96"><a href="#Session.load-96"><span class="linenos"> 96</span></a><span class="sd">        Filters out internal keys and leaves only standard API-compatible fields.</span>
</span><span id="Session.load-97"><a href="#Session.load-97"><span class="linenos"> 97</span></a>
</span><span id="Session.load-98"><a href="#Session.load-98"><span class="linenos"> 98</span></a><span class="sd">        Args:</span>
</span><span id="Session.load-99"><a href="#Session.load-99"><span class="linenos"> 99</span></a><span class="sd">            session_id (str): ID of the session to load.</span>
</span><span id="Session.load-100"><a href="#Session.load-100"><span class="linenos">100</span></a>
</span><span id="Session.load-101"><a href="#Session.load-101"><span class="linenos">101</span></a><span class="sd">        Returns:</span>
</span><span id="Session.load-102"><a href="#Session.load-102"><span class="linenos">102</span></a><span class="sd">            List[Dict]: List of clean message dictionaries.</span>
</span><span id="Session.load-103"><a href="#Session.load-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.load-104"><a href="#Session.load-104"><span class="linenos">104</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session.load-105"><a href="#Session.load-105"><span class="linenos">105</span></a>        <span class="k">return</span> <span class="p">[</span>
</span><span id="Session.load-106"><a href="#Session.load-106"><span class="linenos">106</span></a>            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">{</span>
</span><span id="Session.load-107"><a href="#Session.load-107"><span class="linenos">107</span></a>                <span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;function_call&quot;</span><span class="p">,</span> <span class="s2">&quot;tool_call_id&quot;</span>
</span><span id="Session.load-108"><a href="#Session.load-108"><span class="linenos">108</span></a>            <span class="p">}}</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Session.load-109"><a href="#Session.load-109"><span class="linenos">109</span></a>        <span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Return OpenAI-compatible message list from a session.</p>

<p>Filters out internal keys and leaves only standard API-compatible fields.</p>

<p>Args:
    session_id (str): ID of the session to load.</p>

<p>Returns:
    List[Dict]: List of clean message dictionaries.</p>
</div>


                            </div>
                            <div id="Session.load_full" class="classattr">
                                        <input id="Session.load_full-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_full</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="Session.load_full-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.load_full"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.load_full-111"><a href="#Session.load_full-111"><span class="linenos">111</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="Session.load_full-112"><a href="#Session.load_full-112"><span class="linenos">112</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.load_full-113"><a href="#Session.load_full-113"><span class="linenos">113</span></a><span class="sd">        Return the complete session file as-is.</span>
</span><span id="Session.load_full-114"><a href="#Session.load_full-114"><span class="linenos">114</span></a>
</span><span id="Session.load_full-115"><a href="#Session.load_full-115"><span class="linenos">115</span></a><span class="sd">        Args:</span>
</span><span id="Session.load_full-116"><a href="#Session.load_full-116"><span class="linenos">116</span></a><span class="sd">            session_id (str): ID of the session.</span>
</span><span id="Session.load_full-117"><a href="#Session.load_full-117"><span class="linenos">117</span></a>
</span><span id="Session.load_full-118"><a href="#Session.load_full-118"><span class="linenos">118</span></a><span class="sd">        Returns:</span>
</span><span id="Session.load_full-119"><a href="#Session.load_full-119"><span class="linenos">119</span></a><span class="sd">            Dict: Entire raw session data.</span>
</span><span id="Session.load_full-120"><a href="#Session.load_full-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.load_full-121"><a href="#Session.load_full-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return the complete session file as-is.</p>

<p>Args:
    session_id (str): ID of the session.</p>

<p>Returns:
    Dict: Entire raw session data.</p>
</div>


                            </div>
                            <div id="Session.delete" class="classattr">
                                        <input id="Session.delete-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Session.delete-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.delete"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.delete-123"><a href="#Session.delete-123"><span class="linenos">123</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Session.delete-124"><a href="#Session.delete-124"><span class="linenos">124</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.delete-125"><a href="#Session.delete-125"><span class="linenos">125</span></a><span class="sd">        Delete a session file from disk.</span>
</span><span id="Session.delete-126"><a href="#Session.delete-126"><span class="linenos">126</span></a>
</span><span id="Session.delete-127"><a href="#Session.delete-127"><span class="linenos">127</span></a><span class="sd">        Args:</span>
</span><span id="Session.delete-128"><a href="#Session.delete-128"><span class="linenos">128</span></a><span class="sd">            session_id (str): ID of the session to delete.</span>
</span><span id="Session.delete-129"><a href="#Session.delete-129"><span class="linenos">129</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.delete-130"><a href="#Session.delete-130"><span class="linenos">130</span></a>        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">.json&quot;</span>
</span><span id="Session.delete-131"><a href="#Session.delete-131"><span class="linenos">131</span></a>        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="Session.delete-132"><a href="#Session.delete-132"><span class="linenos">132</span></a>            <span class="n">file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Delete a session file from disk.</p>

<p>Args:
    session_id (str): ID of the session to delete.</p>
</div>


                            </div>
                            <div id="Session.update" class="classattr">
                                        <input id="Session.update-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">key</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">value</span><span class="p">:</span> <span class="n">Any</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Session.update-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.update"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.update-134"><a href="#Session.update-134"><span class="linenos">134</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span id="Session.update-135"><a href="#Session.update-135"><span class="linenos">135</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.update-136"><a href="#Session.update-136"><span class="linenos">136</span></a><span class="sd">        Update a top-level key in a session file.</span>
</span><span id="Session.update-137"><a href="#Session.update-137"><span class="linenos">137</span></a>
</span><span id="Session.update-138"><a href="#Session.update-138"><span class="linenos">138</span></a><span class="sd">        Args:</span>
</span><span id="Session.update-139"><a href="#Session.update-139"><span class="linenos">139</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session.update-140"><a href="#Session.update-140"><span class="linenos">140</span></a><span class="sd">            key (str): Field to update.</span>
</span><span id="Session.update-141"><a href="#Session.update-141"><span class="linenos">141</span></a><span class="sd">            value (Any): New value for the field.</span>
</span><span id="Session.update-142"><a href="#Session.update-142"><span class="linenos">142</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.update-143"><a href="#Session.update-143"><span class="linenos">143</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session.update-144"><a href="#Session.update-144"><span class="linenos">144</span></a>        <span class="n">session</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="Session.update-145"><a href="#Session.update-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Update a top-level key in a session file.</p>

<p>Args:
    session_id (str): Session ID.
    key (str): Field to update.
    value (Any): New value for the field.</p>
</div>


                            </div>
                            <div id="Session.msg_insert" class="classattr">
                                        <input id="Session.msg_insert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">msg_insert</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">message</span><span class="p">:</span> <span class="n">Dict</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Session.msg_insert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.msg_insert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.msg_insert-151"><a href="#Session.msg_insert-151"><span class="linenos">151</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">msg_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Session.msg_insert-152"><a href="#Session.msg_insert-152"><span class="linenos">152</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.msg_insert-153"><a href="#Session.msg_insert-153"><span class="linenos">153</span></a><span class="sd">        Insert a new message into a session.</span>
</span><span id="Session.msg_insert-154"><a href="#Session.msg_insert-154"><span class="linenos">154</span></a>
</span><span id="Session.msg_insert-155"><a href="#Session.msg_insert-155"><span class="linenos">155</span></a><span class="sd">        Args:</span>
</span><span id="Session.msg_insert-156"><a href="#Session.msg_insert-156"><span class="linenos">156</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session.msg_insert-157"><a href="#Session.msg_insert-157"><span class="linenos">157</span></a><span class="sd">            message (Dict): Message dictionary to insert.</span>
</span><span id="Session.msg_insert-158"><a href="#Session.msg_insert-158"><span class="linenos">158</span></a>
</span><span id="Session.msg_insert-159"><a href="#Session.msg_insert-159"><span class="linenos">159</span></a><span class="sd">        Returns:</span>
</span><span id="Session.msg_insert-160"><a href="#Session.msg_insert-160"><span class="linenos">160</span></a><span class="sd">            str: ID of the inserted message.</span>
</span><span id="Session.msg_insert-161"><a href="#Session.msg_insert-161"><span class="linenos">161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.msg_insert-162"><a href="#Session.msg_insert-162"><span class="linenos">162</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session.msg_insert-163"><a href="#Session.msg_insert-163"><span class="linenos">163</span></a>        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Session.msg_insert-164"><a href="#Session.msg_insert-164"><span class="linenos">164</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span id="Session.msg_insert-165"><a href="#Session.msg_insert-165"><span class="linenos">165</span></a>            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="Session.msg_insert-166"><a href="#Session.msg_insert-166"><span class="linenos">166</span></a>            <span class="o">**</span><span class="n">message</span>
</span><span id="Session.msg_insert-167"><a href="#Session.msg_insert-167"><span class="linenos">167</span></a>        <span class="p">}</span>
</span><span id="Session.msg_insert-168"><a href="#Session.msg_insert-168"><span class="linenos">168</span></a>        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span><span id="Session.msg_insert-169"><a href="#Session.msg_insert-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span id="Session.msg_insert-170"><a href="#Session.msg_insert-170"><span class="linenos">170</span></a>        <span class="k">return</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Insert a new message into a session.</p>

<p>Args:
    session_id (str): Session ID.
    message (Dict): Message dictionary to insert.</p>

<p>Returns:
    str: ID of the inserted message.</p>
</div>


                            </div>
                            <div id="Session.msg_get" class="classattr">
                                        <input id="Session.msg_get-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">msg_get</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Session.msg_get-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.msg_get"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.msg_get-172"><a href="#Session.msg_get-172"><span class="linenos">172</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">msg_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Session.msg_get-173"><a href="#Session.msg_get-173"><span class="linenos">173</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.msg_get-174"><a href="#Session.msg_get-174"><span class="linenos">174</span></a><span class="sd">        Retrieve a specific message from a session.</span>
</span><span id="Session.msg_get-175"><a href="#Session.msg_get-175"><span class="linenos">175</span></a>
</span><span id="Session.msg_get-176"><a href="#Session.msg_get-176"><span class="linenos">176</span></a><span class="sd">        Args:</span>
</span><span id="Session.msg_get-177"><a href="#Session.msg_get-177"><span class="linenos">177</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session.msg_get-178"><a href="#Session.msg_get-178"><span class="linenos">178</span></a><span class="sd">            message_id (str): ID of the message to retrieve.</span>
</span><span id="Session.msg_get-179"><a href="#Session.msg_get-179"><span class="linenos">179</span></a>
</span><span id="Session.msg_get-180"><a href="#Session.msg_get-180"><span class="linenos">180</span></a><span class="sd">        Returns:</span>
</span><span id="Session.msg_get-181"><a href="#Session.msg_get-181"><span class="linenos">181</span></a><span class="sd">            Optional[Dict]: The message if found, else None.</span>
</span><span id="Session.msg_get-182"><a href="#Session.msg_get-182"><span class="linenos">182</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.msg_get-183"><a href="#Session.msg_get-183"><span class="linenos">183</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session.msg_get-184"><a href="#Session.msg_get-184"><span class="linenos">184</span></a>        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="Session.msg_get-185"><a href="#Session.msg_get-185"><span class="linenos">185</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">message_id</span><span class="p">:</span>
</span><span id="Session.msg_get-186"><a href="#Session.msg_get-186"><span class="linenos">186</span></a>                <span class="k">return</span> <span class="n">msg</span>
</span><span id="Session.msg_get-187"><a href="#Session.msg_get-187"><span class="linenos">187</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Retrieve a specific message from a session.</p>

<p>Args:
    session_id (str): Session ID.
    message_id (str): ID of the message to retrieve.</p>

<p>Returns:
    Optional[Dict]: The message if found, else None.</p>
</div>


                            </div>
                            <div id="Session.msg_index" class="classattr">
                                        <input id="Session.msg_index-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">msg_index</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Session.msg_index-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.msg_index"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.msg_index-189"><a href="#Session.msg_index-189"><span class="linenos">189</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">msg_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="Session.msg_index-190"><a href="#Session.msg_index-190"><span class="linenos">190</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.msg_index-191"><a href="#Session.msg_index-191"><span class="linenos">191</span></a><span class="sd">        Get the index of a message within a session.</span>
</span><span id="Session.msg_index-192"><a href="#Session.msg_index-192"><span class="linenos">192</span></a>
</span><span id="Session.msg_index-193"><a href="#Session.msg_index-193"><span class="linenos">193</span></a><span class="sd">        Args:</span>
</span><span id="Session.msg_index-194"><a href="#Session.msg_index-194"><span class="linenos">194</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session.msg_index-195"><a href="#Session.msg_index-195"><span class="linenos">195</span></a><span class="sd">            message_id (str): Message ID.</span>
</span><span id="Session.msg_index-196"><a href="#Session.msg_index-196"><span class="linenos">196</span></a>
</span><span id="Session.msg_index-197"><a href="#Session.msg_index-197"><span class="linenos">197</span></a><span class="sd">        Returns:</span>
</span><span id="Session.msg_index-198"><a href="#Session.msg_index-198"><span class="linenos">198</span></a><span class="sd">            Optional[int]: Index if found, else None.</span>
</span><span id="Session.msg_index-199"><a href="#Session.msg_index-199"><span class="linenos">199</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.msg_index-200"><a href="#Session.msg_index-200"><span class="linenos">200</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session.msg_index-201"><a href="#Session.msg_index-201"><span class="linenos">201</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])):</span>
</span><span id="Session.msg_index-202"><a href="#Session.msg_index-202"><span class="linenos">202</span></a>            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">message_id</span><span class="p">:</span>
</span><span id="Session.msg_index-203"><a href="#Session.msg_index-203"><span class="linenos">203</span></a>                <span class="k">return</span> <span class="n">i</span>
</span><span id="Session.msg_index-204"><a href="#Session.msg_index-204"><span class="linenos">204</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Get the index of a message within a session.</p>

<p>Args:
    session_id (str): Session ID.
    message_id (str): Message ID.</p>

<p>Returns:
    Optional[int]: Index if found, else None.</p>
</div>


                            </div>
                            <div id="Session.msg_update" class="classattr">
                                        <input id="Session.msg_update-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">msg_update</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">new_content</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Session.msg_update-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.msg_update"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.msg_update-206"><a href="#Session.msg_update-206"><span class="linenos">206</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">msg_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Session.msg_update-207"><a href="#Session.msg_update-207"><span class="linenos">207</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.msg_update-208"><a href="#Session.msg_update-208"><span class="linenos">208</span></a><span class="sd">        Update the content of a specific message.</span>
</span><span id="Session.msg_update-209"><a href="#Session.msg_update-209"><span class="linenos">209</span></a>
</span><span id="Session.msg_update-210"><a href="#Session.msg_update-210"><span class="linenos">210</span></a><span class="sd">        Args:</span>
</span><span id="Session.msg_update-211"><a href="#Session.msg_update-211"><span class="linenos">211</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session.msg_update-212"><a href="#Session.msg_update-212"><span class="linenos">212</span></a><span class="sd">            message_id (str): Message ID.</span>
</span><span id="Session.msg_update-213"><a href="#Session.msg_update-213"><span class="linenos">213</span></a><span class="sd">            new_content (str): New content for the message.</span>
</span><span id="Session.msg_update-214"><a href="#Session.msg_update-214"><span class="linenos">214</span></a>
</span><span id="Session.msg_update-215"><a href="#Session.msg_update-215"><span class="linenos">215</span></a><span class="sd">        Returns:</span>
</span><span id="Session.msg_update-216"><a href="#Session.msg_update-216"><span class="linenos">216</span></a><span class="sd">            bool: True if update succeeded, False otherwise.</span>
</span><span id="Session.msg_update-217"><a href="#Session.msg_update-217"><span class="linenos">217</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.msg_update-218"><a href="#Session.msg_update-218"><span class="linenos">218</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session.msg_update-219"><a href="#Session.msg_update-219"><span class="linenos">219</span></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]:</span>
</span><span id="Session.msg_update-220"><a href="#Session.msg_update-220"><span class="linenos">220</span></a>            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">message_id</span><span class="p">:</span>
</span><span id="Session.msg_update-221"><a href="#Session.msg_update-221"><span class="linenos">221</span></a>                <span class="n">m</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_content</span>
</span><span id="Session.msg_update-222"><a href="#Session.msg_update-222"><span class="linenos">222</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span id="Session.msg_update-223"><a href="#Session.msg_update-223"><span class="linenos">223</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="Session.msg_update-224"><a href="#Session.msg_update-224"><span class="linenos">224</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Update the content of a specific message.</p>

<p>Args:
    session_id (str): Session ID.
    message_id (str): Message ID.
    new_content (str): New content for the message.</p>

<p>Returns:
    bool: True if update succeeded, False otherwise.</p>
</div>


                            </div>
                            <div id="Session.msg_delete" class="classattr">
                                        <input id="Session.msg_delete-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">msg_delete</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Session.msg_delete-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.msg_delete"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.msg_delete-226"><a href="#Session.msg_delete-226"><span class="linenos">226</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">msg_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Session.msg_delete-227"><a href="#Session.msg_delete-227"><span class="linenos">227</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.msg_delete-228"><a href="#Session.msg_delete-228"><span class="linenos">228</span></a><span class="sd">        Delete a message from a session.</span>
</span><span id="Session.msg_delete-229"><a href="#Session.msg_delete-229"><span class="linenos">229</span></a>
</span><span id="Session.msg_delete-230"><a href="#Session.msg_delete-230"><span class="linenos">230</span></a><span class="sd">        Args:</span>
</span><span id="Session.msg_delete-231"><a href="#Session.msg_delete-231"><span class="linenos">231</span></a><span class="sd">            session_id (str): Session ID.</span>
</span><span id="Session.msg_delete-232"><a href="#Session.msg_delete-232"><span class="linenos">232</span></a><span class="sd">            message_id (str): Message ID.</span>
</span><span id="Session.msg_delete-233"><a href="#Session.msg_delete-233"><span class="linenos">233</span></a>
</span><span id="Session.msg_delete-234"><a href="#Session.msg_delete-234"><span class="linenos">234</span></a><span class="sd">        Returns:</span>
</span><span id="Session.msg_delete-235"><a href="#Session.msg_delete-235"><span class="linenos">235</span></a><span class="sd">            bool: True if deletion occurred, False otherwise.</span>
</span><span id="Session.msg_delete-236"><a href="#Session.msg_delete-236"><span class="linenos">236</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.msg_delete-237"><a href="#Session.msg_delete-237"><span class="linenos">237</span></a>        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session.msg_delete-238"><a href="#Session.msg_delete-238"><span class="linenos">238</span></a>        <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>
</span><span id="Session.msg_delete-239"><a href="#Session.msg_delete-239"><span class="linenos">239</span></a>        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">message_id</span><span class="p">]</span>
</span><span id="Session.msg_delete-240"><a href="#Session.msg_delete-240"><span class="linenos">240</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</span><span id="Session.msg_delete-241"><a href="#Session.msg_delete-241"><span class="linenos">241</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">before</span>
</span></pre></div>


            <div class="docstring"><p>Delete a message from a session.</p>

<p>Args:
    session_id (str): Session ID.
    message_id (str): Message ID.</p>

<p>Returns:
    bool: True if deletion occurred, False otherwise.</p>
</div>


                            </div>
                            <div id="Session.branch" class="classattr">
                                        <input id="Session.branch-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">branch</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">from_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">new_name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Session.branch-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.branch"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.branch-247"><a href="#Session.branch-247"><span class="linenos">247</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Session.branch-248"><a href="#Session.branch-248"><span class="linenos">248</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.branch-249"><a href="#Session.branch-249"><span class="linenos">249</span></a><span class="sd">        Create a new session by branching from a specific message.</span>
</span><span id="Session.branch-250"><a href="#Session.branch-250"><span class="linenos">250</span></a>
</span><span id="Session.branch-251"><a href="#Session.branch-251"><span class="linenos">251</span></a><span class="sd">        Args:</span>
</span><span id="Session.branch-252"><a href="#Session.branch-252"><span class="linenos">252</span></a><span class="sd">            from_id (str): ID of the base session.</span>
</span><span id="Session.branch-253"><a href="#Session.branch-253"><span class="linenos">253</span></a><span class="sd">            message_id (str): Message ID to branch from.</span>
</span><span id="Session.branch-254"><a href="#Session.branch-254"><span class="linenos">254</span></a><span class="sd">            new_name (str): Name of the new session.</span>
</span><span id="Session.branch-255"><a href="#Session.branch-255"><span class="linenos">255</span></a>
</span><span id="Session.branch-256"><a href="#Session.branch-256"><span class="linenos">256</span></a><span class="sd">        Returns:</span>
</span><span id="Session.branch-257"><a href="#Session.branch-257"><span class="linenos">257</span></a><span class="sd">            str: ID of the new session.</span>
</span><span id="Session.branch-258"><a href="#Session.branch-258"><span class="linenos">258</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.branch-259"><a href="#Session.branch-259"><span class="linenos">259</span></a>        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">from_id</span><span class="p">)</span>
</span><span id="Session.branch-260"><a href="#Session.branch-260"><span class="linenos">260</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">message_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Session.branch-261"><a href="#Session.branch-261"><span class="linenos">261</span></a>        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Session.branch-262"><a href="#Session.branch-262"><span class="linenos">262</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message ID </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2"> not found in session </span><span class="si">{</span><span class="n">from_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="Session.branch-263"><a href="#Session.branch-263"><span class="linenos">263</span></a>        <span class="n">partial</span> <span class="o">=</span> <span class="n">base</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Session.branch-264"><a href="#Session.branch-264"><span class="linenos">264</span></a>        <span class="n">new_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
</span><span id="Session.branch-265"><a href="#Session.branch-265"><span class="linenos">265</span></a>        <span class="n">branch</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Session.branch-266"><a href="#Session.branch-266"><span class="linenos">266</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">new_id</span><span class="p">,</span>
</span><span id="Session.branch-267"><a href="#Session.branch-267"><span class="linenos">267</span></a>            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">new_name</span><span class="p">,</span>
</span><span id="Session.branch-268"><a href="#Session.branch-268"><span class="linenos">268</span></a>            <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="Session.branch-269"><a href="#Session.branch-269"><span class="linenos">269</span></a>            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">from_id</span><span class="p">,</span>
</span><span id="Session.branch-270"><a href="#Session.branch-270"><span class="linenos">270</span></a>            <span class="s2">&quot;branch_point&quot;</span><span class="p">:</span> <span class="n">message_id</span><span class="p">,</span>
</span><span id="Session.branch-271"><a href="#Session.branch-271"><span class="linenos">271</span></a>            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Session.branch-272"><a href="#Session.branch-272"><span class="linenos">272</span></a>            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Session.branch-273"><a href="#Session.branch-273"><span class="linenos">273</span></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">partial</span>
</span><span id="Session.branch-274"><a href="#Session.branch-274"><span class="linenos">274</span></a>        <span class="p">}</span>
</span><span id="Session.branch-275"><a href="#Session.branch-275"><span class="linenos">275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">new_id</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
</span><span id="Session.branch-276"><a href="#Session.branch-276"><span class="linenos">276</span></a>        <span class="k">return</span> <span class="n">new_id</span>
</span></pre></div>


            <div class="docstring"><p>Create a new session by branching from a specific message.</p>

<p>Args:
    from_id (str): ID of the base session.
    message_id (str): Message ID to branch from.
    new_name (str): Name of the new session.</p>

<p>Returns:
    str: ID of the new session.</p>
</div>


                            </div>
                            <div id="Session.summarize" class="classattr">
                                        <input id="Session.summarize-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">summarize</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">interactor</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Session.summarize-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.summarize"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.summarize-278"><a href="#Session.summarize-278"><span class="linenos">278</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interactor</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Session.summarize-279"><a href="#Session.summarize-279"><span class="linenos">279</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.summarize-280"><a href="#Session.summarize-280"><span class="linenos">280</span></a><span class="sd">        Summarize the conversation in a session using the Interactor.</span>
</span><span id="Session.summarize-281"><a href="#Session.summarize-281"><span class="linenos">281</span></a>
</span><span id="Session.summarize-282"><a href="#Session.summarize-282"><span class="linenos">282</span></a><span class="sd">        Args:</span>
</span><span id="Session.summarize-283"><a href="#Session.summarize-283"><span class="linenos">283</span></a><span class="sd">            interactor: An instance of the Interactor class with messaging methods.</span>
</span><span id="Session.summarize-284"><a href="#Session.summarize-284"><span class="linenos">284</span></a><span class="sd">            session_id (str): ID of the session to summarize.</span>
</span><span id="Session.summarize-285"><a href="#Session.summarize-285"><span class="linenos">285</span></a>
</span><span id="Session.summarize-286"><a href="#Session.summarize-286"><span class="linenos">286</span></a><span class="sd">        Returns:</span>
</span><span id="Session.summarize-287"><a href="#Session.summarize-287"><span class="linenos">287</span></a><span class="sd">            str: Generated summary string.</span>
</span><span id="Session.summarize-288"><a href="#Session.summarize-288"><span class="linenos">288</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.summarize-289"><a href="#Session.summarize-289"><span class="linenos">289</span></a>        <span class="n">clean_messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span id="Session.summarize-290"><a href="#Session.summarize-290"><span class="linenos">290</span></a>        <span class="n">summary_prompt</span> <span class="o">=</span> <span class="s2">&quot;Summarize the following interaction in 3-4 sentences.&quot;</span>
</span><span id="Session.summarize-291"><a href="#Session.summarize-291"><span class="linenos">291</span></a>        <span class="n">interactor</span><span class="o">.</span><span class="n">messages_flush</span><span class="p">()</span>
</span><span id="Session.summarize-292"><a href="#Session.summarize-292"><span class="linenos">292</span></a>        <span class="n">interactor</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">summary_prompt</span><span class="p">)</span>
</span><span id="Session.summarize-293"><a href="#Session.summarize-293"><span class="linenos">293</span></a>        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">clean_messages</span><span class="p">:</span>
</span><span id="Session.summarize-294"><a href="#Session.summarize-294"><span class="linenos">294</span></a>            <span class="n">interactor</span><span class="o">.</span><span class="n">messages_add</span><span class="p">(</span><span class="o">**</span><span class="n">msg</span><span class="p">)</span>
</span><span id="Session.summarize-295"><a href="#Session.summarize-295"><span class="linenos">295</span></a>        <span class="n">summary</span> <span class="o">=</span> <span class="n">interactor</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">user_input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Session.summarize-296"><a href="#Session.summarize-296"><span class="linenos">296</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="n">summary</span><span class="p">)</span>
</span><span id="Session.summarize-297"><a href="#Session.summarize-297"><span class="linenos">297</span></a>        <span class="k">return</span> <span class="n">summary</span>
</span></pre></div>


            <div class="docstring"><p>Summarize the conversation in a session using the Interactor.</p>

<p>Args:
    interactor: An instance of the Interactor class with messaging methods.
    session_id (str): ID of the session to summarize.</p>

<p>Returns:
    str: Generated summary string.</p>
</div>


                            </div>
                            <div id="Session.search" class="classattr">
                                        <input id="Session.search-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">search</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">query</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Session.search-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.search"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.search-303"><a href="#Session.search-303"><span class="linenos">303</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Session.search-304"><a href="#Session.search-304"><span class="linenos">304</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.search-305"><a href="#Session.search-305"><span class="linenos">305</span></a><span class="sd">        Search messages for a text query across sessions or within a specific session.</span>
</span><span id="Session.search-306"><a href="#Session.search-306"><span class="linenos">306</span></a>
</span><span id="Session.search-307"><a href="#Session.search-307"><span class="linenos">307</span></a><span class="sd">        Args:</span>
</span><span id="Session.search-308"><a href="#Session.search-308"><span class="linenos">308</span></a><span class="sd">            query (str): Search term (case-insensitive).</span>
</span><span id="Session.search-309"><a href="#Session.search-309"><span class="linenos">309</span></a><span class="sd">            session_id (str, optional): If specified, restrict search to that session.</span>
</span><span id="Session.search-310"><a href="#Session.search-310"><span class="linenos">310</span></a>
</span><span id="Session.search-311"><a href="#Session.search-311"><span class="linenos">311</span></a><span class="sd">        Returns:</span>
</span><span id="Session.search-312"><a href="#Session.search-312"><span class="linenos">312</span></a><span class="sd">            List[Dict]: List of session dicts containing only matching messages.</span>
</span><span id="Session.search-313"><a href="#Session.search-313"><span class="linenos">313</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.search-314"><a href="#Session.search-314"><span class="linenos">314</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Session.search-315"><a href="#Session.search-315"><span class="linenos">315</span></a>        <span class="n">sessions</span> <span class="o">=</span> <span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="k">if</span> <span class="n">session_id</span> <span class="k">else</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">stem</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">)]</span>
</span><span id="Session.search-316"><a href="#Session.search-316"><span class="linenos">316</span></a>
</span><span id="Session.search-317"><a href="#Session.search-317"><span class="linenos">317</span></a>        <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
</span><span id="Session.search-318"><a href="#Session.search-318"><span class="linenos">318</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Session.search-319"><a href="#Session.search-319"><span class="linenos">319</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
</span><span id="Session.search-320"><a href="#Session.search-320"><span class="linenos">320</span></a>                <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Session.search-321"><a href="#Session.search-321"><span class="linenos">321</span></a>                    <span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Session.search-322"><a href="#Session.search-322"><span class="linenos">322</span></a>                    <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Session.search-323"><a href="#Session.search-323"><span class="linenos">323</span></a>                <span class="p">]</span>
</span><span id="Session.search-324"><a href="#Session.search-324"><span class="linenos">324</span></a>                <span class="k">if</span> <span class="n">matching</span><span class="p">:</span>
</span><span id="Session.search-325"><a href="#Session.search-325"><span class="linenos">325</span></a>                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Session.search-326"><a href="#Session.search-326"><span class="linenos">326</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Session.search-327"><a href="#Session.search-327"><span class="linenos">327</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Session.search-328"><a href="#Session.search-328"><span class="linenos">328</span></a>                        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">],</span>
</span><span id="Session.search-329"><a href="#Session.search-329"><span class="linenos">329</span></a>                        <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">),</span>
</span><span id="Session.search-330"><a href="#Session.search-330"><span class="linenos">330</span></a>                        <span class="s2">&quot;branch_point&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;branch_point&quot;</span><span class="p">),</span>
</span><span id="Session.search-331"><a href="#Session.search-331"><span class="linenos">331</span></a>                        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Session.search-332"><a href="#Session.search-332"><span class="linenos">332</span></a>                        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">),</span>
</span><span id="Session.search-333"><a href="#Session.search-333"><span class="linenos">333</span></a>                        <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">matching</span>
</span><span id="Session.search-334"><a href="#Session.search-334"><span class="linenos">334</span></a>                    <span class="p">})</span>
</span><span id="Session.search-335"><a href="#Session.search-335"><span class="linenos">335</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Session.search-336"><a href="#Session.search-336"><span class="linenos">336</span></a>                <span class="k">continue</span>
</span><span id="Session.search-337"><a href="#Session.search-337"><span class="linenos">337</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Search messages for a text query across sessions or within a specific session.</p>

<p>Args:
    query (str): Search term (case-insensitive).
    session_id (str, optional): If specified, restrict search to that session.</p>

<p>Returns:
    List[Dict]: List of session dicts containing only matching messages.</p>
</div>


                            </div>
                            <div id="Session.search_meta" class="classattr">
                                        <input id="Session.search_meta-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">search_meta</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">query</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Session.search_meta-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Session.search_meta"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Session.search_meta-339"><a href="#Session.search_meta-339"><span class="linenos">339</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">search_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="Session.search_meta-340"><a href="#Session.search_meta-340"><span class="linenos">340</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Session.search_meta-341"><a href="#Session.search_meta-341"><span class="linenos">341</span></a><span class="sd">        Search session metadata fields: name, tags, and summary.</span>
</span><span id="Session.search_meta-342"><a href="#Session.search_meta-342"><span class="linenos">342</span></a>
</span><span id="Session.search_meta-343"><a href="#Session.search_meta-343"><span class="linenos">343</span></a><span class="sd">        Args:</span>
</span><span id="Session.search_meta-344"><a href="#Session.search_meta-344"><span class="linenos">344</span></a><span class="sd">            query (str): Case-insensitive search term.</span>
</span><span id="Session.search_meta-345"><a href="#Session.search_meta-345"><span class="linenos">345</span></a>
</span><span id="Session.search_meta-346"><a href="#Session.search_meta-346"><span class="linenos">346</span></a><span class="sd">        Returns:</span>
</span><span id="Session.search_meta-347"><a href="#Session.search_meta-347"><span class="linenos">347</span></a><span class="sd">            List[Dict]: Matching sessions (without message contents).</span>
</span><span id="Session.search_meta-348"><a href="#Session.search_meta-348"><span class="linenos">348</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Session.search_meta-349"><a href="#Session.search_meta-349"><span class="linenos">349</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Session.search_meta-350"><a href="#Session.search_meta-350"><span class="linenos">350</span></a>        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.json&quot;</span><span class="p">):</span>
</span><span id="Session.search_meta-351"><a href="#Session.search_meta-351"><span class="linenos">351</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Session.search_meta-352"><a href="#Session.search_meta-352"><span class="linenos">352</span></a>                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
</span><span id="Session.search_meta-353"><a href="#Session.search_meta-353"><span class="linenos">353</span></a>                <span class="n">searchable</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
</span><span id="Session.search_meta-354"><a href="#Session.search_meta-354"><span class="linenos">354</span></a>                    <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="Session.search_meta-355"><a href="#Session.search_meta-355"><span class="linenos">355</span></a>                    <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="Session.search_meta-356"><a href="#Session.search_meta-356"><span class="linenos">356</span></a>                    <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]))</span>
</span><span id="Session.search_meta-357"><a href="#Session.search_meta-357"><span class="linenos">357</span></a>                <span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Session.search_meta-358"><a href="#Session.search_meta-358"><span class="linenos">358</span></a>                <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">searchable</span><span class="p">:</span>
</span><span id="Session.search_meta-359"><a href="#Session.search_meta-359"><span class="linenos">359</span></a>                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="Session.search_meta-360"><a href="#Session.search_meta-360"><span class="linenos">360</span></a>                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Session.search_meta-361"><a href="#Session.search_meta-361"><span class="linenos">361</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="Session.search_meta-362"><a href="#Session.search_meta-362"><span class="linenos">362</span></a>                        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">],</span>
</span><span id="Session.search_meta-363"><a href="#Session.search_meta-363"><span class="linenos">363</span></a>                        <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">),</span>
</span><span id="Session.search_meta-364"><a href="#Session.search_meta-364"><span class="linenos">364</span></a>                        <span class="s2">&quot;branch_point&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;branch_point&quot;</span><span class="p">),</span>
</span><span id="Session.search_meta-365"><a href="#Session.search_meta-365"><span class="linenos">365</span></a>                        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="Session.search_meta-366"><a href="#Session.search_meta-366"><span class="linenos">366</span></a>                        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
</span><span id="Session.search_meta-367"><a href="#Session.search_meta-367"><span class="linenos">367</span></a>                    <span class="p">})</span>
</span><span id="Session.search_meta-368"><a href="#Session.search_meta-368"><span class="linenos">368</span></a>            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Session.search_meta-369"><a href="#Session.search_meta-369"><span class="linenos">369</span></a>                <span class="k">continue</span>
</span><span id="Session.search_meta-370"><a href="#Session.search_meta-370"><span class="linenos">370</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Search session metadata fields: name, tags, and summary.</p>

<p>Args:
    query (str): Case-insensitive search term.</p>

<p>Returns:
    List[Dict]: Matching sessions (without message contents).</p>
</div>


                            </div>
                </section>
    </main>
</body>
</html>